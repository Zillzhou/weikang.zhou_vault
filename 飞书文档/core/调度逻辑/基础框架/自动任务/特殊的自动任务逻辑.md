# 特殊的自动任务逻辑

## 特殊的自动任务逻辑
## @丁禹伯
## 充电点停靠点距离比较近
当场景中，自动停靠点和自动充电点无法被同时占用时，需要将自动充电点和自动停靠点位于同一个互斥组内。一个参考的案列场景如下所示：

### 0.1.9.240705 版本后，调度系统已经可以自动处理此情形，无需用户额外配置
1655879573991-1706b325-148c-473a-a3d3-e0fed72b0afd.png

## 取消没有绑定充电点和停靠点的报错
如果机器人没有绑定 PP 点和 CP 点，调度会报错 52101 have no charge point 和 52103 have no park point ，如果想不显示这两项报错，可以将参数 CloseChargeParkError 置为 true，便不再显示上述报错。如下图：
1665991808896-a5215f8b-31f7-4802-85e0-4b9bf25a1e0a.png 

1665988337961-e122d7b1-4f40-4f51-942e-ad3d4f94b90b.png

## 禁用 PP/CP 点
如果不想机器人去某些点位充电或停靠，可以将对应的 PP/CP 点禁用，禁用后算法不再生成对应点位的自动任务，重新启用禁用的 PP/CP 点后，算法可继续生成对应点位的自动任务
需要注意的是，如果在机器人前往 PP/CP 点的途中禁用了对应的 PP/CP 点，机器人的自动任务会被终止，重新寻找可用的 PP/CP 点
## 不同时间段采用不同的充电策略
如果在不同时间段想设置不同的 chargeNeed 等充电参数，可以使用模型文件多策略分时充电来实现
## 某些 CP 点不可以同时生成充电任务
如果一个充电桩对应多个 CP 点或因其他原因，不想一些 CP 点同时生成充电任务，可采用高级组SameCharger 组来实现
## 充电时长时间未充上电
如果机器人执行 chargeOnly 类型订单，在充电桩充电时连续超过 1min 未处于充电中状态，调度会将这个充电订单终止掉，重新生成充电订单
### chargeOnly（低电量不可接单）订单存在如下逻辑：
### 机器人前往充电桩过程中，订单状态为 RUNNING
机器人到达充电桩开始充电且电量小于 chargedOk（可接单阈值）时，订单状态为 WAITING
机器人电量大于 chargedOK 时，订单状态为 FINISHED
### 此异常处理只会终止 WAITING 状态的订单
由于此时机器人实际位置仍处于 CP 点，重新生成的充电任务大概率还是此 CP 点，若已诊断此充电桩硬件问题而不可用，建议 将此 CP 点禁用
注： 如果是 chargeNeed 类型订单，机器人在充电过程中长时间未处于充电状态，现有调度逻辑为：
如果此时电量仍小于 chargeNeed，会重新生成一个 chargeNeed 订单
### 如果此时电量大于 chargeNeed，会生成一个停靠订单
## 轮换充电
如果机器人 a 需要充电，但是没有可用的充电点时，会从所有机器人 a 绑定的充电点中，找到正在充电的机器人，如果正在充电的机器人电量已经大于 chargedOK，那么会综合考虑距离和电量选取一个最合适的正在充电的机器人 b，机器人 b 停止充电，前往停靠点，机器人 a 前往充电点，实现轮换充电
## 注意：使用此功能，需打开下述参数

## 参数名称

## 参数位置

## 单位

## 默认值

## 支持版本

## AdvancedAutoOrder

## 参数配置-导航

## bool

## false

### 0.1.8.230716

### 自动任务总开关，使用轮换充电时需要打开此参数

## AlternateCharge

## 参数配置-导航-更多

## bool

## false

### 0.1.8.230716

### 轮换充电开关，使用轮换充电时需要打开此参数

### AlternateChargePercentage

## 参数配置-导航-更多

## double

## 1.0

### 0.1.9.231106

轮换值，即只有正在充电的机器人电量已经大于 chargedOk + 此参数值，才会被轮换

轮换值： chargedOK + AlternateChargePercentage （参数配置）
动态任务： 机器人去某点的动态任务指的是，机器人存在去该点位的路径，但是路径上存在其他机器人挡路，动态任务会把挡路的机器人移开，此功能由参数 prepark 控制，使用时需要将挡路机器人所处点位添加到高级组 Prepark--doTask 中； 0.1.9.240705版本开始，简化操作，无需用户设置此项，调度系统可自动处理
轮换充电： 此功能直接控制参数为 AlternateCharge ；
此外还需要参数 AutoCharge AutoPark AdvancedAutoOrder
## 轮换充电完整逻辑如下：
1705974100721-503c58fd-f81b-43a0-9123-bd1340592daf.jpeg

## 自动终止自动任务
### 触发下述条件时，调度会终止正在执行的自动任务：
## 机器人电量波动异常
## 自动任务目标点被禁用
### 充电任务目标点被占用 0.1.9.231106
## 切换控制权时做过外部任务
## 切换控制权时机器人被移动位置
## 切换控制权后，机器人状态发生变化
### 低电量充电时，连续 1min 未处于充电状态
### 切换控制权后，目标点已经无法到达或与其他机器人发生冲突
## 通过 API 下发充电任务
### 0.1.8.230716
## API 文档：下发充电运单
## 需求如下：
当外界没有调用 setChargeOrder API 向指定机器人下发充电任务时，只有机器人电量小于 chargeOnly 时才会生成充电任务，否则不会生成充电任务。
当调用 setChargeOrder API 时，会立刻为该机器人生成一个充电任务，并且机器人遵循 chargedOK 和 chargedFull 的逻辑
## 实现方法：
## 设置 chargeNeed 为 -1
设置 chargeOnly 为合适值，即低于此值机器人必须去充电（即使没有通过 API 下发充电）
### 打开参数 AdvancedAutoOrder
## 停靠位置或附近是其它机器人的目标点
## 最低版本：0.1.9.240417
功能：如果场景中其他机器人目标点是当前机器人所处的停靠点，那么当前机器人需要重新生成停靠任务，且停靠点不能是当前停靠点
### 实现方法：参数AutoMovablePark控制了此功能
前置条件：需要开启参数AdvancedAutoOrder和AutoPark
补充说明：从检测到有其他机器人需要来自己所处停靠点做任务开始，需要经过startParkTime秒才会生成新的停靠任务

优化：0.1.9.240619 版本后，当前机器人所处的停靠点与其他机器人目标点只要会碰撞，就会生成新的停靠任务，且停靠点不能是当前停靠点
## 实例视频：

## AutoMovablePark.mp4

### 20240619134559_rec_.mp4
## 禁止机器人跨楼层停靠

### 0.1.9.240822 版本开始，提供参数 ForbidParkDiffArea 用于强制限制机器人不可以匹配跨楼层的停靠点，默认不开启
## 经典案例
### 队列式混用充电停靠 0.1.9.231106
适用场景： 可用的充电停靠位置少，多车共用一个充电桩，需要所有车辆在空闲时尽量保持充电电量均衡
实现效果： 每排为一个队列集合，共用队列头充电桩，队列中的点位均可用于停靠，当队列中的某些车需要充电，队列头的车会离开，队列中的车依次向队列头移动，直到需要充电的车到达充电桩，离开队列的车寻路回到队列尾，如有多辆车需要充电，会触发轮换充电，即正在充电的车电量高于设定值时，会离开队列，让后面的车来充电，以此实现队列中的车电量尽量均衡。

## 特殊的自动任务逻辑.mp4
## 使用参数：
AutoPark AutoCharge AdvancedAutoOrder PrePark AlternateCharge
AlternateChargePercentage : 在充电的机器人只有电量大于（chargedOk + 此值），才会允许被轮换
## 场景及高级组：
### 队列头 CP 点需绑定为队列中所有车的充电点
队列中所有点位需添加到高级组 PrePark-normal 中，队列头 CP 点需添加到高级组 PrePark-dotask 中
队列尾的 PP 点需要绑定为队列中所有车的停靠点（队列中的 PP 点绑不绑定均可）

为简化使用难度，0.1.9.240201 版本起可使用队列停靠（QueuePark）实现此效果，无需用户额外配置，自动支持
