# 预停靠（PrePark）

## 预停靠（PrePark）
## @丁禹伯
预停靠的全称是，预备接单停靠点（简称为PPP点，普通停靠点ParkPoint简称为PP点），比如存在一个接单的点位，我们希望在有订单的一瞬间就能让机器人把货拿走，那么可以使用预停靠这个功能。
## 预期现象
当预停靠点位空出来的时候，他会寻求附近的普通停靠点上的机器人，补充到预停靠的位置上。
预停靠附近的普通停靠点，会自适应拥有队列属性，机器人会依次选择距离预停靠更近的位置停靠。
## 配置方法
首先需要配置预停靠点位，在高级组合中进行配置，区域类型为 PrePark，如下图：
1662373814575-a75d771c-76e3-4996-b11b-dd9e445f0a74.png

## 其中参数的含义：
## normal
普通点没有特殊的功能，特指这个点位属于预停靠的排队区域。
## dotask
关键点是预停靠需要接单的点位，可以配置一个或多个。
注意事项1：关键点需要和排队区域中的普通点添加在同一个高级组合中，他才能捕获排队区域中的机器人。
注意事项2：需要用一个额外的高级组，单独声明任务点，在那个组中将属性 do_task 设置成 true
## 示例如下：
## 有两个排队区域：
1673405234586-0d53a7cc-0149-478e-a594-7639f6c68105.png

## 然后单独声明任务点：
1673405350978-d6eed512-5358-4b8a-b21e-18d212865be7.png

### 其次设置打开导航参数中的 PrePark，如下：

## 参数名

## 参数位置

## 默认值

## 支持版本

## PrePark

## 导航参数

## false

## ~lastest

### 是否启用预停靠功能（内置了新的停靠点匹配算法）

## 使用的限制条件
被预停靠捕获的普通停靠点， 他们之间必须是单向路径 ，即存在拓扑结构上的队列属性，否则无法正常使用。
## 上述为通俗的解释，严格的数学解释为：
在任意一个 PPP 点捕获范围内，所有的 PP 点与其他 PPP 点构成的一个局部拓扑图中，不存在任何一个移动策略，使得机器人无法移动到 PPP 点。（i.e., 不存在环路）
## 下图为一个合格的示例：

## 仿真演示
## 以下是一个仿真示例：
1662608347848-b7536fc6-a25d-4ce2-9255-e6d2d794e313.gif 

## 注意事项
不要下发目标点在排队区域的其他任务，会引起任务失败或排队区域车辆行动异常
小车在排队区域内的路线选择是基于路线长度来决定的，在一个路口车辆会选择长度短的边来通过，因此可以通过改变边的长度来定制想要实现的通行路线
## 务必保证排队区域内不存在环路
排队区域的入口需要绑定为所有要进入的车的停靠点，排队区域的出口与任务点之间可以间隔一段距离，不是必须要紧密连接的
打开 PreParkPoint 后，停靠任务的匹配原则变为基于距离匹配，即会为停靠点匹配最近的车来停靠，这与以前的自动停靠任务基于车辆序号来进行匹配的规则是不一样的
## 应用实例
## 优先停靠部分 PP 点
需求：在车辆停靠时，优先选择某些停靠点位（优先停靠点），优先停靠点停满车辆后再去其它点位停靠
实现原理：PrePark 功能中，doTask 里的点位的权限高于与他在一个 normal 组里的其它点位，例如 1234 为 PrePark::normal 组 1，1256 为 PrePark::normal 组 2，45 为 PrePark::doTask 组，123456 都为停靠点，那么 4 的权限比 123 高（意味着如果车停在 123，会被 4 拉过去，从而停在 4 这个优先停靠点），5 的权限比 126 高（同上）
效果：按步骤 2 配置，开启 AutoPark 和 PrePark 后，车辆会优先停靠在 45，两个点位停满车后，再去 1236 停靠
设置方法：下图中 ["AP3", "AP4", "AP49", "PP46", "PP47", "PP51"] 为停靠点，由于 3 4 49 为充电点前置点，所以希望车辆优先停靠在 46 47 51 上，停满后再去前置点；首先，设置 ["AP3", "AP4", "AP49", "PP46"] 为 PrePark::normal 组 1，设置 ["AP3", "AP4", "AP49", "PP47"] 为 PrePark::normal 组 2，设置 ["AP3", "AP4", "AP49", "PP51"] 为 PrePark::normal 组 3，最后设置 ["PP46", "PP47", "PP51" ] 为 PrePark::doTask 组，这样就能实现上述功能
## 高级组配置图：
1673426380687-69bb0d09-9ab5-48f8-882b-0300e7e193ef.png

## 效果图：见下动图
1673426280197-d7eacf70-3d0c-48ee-967f-bbc2124b4c3f.gif

## 自动填充队列式 PP 点
## 场景描述：
如下视频所示，存在 6 排单向连接的 PP 点（先进先出的队列结构），每次队列头去执行订单，队列中的车依次移动到队列头，空出的队列尾允许其他车来停靠。
## 使用方法：
## 使用预停靠功能：以其中一排为例
### 橘色为 PrePark 高级组的 normal 属性
### 紫色为 PrePark 高级组的 dotask 属性
队列尾（最右侧进队点位）的 PP 点需要绑定想在这一队列中停靠的机器人，队伍中其他 PP 点可以不绑定
1686651205061-6487759e-dccd-4a6b-9dff-8cd3501b8cad.png

## 效果展示：

## 预停靠（PrePark）.mp4

建议使用队列停靠（QueuePark）实现此功能，简化配置难度
