# 选车逻辑（订单分配模块）

## 选车逻辑（订单分配模块）
## @杨达
根据运单中输入的 label 和 group 字段，以及运单中的 keyRoute 或者 block 中的 location 或者拼合单中 fromLoc 或者 拼合单中的 toLoc 来从调度中选择出所有合适的机器人列表。
如果是拼合单，则在所有的合适的车子中遍历，选择有空背篓的车子，如果车子身上有某个运单的终点和当前拼合单起点的距离小于 JoinableDist ，则将拼合单接入，最后要将车子身上的所有运单的总距离最短。
如果是普通运单，是取货运单，则在所有合适的车子中遍历，优先选择附近放货的运单，如果放货运单目标点和预备取货运单起点的距离小于 JoinableDist , 则形成预接单模式，或者叫做顺风车任务。
如果是指定顺序的分拨单，则在所有合适的车子中遍历，根据到取货点的订单匹配得分来分配整个分拨单，分拨单不支持拼单。
>0.1.9.240517 如果下单(setOrder接口)时，指定了 keyGoodsId 字段，或者订单的第一个动作块有 goodsId 字段，且订单为卸货订单，且机器人的夹爪上有货，会根据货物id判断机器人能否接单。
>0.1.9.240529 如果机器人刚刚完成一个放货（取货）订单，且开启了模型文件-ChooseAGV中的 consecutiveLoadUnload，在分配新订单时，会修改放货（取货）订单的匹配价值，即，更偏向于在执行放货（取货）订单后，再执行一个放货（取货）订单，更偏向连续取货，或者连续放货
>0.1.9.240716如果订单中有loadBlockCount字段，且机器人的剩余空背篓小于它的值，不能分配
≤0.1.8.220823 如果还有待分派的运单，则遍历所有的车子，按时间先后顺序从待分配运单中选择不超过100个运单，计算车和运单匹配的价值，该匹配价值考虑了运单优先级，运单等待时间，和车与运单的距离。距离越小，优先级越高，运单等待时间越长，车与运单的匹配价值越低。计算所有车与运单的匹配价值后， 按匹配价值从小到大 ，去给每个空闲车安排运单执行，分配考虑到每个小车只能执行一个运单的限制。比如，如果有 n 辆车，一共有 200 个运单，那么会按照任务收到的时间顺序，先挑选前面的100个运单给n辆车匹配。然后将100n个匹配价值进行排序。 将匹配价值从小到大进行分配运单 。由于一个小车只能执行一个运单，当所有空闲小车都有运单后。此轮分配结束。
> 0.1.8.220823 如果还有待分派的运单，则遍历所有的车子，按优先级和时间计算运单价值，将运单价值从小到大排序，选择不超过100个运单，计算车和运单的匹配价值，该匹配价值考虑了运单优先级，运单等待时间，和车与运单的距离。距离越小，优先级越高，运单等待时间越长，车与运单的匹配价值越低。计算所有车与运单的匹配价值后， 按匹配价值从小到大 ，去给每个空闲车安排运单执行，分配考虑到每个小车只能执行一个运单的限制。比如，如果有 n 辆车，一共有 200 个运单，那么会按照任务收到的时间顺序，先挑选前面的100个运单给n辆车匹配。然后将100*n个匹配价值进行排序。 将匹配价值从小到大进行分配运单 。由于一个小车只能执行一个运单，当所有空闲小车都有运单后。此轮分配结束。

## 参数名称

## 参数位置

## 单位

## 默认值

## 最小值

## 最大值

## 支持版本

## JoinableDist

## 参数配置-导航

## m

## 1.

### 0.

### 100.

## ~latest

## 拼合单和预接单距离

## 运单价值：

## 车与运单的匹配价值：

其中  是机器人到运单位置的路径距离，单位是 m。  是距离的权重系数。  是运单的优先级。  是优先级的权重系数。  是运单的等待分配时间，单位是 s。  是等待分配时间的权重系数。  是机器人等待时间，单位是 s。  是机器人等待时间的权重系数。
OrderScore 会记录在运单中，字段为 OrderScore 。
对于一个运单，有多个 MatchScore，最小值会记录在运单中， 字段为 OrderMinScore 。
## 分页查询运单信息

## 参数名称

## 参数位置

## 单位

## 默认值

## 最小值

## 最大值

## 支持版本

## distRatio

## 模型文件-ChooseAGV

## 1.0

### 0.001

### 10000000.

## ~latest

## 距离的权重系数

## priorityRatio

## 模型文件-ChooseAGV

## 100000

### 0.001

### 100000000.

## ~latest

## 优先级的权重系数

## waitTimeRatio

## 模型文件-ChooseAGV

## 1

### 0.001

### 100000000.

## ~latest

## 等待分配时间的权重系数

### vehicleIdleTimeRatio

## 模型文件-ChooseAGV

## 0

## 0

### 100000000.

## ~latest

## 机器人空闲时间的权重系数

### preferVehicleInSameFloor

## 模型文件-ChooseAGV

## false

## -

## -

### 0.1.9.231130

## 避免跨楼层分配订单

### consecutiveLoadUnload

## 模型文件-ChooseAGV

## false

## -

## -

### 0.1.9.240520

### 在距离差距不大的情况下，优先分配连续的取放货任务

机器人到运单的距离默认采用 A* 算法规划出来的路径长度，对于有很多车，并且点位复杂，互相联通的场景。可以采用欧氏距离代替路径长度。这个开关由参数配置的 UseEuclideanDistEstimation 来控制。

## 参数名称

## 参数位置

## 单位

## 默认值

## 最小值

## 最大值

## 支持版本

### UseEuclideanDistEstimation

## 参数配置-导航

## false

## ~latest

## 运单选车价值中的距离是否采用欧氏距离

对于多楼层场景，需要尽量让同楼层机器人执行订单时，开启preferVehicleInSameFloor选项。开启后，如果机器人和任务的第一个目标点（keyRoute或者第一个动作块的location字段）不再同一楼层，且目标点所在楼层有其他车辆时，不会让机器人执行跨楼层任务。此外，开启选项后，普通订单在进行预接单（顺风车）时，如果机器人当前楼层和订单目标不在同一楼层，也不会进行预接单。
## 重新分配订单
## >0.1.8.220919
如果订单处于 CREATED 状态的时长超过配置的自动重分配时长，或者通过API手动标记订单需要重分配，则将订单重新放入待分配的订单池中；
订单处于 CREATED 状态且执行订单的机器人报错，则将订单重新放入待分配的订单池中。
## 无法重分配的三种情况：
如果订单属于拼合单，且拼合单已开始执行，不能重分配；
如果订单属于分拨单，不能重分配；
如果订单有externalId字段，且相同externalId的其他订单已开始执行，不能重分配；

## 参数名称

## 参数位置

## 单位

## 默认值

## 最小值

## 最大值

## 支持版本

## UnassignTime

## 参数配置-导航

## s

## -1

## -1

## 10000

## >0.1.8.220919

自动重分配时长。如果为-1，表示该功能关闭。默认是关闭的。

## >0.1.9.231226
如果下单时指定了机器人，即下单时报文中的 vehicle 字段不为空字符串，默认不重分配订单。
### 如需分配指定机器人的订单，需要开启下列参数：

## 参数名称

## 参数位置

## 单位

## 默认值

## 最小值

## 最大值

## 支持版本

### UnassignUserSpecifiedRobot

## 参数配置-导航

## -

## false

## -

## -

## >0.1.9.231226

下单时指定机器人的情况下，是否需要重分配。false表示不重分配指定机器人的订单。

## 根据预测时间分配订单
## >0.1.9.240306
分配运单时，考虑处于“即将完成当前运单”状态的机器人。

## 参数名称

## 参数位置

## 单位

## 默认值

## 最小值

## 最大值

## 支持版本

## DispatchWithOB

## 参数配置-导航

## -

## false

## -

## -

## >0.1.9.240306

开启根据订单完成时间预测进行订单分配的功能。false表示关闭，默认关闭。

### UnfinishedPathTimeThreshold

## 参数配置-导航

## s

## 10

## 0

## 10000

## >0.1.9.240306

判断机器人即将完成订单的剩余时间阈值。默认10秒，表示“预测还需10秒完成时，认为机器人即将完成任务”

## 拼单
希望在当前运单没有封口时，也能将其他运单拼到当前运单之后，需要修改下列参数：

## 参数名称

## 参数位置

## 单位

## 默认值

## 最小值

## 最大值

## 支持版本

### AppendAfterIncompleteOrder

## 参数配置-导航

## -

## false

## -

## -

## ~latest

开启订单未封口时的预接单功能。false表示关闭，默认关闭。
