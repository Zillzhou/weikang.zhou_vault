# G-MAPF 常用配置方法

## G-MAPF 常用配置方法
## @丁禹伯
## 将主干道设置为“高速公路”
## 问题引入背景
在现场往往存在着两条平行线路（双向线或方向相反的单向线）作为车辆的主干道，车辆通过主干道前往各工作站或支路，如下图所示
1679638839263-5b4fa13a-d324-4882-b3b7-4b014f543096.png 

1679638991694-9e630b0f-3c38-482b-97a0-67aaf82ebb30.png 

1679639156224-a1071365-ad12-4ec1-8d5b-2a1fd5bc9d57.png

如果不加以设置，可能会出现当一辆车停在某一条主干道时，其他车在另一条主干道上无法通行（ 即便实际空间尺寸是满足两车同时通行的 ）（ 实际能通过但是算法认为通不过 ）
在实际使用时，我们希望车辆在主干道上能实现快速通行，尽量不减速、不停止、不等待，即便有车停在一条路也不影响另一条路的通行，也就是类似于赋予其“高速公路”的属性
此配置方法旨在提供一种主干道配置方法，使算法将其视为“高速公路”
## G-MAPF 碰撞检测规则（原理）
检测机器人能否通行某位置实质上是判断两个点位之间的机器人是否有冲突。一般情况下，我们采用机器人的最大旋转半径模型来进行判断，如果在两个点位上机器人的最大旋转半径外接圆相交，则认为机器人在这两个点位会发生碰撞，如下图所示：
叶子结点 ：地图上只有一条边与之连接的点位被视为叶子结点，在叶子节点上的车采用一个特殊的值作为外接圆直径来进行碰撞检测，这个值可以通过导航参数 G-MAPF-LeafSize 进行设置，如下图所示：
叶子结点既有天然叶子结点，也可以通过高级组或导航参数人工设置，详见下述
1679969809317-8dafc15f-7f71-4363-8ec3-2814ce810038.png 

1679973841316-06ae3b90-2f68-44ef-936e-3bfd78fe0317.png

## 涉及参数及作用
G-MAPF-EF-2：自动识别高速公路点位（与某个点位相连接的边的数量小于这个值的点位被视为叶子结点，单向边视为一条边，双向边视为两条边）（ 注：不开EF1可以使用，小于不包含等号 ） 
G-MAPF-LeafSize：叶子结点大小（ 注：外接圆直径 ）
高级组-MAPF-minDistance：MAPF 区域内车辆间最小距离
高级组-MAPFProperty-Leaves：将点位设置为叶子结点
## 解决方案
将主干道上的点设置为叶子结点（ 这样上下同时通行的车就不会有冲突 ），同时分别对两条主干道限制组内最小距离（ 避免跟车过近发生意外 ）
### 应额外关注主干道两侧点位的车是否会影响主干道车的通行
1679975923590-dd1f7091-d2b4-4714-8af7-170c9163b0c3.png

## 配置方法/演示示例
添加三个高级组： 两个 MAPF 区域，一个 MAPFProperties 区域
设置叶子结点： 将两条主干道的点位都加入 MAPFProperties 区域，并设置 Leaves 属性为 True
限制组内距离： 将两条主干道 分别 加入两个 MAPF 区域里，设置 minDistance 为合适的值，如无特殊情况，可将 maxRobotNum 设置为 999，不限制机器人数量，只限制组内距离
1679980301603-e8ec64ec-c990-40ff-bfae-d93ce2b80f7a.png

## 旋转检测及环形锁的解法
## 问题引入背景
默认状态下，G-MAPF 不会考虑机器人在点位上的旋转，如下图所示，算法可能规划 1 车等待，2 车先走；但是实际上 2 车向左走到 LM820 后无法逆时针旋转 90°（会与 1 车碰撞）从而导致死锁
1679980827657-2bfce8f8-5f0a-43b9-8268-52dcad7f63ec.png

## G-MAPF 旋转检测的原理及局限性
如果路线上的连续三个点位不在一条直线上（不是严格的直线，由导航参数 G-MAPF-RotateDetection 控制直线的弯曲程度），则视为机器人会旋转
开启碰撞检测后，点位的碰撞模型将由原来的宽度变大为一个圆，这样就可以检测到旋转造成的冲突，就不会下发路线
1679982407220-cbd127f7-17d5-4149-9f14-fe983dd52cb4.png

### G-MAPF 应对环形锁的解法原理及局限性
开启旋转检测后，如果几辆车的路线构成一个环，可能造成伪环死锁，这时需要通过开启环形死锁参数来解伪环冲突 
环形冲突解法： 检测到环形冲突后，每个周期解决一辆车，只要这个车可以动，那么就可以解开这个环形冲突（比如下图 1 右下车辆向右走一步 或 左上车辆向左走一步，就可以解开），如果因为被阻挡无法移动会就进入 G-MAPF-Recover（ 比如下图 2 因为 7 号车的阻挡 5 号车无法向右走 ），此时首先考虑自己不动，让其它车行动尝试解开，若还是解不开，则尝试自己动来解开（ 此图中先尝试 5 号车不动，7 号车移动，7 号车可以向右移动，死锁解开 ）（ 注：recover 策略会在阻挡 8s 后启用第一个小策略，再 8s 后启用第二个小策略，且尝试行动时， 绑定了库位的站点 、 defect 点位 、 fluent 点位、电梯点位、距离几乎重合的点位 ，是不可以去的 ）
1679983100083-e44bc436-4ced-4bdc-81b9-1c44e1e1df59.png 

1679983329323-37d445d5-3d5a-4dbb-bc5b-da930ec991d5.png

## 涉及参数及作用
G-MAPF-RotateDetection： 旋转检测开关
### G-MAPF-SafeSpacing： 跟车距离
### G-MAPF-PseudoCircle： 环形冲突环的大小
### G-MAPF-Recover： 机器人被阻挡后的恢复
## 解决方案
### 开启旋转检测功能，使算法可以检测到旋转死锁
## 设置跟车距离，防止跟车过近造成意外
## 设置环形冲突的大小，来解决伪环冲突
## 开启阻挡恢复功能，解决阻挡造成的死锁
## 配置方法
导航参数 G-MAPF-RotateDetection 置为 True
导航参数 G-MAPF-SafeSpaing 设置为合适的值（ 跟车距离，机器人下发的点位距离其它机器人不可以小于此值，一般保持一到两个车位大小即可 ）
导航参数 G-MAPF-PseudoCircle 设置为合适的值（ 伪环大小，描述为机器人经过几个点位回到本身，一般设置为 1 即可 ）
### 导航参数 G-MAPF-Recover 置为 True
## 库位的常见操作
## 问题引入背景
现场的库位一般会与地图中的点位进行绑定，有些可以用于避让，有些不可以用于避让，有些属于堆栈类型的库位，需要按顺序取放货
## G-MAPF 避让逻辑及局限性
当车辆发生冲突时，往往体现为一辆车在等待另一辆车，如果另一辆车按原规划路线无法行驶，算法求解器会在可以避让的范围内随机寻找一个“合适的”避让点，从而解开冲突
避让点的选择是随机的，不想用于避让的点位可以设置为 defect 属性，则不会去这些点位避让
可以通过导航参数 G-MAPF-BinDefect 设置所有绑定了库位的点不可用于避让
### 堆栈类型的库位本质为“有货则不可避让”的问题
## 涉及参数及作用
高级组--G-MAPF-Properties--defect： defect 点位不可用于避让
高级组--G-MAPF-Properties--fluent： 当机器人的路线里存在 fluent 点位时，如果不可以一次性直接通过，就不会下发路线（ 要么一次通过，要么不通过 ）
高级组--G-MAPF-Properties--station： station 点位会提高被选为避让点的概率（ 只是有更高的概率，不是百分百保证 ）
G-MAPF-BinDefect： 绑定了库位的点位都不可以作为避让点
G-MAPF-BinRecognition： 自动识别库位，有货则禁止在此处避让；需要配置库位监测，或使用物理库位
G-MAPF-TransferLimit： 用于限制机器人解死锁时的场地范围，单位米；会倾向搜索小于这个距离范围内的避让点。
## 解决方案/配置方法
## 按需使用上述参数或高级组
避让行为常发生在两车对开的情形下，其中一辆车需要寻找一个避让点，现场的地图空间往往有限，选择的范围也很小，这时就要确保自己绘制地图时尽量考虑到预留出用于避让的点位，同时 G-MAPF-TransferLimit 范围内可以“看见”避让点
## 排队模式及跟车绕路的选择
## 问题引入背景
大规模相同、相似路线的车辆，如果数量很大，会给算法造成不必要的压力，如何优化此种情形
## 如何实现机器人交替经过一片冲突区域
## G-MAPF 排队模式的原理及局限性
### 可以通过排队等待而解开的资源冲突，即为队列模式
根据产生冲突的时间判断进队列，如果 a 在 b 之前发生冲突，那么在队列里 b 跟在 a 后面
队列模式下，只有队列头的车会参与解死锁，后面的车仅仅通过跟随来行动
如不加额外设置，机器人会一直跟随等待，不会绕路，这往往是使用时不希望看到的
### G-MAPF 对排队中的车跟车及绕路选择的原理及局限性
开启排队模式后，处于排队状态的机器人会跟随前方的机器人行走，处于跟车模式
## 可以通过开启绕路模式，来增加绕路选择
### 绕路时机器人会重新选择一条不经过前车的路
## 涉及参数及作用
## G-MAPF-EF-3： 排队模式开关
G-MAPF-EF-4： 绕路选择控制参数，对应的是前面有此参数辆车时会选择绕路
## 解决方案/配置方法
排队模式的解决方案主要涉及的为是否选择让机器人绕路，如果现场认为队伍过长等待时间不可接受，则可以同时开启 G-MAPF-EF-3 和 G-MAPF-EF-4 来使用可绕路的排队模式；
反之如果现场认为排队等待的时间可以接受或必须排队等待不可以绕路，则只需打开 G-MAPF-EF-3 使用不绕路的排队模式
## 电梯及自动门的处理方法
## 问题引入背景
### 如何处理电梯与门及附近的点位来实现交替使用电梯或门
### G-MAPF 对电梯门的搜路及下发路线原理和局限性
下发路线时，只会下发到电梯前的一个点位（即便是 fluent 点位）避免出现车辆的跨楼层等待
## 涉及参数及作用
高级组--MAPFProperties--fluent： 只有在可以一次性通过 fluent 点位时才会下发路线
### 高级组--Mutex： 只允许一辆车申请使用的互斥区
## 解决方案/配置方法
在进入电梯和出去电梯的点位添加 fluent 属性，保证车辆一次通行不停顿
## 电梯和门点位做互斥，只允许一辆车使用
### 如果需要使用电梯的车很多，可以考虑使用排队模式
## 演示案例
SM90 为电梯，GS-2F、GD-2F 为自动门，蓝色为 fluent 点位，紫色为 mutex 属性
1680155508807-20ac79bc-0d70-4bb7-90b0-8e747ee0cce3.png

## 其他较独立的参数
### 导航参数 G-MAPF-FixOperation
## 目标点资源释放优化
不开启参数时，只有在车辆完全到达目标点后，才会释放目标点前置点的点位资源
开启参数后，在下发路线到达目标点后，会立即释放目标点前置点的点位资源
### 高级组--MAPFProperties--forced
## forced 点位的车会强制进算法
## 本质为保证不进队列
### 高级组--MAPFProperties--queue
## queue 点位的车会强制不进算法
## 本质为进队列模式
### 导航参数--G-MAPF-OptSmooth
## 求解器平滑参数
开启后，如果一个任务是刚刚启动的，那么它的优先级会很低，这样便于让求解器优先解决长时间未完成的任务
