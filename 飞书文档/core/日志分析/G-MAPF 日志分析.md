# G-MAPF 日志分析

## G-MAPF 日志分析
## @高磊

## 死锁案例.xlsx
## 抽象 G-MAPF 多车搜路的模型
虽然 G-MAPF 是一个复杂的多车联合搜路系统，我们仍可以将其抽象为几个模块，方便我们理解及分析问题
### 如果将其视为一个顺序执行系统，可以分为以下几个步骤：
A*：                 搜索所有机器人去目标点的最短路
search_conflict：基于上述最短路寻找机器人间的路线冲突
ga_solver：       需要为冲突的机器人计算不冲突路线
path_track：     判断上一步骤计算出的路线能否下发
### setpath：         下发路线给碰撞检测模块
### checkCollision：碰撞检测再做一层保护
### send：             下发路线给机器人
## 每个阶段对应的日志如下：
### A*：日志关键字为A* Plan，后面打印了完整路径
[240722 200303.705][D][d] [GM][AMB-05|A* Plan|17|9.552131|227-18-226-17-225-16-15-224-14-223-13-221-1-2-8-140-139-]
/* 上述日志含义为 AMB-05 机器人的最短路共有 17 个点，路线总长度 9.552131m， 路线为xxx */
search_conflict：日志关键字为conflict
[240722 200303.706][D][d] [KL][3694|pair|AMB-03|AMB-06|4497|conflict]
/* 上述日志含义为 AMB-03 和 AMB-06 的最短路径存在冲突 */
/* Tip: 这条日志前缀有[KL]，其含义为 kernel log，这种类型的日志一般打印量很大，默认是不打印的，只有参数 G-MAPF-KernelLog 为 true 时才会打印 */
ga_solver：计算不冲突路线的模块实际上是一个独立的线程，当主线程想要机器人不冲突路线时，会尝试从子线程读取计算结果，所以实际上分为子线程计算的结果和主线程读取到的结果两部分，对应日志分别如下：
### 子线程计算结果：日志关键字为final_path
[240722 200303.290][D][d] [GM][MAPFSolver|AMB-05|final_path|227-18-226-17-225-16-15-224-14-223-13-221-1-2-8-140-139-]
### /* 上述日志含义为 AMB-05 的不冲突路线 */
### 主线程读取结果：日志关键字为res_path
[240722 200303.323][D][d] [GM][AMB-05|res_path|1|34.552131|false|9.552131|::|227-18-226-17-225-16-]
/* 这条日志含义为 AMB-05 从子线程读取的不冲突路线，其他几个数值输出无需关注 */
/* Tip: res_path 实际上很可能是 final_path 的子集，这是因为 final_path 大多数情况下是算到终点的，但在一个周期里是不需要这么长的路线的，所以只截取部分 */
path_track：日志关键字为STSP.
[240722 200317.096][D][d] [GM][AMR-18|STSP.|out of limit length|10.661087|8.000000]
/* 日志含义为 AMR-18 res_path 长度为 10.661087m，比规定的最大下发长度 8m 长，所以需要截取后下发 */
/* Tip：STSP 是 stop to set path 的缩写，含义为截断下发路线的过程，其后的输出是截断原因，实际有很多截断逻辑，比较庞杂，暂不赘述 */
### setpath：日志关键字为setpath
[240722 200317.096][D][d] [AMR-18][setPath|2|30850-30851]
/* 日志含义为 AMR-18 下发了点位数量为 2 的路线给碰撞检测模块 */
checkcollision：日志关键字为checkcollision
[240724 090417.286][D][d] [RIL-H-9008][checkCollision|17.010000|-0.287000|-3.141593|18.780000|-0.277000|3.141593|true|RIL-H-9005|1.453412|2.399613|false]
[240724 090417.286][D][d] [RIL-H-9008][shape|[(1.160,0.594),(1.160,-0.594),(-0.587,-0.594),(-0.587,0.594),]|[(1.160,0.594),(1.160,-0.594),(-0.587,-0.594),(-0.587,0.594),]]
日志含义为 RIL-H-9008 和 RIL-H-9005 会碰撞
## 这个碰撞形状可以使用日志分析器绘制出来
## image.png

## send：日志关键字为SEND
[240722 195915.736][D][d] [AMB-03][SEND|AMB-03|3066|19206|1|{"move_task_list":[{"binTask":"load","dispatcherArgs":{"blockId":"222dd8c4-3a42-4070-b8d4-468a7e5190c0","curSection":0,"endP":1.0,"startP":0.0,"targetLoc":"CS01HW0703","totalSection":1},"goodsId":"HX01491","id":"CS01HW0703","operation":"script","percentage":1.0,"source_id":"AP257","task_id":"e0d41751-e4dc-425b-8c33-3097f897fb23"}]}]
/* 日志含义为 AMB-03 下发了一条起点为 "source_id":"AP257"， 终点为 "id":"CS01HW0703"， 走到路线百分比 "percentage":1.0 处 */
