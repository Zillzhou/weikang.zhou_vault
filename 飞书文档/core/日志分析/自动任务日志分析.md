# 自动任务日志分析

## 自动任务日志分析
## 充电任务
## 下发充电任务的步骤
## 判断机器人是否满足充电条件
## 匹配可用充电桩
## 下发去充电桩的充电任务
## 充电需满足条件：
自动充电参数打开：参数AutoCharge，bool 量，true表示允许自动充电，false表示禁止自动充电
未处于断联状态：对于日志字段GET.connect，bool 量，1表示连接，0表示断联
有控制权：对应日志字段GET.control，bool 量，1表示调度有机器人的控制权，0表示无控制权
未处于充电状态：对应日志字段GET.is_charging，bool 量，1表示机器人正在充电，0表示机器人未在充电
没有正在执行的订单并且没有预接单：对应日志字段GET.order_state，枚举量，详见下代码块
## {
### 0: Created  // 创建状态，订单刚被创建
  1：Waiting  // 等待状态，指的是机器人完成了当前动作块，订单没有封口，等待后续指令（封口或追加动作块）
### 2：Running  // 运行状态，机器人正在执行任务
  3：Suspend  // 暂停状态，机器人暂停时可能会跳转这个状态
### 4：Finished // 完成状态，机器人完成了当前任务
### 5：Failed   // 失败状态，机器人执行订单失败
### 6：Stopped  // 终止状态，订单被终止
### 7：Error    // 错误状态，目前没有使用
## 8：None     // 初始化使用
  9：TobeDispatched  // 待分配状态，字面意思
  10：Manual_Finished：// 人工完成状态，目前没有使用
## }
当前订单状态为终态（ FINISHED 或 STOPPED ）：查看方式与上述一致
滤波后电量低于 chargeNeed 或 chargeOnly：对应日志字段GET.battery，double 量，转换为 0-1 之间的数字，比如 0.67 代表有 67 个电
如果开启了禁止载货充电功能，还需保证机器人未载货：参数 goodsCharge 为 true 表示禁止载货充电，载货状态对应日志字段rTopoPos.has_goods，bool 量，1代表载货，0代表空载
## 匹配充电桩
禁用的充电桩不可使用：日志中搜索关键字disPointPath 后面的信息为禁用点位和禁用线路
有其他无任务机器人停在充电桩附近（会碰撞），则不可用：不建议通过搜索日志方式查看，一般通过地图查看
已经被其他机器人占用的充电桩不可用：不建议通过搜索日志方式查看，一般通过地图查看
充电桩附近（会碰撞）的停靠点已经被其他机器人占用，不可用：不建议通过搜索日志方式查看，一般通过地图查看
上述后三项如果需要在日志搜索，关键字为NoP-C 含义是由于这个机器人影响，其他机器人不能使用这些点位停靠或充电，以下面两条日志为例：
[2024-07-18 15:55:19.369712][D][debug] [OQC-136][NoP-C|targetId|22013|blockId|22004|22009|]
[2024-07-18 15:55:19.369712][D][debug] [OQC-138][NoP-C|blockId|r.sid|10065|r.eid|10065|]
第一行含义为：机器人 OQC-136 订单目标点是 22013，占据的互斥区包含点位 22004 22009，所以其他机器人都不可以去这些点位停靠或充电
第二行含义为：机器人 OQC-138 位于点位 10065 上（sid 和 eid 都是 10065），所以其他机器人不能去这个点位停靠或充电
匹配成功的日志字段为autoChargeFINISHED，如下含义为 sim_02 匹配的充电桩为 CP132
[2025-01-21 15:11:48.817777][D][debug] [sim_02][autoChargeFINISHED|132|CP132]
匹配失败的日志字段为 chargeLength autoCharge，
如下第一行含义为 [chargeLength | 匹配的充电桩ID | 搜路去充电桩次数 | 到充电桩最短距离 | 搜路耗时]
### 如下第二行含义为 sim_02 没有匹配到充电桩
[2025-01-21 15:14:04.098083][D][debug] [sim_02][chargeLength|-1|1|10000000000.000000|0.000213]
[2025-01-21 15:14:04.098083][D][debug] [sim_02][autoCharge|no id.|-1]
## 下发充电任务
## 只要前两个步骤满足，都可以下发
## 停靠任务

## 基于 0.2.0 版本调度的总结
## 下发停靠任务的步骤
## 判断机器人是否满足停靠条件
## 搜索空闲可用的停靠点
## 搜路计算最优停靠点
## 下发订单
## 停靠需满足的条件：
自动停靠参数打开：参数AutoPark，bool 量，true表示允许自动停靠，false表示禁止自动停靠
未处于断联状态：对于日志字段GET.connect，bool 量，1表示连接，0表示断联
有控制权：对应日志字段GET.control，bool 量，1表示调度有机器人的控制权，0表示无控制权
如果未处于充电状态，那么电量必须大于 chargeNeed：
充电状态，对应日志字段GET.is_charging，bool 量，1表示机器人正在充电，0表示机器人未在充电；
电量，对应日志字段GET.battery，double 量，转换为 0-1 之间的数字，比如 0.67 代表有 67 个电
如果处于充电状态，那么电量必须大于 chargedFull：日志字段同上
如果现场开了参数ForbidGoodsPark，即禁止载货停靠，那么必须处于空载状态，载货状态对应日志字段rTopoPos.hasGoods(单背篓车)和 rTopoPos.load_c(料箱车等多背篓车负载数量)
如果是清洁机器人，在水量没有达到脚本阈值前，是不可以停靠的，此处需注意非清洁机器人应确保参数minCleanWater和maxdirtyWater为 -1
## 如果调度系统处于下班状态，不可以停靠
### 用过此时处于用户设置的禁止停靠时间段内，不可以停靠
没有正在执行的订单并且没有预接单：对应日志字段GET.order_state，枚举量，详见下代码块
## {
### 0: Created  // 创建状态，订单刚被创建
  1：Waiting  // 等待状态，指的是机器人完成了当前动作块，订单没有封口，等待后续指令（封口或追加动作块）
### 2：Running  // 运行状态，机器人正在执行任务
  3：Suspend  // 暂停状态，机器人暂停时可能会跳转这个状态
### 4：Finished // 完成状态，机器人完成了当前任务
### 5：Failed   // 失败状态，机器人执行订单失败
### 6：Stopped  // 终止状态，订单被终止
### 7：Error    // 错误状态，目前没有使用
## 8：None     // 初始化使用
  9：TobeDispatched  // 待分配状态，字面意思
  10：Manual_Finished：// 人工完成状态，目前没有使用
## }
当前订单状态为终态（ FINISHED 或 STOPPED ）：查看方式与上述一致
如果机器人已经处于停靠点，就不会停靠；此处有个特例，如果开了AutoMovablePark或MovableParkInPath，即赶车逻辑，在停靠点的车如果挡住了其他车的路线，是会重新停靠的
## 日志排查流程：
### 总体上是按照下发停靠任务的步骤一步步看下去的：
## 查看机器人是否满足停靠条件
搜索日志机器人名称][autoOrderRecord，示例如下：

[250707 171442.750][0x00007686ffe00640][RDSDispatcher][debug] [AMB-1][AutoOrderRecord|"robot has goods, cannot park"|"the power is above the chargeNeed, do not need to charge"|"robot has goods, cannot charge"|"is executing order"|"not in final state: RUNNING"]
[250707 171442.750][0x00007686ffe00640][RDSDispatcher][debug] [AMB-6][AutoOrderRecord|""|"the power is above the chargeNeed, do not need to charge"|"the power is above the chargeOnly"|"unexpected'"|"not in park queue: 869"]
第一项为是否满足停靠条件的输出，其中 1 号车不满足停靠条件，原因是处于载货状态；
### 6 号车输出为 "" 空字符串，含义为满足停靠条件
### 确认机器人满足停靠条件后，查看停靠点匹配结果
### 搜索日志机器人名称][parkLength，示例如下：

[250707 171442.909][0x00007686ffe00640][RDSDispatcher][debug] [AMB-6][parkLength|-1|0|10000000000.000000|0.000005]
[250707 171437.218][0x00007686ffe00640][RDSDispatcher][debug] [AMB-6][autoPark|no id.|-1]
输出信息为-1|0|10000000000.000000|0.000005
第一项 -1 表示没有匹配到停靠点；
第二项 0 表示匹配了 0 次；
### 第三、四项分别表示到最优停靠点的距离及匹配时间，无需关注
这说明所有停靠点都是不可用的，无法进行匹配；
## 查看停靠点资源占用情况
## 停靠点的资源占用一般分为两种：
## 被其他机器人占用：
正则搜索日志nop-c.*停靠点id，比如使用nop-c.*890搜索 PP890 的占用情况
### 如果搜不到表示这个停靠点是空闲的，搜到的一个示例如下：

[250707 171435.893][0x00007686ffe00640][RDSDispatcher][debug] [AMB-8][NoP-C|blockId|pp_list_by_cp|891|r.eid|890|r.sid|891|]
不必关注占用的原因，只需知道这个停靠点已经被 8 号车占用了
## 被禁用
日志搜索dispointpath会输出所有被禁用的点线，示例如下：

[250707 171436.039][0x00007686ffe00640][RDSDispatcher][debug] [disPointPath][PP881|LM928|LM915|PP882|LM913|LM906|LM908||]
