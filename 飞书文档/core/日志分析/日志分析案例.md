# 日志分析案例

## 日志分析案例
## 互斥区死锁
案例1：DS-04与DS-02 死锁,两个灰色区域均为互斥区
## 图片.png

在日志发生时间往下搜索 send|robotname,
## 在这个案例中搜索 send|DS-04
[2024-04-28 02:42:58.941628][D][debug] [DS-04][SEND|DS-04|3066|19206|1|{"move_task_list":[{"dispatcherArgs":{"blockId":"eb5cc975-2640-4a62-b157-66575ddfa2a1","curSection":10,"endP":0.14082523588227006,"startP":0.0,"targetLoc":"DJL-01","totalSection":16},"id":"LM503","operation":"Wait","percentage":0.14082523588227006,"reach_angle":3.141592653589793,"source_id":"LM501","task_id":"68dda3e8-a24d-4077-afe7-d5d51b527d4b"}]}]
3066|19206 表示通过19206端口3066编号报文下发路径导航指令，路径导航从LM501->LM503，线路百分比（"percentage":0.14082523588227006）14%
## 查看任务状态
## 图片.png

发现DS-04被暂停导致资源释放，导致DS-02进入互斥区后死锁
## 原因分析：
## 现场错误操作导致死锁
案例2：左侧Jack-03需要出互斥区，右侧紫色Jack-05需要进入左方互斥区，造成死锁 #7410
问题：预期情况下，jack-05会去互斥区等待点AP58018等待，但实际停在LM58005，下图为仿真重现

### 20240702110309_rec_.gif
## 图片.png

查看最初时刻互斥区占用情况，如下图，可以看出jack-03占用互斥区8108
## 图片.png

## 查看jack-05下发线路
[2024-07-01 16:43:28.336019][D][debug] [jack-05][SEND|jack-05|3066|19206|1|{"move_task_list":[{"dispatcherArgs":{"blockId":"5f1cad7a-7bf9-4bb3-84b3-ae75a6955440","curSection":1,"endP":0.09225092250922513,"startP":0.0,"targetLoc":"TEMP-04","totalSection":48},"id":"LM58106","operation":"Wait","percentage":0.09225092250922513,"reach_angle":3.141592653589793,"source_id":"LM58005","task_id":"edaab3a5-d8ba-4bce-93bd-cab76f6b6ffb"}]}]
下发给jack-05的线路为LM58005->LM58016, 线路百分比9%
## 查看下一时刻下发路线
## 图片.png

[2024-07-01 16:43:56.823165][D][debug] [jack-03][SEND|jack-03|3066|19206|1|{"move_task_list":[{"dispatcherArgs":{"blockId":"PPfcb8c98e-405d-4d8b-a529-bac40d4af286","curSection":11,"endP":1.0,"startP":0.0,"targetLoc":"PP563","totalSection":50},"id":"LM58106","operation":"Wait","percentage":1.0,"reach_angle":3.141592653589793,"source_id":"LM58104","task_id":"8fb4c85e-9e85-4b6e-8b08-69f8524f9b31"}]}]
...
[2024-07-01 16:43:59.211805][D][debug] [jack-05][tmpts|58005|58106|0.092251|1.000000|false]
[2024-07-01 16:43:59.211805][D][debug] [jack-05][checkCollision|-10.904514|27.589000|3.141593|-11.764167|27.589000|-0.000000|true|jack-03|0.103139|0.177102|false]
[2024-07-01 16:43:59.211805][D][debug] [jack-05][shape|[(0.440,0.299),(0.440,-0.299),(-0.440,-0.299),(-0.440,0.299),]|[(0.420,0.280),(0.420,-0.280),(-0.380,-0.280),(-0.380,0.280),]]
[2024-07-01 16:43:59.211805][D][debug] [jack-05][collisionTask|58005|58106|0.000|1|58005|58106|0.000|1|-1|-1|1.000|0]
[2024-07-01 16:43:59.211805][D][debug] [jack-05][runCollision|0|17|true|jack-03|0]
[2024-07-01 16:43:59.222776][D][debug] [jack-03][SEND|jack-03|3066|19206|1|{"move_task_list":[{"dispatcherArgs":{"blockId":"PPfcb8c98e-405d-4d8b-a529-bac40d4af286","curSection":12,"endP":0.4612546125461256,"startP":0.0,"targetLoc":"PP563","totalSection":50},"id":"LM58005","operation":"Wait","percentage":0.4612546125461256,"reach_angle":3.141592653589793,"source_id":"LM58106","task_id":"b6e6ecb9-a1a6-4380-8ac7-a672d26ff24e"}]}]

## 可以看出
jack-03路径发至LM58104，
jack-05检测到与jack-03碰撞 [jack-05][runCollision|0|17|true|jack-03|0]
jack-03下发至线路LM58106->LM58005,百分比为46%
## 原因分析：
从日志上看jack-05就没有下发去AP58018的路线，原因如下
### 可能是jack-05当前情况下无法到达AP58018
## 调度的bug，没有规划去等待点等待
实际情况jack-05在LM58106会占用互斥区，导致无法到达AP58018，系地图问题，需要修改, 如果waitpoint没有在最短路径上,waitpoint不会生效
### 案例3：机器人去往非任务下发点  #7414
根据现场提供信息，通过运单号202407010000000000000003，在日志中搜索，找到运单
 [2024-07-01 17:09:32.384137][D][debug] [AGV-123][robotOrderStatus|30|0|1|6|0|{"additionalProperties":{},"blocks":[{"binArea":"","binTask":"QHSB","blockId":"77241ebe-2b81-4cce-bcd5-2763dfe4206e","containerName":"","goodsId":"","location":"INAOIP80C0014","manuallyFinished":false,"operation":"Script","operation_args":{},"postAction":{},"preBinTask":"","robotMotionProfile":null,"script_args":{},"script_name":"","state":"FINISHED"},{"binArea":"","binTask":"TZ","blockId":"1331670a-1499-4130-9103-a4c62aae97c2","containerName":"","goodsId":"","location":"INAOIP80C0014","manuallyFinished":false,"operation":"GoPGV","operation_args":{},"postAction":{},"preBinTask":"","robotMotionProfile":null,"script_args":{},"script_name":"","state":"FINISHED"},{"binArea":"","binTask":"","blockId":"5768578c-8a55-46dd-a1a5-b54515fe8ef0","containerName":"","goodsId":"120007","location":"INAOIP80C0014","manuallyFinished":false,"operation":"JackLoad","operation_args":{},"postAction":{},"preBinTask":"","robotMotionProfile":null,"script_args":{},"script_name":"","state":"FINISHED"},{"binArea":"","binTask":"FH","blockId":"89cb2468-c31e-40e4-9c62-16e84e1cfce4","containerName":"","goodsId":"","location":"AOI15P80SB02","manuallyFinished":false,"operation":"JackUnload","operation_args":{},"postAction":{},"preBinTask":"","robotMotionProfile":null,"script_args":{},"script_name":"","state":"STOPPED"}],"candidateName":"","complete":true,"createTime":1719823698,"error":"[]","errors":[],"executionTimeCost":0,"externalId":"202407010000000000000003","finishOdo":5082.212,"group":"F3-A1","id":"b50b7fe6-4c74-482a-bf4e-0c9c94a45dbb","isReassignable":false,"joinable":false,"keyGoodsId":"","keyRoute":["INAOIP80C0014"],"keyTask":"","label":"","mapfPriority":0,"msg":"","notices":[],"orderMinScore":0.0,"orderOdo":14.160000000000764,"orderScore":0.0,"prePointRedo":false,"priority":1,"reassignLog":"","receiveTime":1719821705,"startOdo":5068.052,"state":"STOPPED","terminalTime":1719824771,"terminateTime":1719824771,"type":0,"vehicle":"AGV-123","warnings":[]}]
可以看出分配的机器人是AGV-123    （"vehicle":"AGV-123"）
## 在这个运单执行时刻，找到机器人位置
## 图片.png

## 查看机器人当前运单
## 图片.png

## 搜索点位AOI15P80SB02
## 图片.png

发现库位位置在AP2745上方，实际绑定的点位是AP2740
## 原因分析：
库位的逻辑位置与绑定点位一致，通过地图错误判断库位在AP2745，误以为走错点位

### 案例4：两车路口死锁   #7342（GMAPF）
## 图片.png

## 查看两车连接状况，控制权，报错

[2024-06-26 04:33:02.007415][D][debug] [VWEDCC02][planMinPath|129|127|0.133803|68.590362|-1.000000|0|129|127|125|123|65|66|68|70|233|232|235|72|189|191|193|179|177|181|180|182|176|178|222|236||false]
[2024-06-26 04:33:02.007415][D][debug] [GM][VWEDCC02|A* Plan|22|49.830000|125-123-65-66-68-70-233-232-235-72-189-191-193-179-177-181-180-182-176-178-222-236-]
[2024-06-26 04:33:02.007415][R][debug] [VWEDCC03][AStarCost|0.030000|0|113.801420|true|192|190|0.851893|8|1.567439|false]
[2024-06-26 04:33:02.007415][D][debug] [VWEDCC03][planMinPath|192|190|0.851893|113.801420|-1.000000|0|192|190|74|73|71|243|69|67|65|63|61|59|57|55|53|51|49|47|45|43|41|39|24|23|22|29|219|220|216|8||false]
[2024-06-26 04:33:02.009414][D][debug] [GM][VWEDCC02|res path|125-123-65-66-68-]
[2024-06-26 04:33:02.009414][D][debug] [GM][VWEDCC03|res path|69-67-65-63-61-]
搜索GMAPF下发路线,日志中搜索 [vwedcc-02][constpath
### 日志中没有搜到，说明GMAPF没有下发路线
查看GMAPF的一个规划周期，日志中搜索MAPF online
[2024-06-26 04:34:55.964574][D][debug] [GM][MAPF online|EX.12.0|Jun 13 2024|17:31:17|false|false|1986978]
...
[2024-06-26 04:34:55.965558][D][debug] [GM][VWEDCC02|A* Plan|21|44.830000|123-65-66-68-70-233-232-235-72-189-191-193-179-177-181-180-182-176-178-222-236-]
...
[2024-06-26 04:34:55.965558][D][debug] [GM][VWEDCC03|A* Plan|24|95.990005|69-67-65-63-61-59-57-55-53-51-49-47-45-43-41-39-24-23-22-29-219-220-216-8-]
[2024-06-26 04:34:55.966554][D][debug] [KL][3659|pair|VWEDCC02|VWEDCC03|4507|conflict]
A* 搜出的路线 VWEDCC02： A* Plan|21|44.830000|123-65-66-68-70-233-232-235-72-189-191-193-
A* 搜出的路线 VWEDCC03： A* Plan|24|95.990005|69-67-65-63-61-59-57-55-53-51-49-47-45-43-41-39-24-23-22-29-219-220-216-8-]
[2024-06-26 04:34:55.967555][D][debug] [GM][VWEDCC02|res_path|4|69.830000|false|44.830000|::|123-65-66-68-70-233-232-]
[2024-06-26 04:34:55.967555][D][debug] [GM][VWEDCC03|res_path|3|120.990005|false|95.990005|::|69-69-67-65-63-61-59-]
求解器求出来的路线VWEDCC02: res_path|4|69.830000|false|44.830000|::|123-65-66-68-70-233-232-]
## 查看是否有其他冲突
[2024-06-26 04:34:55.967555][D][debug] [RDSCollisionCheck][true|VWEDCC02|66|68|-1.570796|-0.000000|VWEDCC03|69|67|-3.131583|-3.141593]
## 02和03检测到碰撞

### 案例5：车突然绕路 #7334 （mapf）

### 20240702160116_rec_.gif
## 图片.png

搜索下发路线 setPath.path，查看是否规划出绕路并定位到绕路时刻，下图所示确实规划出绕路
## 图片.png

### 在此时刻在日志搜索 [FC-1-3][setPath
...
[240626 110842.469][D][d] [FC-1-3][setPath|4|19096-19097-19046-19047]
## 从日志往上查找 A*规划路线
[240626 110842.468][D][d] [GM][FC-1-3|A* Plan|4|6.021000|19096-19097-19046-1835-]
## 往下查看日志
[240626 110842.469][D][d] [GM][FC-1-3|T. replan|6.021000|13.563357|:|19096|19097|19046|19047|19045|1865|1837|1835|]
T. replan表示重归划，触发重规划这个逻辑和参数配置有关，GMAPF重规划参数G-MAPF-Recover
查看参数发现G-MAPF-Recover打开，并且延时设置为1，即一个调度周期就触发重规划，一个周期时长0.1~0.3s。在被阻挡时几乎立刻重规划
## 图片.png

## 原因分析：
## 重规划参数设置的不对导致绕路

案例6：机器人处于running状态下不动，两车均向右行驶 （GMAPF）
## 图片.png

### 查看机器人是否不占用资源 dispatchable
## 图片.png

## 查看下发线路，日志中搜索setpath
[2024-06-25 16:58:53.153979][D][debug] [jack-03][setPath|2|144-533]
从中可以看出两个问题，一是为什么没有检测到冲突，二是为什么下发冲突线路
### 往上看日志，发现没有jack-01和jack-03的冲突
[2024-06-25 16:58:53.150986][D][debug] [KL][3679|pair|jack-01|link-01|4437|conflict]
[2024-06-25 16:58:53.150986][D][debug] [KL][3679|pair|link-01|link-05|4437|conflict]
[2024-06-25 16:58:53.150986][D][debug] [KL][3679|pair|jack-01|link-05|4437|conflict]
### 查看A*下发线路是否真的没有冲突，往上看日志
[2024-06-25 16:58:53.147994][D][debug] [GM][jack-01|A* Plan|12|40.118347|533-154-9301-145-797-146-926-30-9304-31-597-584-]
[2024-06-25 16:58:53.148992][D][debug] [GM][jack-03|A* Plan|14|87.221592|144-533-154-9301-145-797-146-593-612-594-596-575-678-677-]
发现jack-01 和 jack-03 存在冲突533-154，144-533-154-，是算法没有检测出来
## 查看版本发布说明，是否有改动
## 原因分析：
## 冲突检测算法问题
### 案例7：充电任务没有被正确中断 #7182
查看orderstatus（2表示running，4表示finished，3表示suspend，6表示stop）
可以看到运单状态一直都是running，无法判断是否有中断充电任务（充电任务被中断状态是在一个周期内变化的，不能看到状态跳变）
## 图片.png

在日志中搜索[dzcBox2][stopCharge(中断停靠搜索stoppark)
[2024-06-25 14:59:10.805843][D][debug] [dzcBox2][stopChargeNeed]
## 充电任务被终止了
## 查看已下发路线
## 图片.png

## 已经下发到终点CP1345
## 原因分析：
### 调度会执行完已经下发的线路再查看订单状态是否改变
## 案例8：2，3号车不动  #7290
## 图片.png

## 查看机器人运单状态
## 图片.png

### 发现2，3号车都处于状态1waiting中，追加新的动作块
## 原因分析：
## 上位系统没有及时下发任务
## 案例9：两车不动（GMAPF）
## 图片.png

## 1.搜索setPath.path,定位到不动的时刻
## 图片.png

### 在此时刻从日志往上搜索conflict，检测是否有冲突
## 没有查到任何结果
继续往上搜索，[AMB-01|res path，检查下发解路线
[2024-06-19 17:08:33.479491][D][debug] [GM][AMB-01|res path|0|32.865007|false|7.865007|::|1-]
### 继续往上搜索slove complete
[2024-06-19 17:08:33.276057][D][debug] [GM][MAPFSolver|solve completely|227|155|155|0.000539|0.146814|1800|0|1.000000|2|1]
[2024-06-19 17:08:33.276057][D][debug] [GM][MAPFSolver|AGV-02|]
[2024-06-19 17:08:33.276057][D][debug] [GM][MAPFSolver|AGV-02|2064-]
[2024-06-19 17:08:33.276057][D][debug] [GM][MAPFSolver|AMB-01|]
[2024-06-19 17:08:33.276057][D][debug] [GM][MAPFSolver|AMB-01|1-]
[2024-06-19 17:08:33.276057][D][debug] [GM][MAPFSolver|convergence|0.953976]
可以看出求解路线为空[GM][MAPFSolver|AGV-02|2064-]、[GM][MAPFSolver|AMB-01|1-]
## 原因分析：
## GMAPF求解器没有求出解
### 案例10：机器人发完线路不动 #7207
## 图片.png

查看order_state, Tcost, SendRetry  （运单状态，调度周期，重发次数)
## 图片.png

### 运单状态无变化，调度周期正常无卡顿，有重发次数
### 2.查看connect 连接状态
## 图片.png

## 存在断连
## 原因分析：
## 网络连接问题
案例11：RIL-L-8229,RIL-L-8224两车死锁  井智 #311
## 图片.png

## 图片.png

查看下发线路 send.task_list_size (下发线路段数量)
## 图片.png

发现两车没有再下发任何线路，因为存在互斥组被RIL-L-8224占用，RIL-L-8229无法下发线路是合理的
### 从图中可以看出两车过近，需要查看是否检测到碰撞
### 当前时刻从日志往上查看checkCollision
[240612 230701.949][D][d] [RIL-L-8224][RotateCollision|1.570796|3.129522|RIL-L-8229|0.000000|3.134268]
[240612 230701.949][D][d] [RIL-L-8224][checkCollision|115.807000|3.184000|3.129522|117.230476|3.173573|3.134268|true|RIL-L-8229|0.000000|0.235070|true]
[240612 230701.949][D][d] [RIL-L-8224][shape|[(0.650,0.515),(0.650,-0.515),(-0.650,-0.515),(-0.650,0.515),]|[(0.650,0.515),(0.650,-0.515),(-0.650,-0.515),(-0.650,0.515),]]
[240612 230701.949][D][d] [RIL-L-8224][runCollision|0|16|true|RIL-L-8229|0]
## 图片.png

## 发现有碰撞
## 原因分析：
## 图片.png

stopsafeDist参数设置的不合理导致RIL-L-8229停靠的离互斥区太近太近，导致RIL-L-8224旋转时检测到碰撞
## RHCR相关
## RHCR发了路线车不动
## 观察Core停止给车发路线的时间
## image.png

## 观察停止发路线的时间点是否出现了报错
## image.png

### 如果报错结束后还是不动，观察outlist是否一直为空
## image.png

## outlist为空的可能原因：
## 门、电梯状态异常，暂停了
### 碰撞检测发现了异常，清空了outlist
## 通过日志文件排查门、电梯状态
## 通过日志文件排查外部碰撞检测问题
## 搜索SetError|52106
## 定位到：
[250425 181506.434][0x0000140c][RDSDispatcher][debug] [CDD14-02][SetError|52106| blocked by CDD14-01 in 1439-495]
## 以及更早的
[250425 181459.701][0x0000140c][RDSDispatcher][debug] [CDD14-02][RotateCollision|-0.083046|1.570705|CDD14-01|0.000000|1.570796]
[250425 181459.701][0x0000140c][RDSDispatcher][debug] [CDD14-02][reInit]
查找对应代码，发现是错误的碰撞检测，触发了ErrorRelease参数控制的逻辑，清除了任务，关闭选项可以临时解决。
