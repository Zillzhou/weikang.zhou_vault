# 常见问题日志分析方法

## 常见问题日志分析方法
## 如何查看一些基本信息
## 主要在日志分析器中的两个字段查看
## GET
## 连接状态信息
## 控制权信息
## 地图信息
## 电量信息
## 订单状态
## 接单信息
## image.png
## 连接状态 控制权 订单状态

## rTopoPos
## 位置信息
## 速度信息
## 导航任务执行信息
## 报错信息
## 载货信息
## image.png
## 载货状态 报错 x位置

## 如何在日志中查看机器人的时间
Rbk 的时间和 调度的时间很多时候并不是相同的，可以在 internalMsg 字段中查看两者
## image.png
## t 表示调度时间
## timestamp 表示 rbk 时间

## 如何排查多台机器人死锁问题
为方便大家理解调度系统对于多机器人无死锁规划的思路，我们可以将交管简化为下述模型

从上可知，图中任何一个步骤出现问题都会导致机器人不动，下面就通过一个个案例来分析下每个模块导致机器人不动死锁
### 案例 1：因交管算法没有收到机器人订单而导致的死锁
## coding 链接
coding 原始问题描述：小车在四楼不动，时间 14:45
### 按上述的分析流程，先查看机器人有没有收到订单
## image.png
### 在 GET.order_state 字段查看机器人订单状态

由上图可见，在 14:45 前后，机器人订单状态是 1，对应 waiting 状态，这表明上位系统没有及时为机器人下发新的动作块，交管自然也就没有收到新的目的地，机器人也就不会动
### 至此，问题找到，后续需要交由上位系统排查
### 案例 2：因交管算法没有规划出路线而导致的死锁
## coding 链接
Coding 问题描述：AGV125 任务号：202407190000000000000112 小车运行中无报错静止；时间：18.46分；点位：lm2112，小车运行中静止
先按照描述找到对应时间，看看调度里的信息和现场提供的是否一致
## image.png
### 在 robotOrderStatus 中查看订单信息

信息一致，说明，交管算法收到了订单，接下来看是否规划出路线，查看下发路线信息
## image.png
## send 字段为调度给机器人下发的路线
### setpath 字段 为 mapf 下发的路线

由此可见，交管算法没有下发路线，排查至此处，我们已经可以确认出问题的模块，目前的现象是交管算法没有再给出路线了，那么问题大概率是交管算法部分
### 后面再精细的排查需要打开日志，查看 mapf 地方的输出
## image.png

### 因为是检测到 和 116 号车冲突，查看下 116 车状态
## image.png

如上图所示，为无控制权切占用资源状态，位置挡住了其他机器人行驶路线，至此找到问题，无控制权机器人占据的资源挡住了其他机器人行驶路线，需要将其设置为不占资源状态
### 案例 3：因碰撞检测检测到碰撞而导致的死锁
/* 暂时没有找到示例 coding，碰撞检测模块最近比较坚挺 */
### 案例 4：因机器人出现激光阻挡而导致的死锁
## coding 链接
Coding 问题描述：小车在收到任务顶升货物后静止不动，附加了图片显示库位是 P12022
## 先看订单信息能否对得上描述
## image.png

### 订单没问题，描述正确，接下来看交管有没有规划出路线并下发
## image.png

由上图可知，调度规划并下发了正确的导航指令，接下来查看机器人是否执行这个路线的状态并查看有否报错
## image.png

由上图可知，是因为机器人执行导航指令时激光阻挡导致无法行动，后续需要 rbk 处理
## 如何排查调度的货叉调整策略问题
## 什么是货叉调整策略
用于管控叉车，空载运行和载货运行时的货叉高度，同时控制停下来调整还是边走边调整
## image.png
## 配置在机器人组的属性里

### cargoSafeHeight：载货时的货叉安全高度
### idlerSafeHeight：空载时的货叉安全高度
cargoStopToAdjuctHeight：载货时停下来调整（true）/ 边走边调整（false）
idlerStopToAdjuctHeight：空载时停下来调整（true）/ 边走边调整（false）
## 调度如何控制机器人调整货叉高度
### 通过在给机器人下发导航指令时添加货叉高度字段实现
## image.png
此导航指令含义为 机器人 TBR4-2 从 LM521 走到 LM520，边走边调整货叉高度至 0.4m
Tips：fork_mid_height 表示边走边调整；如果是 end_height 字段则表示到点停下来再调整

## 排查思路
### 先确认是哪台车在什么时间在哪个库位处的货叉抬升动作不合理
哪个库位处异常是一个很重要的信息，因为调度是不知道叉车插齿高度信息的，所以这个信息如果没有几乎无法定位问题
### 查看调度下发的去抬升不合理点位的导航任务
如果调度下发了对的抬升指令，那么问题就是 rbk 为什么没有执行
### 如果调度没有下发或者下发的抬升指令，则为调度问题
## 调度在以下情况不会下发货叉调整指令
### 当前 block 的第一段线路不会下发，安全考虑
当前 block 最后一段线路不会下发，很可能是库位处，抬升货叉存在安全风险
## 案例
## coding 链接
现场描述 9:57 时刻，机器人在 LM586 没有下降货叉
查看下发去 LM586 的导航任务，如下图，可以看到报文中 operation 为 ForkHeight，并且 fork_mid_height 为 0.4，符合预期下发指令，所以需要 rbk 进一步排查
## image.png

### 如何排查 removeFirstPoint 逻辑问题
## 问题释义
什么是 removeFirstPoint 逻辑？简单来说，就是机器人在多条重叠路线上的路线选择问题。
## 我们以下图为例来阐述：
img_v3_02e4_d8a36316-a96e-4f61-8d02-b9b0abccaeeg.jpg

当机器人位于 CP81，车头朝上（机器人朝向 1.57），目标点为 PP108 时，存在两种路线选择：
如果认为机器人此时位于 LM80--CP81 线路上，路线为 81-80-108：
## 倒走到 LM80
## 原地旋转 180°
## 倒走到 PP108
如果认为机器人此时位于 LM80--PP108 线路上，路线为 80-108：
## 原地旋转 180°
## 倒走到 PP108

此处读者可能会有疑惑，机器人的拓扑位置在调度系统中应该是确定的，为什么会出现不确定机器人位于 LM80-CP81 还是 LM80-PP108 的情况呢？
### 我们可以思考，调度系统如何确定机器人的拓扑位置？
如果调度系统给机器人发送了路线 1-2-3，并拆分为了下面两段任务
{source_id: 1, id: 2} {source_id: 2, id: 3}
那么只需要确认机器人在执行哪段任务就可以确认机器人的拓扑位置
## 如此便存在两种情况打破常规逻辑：
机器人没有办法准确上报在执行哪段任务或者就没有在执行任务（最简单的例子机器人刚开机）
用户不允许采用正确的拓扑逻辑，我们结合上图详解下用户为什么不接受正确的拓扑逻辑
假设存在前置任务 "机器人从 PP108 去目标点 CP81"，那么执行此任务的路线为 108-80-81
根据上述判断拓扑位置的逻辑，在机器人完成任务时，调度可以明确知道其位于 80-81 路线上
此时机器人需要返回 PP108，搜路结果必定为 81-80-108，一切看起来很合理
但是如果真的这么走，机器人就需要先退到 80，再去 108，在用户看来，这是一个很不合理的行为，因为机器人明明可以直接退到 108
此时便需使用 removeFirstPoint 逻辑，如果机器人和一条路线很近，可以直接走，就不需要先退出去，也就是将路线的第一个点位删除，路线从 81-80-108 变为 80-108

## 问题现象
从上面的问题释义也可以推测出，涉及此逻辑的现场问题可分为两种现象阐述
机器人应该先退出去再进来，但是却原地旋转了（空间不允许），也就是不合理的 removeFirstPoint
机器人应该直接走，但是却先退出去（如果退出去的点很近很近，观感则是机器人停顿了一下），也就是没有触发 removeFirstPoint
## 问题排查
此类问题排查方式较简单，只需在日志中搜索removeFirstPoint字段，查看输出信息即可知道问题原因
## 依旧以上图为例，日志查询如下图所示
## image.png

可以发现紧挨着出现两个removeFirstPoint输出，大部分情况下第二个是控制此逻辑的，我们也仅以第二处输出为例阐述各字段含义
[2024-08-26 10:22:29.711687][D][debug] [CBD16-S][removeFirstPoint|1|80|108|0.005|0.000|1.571|-7.541|6.342|77|-7.541|6.337|0.100]

## 位数

## 日志中对应值

## 含义

## 1

## 1

最终是否删除了路线第一个点位，1 表示删除了，0 表示未删除

## 2

## 80

经过此逻辑操作后的路线的第一个点位，完整的路线可以在紧挨着的日志 nextpath 中看到

## 3

## 108

经过此逻辑操作后的路线的第二个点位，完整的路线可以在紧挨着的日志 nextpath 中看到

## 4

### 0.005

机器人到判断是否可以直接走的路线（此实例中为路线 80-108）最近的距离 m

## 5

### 0.000

机器人朝向与 80-108 线路上和机器人最近的点处的切线方向的绝对差值

## 6

## 1.571

### 线路 80-108 上距离机器人最近的点的切线角度

## 7

## -7.541

## 机器人坐标 x

## 8

### 6.342

## 机器人坐标 y

## 9

## 77

线路上距离机器人最近的点在线路上的索引值（内部定义结构，可以不关注）

## 10

## -7.541

## 线路上距离机器人最近的点的坐标 x

## 11

### 6.337

## 线路上距离机器人最近的点的坐标 y

## 12

### 0.100

允许机器人与线路 80-108 的最大距离阈值，参数 RemoveFirstPointDist 控制 m

## 判断可以删除路线第一个点位的条件是：
机器人距离下一条线路距离在参数 RemoveFirstPointDist 内且机器人朝向和线路在 5deg 内
### 只需按照上面日志输出比对实际路线即可确认原因，此案例分析：
日志中输出，机器人距离线路 80-108 距离为 0.005m，参数 RemoveFirstPointDist 为 0.1m，满足条件，实际上机器人位置和线路也符合计算结果，此条件没问题
日志中输出机器人朝向和线路偏差为 0°，但是实际上机器人朝上（1.57），线路是倒走朝向为 -1.57，偏差应该为 3.14，而不是 0，此条件有问题，进一步分析：
日志中输出机器人朝向为 1.57，这行日志没有此字段输出，需要在 rTopoPos 中查看，与实际一致
日志中输出线路朝向为 1.571，与实际不符，问题在此处，说明代码此处没有考虑路线正倒走，问题找到

## 如何排查动作块完成状态回调问题
## 问题释义
动作块完成状态回调指的是，当动作块状态改变时，向指定服务器发送一条状态变化信息，详细的阐述及使用文档见动作块状态变化回调
## 问题现象
## 现场常见的咨询问题为以下几种
## 如何使用、配置
### 为什么我按要求配置后还是没有接到上报信息
## 上报信息与预期不符
## 排查步骤
对于使用问题，主要还是参考 动作块状态变化回调 文档内给出的配置步骤，按序查看现场配置是否正确，基础的的可能有单词拼写错误、存在中文符号、没有勾选启用设备等

### 如何在 roboshop 中显示日志中配置的回调策略
### 解压日志文件、进入 models 文件夹
文件夹内可能存在多个 .model 文件，用户每修改一次并推送模型文件，都会在此文件夹下保留旧的配置文件，最新的配置文件名称为 robot.model
将 robot.model 文件拖至 robohsop 设备配置（旧版本名称为模型文件）窗口即可自动加载
## 下面附视频演示

## roboshop显示配置文件.mp4
对于没有上报信息和上报信息不符合预期问题，在日志中查看调度有没有上报信息比较容易，排查上报信息为什么不符合用户预期就比较困难，因为涉及状态跳转的状态机，此处只介绍如何在日志中查看上报信息

### 如何在日志中查看调度上报的动作块状态变化信息
需要现场提供订单号或动作块 id 信息，这样才能查动作块状态变化时的状态变化信息
## 下面给出一条示例日志：
[240825 095107.755][D][i] [PushHttp][BlockStateChange|1724550667|{"binArea":"","binTask":"ForkUnload","blockId":"6128B8D4-EA95-4A20-BB80-E2446DA87E39","containerName":"","goodsId":"","group":"","location":"RK-01","manuallyFinished":false,"operation":"ForkUnload","operation_args":{},"orderId":"YD2024082300045","postAction":{},"preBinTask":"","robotMotionProfile":null,"script_args":{},"script_name":"","state":"RUNNING","vehicle":"AMB-01"}]
## 其中 1724550667 为时间戳
## 后面是上报内容的报文
可以搜索关键字 pushhttp 搜索相关日志，如果需要搜索指定订单/动作块号的上报信息，可以使用正则表达式，如下图所示：
## image.png

如果排查的是订单状态上报信息是否正确，可以继续在正则表达式添加状态字段，这样标红方便查看，如下图：
## image.png

## 如何快速定位到问题描述时刻
一般来说，定位到一个问题在日志中的位置需要机器人名称、问题时间、问题发生位置信息；但是现场往往不能完整提供这些信息，如何从有限的信息快速定位到问题对排查效率有很大影响，在此事项分享一个快速定位问题的方式
## 以工单链接为例，问题描述为：

现场小车运行过程中在提升机呼梯点播报语音TSJDD，动作块一直不能结束
运单ID:2370953e-1220-48e0-81bf-4f98752c0953
打开日志发现有 9 个日志文件，我们肯定希望拖动尽可能少的日志去分析问题，这就需要定位发生问题对应的日志
## image.png

使用 git bash 终端在日志文件夹查找运单 id 出现的文件
grep -r -i -c '2370953e-1220-48e0-81bf-4f98752c0953' 
## // -r 递归查询
## // -i 忽略大小写
### // -c 统计查询对象在每个文件出现次数
## image.png

### 这样我们就找到了我们需要查看的 3 个日志，拖入日志分析器
