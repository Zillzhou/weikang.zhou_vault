# 清扫运单

## 清扫运单
## @丁禹伯
## 最低版本：0.1.9.230816
## 清扫运单是什么
清扫运单是针对清扫机器人执行清扫任务开发的一种订单，用户按照指定格式下发清扫运单后，RDSCore 会处理清扫机器人的清扫、换水、继续清扫等行为
## 运单格式
采用 /setOrder API 下发运单，含有字段 workArea 的订单视为清扫订单，详见 创建运单
下面给出了一个最简单的 cleanOrder 示例，目前下单时必须指定运单号、机器人名称和清扫区域名称，不可缺省
## {
### "id": "seer-12345",   // 运单号
  "vehicle": "sim_01",  // 机器人名称
  "workArea": "12"      // 清扫区域名称
## }
workArea 为清扫区域名称，在调度界面和 smap 里分别如下图所示：
1692234291815-0f7919e0-0273-45ef-a1e7-6b5a108241c3.png 

1692234331783-09ecdad0-80aa-4987-b6b3-33dc01aecfc4.png

## 处理流程
1692259229445-5be1db25-c406-4bba-b2b9-b2f1ece0b330.jpeg

## 检查订单格式
调度收到通过 API 下发的清扫运单时，会对以下条件进行检查：
若不包含workArea字段，不视作清扫任务，不下发清扫任务
### 若vehicle没有指定清扫机器人， 不下发清扫任务
若workArea没有相应的起始点终止点，不下发清扫任务，API 响应会报错
若workArea起始点终止点没有绑定库位或绑定了多个库位，不会下发清扫任务，API 响应会报错
若workArea起始点或终止点库位动作设置错误，不会下发清扫任务，API 响应会报错
## 设置清扫机器人执行脚本名称
支持使用调度模型文件配置清扫机器人使用的脚本名称，脚本主要用于处理机器人的开始、停止、结束清扫，开始、结束换水、关闭电机等动作

## 参数名称

## 参数类型

## 参数默认值

## 参数含义

## scriptname

## string

## clean_robot.py

## 清扫机器人使用的脚本名称

## autoChangeWater

## bool

## true

## 是否开启自动换水功能
1697006021081-9281f048-7822-4a0e-b490-d88ae72ff0ee.png

## 查询清扫运单的状态
## 查询单个订单
查询接口 ： http://ip:8088/sweepOrderDetails/{order_id}
## ip ： 服务器 ip
## order_id ：清扫运单 id
## 查询示例 ：
http://127.0.0.1:8088/sweepOrderDetails/seer-1008611
## 响应值：

## 字段名称

## 字段类型

## 字段含义

## changeWaterId

## string

## 换水订单 id

## changeWaterOrder

## object

## 换水订单详细信息
## null 表示此清扫运单没有换水订单

## cleanOrder

## object

## 清扫子订单详细信息

## id

## string

## 清扫订单 id

## receiveTime

## int

## 订单接收时间

## recleanOrder

## object

## 结束换水继续清扫运单详细信息

## recleanOrderId

## string

## 结束换水继续清扫运单 id

## state

## string

## 清扫订单状态，详见
## 运单和动作块状态

## vehicle

## string

## 执行订单机器人名称

## workArea

## string

## 清扫区域名称
## 响应示例：
## {
    "changeWaterId": "",
    "changeWaterOrder": null,
## "cleanOrder": {
        "additionalProperties": {},
## "blocks": [
## {
                "binArea": "",
                "binTask": "START_CLEAN",
                "blockId": "4af78dc8-7ec9-4e61-baa8-f20d3770f676",
                "containerName": "",
                "goodsId": "",
                "location": "2F-R",
                "manuallyFinished": false,
                "operation": "Script",
                "operation_args": {},
                "postAction": {},
                "robotSpeed": -1.0,
                "script_args": {},
                "script_name": "",
## "state": "FINISHED"
            },
## {
                "binArea": "",
                "binTask": "STOP_CLEAN",
                "blockId": "dcaa185e-ba53-49ea-bf14-fa33a754ea3a",
                "containerName": "",
                "goodsId": "",
                "location": "2F-R-END",
                "manuallyFinished": false,
                "operation": "Script",
                "operation_args": {},
                "postAction": {},
                "robotSpeed": -1.0,
                "script_args": {},
                "script_name": "",
## "state": "FINISHED"
## }
        ],
        "candidateName": "",
        "complete": true,
        "createTime": 1696990430,
        "error": "[]",
        "errors": [],
        "executionTimeCost": 150,
        "externalId": "",
        "finishOdo": 139.905713,
        "group": "",
        "id": "67e36b6f-3d9f-4b18-89c8-157651a84bee",
        "joinable": false,
        "label": "",
        "mapfPriority": 0,
        "msg": "",
        "notices": [],
        "orderMinScore": 0.0,
        "orderOdo": 137.303713,
        "orderScore": 0.0,
        "prePointRedo": false,
        "priority": 0,
        "receiveTime": 1696990430,
        "startOdo": 2.602,
        "state": "FINISHED",
        "terminalTime": 1696990580,
        "terminateTime": 1696990580,
        "type": 0,
        "vehicle": "SCL-AWG50-HMI",
## "warnings": []
    },
    "createTime": 0,
    "externalId": "",
    "group": "",
    "id": "seer-1008611",
    "label": "",
    "priority": 0,
    "receiveTime": 1696990430,
    "recleanOrder": null,
    "recleanOrderId": "",
    "state": "FINISHED",
    "terminateTime": 0,
    "transferOrderId": "",
    "vehicle": "SCL-AWG50-HMI",
## "workArea": "17"
## }
## 分页查询订单
查询接口 ： http://ip:8088/sweepOrders
## ip ： 服务器 ip
请求参数： page size orderBy orderMethod where

## Name

## Type

## Description

## Required

## page

## number

## 页码数，如果不传默认为1

## 否

## size

## number

## 每页运单数量，如果不传默认为20

## 否

## orderBy

## string

排序的字段，可以为运单信息中的任意字段，默认为 createTime

## 否

## orderMethod

## string

排序方法，可以为  descending  和  ascending ，默认为  descending  降序

## 否

## where

## object string

过滤条件，为 JSON 字符串，不传时不做过滤，详情见 过滤条件

## 否
## 更多过滤方法详见 分页查询运单信息
## 查询示例 ：
http://127.0.0.1/8088/sweepOrders
## 响应值：

## 字段名称

## 字段类型

## 字段含义

## list

## object array

## 运单数组

## page

## int

## 页面数

## size

## int

## 每页运单数量

## total

## int

## 运单总数
## 响应示例：
## {
## "list": [
## {
            "changeWaterId": "",
## "cleanOrder": {
                "additionalProperties": {},
## "blocks": [
## {
                        "binArea": "",
                        "binTask": "START_CLEAN",
                        "blockId": "2ebe0025-63d3-4ec7-99a6-856bfa44dd75",
                        "containerName": "",
                        "goodsId": "",
                        "location": "2F-R",
                        "manuallyFinished": false,
                        "operation": "Script",
                        "operation_args": {},
                        "postAction": {},
                        "robotSpeed": -1.0,
                        "script_args": {},
                        "script_name": "",
## "state": "FINISHED"
                    },
## {
                        "binArea": "",
                        "binTask": "STOP_CLEAN",
                        "blockId": "9f65414c-b200-48a8-9b52-fc33757d8f18",
                        "containerName": "",
                        "goodsId": "",
                        "location": "2F-R-END",
                        "manuallyFinished": false,
                        "operation": "Script",
                        "operation_args": {},
                        "postAction": {},
                        "robotSpeed": -1.0,
                        "script_args": {},
                        "script_name": "",
## "state": "FINISHED"
## }
                ],
                "candidateName": "",
                "complete": true,
                "createTime": 1697092381,
                "error": "[]",
                "errors": [],
                "executionTimeCost": 149,
                "externalId": "",
                "finishOdo": 139.905713,
                "group": "",
                "id": "d7a3adf4-79c3-4f5d-a2dc-145b27590812",
                "joinable": false,
                "label": "",
                "mapfPriority": 0,
                "msg": "",
                "notices": [],
                "orderMinScore": 0.0,
                "orderOdo": 137.303713,
                "orderScore": 0.0,
                "prePointRedo": false,
                "priority": 0,
                "receiveTime": 1697092381,
                "startOdo": 2.602,
                "state": "FINISHED",
                "terminalTime": 1697092530,
                "terminateTime": 1697092530,
                "type": 0,
                "vehicle": "SCL-AWG50-HMI",
## "warnings": []
            },
            "createTime": 0,
            "externalId": "",
            "group": "",
            "id": "seer-1008611",
            "label": "",
            "priority": 0,
            "receiveTime": 1697092381,
            "recleanOrderId": "",
            "state": "FINISHED",
            "terminateTime": 0,
            "transferOrderId": "",
            "vehicle": "SCL-AWG50-HMI",
## "workArea": "17"
        },
## {
            "changeWaterId": "",
## "cleanOrder": {
                "additionalProperties": {},
## "blocks": [
## {
                        "binArea": "",
                        "binTask": "START_CLEAN",
                        "blockId": "3a591433-a8ba-4b05-ac18-fbd9da02a4a2",
                        "containerName": "",
                        "goodsId": "",
                        "location": "2F-R",
                        "manuallyFinished": false,
                        "operation": "Script",
                        "operation_args": {},
                        "postAction": {},
                        "robotSpeed": -1.0,
                        "script_args": {},
                        "script_name": "",
## "state": "RUNNING"
                    },
## {
                        "binArea": "",
                        "binTask": "STOP_CLEAN",
                        "blockId": "fac2ae50-b16f-4a8f-85e0-6c5f7a4d48f0",
                        "containerName": "",
                        "goodsId": "",
                        "location": "2F-R-END",
                        "manuallyFinished": false,
                        "operation": "",
                        "operation_args": {},
                        "postAction": {},
                        "robotSpeed": -1.0,
                        "script_args": {},
                        "script_name": "",
## "state": "CREATED"
## }
                ],
                "candidateName": "",
                "complete": true,
                "createTime": 1697096868,
                "error": "[]",
                "errors": [],
                "executionTimeCost": 0,
                "externalId": "",
                "finishOdo": 0.0,
                "group": "",
                "id": "bb2993f0-6829-434a-bfca-01e8c104ac98",
                "joinable": false,
                "label": "",
                "mapfPriority": 0,
                "msg": "",
                "notices": [],
                "orderMinScore": 0.0,
                "orderOdo": 0.0,
                "orderScore": 0.0,
                "prePointRedo": false,
                "priority": 0,
                "receiveTime": 1697096868,
                "startOdo": 2.602,
                "state": "RUNNING",
                "terminalTime": 0,
                "terminateTime": 0,
                "type": 0,
                "vehicle": "SCL-AWG50-HMI",
## "warnings": []
            },
            "createTime": 0,
            "externalId": "",
            "group": "",
            "id": "seer-1008612",
            "label": "",
            "priority": 0,
            "receiveTime": 1697096868,
            "recleanOrderId": "",
            "state": "RUNNING",
            "terminateTime": 0,
            "transferOrderId": "",
            "vehicle": "SCL-AWG50-HMI",
## "workArea": "17"
## }
    ],
    "page": 1,
    "size": 20,
## "total": 2
## }
## 使用方法
## 一个完整的清扫任务使用方法如下：
使用 roboshop 在 smap 里绘制清扫区域，并自动生成起点终点，将清扫区域名称改为想要的名称
在 smap 的清扫区域里，起点和终点分别绑定库位，并配置 binTask ，键位分别为 START_CLEAN 和 STOP_CLEAN ，值对应相应脚本
如需自动换水，换水点也应该绑定库位并设置相应 binTask ，同时绑定为机器人的充电点
## 同步地图到调度场景
### 使用 setOrder API 发送清扫订单
## 机器人按照处理流程进行清扫任务
### 更详细的清洁机器人部署文档：清洁机器人部署文档
### 清洁机器人的避让订单（0.1.9.240726）
清洁机器人的避让订单通过 呼叫清洁机器人离场 api 触发生成，其含义为：当用户使用上述 api 呼叫清洁机器人离场后，机器人会停止当前清扫任务，生成避让订单，前往距离最近的避让点，订单变为 Waiting 状态，直到收到返场信号 呼叫清洁机器人返场，才会将避让订单标记完成，清洁机器人会返回离场位置继续当前的清扫任务
避让点设置方法（roboshop 版本 2.4.1.178 及以上）
如下图所示，可以在 smap 中清扫区域的属性中配置避让点，可以配置多个避让点
当清洁机器人执行此区域的清扫任务时，如果需要避让，会在该区域配置的停靠点中寻找一个最近的
## image.png

## 策略详情
根据呼叫机器人离场时机器人所处的不同位置及清扫不同阶段，避让策略的响应措施也会不同，其对应关系见下表：

## 机器人位置

## 机器人动作

## 触发避让时的措施

## 后续呼叫返场的措施

## 清扫区域外

机器人在执行清扫运单，但是还没到清扫区域，
## 正在前往清扫区域的路上

### 不再去清扫区域，改为去当前位置最近的避让点

## 会前往清扫区域，从入口处开始清扫

## 清扫区域内

### 机器人在执行清扫运单，并且已经在清扫区域内清扫了

## 停止清扫
## 路径导航去最近避让点

### 会前往清扫区域，从入口处自由导航去离场位置，然后开始清扫

## 清扫区域内

## 正在前往充电桩换水路上
## 还没走出清扫区域

## 不处理
## 因为换水一定会离开清扫区域

## 无响应

## 清扫区域外

## 正在去充电桩换水路上
## 已经走出了清扫区域

## 不处理

## 无响应

## 清扫区域外

## 正在充电桩换水

## 不处理

## 无响应

## 清扫区域外

## 机器人换水完毕
### 开始前往清扫区域继续清扫任务，但是还没走到清扫区域

### 不再前往清扫区域，改为去当前位置最近的避让点

### 会前往清扫区域，自由导航从触发换水位置开始继续清扫

## 清扫区域内

## 机器人换水完毕
### 前往清扫区域触发换水的位置，此时正好在自由导航去该位置

## 不处理
如果在自由导航时处理，会先让机器人停下来，这样有可能会在线路外，所以不处理

## 无响应

## 清扫区域内

## 机器人换水完毕
## 并且已经返回清扫区域内继续开始清扫了

## 停止清扫
## 路径导航去最近避让点

### 会前往清扫区域，从入口处自由导航去离场位置，然后开始清扫

## 任意位置

## 机器人在执行避让订单

## 重复触发不处理

## 无响应
## 常见问题
## 避让订单有什么用
目前用于解决和三方搬运车的交管问题，本质上搬运订单的优先级是高于清扫订单的，如果有搬运车想进入清扫区域，用户往往希望清扫车去一个合适地方避让，让位于搬运车使用，直到通知清扫车可以回来继续扫地了；这种情形就可以使用避让订单的功能实现
