# 场景的同步

## 场景的同步
## 服务器数据与机器人数据检查原理
场景同步和还原时，因为涉及到给机器人上传/更新地图以及切换地图。上传/更新地图是根据 RDSCore 中的地图数据和机器人中的地图数据之间的不同来进行的。
当场景构建好并且在不同区域中加载了机器人地图后，点击 roboshop 中的不同区域，在 右侧栏 就会有相关机器人加载在此区域中的地图。如下图，在区域 Area-01 中添加了两张地图，分别是 AMB-201 和 AMB-202 的 default_map。此处需要记住一个概念， 一个机器人在场景中的地图 为这个机器人加载在每个区域内的地图的总和。
1669627907228-c57463f9-e789-4eea-adb7-961acb484005.png

当对比 服务器数据 和 机器人数据 时，对于每个机器人来说服务器数据指的是 当前机器人在场景中的地图。 机器人数据指的是机器人本地所有地图的地图名和相关信息。
需注意：RDSCore版本大于0.1.8.221123时此概念才生效，之前版本对于每个机器人来说服务器数据指的是在场景文件中，当前机器人的所有地图。
### 服务器数据 与 机器人数据 不一致可以分为两个方面解释：
机器人本地地图包括了 当前机器人在场景中的地图 （即机器人加载在场景中的地图为机器人本地地图的子集）
此时若服务器与机器人数据不一致，代表机器人本地数据中地图的MD5值和场景中的不一致。
### 机器人本地地图不包括 当前机器人在场景中的地图
此时若服务器与机器人数据不一致，代表场景中的一些地图是全新的地图，不存在于机器人本地。

## 同步
同步指的是，针对每一个机器人，对比 服务器数据 和 机器人数据 ，将场景中这些数据不一致的地图全部上传给机器人。
举个例子，上图中两个机器人在场景中的地图名都为 default_map ，md5为 38b573f98bbf2724489ed89bb3f313ea 。此时若使用 roboshop 单独修改这两个机器人本地的 default_map 地图并且推送给机器人，在RDSCore中会显示数据不同步，如下图。
1669630210760-fb50e2c9-c500-403d-ae77-4e59e192cecb.png

此时若同步场景，因为服务器中的数据已经与机器人中的数据不一致了，RDSCore会将这两个机器人加载在场景中的地图重新上传给机器人。在此例子中，RDSCore会将md5为 38b573f98bbf2724489ed89bb3f313ea 的地图 default_map 重新上传给 AMB-201 和 AMB-202 。而不管机器人本地的 default_map 地图被如何修改。
## 同步中的约束
若RDSCore没有当前机器人的 控制权 或者当前 机器人断连 ，此机器人的同步是无法成功的。此时会有个报警码 55000 ，直到下一次同步全部成功，这个报警码才会自动消除。

### 同步与roboshop中的机器人同步服务器的关系
选中单个机器人的数据同步页面，可以在roboshop中拉取当前机器人本地与场景中不一致的地图，并且将拉取到的地图加载在场景中。
当此动作完成后，场景中的数据已经和机器人本地的数据保持一致了，此时roboshop上传场景。因为没有不一致的数据，同步操作直接跳过，并不上传场景中与机器人不一致的数据（此时也没有不一致的数据）。
## 整个流程图如下
1669631514669-9d747bb7-bbb8-4235-9719-6e856547c7d5.jpeg

## 上传场景时自动同步的配置参数
在上传场景时，有一个参数可以用来配置是否开启自动同步的功能。若开启，在上传时会自动将场景中与机器人本地不一致的数据全部上传给机器人；若不开启，则跳过上传步骤，此时若有数据不同步的情况，可以手动调用 服务器同步机器人。
1669632196847-e1474ef7-f8f1-42df-9e28-dec096789b67.png

### 同步与roboshop中的服务器同步机器人的关系
选中数据同步页面中的服务器同步机器人，此时roboshop不会拉取机器人本地数据到场景中，因此场景中可能会有和机器人本地数据不一致的地图。
RDSCore接收到服务器同步机器人请求后，直接开始同步操作。针对存在数据不一致的机器人，RDSCore会上传服务器中的数据给机器人。
## 整个流程如下
1669632054778-e696ca9a-e340-4c11-b3a7-842b55f924fb.jpeg
