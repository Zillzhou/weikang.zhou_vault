# 清洁机器人部署文档

## 清洁机器人部署文档
## @高磊@丁禹伯
本文档介绍了清洁机器人如何配置、部署；地图清扫区域绘制、清扫运单及脚本相关操作
## 编辑地图
## 绘制清扫区域
## 点击左侧栏区域, 选择清扫区域
ZPQUbm5zvoaeiQxlL81clkMan8g.png

### 绘制区域, 清扫区域支持矩形, 凸多边形, 任意多边形
CsEYbp76Po5BJuxJqWNclj9JnNe.gif

## 添加清洁区域起始点
自动生成清洁路径需要区域内必须有一个点位, 该点位为清洁区域的起始点
H6IJbJdJmome6XxtzS5c162zn6f.png

## 生成路径
 点击确定后会自动生成清洁路径, 该路径包含清洁起始点和终点,如下图
Q3PLbMRp9os2HWxHS16chPnFnnc.png

## 起始点和终点设置库位
起点库位动作名为START_CLEAN，终点库位动作名STOP_CLEAN

注意：这两个动作名称是不可以变的，因为调度生成清扫订单时会默认采用这两个库位动作
## {
    "operation": "Script",
## "script_args": {
### "operation": "WashStart"
    },
    "script_name": "clean_robot.py"
## }
FaH1bfdp9o0MUWxBtN2crkLgnVe.png

## {
    "operation": "Script",
## "script_args": {
### "operation": "WashEnd"
    },
    "script_name": "clean_robot.py"
## }
SskTbo7qioSgbBxcxzvcJP5UnBc.png

## 设置换水点位及动作块
通常将充电点设置为换水点位,配置换水库位，动作名称为CHANGE_WATER

注意：换水点的动作名称也是不能变的，调度在生成自动换水任务时会默认采用此动作名称
VKFOb0dOcoHcPcxrE1KcxmC8nUe.png

可以根据需要配置更多清洁机器人库位动作, 动作脚本如下文所示。
## 执行脚本动作
### 清洁机器人有扫地, 推尘, 加水等动作脚本
### 脚本使用详见:清洁机器人脚本工作流程与使用
## 调度下发清扫运单
### 下发清扫运单,使清洁机器人完成清扫, 换水工作
## 配置
## 模型文件配置
## image.png

## 勾选字段说明:

scriptName：机器人使用的脚本文件名称（注意不要遗漏.py后缀）

closeMotorAtPrePoint：是否在出口前置点关闭吸水出水电机
默认下，机器人到达清扫区域出口，关闭吸水和出水电机，清扫任务结束。但是这会导致在出口处地面留下一滩水，此参数可以控制机器人在出口的前置点处关闭电机，来解决此问题。
注意：前置点需要绑定库位并配置键位CLOSE                 最低版本支持：0.1.9.231106

### autoChangeWater：是否开启自动换水功能
自动换水功能：调度系统控制下，如果机器人清水量或污水量不满足设定阈值，会自动生成换水订单；如果是在执行清扫任务的过程中触发换水，还会在换水完成后自动前往上次清扫的地点继续清扫任务

redoChangeWaterFailed：换水失败自动重做功能

onlyChangeWaterInPP：只允许在 PP 点时才可以触发换水任务，用于防止在清扫途中换水，最低版本支持 0.1.9.250219
## 机器人配置
DCK5bdzeKoX3plxTqWXc8UsRnhg.png

maxDirtyWater：污水最大阈值，污水超过此值会触发自动换水
minCleanWater：清水最低阈值，清水低于此值会触发自动换水

注意：maxDirtyWater，minCleanWater 仅在勾选自动换水时有效
## 清扫任务下发
## 请求
## 功能：创建一个清扫运单
## 方法： POST
## 接口说明： /setOrder
## {
  "id": "seer-test-01",      // 订单 id，不可缺省
  "vehicle": "SCL-AWG50-HMI",// 执行机器人名称，不可缺省
  "workArea": "2"            // 清扫区域名称，含有此字段的订单会被视为清扫运单
## }

调度下的清扫运单分为三个部分：清扫订单、换水订单、继续清扫订单
清扫订单：用户下发清扫任务后，调度自动生成的用于清扫下发区域的订单
换水订单：在执行清扫订单过程中，如果机器人水量不满足阈值要求，生成的换水订单
继续清扫订单：换水订单执行完成后，生成的返回上次清扫点继续清扫的订单
注：用户只需通过上述接口下发清扫任务，三个子订单均为调度自动生成，无须用户下发
## 错误响应信息

## 响应

## 描述

## 含义

## 解决办法

## 400

## workArea is empty

### 下发报文 workArea 字段为空字符串

## 下发清扫任务必须指定清扫区域名称

## 400

### workArea must be string

## workArea 字段不是字符串类型

## 此字段必须为字符串类型

## 400

workArea xxx is not in the scene

## 清扫区域不在场景里

## 确认清扫区域名称是否正确

## 400

workArea xxx missing start_site or end_site

## 清扫区域没有设置入口或出口

## 检查场景里的清扫区域入口和出口是否为空

## 400

workArea xxx missing bin at start_site or end_site

## 清扫区域入口或出口没有绑定库位

## 检查清扫区域入口和出口是否绑定了库位

## 400

workArea xxx binTask is invalid at start_site or end_site

### 清扫区域入口或出口 binTask 非法

## 入口必须有动作START_CLEAN
## 出口必须有动作STOP_CLEAN
## RDS 清洁运单管理界面
RDS 在清洁运单管理中可以监控已经下发的清扫运单状态，并可以在清扫详情、换水详情和继续清扫详情中查看对应的三个订单状态
## image.png

## 清扫订单
### 清扫运单包含两个动作块, 分别为开始动作块和结束动作块：

## 动作块1：
## 目标点：清扫区域入口
## 到点动作：START_CLEAN
## 动作块2：
## 目标点：清扫区域出口
## 到点动作：STOP_CLEAN
### RDS 清洁运单管理 清扫详情 内的清扫订单显示见下图
## image.png

## 换水订单
启用自动换水功能后，当污水或清水达到阈值 maxDirtyWater，minCleanWater 会触发自动换水

## 自动换水：
## 机器人在清扫区域外：
只有在任务终态时才会生成换水订单，订单目标点为换水点，动作为CHANGE_WATER
## 机器人在清扫区域内：
只有机器人在执行清扫订单时才会生成换水订单，并同时终止正在执行的清扫订单，换水订单有两个动作块
## 动作块1：
## 目标点：原地任务
## 动作：自由导航前往清扫区域出口
## 动作块2：
目标点：换水点；
到点动作：CHANGE_WATER；
## 运动方式：路径导航
注：如果没有勾选自动换水, 即使污水和清水到达阈值，也会继续清扫
注：通过调度下发的清扫任务目前不支持暂停任务人工换水，人工换水后只能重新下发清扫任务
### RDS 清洁运单管理 换水详情 内的换水订单显示见下图
## image.png

## 继续清扫订单
换水完成后，如果机器人此前正在执行清扫任务，机器人需返回上次触发换水的位置继续清扫，继续清扫订单包含两个动作块

## 动作块1：
## 目标点：清扫区域入口
## 到点动作：自由导航到清扫位置并开始清扫
## 动作块2：
## 目标点：清扫区域出口
## 到点动作：STOP_CLEAN
RDS 清洁运单管理 继续清扫详情 内的继续清扫订单显示见下图：
其中操作参数内的restart_clean_location即为继续清扫的位置，图示含义：线路 LM609--LM610 的 52.7% 处
## image.png

## 查询清扫运单
## 单个运单查询
查询接口：http://ip:8088/sweepOrderDetails/{order_id}
查询示例：http://127.0.0.1:8088/sweepOrderDetails/seer-test-01
## 响应值：

## 响应示例：
## {
  "changeWaterId": "",
  "changeWaterOrder": null,
## "cleanOrder": {
    "additionalProperties": {},
## "blocks": [
## {
        "binArea": "",
        "binTask": "START_CLEAN",
        "blockId": "4af78dc8-7ec9-4e61-baa8-f20d3770f676",
        "containerName": "",
        "goodsId": "",
        "location": "2F-R",
        "manuallyFinished": false,
        "operation": "Script",
        "operation_args": {},
        "postAction": {},
        "robotSpeed": -1.0,
        "script_args": {},
        "script_name": "",
## "state": "FINISHED"
      },
## {
        "binArea": "",
        "binTask": "STOP_CLEAN",
        "blockId": "dcaa185e-ba53-49ea-bf14-fa33a754ea3a",
        "containerName": "",
        "goodsId": "",
        "location": "2F-R-END",
        "manuallyFinished": false,
        "operation": "Script",
        "operation_args": {},
        "postAction": {},
        "robotSpeed": -1.0,
        "script_args": {},
        "script_name": "",
## "state": "FINISHED"
## }
    ],
    "candidateName": "",
    "complete": true,
    "createTime": 1696990430,
    "error": "[]",
    "errors": [],
    "executionTimeCost": 150,
    "externalId": "",
    "finishOdo": 139.905713,
    "group": "",
    "id": "67e36b6f-3d9f-4b18-89c8-157651a84bee",
    "joinable": false,
    "label": "",
    "mapfPriority": 0,
    "msg": "",
    "notices": [],
    "orderMinScore": 0.0,
    "orderOdo": 137.303713,
    "orderScore": 0.0,
    "prePointRedo": false,
    "priority": 0,
    "receiveTime": 1696990430,
    "startOdo": 2.602,
    "state": "FINISHED",
    "terminalTime": 1696990580,
    "terminateTime": 1696990580,
    "type": 0,
    "vehicle": "SCL-AWG50-HMI",
## "warnings": []
  },
  "createTime": 0,
  "externalId": "",
  "group": "",
  "id": "seer—test-01",
  "label": "",
  "priority": 0,
  "receiveTime": 1696990430,
  "recleanOrder": null,
  "recleanOrderId": "",
  "state": "FINISHED",
  "terminateTime": 0,
  "transferOrderId": "",
  "vehicle": "SCL-AWG50-HMI",
## "workArea": "2"
## }
## 分页查询
查询接口：http://ip:8088/sweepOrders
## 请求参数：

## 更多过滤方法详见 分页查询运单信息
查询示例：http://127.0.0.1:8088/sweepOrders
## 响应示例：
## {
## "list": [
## {
    "changeWaterId": "",
## "cleanOrder": {
      "additionalProperties": {},
## "blocks": [
## {
        "binArea": "",
        "binTask": "START_CLEAN",
        "blockId": "2ebe0025-63d3-4ec7-99a6-856bfa44dd75",
        "containerName": "",
        "goodsId": "",
        "location": "2F-R",
        "manuallyFinished": false,
        "operation": "Script",
        "operation_args": {},
        "postAction": {},
        "robotSpeed": -1.0,
        "script_args": {},
        "script_name": "",
## "state": "FINISHED"
      },
## {
        "binArea": "",
        "binTask": "STOP_CLEAN",
        "blockId": "9f65414c-b200-48a8-9b52-fc33757d8f18",
        "containerName": "",
        "goodsId": "",
        "location": "2F-R-END",
        "manuallyFinished": false,
        "operation": "Script",
        "operation_args": {},
        "postAction": {},
        "robotSpeed": -1.0,
        "script_args": {},
        "script_name": "",
## "state": "FINISHED"
## }
      ],
      "candidateName": "",
      "complete": true,
      "createTime": 1697092381,
      "error": "[]",
      "errors": [],
      "executionTimeCost": 149,
      "externalId": "",
      "finishOdo": 139.905713,
      "group": "",
      "id": "d7a3adf4-79c3-4f5d-a2dc-145b27590812",
      "joinable": false,
      "label": "",
      "mapfPriority": 0,
      "msg": "",
      "notices": [],
      "orderMinScore": 0.0,
      "orderOdo": 137.303713,
      "orderScore": 0.0,
      "prePointRedo": false,
      "priority": 0,
      "receiveTime": 1697092381,
      "startOdo": 2.602,
      "state": "FINISHED",
      "terminalTime": 1697092530,
      "terminateTime": 1697092530,
      "type": 0,
      "vehicle": "SCL-AWG50-HMI",
## "warnings": []
    },
    "createTime": 0,
    "externalId": "",
    "group": "",
    "id": "seer-1008611",
    "label": "",
    "priority": 0,
    "receiveTime": 1697092381,
    "recleanOrderId": "",
    "state": "FINISHED",
    "terminateTime": 0,
    "transferOrderId": "",
    "vehicle": "SCL-AWG50-HMI",
## "workArea": "17"
  },
## {
    "changeWaterId": "",
## "cleanOrder": {
      "additionalProperties": {},
## "blocks": [
## {
        "binArea": "",
        "binTask": "START_CLEAN",
        "blockId": "3a591433-a8ba-4b05-ac18-fbd9da02a4a2",
        "containerName": "",
        "goodsId": "",
        "location": "2F-R",
        "manuallyFinished": false,
        "operation": "Script",
        "operation_args": {},
        "postAction": {},
        "robotSpeed": -1.0,
        "script_args": {},
        "script_name": "",
## "state": "RUNNING"
      },
## {
        "binArea": "",
        "binTask": "STOP_CLEAN",
        "blockId": "fac2ae50-b16f-4a8f-85e0-6c5f7a4d48f0",
        "containerName": "",
        "goodsId": "",
        "location": "2F-R-END",
        "manuallyFinished": false,
        "operation": "",
        "operation_args": {},
        "postAction": {},
        "robotSpeed": -1.0,
        "script_args": {},
        "script_name": "",
## "state": "CREATED"
## }
      ],
      "candidateName": "",
      "complete": true,
      "createTime": 1697096868,
      "error": "[]",
      "errors": [],
      "executionTimeCost": 0,
      "externalId": "",
      "finishOdo": 0.0,
      "group": "",
      "id": "bb2993f0-6829-434a-bfca-01e8c104ac98",
      "joinable": false,
      "label": "",
      "mapfPriority": 0,
      "msg": "",
      "notices": [],
      "orderMinScore": 0.0,
      "orderOdo": 0.0,
      "orderScore": 0.0,
      "prePointRedo": false,
      "priority": 0,
      "receiveTime": 1697096868,
      "startOdo": 2.602,
      "state": "RUNNING",
      "terminalTime": 0,
      "terminateTime": 0,
      "type": 0,
      "vehicle": "SCL-AWG50-HMI",
## "warnings": []
    },
    "createTime": 0,
    "externalId": "",
    "group": "",
    "id": "seer-1008612",
    "label": "",
    "priority": 0,
    "receiveTime": 1697096868,
    "recleanOrderId": "",
    "state": "RUNNING",
    "terminateTime": 0,
    "transferOrderId": "",
    "vehicle": "SCL-AWG50-HMI",
## "workArea": "17"
## }
],
"page": 1,
"size": 20,
## "total": 2
## }
## 仿真
## 清洁机器人可仿真以下条目：

## 清水量、污水量
## 任务时的清水消耗速度、污水增加速度
## 换水时的清水增加速度、污水排放速度
## 详细设置见: 机器人
## 常见问题
## 机器人沿墙壁清扫时，速度较低的问题
由于机器人检测到墙面为障碍物，会触发小车的避障减速，速度为 ObsDecSpeed。想提高速度，把 ObsDecSpeed 增大即可
D0K3bfS7gomUjyxsKSvcKLnCnJh.png

CYuubb0aIokoZfxXtw2cI48Fngl.png

## 加水失败导致机器人不会返回区域继续清扫
若加水失败，机器人实际水量仍小于阈值，机器人不会返回清扫区域继续清扫任务，而是会标记任务失败
## 设置机器人在出口前置点关闭电机
机器人到达清扫区域出口，关闭吸水和出水电机，清扫任务结束，但是这会导致在出口处地面留下一滩水，现提供closeMotorAtPrePoint功能，控制机器人在出口的前置点处关闭电机（前置点需要绑定库位并配置键位 CLOSE），此功能由模型文件 CleanRobot 控制。
### 更新 rbk 后，调度不断崩溃重启问题：
目前已知两个现场在从 3.4.6.13 升级到 3.4.6.14 版本后会出现此问题，这是由于 14 版本报错码中增加了新的字段无法解析成功导致的，调度在版本 0.1.9.240329 进行了修复，详见 https://seer-group.coding.net/p/test_center/bug-tracking/issues/3194/detail(如无法访问，可联系我司工作人员)
