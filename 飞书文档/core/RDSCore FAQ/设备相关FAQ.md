# 设备相关FAQ

## 设备相关FAQ
## 设备重连慢如何解决
## 设备重连慢的可能原因：
网络环境差或者设备不响应，一段时间内网络无法连接，导致重连持续失败
## 配置的超时过大，开始重连需要的时间过长
## 排查步骤
## ping测试
在运行Core的机器上，保持出问题时的网络设置，即连到相同的无线网或者有线网，ping出问题的设备ip。
例如，现场运行Core的电脑ip为192.168.123.123，工程师的笔记本为192.168.123.321，不能用笔记本ping，需要用运行Core的电脑来ping。
## ping结果分析和处理：
### 不通，所有的包都没返回。网络不通，进一步确认网络不通的原因
### 延迟稳定，但是高于10ms。需要确认网络设置是否正确
### 延迟不稳定，最大时高于20ms。需要确认网络设置是否正确
## 协议测试
连接出问题，但是ping正常的情况，可能是防火墙阻挡端口/协议或者设备控制器程序问题。需要用具体的tcp协议测试工具或者modbus测试工具来确认。常用测试方法：
windows测试modbus：ModbusPoll, qModbus
### windows测试tcp：telnet, 其他测试工具
### linux测试modbus: modpoll
### linux测试tcp: telnet, nc
## 检查日志
日志中，搜索 ::read ，可以找到读取modbus和其他tcp消息的计时，如下：
[2023-09-19 17:18:13.550256][R][debug] [TimeLogger][7256|DF1::readInputRegisters|log|0|total|112]
上面的日志表示：读取代理DF1，读取只读寄存器，耗时112毫秒
搜索 ::write 可以找到写入计时。
## 小于100毫秒时不计时
如果日志中的读写操作耗时和模型文件中配置的timeout一致，表示连接超时
## 检查配置
模型文件-proxy-timeout 为tcp通信超时，旧版本默认为120秒，新版本默认为10秒。如果重连需要好几分钟，可能是超时为120秒导致的，改为10秒
## 如何查看ModbusTCP通信记录
### 对应常见问题：门、电梯、库位、终端的信号有误
日志中记录了所有成功的的ModbusTCP通信记录。
## 格式为:
[yyyy-mm-dd hh:MM:ss.ssssss][RDSProxy][info] [ModbusIOSuccess][<ProxyName>|<FunctionCode>|<StartAddress>|<Count/Value>(|ValueArray)]
## 解释：
ProxyName 为代理名称，对应门、电梯等的proxyName配置项，和模型文件中proxy的“设备名称”项
FunctionCode 对应ModbusTCP协议的函数号，可能取值如下：
### 01(read_bits) 批量读取线圈量
### 02(read_input_bits) 批量读取只读线圈量
### 03(read_registers) 批量读取寄存器
04(read_input_registers) 批量读取只读寄存器
### 05(write_bit) 写入单个线圈量
### 06(write_register) 写入单个寄存器
### 15(write_bits) 批量写入线圈量
### 16(write_registers) 批量写入寄存器
### StartAddress 为起始地址，对于单个操作，为地址
Count/Value 对于批量操作，为操作的寄存器/线圈量数量，对于单个操作，为写入/读取的值
ValueArray 只存在于批量操作日志，为写入/读取的值，用逗号分割
## 例子：
从代理 DF 读取只读寄存器，从0开始读，读1个，返回的结果为1
[2023-09-17 02:11:04.307789][RDSProxy][info] [ModbusIOSuccess][DF|04(read_input_registers)|0|1|[1,]]
向代理 DF 写入保持寄存器，写入单个寄存器，地址为0，写入1
[2023-09-17 02:11:04.510854][RDSProxy][info] [ModbusIOSuccess][DF|06(write_register)|0|1]

## 如何解决机器人出电梯后暂停的问题
机器人离开电梯时，core会持续给电梯发送目标楼层，梯控收到目标楼层后，可能会保持开门，也可能关门。如果，机器人未到达出电梯后的第一个点，即电梯在本层的前置点，电梯门就关上了，会触发异常暂停逻辑。
## 解决方法有两种：
减少SM点到前置点的距离，但是也要保证，机器人在前置点时，电梯门可以关上。如下图，在SM1和LM20之间增加一个点，作为SM1的前置点 
1696817049654-91145d84-01f5-4077-867a-f889485095d6.png 

## 修改后：
1696817163136-7f245965-8345-4e21-a721-80accef313e4.png

反馈给梯控，让梯控将逻辑改为：即使电梯已经在目标楼层，门已经打开，收到目标楼层时，不能忽略，要保持开门
两种方法都可以解决。
### order_issue_pool#4024
## 如何查看发给门的指令
## 自动门指令历史查询
可以通过上面的接口看。如果是Modbus门控，可以通过 查看ModbusTCP通信记录 来看发给门的指令
## 死胡同尽头的门，该如何配置
1698391872279-0c28b8bc-cd2f-4481-bf50-432e90853adb.png

如图中，Door-01配置了路线LM42<->AP40。
如果 不希望机器人到AP40后发关门 ，需要升级到 231027 之后版本的core。230817之后版本的core，过门之后一定会发一次关门。231027之后的版本，对死胡同尽头的情况做了特殊处理
如果 希望机器人到AP40后发关门 ，且使用了231027之后版本的core。需要在参数配置中，打开 CloseDoorAtDeadEnd
### 502端口被占用，导致Core起不来、无法使用外部互斥组
## 确认是否有人在占用 502 端口
linux: netstat -ltnp | grep 502
windows: Get-Process -Id (Get-NetTCPConnection -LocalPort 502).OwningProcess
### 如果可以关闭使用502端口的程序，到此结束
## 升级到231027之后的Core
启动后，修改 ModbusSlavePort 参数，选一个可以用的端口
## 重启Core
## 电梯报错53016，该如何配置楼层
1698809456230-37a77174-91df-48e6-bb76-4ccb7bad7dc1.png

电梯如上图报错时，表示电梯上报的楼层不在电梯配置的AreaFloorMapping中。有两种解决办法：
在AreaFloorMapping中配置报错楼层对应的区域。如，添加 "Area3":"3"
关闭电梯报错。在参数配置中，关闭 ReportInvalidFloor
### 有多个HTTP门控时，如何加快门控状态同步
## 更新到231115之后的版本
### 在参数配置中，将 AsyncLoop 改为true
1700098345910-4c85ce75-18af-4179-b240-15c53d2a2303.png 

在模型文件中，将门控对应的HTTP代理的 parallelism 参数改大，推荐尝试1，3，10
1700098866522-a9ce321a-01e8-4fd2-9ad6-fe4026b7973e.png 

## 、
### Modbus Slave无法正确读取寄存器状态，该如何解决
## 1.使用Modbus Pull时，读取4个及以上连续的寄存器
1701683996795-ed8d5fb7-0830-45d6-84ab-023daf1d95bd.png

### 2.使用其他的仿真工具

## 风淋门中的线路如何配置
目前的调度逻辑不支持在风淋门中接单掉头，因此需要配置线路时注意：
## 风淋门中需要用使用单向路
从两个方向经过风淋的路线，没有相同的拓扑点位，物理位置可以相交，但是不能公用拓扑点
## 例如：
1702445982309-4e1faf5a-d1b9-496e-957c-51e31e517996.png

图中8108和8019是两个不同的拓扑点，但是物理位置可以相同；8020和8018在风淋之外
此外，在场景中，使用模型文件配置风淋门时，在门控下添加的图元只做显示，业务逻辑不会解析。例如，
## image.png

上图中，Door-001是使用模型文件配置的风淋，它有LM435-LM436这条路线的图元，所以显示在这条路线上，业务逻辑中不会解析这条路线，只关心模型文件中配置的路径
