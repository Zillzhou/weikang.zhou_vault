# 触发器

## 触发器
## @杨达
### 0.1.9
## 在状态变化时触发，执行配置的任务

## 配置说明
## 打开调度模型文件
## 在roboshop首页，连接调度
1689734281332-ce26d7ea-8ee3-4b47-8f9f-b34e7719155f.png

点击界面上方的 模型文件 标签，打开调度的模型文件，触发器的配置就在左侧列表中的 Trigger 项中
1689734262267-6cd4c468-fafb-4c5c-ae1d-f9f9444fa924.png

点击左侧模型文件列表中的 Trigger ，可以展开触发器模型列表。下图中的状态表示：有一个触发器，名称为 Sample ，已经启用
1689734418895-0ff23406-5fc7-4268-b40d-54c3c4876c81.png

点击 Trigger 列表中的项，即可在右侧打开对应的触发器属性窗口。下图中，点击左侧的 Sample 后，展开右侧的属性窗口
1691026868140-8f4e21c4-6eee-4218-af8d-4a593547f908.png

## 配置触发器
1691026836130-390ec5dc-1115-44bf-a4f0-27173436d19d.png

### 触发器的属性窗口中，触发器的配置分为三个部分：
## 设备名称，即触发器的名字
## condition，用来判断机器人状态
## action，触发后执行的动作
## 配置条件
1691028257176-3ff3fc56-c91f-4982-b42b-ee5ae3e3b1a6.png

点击 condition下的下拉列表，在列表中选择需要的触发条件。支持的条件参见下文。
## 配置动作
1691028336040-b8dd8a2a-e200-4244-a9e5-fc4f4b92e47c.png

点击action下的下拉列表，在列表中选择需要的动作。支持的动作见下文
## 支持的条件
## DI触发
1691027259849-2da925cd-7256-4e18-9586-8a67a177bc59.png

## 急停
1691027272435-47a16c1f-29ba-432b-ac08-05cd2a0bcc20.png

oldValue表示上次的急停状态，newValue表示新的急停状态，勾选表示要求急停拍下，
### 即，上图的配置表示上次急停没拍下，当前急停拍下时触发
## 订单状态变化
1691027412343-c168ea22-3214-4104-ba9b-99e834f1d9ba.png

不是每个订单状态都一定会触发，比如，对于已经封口的订单，最后一个动作块完成后，不会进行WAITING状态触发，会直接变为FINISHED状态，再触发
## 订单被终止
1691027484701-401b12ae-d6b6-4735-8bcc-c53e7adef084.png

订单的状态变为STOPPED时触发，不管是何种原因导致的变为STOPPED，即，RoboShop手动终止，其他系统调用HTTP接口终止，失败终止，都会触发
## 机器人新增报错
1703056471140-964323ba-b6a8-4e5d-b0b3-fbb4259dc4cb.png

## 机器人上报之前没有的报错时触发
## 机器人报错变化
1703056507503-4eed936e-aca8-4ba5-b881-f11c700c5f52.png

机器人报错变化，即增加或减少时触发，报错次数变化时不触发。例如，原先报错有两个，52200和52702，现在变为一个52200，或者增加一个报错变为三个，都会触发；但是如果还是两个报错码，报错次数增加，不会触发
## Core报错变化
1703056774581-e30c0b12-0357-466d-bb13-c8850ca63afb.png

Core的报错增加或减少时触发，类似RobotErrorChange
## 机器人状态变化
## image.png

目前支持5个状态变化，状态变化后会向配置的 http 地址发送请求，内容为对应的变化状态。
## 支持的动作
## 终止机器人当前订单
1692609797617-a374cb73-32bf-4609-ad67-0c3ca16eeded.png

## 手动完成当前动作块
1692609816220-a1f7e591-164d-4bee-8bfe-442d5f269d13.png

## 手动完成当前订单中的所有动作块
1692609825181-7c553866-8dcc-4bcc-87de-1b02ae7ac05b.png

## 修改机器人接单状态
1691028103924-f18ebf1d-c8d2-4bdd-9b1a-84cd247cfd56.png

## dispatchable 表示可以接单
### undispatchable 表示不可接单，但是占用资源
undispatchable_ignore 表示不可接单，不占资源
## 标记当前订单为失败
1691141297722-433fcbdf-90bc-4c24-8162-93b3bfad6a98.png

执行运单的过程中，会将当前的动作块状态变为FAILED，订单状态也变为FAILED
需要手动重做动作块才能恢复执行，机器人急停拔起、报错消除不会自动恢复
## 发起HTTP请求
1691026901265-f06b3e0a-124c-45b6-8a03-d426d84b1057.png

## 字段说明：
schemeHostPort：请求的地址。0.1.9.240302及之后支持https
## path：请求的路径
expectedStatusCode：期望服务器返回的HTTP状态码，常用200,204
expectedResponseBody：期望服务器返回的body，一般为json，如 {"code":200, "msg":"ok"}
### retryEnabled：请求失败时的重试开关
### retryInterval：两次重试之间的最小间隔
### retryMaxTimes：最多重试多少次
additionalJson：附件的json，会覆盖原信息的同名字段
## 具体例子：
对于订单状态触发的动作，上报的json为订单信息，和 orderDetails接口格式一致，参加下面例子通过运单号查询运单状态
对于机器人状态触发的动作，上报的json为机器人信息，参见下面例子 获取所有机器人信息
对于Core报错变化触发的动作，上报的json为报错信息，类似下面的json:
## {
## "errors": [
## {
      "code": 52113,
      "desc": "Unignore robot is disconnect: (AMB -12 is dispatchable)(AMB-01 is dispatchable)(AMB-02 is dispatchable)(AMB-03 is dispatchable)(AMB-04 is dispatchable)(AMB-05 is dispatchable)(AMB-06 is dispatchable)(AMB-07 is dispatchable)(AMB-08 is dispatchable)(AMB-09 is dispatchable)(AMB-10 is dispatchable)(AMB-11 is dispatchable)(AMB-13 is dispatchable)(AMB-14 is dispatchable)(AMB-15 is dispatchable)(AMB-16 is dispatchable)",
      "times": 1,
### "timestamp": 1703057349
    },
## {
      "code": 53010,
      "desc": "proxy:NoSuchProxy: proxyone",
      "times": 1,
### "timestamp": 1703057351
    },
## {
      "code": 53012,
      "desc": "Door-02:DoorName: Door-02, ",
      "times": 1,
### "timestamp": 1703057350
## }
## ]
## }
## 配置样例
## DI触发终止当前任务
1691027940832-77a5b743-be74-437a-8d77-d204adc3055a.png

## 订单被终止时上报订单信息
1691027743905-4babc2f4-10fe-4ddc-ab17-503d80275d46.png
