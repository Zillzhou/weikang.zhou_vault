# 库位监测同步配置教程

## 库位监测同步配置教程
## 相关概念见文档：库位监控（bin）
## 一、Roboshop  配置
## 1.1 设置库位监测
1）进入调度，启动编辑，选择库位监测。

1703558467324-43ef4457-fd34-41e1-a4b7-b37d1e68edfa.png

2）点击加号，增加库位监测设备。

1703558487528-78682864-37ef-4b2b-b7c2-6def90de96e7.png

3）添加成功，库位监测栏出现 Monitor-01，一个库位监测设备可以添加多个库位，也可以一次添加一个。如图，我们同时选中 PT 库区的 6 个库位。

1703558521146-79041ab6-5d03-4b4f-9ea7-d6c05d1e0060.png

4）鼠标放置在 Monitor-01 处，右键出现“添加库位到库位监测设备”字样，点击它。

1703558735045-39920611-7bd0-40b2-947b-aed0b60a5f5f.png

5）可以看到六个库位已经成功出现在 Monitor-01 下方。

1703558753364-091e17ff-1ac3-4208-90a8-a42aae103fe3.png

## 1.2 设置 binJson
### binjson 字段解释（库位地址配置）
### JSON 数组，其中每个元素有下列字段：

## 字段

## 注释

## 参数位置

## 类型

## 最小值

## 最大值

## binareaname

## 库区名称

## 库位监控-属性-binJson

## string

## -

## binaddress

## 读取库位状态的 modbus 地址位

## 库位监控-属性-binJson

## uint16_t

## 0

## 65535

## binholderaddress

### 读取库位所有者的 modbus 地址位，不用的话写 0

## 库位监控-属性-binJson

## uint16_t

## 0

## 65535

## binname

## 库位名称

## 库位监控-属性-binJson

## string

## -

注：binholderaddress：用于多个系统同时操作的库位，如，人和机器人都会卸货的库位，或者多个系统控制的机器人都会卸货的库位。标识 core 能否操作当前库位。如果只有 core 操作库位，将 binHolderAddress 配置为不用的地址即可，推荐配置为 0。

1）点击 Monitor-01，右侧出现 binJson。

1703558767321-c0b989c6-60cd-453f-97c6-6507cff3b425.png

2）binJson 是配置库位的一些参数，我们要根据项目的实际情况正确填写 binJson。只要使用到库位监测的库位都需要配置 binJson，binjson的构成如下

下面写出一个和多个库位的配置示例。
## 示例 1：设置一个库位
## {
  "binareaname": "PT", // 库区名为PT
  "binholderaddress": 0, // 从地址位0中读取库位占用者信息
  "binaddress": 1, // 从地址位1中读取库位状态
  "binname" : "Loc-1-1" // 库位名称为Loc-1-1
## }
## 去掉注释的代码
## {
  "binareaname": "PT",
  "binholderaddress": 0, 
  "binaddress": 1, 
### "binname" : "Loc-1-1"
## }
将去除注释的代码复制，点击binjson右侧的编辑按钮，将其粘贴到 binJson 中，如图所示

1703561555365-12ae9513-6842-4443-a562-69b923d930bb.png

## 示例 2：设置多个库位
## [
## {
        "binareaname": "PT",
        "binaddress": 1,
        "binholderaddress": 0,
### "binname": "Loc-1-1"
    },
## {
        "binareaname": "PT",
        "binaddress": 2,
        "binholderaddress": 0,
### "binname": "Loc-1-2"
    },
## {
        "binareaname": "PT",
        "binaddress": 3,
        "binholderaddress": 0,
### "binname": "Loc-2-1"
    },
## {
        "binareaname": "PT",
        "binaddress": 4,
        "binholderaddress": 0,
### "binname": "Loc-2-2"
    },
## {
        "binareaname": "PT",
        "binaddress": 5,
        "binholderaddress": 0,
### "binname": "Loc-3-1"
    },
## {
        "binareaname": "PT",
        "binaddress": 6,
        "binholderaddress": 0,
### "binname": "Loc-3-2"
## }
## ]
点击binjson右侧的编辑按钮，将其粘贴到 binJson 中，点击保存，如下所示：

1703561604730-8990079f-0149-41b1-8e2f-80fa0fb6dd81.png

3）根据需要选择一个库位或者多个库位的样例，将以上四个字段都配置为适合自己场景的内容，填入正确的 binJson。本示例用到了多个库位的样例，因为 PT 库区有 6 个库位在 Monitor-01 中。
## 库位监测的属性解释
## 对于右侧红框中的属性配置做以下说明：

1703559180394-b09018c7-bd80-4b76-82d5-eb939c88e18f.png

## binJson
前文已做描述。
## funCode
读取库位状态的 Modbus 函数号。使用 modbus slave 测试时，funCode 和地址类型的对照表（配置路径：setup—salve definition），本案例 modbus slave 的 function 为 02 功能码，根据对照表，roboshop 的 funCode 需要填入 2：

1703571856656-9af15ed9-ac53-480e-b203-c0bc26852e28.png

## funCode

## Function

## 1,3

## 01 Coil Status

## 2,4

## 02 Input Status
## proxyName
代理名称，和左上角红框处的模型文件配置的要一致，本示例我们使用 proxyOne。
## reverse
取反；正常 1 是库位占用，取反后，0 是占用，我们默认用 false。
## 1.3 配置模型文件 proxyOne
1）点击模型文件，找到“proxy”，点击 proxyOne。
2）在右侧勾选“启用设备”，type 默认是 ModbusTCP，按照如下方式配置其他内容。

1703559362051-7f7d3259-0cb8-4b37-82eb-c857b30fb69e.png

3）保存并推送模型文件。
4）切回到调度编辑器，退出编辑，保存并推送场景文件。

1703559503145-b11b32b7-1688-4ab3-aa85-84f0cd9c9dcb.png

### 二、RDS 配置光电
### 2.1 点击设置进入 RdsCore 配置

1703555739342-30236a1d-8e69-4022-88e0-4553562d2043.png

### 2.2 配置 RdsCore 参数
Core 连接地址： http://127.0.0.1:8088
### Core 同步间隔时间（ms）：默认700
### 下载场景读取超时时间(ms)：默认20000
### 库位监测同步方式：NONE、ALL、GROUP
## 库位监测同步间隔(ms)：默认2000
## 库位监测同步库区：会获取系统内所有库区
### 2.3 选择库位监测同步方式
1703555766138-8d2344e7-fc60-4e30-8031-04ea26918603.png

## 选择 NONE
表示没有光电(不用配置光电)。

1703555779268-e4da0987-0c5c-4835-8a7d-dc085ad81afa.png

## 选择 GROUP
那么在库位监测同步库区栏选择库区，支持多选。

1703555797470-167a362a-d8d2-4cb3-a9e5-f90632ec0e36.png

## 选择 ALL
默认所有的库区设置光电检测。

1703555839589-50890d6c-4d00-4a4d-98e6-59b92b7a2e74.png

此案例选择 group，选择库区名：PT。配置完点击 保存 按钮，保存后，重启 RDS，配置生效。
1703555919050-a2395494-5766-4685-8460-9347ec0689c0.png

注意:RDS 配置光电检测的库区需要和 Roboshop 设置的库区名相对应。
### 三、使用 postman 进行检测
### 3.1 根据库区名查状态
在 Postman 中发起一个 GET 请求，URL 如下，点击 Send，会得到 core 的回传。
GET http://127.0.0.1:8088/binDetails?binGroups=PT
1703568494418-d326615d-c5cc-4c01-a742-6fbf8ee564f7.png

### 3.2 返回内容的字段含义
1703560911519-21f42c56-8b16-4954-992a-dc0fbf0c1051.png

postman 中，看返回结果，status 为 0 表示与库位连接正常。
### 3.3 现场配置光电失败的样例
设置光电的库位会显示同步失败， 则导致脚本中调用“查询库位”方法时，无法得到库位 。
1703556832615-5e2077df-80ad-4119-b8a7-891f6a94d777.png

### 四、Modbus Slave 测试
由于该案例没有真正的光电监测设备，因此我们可以用 Modbus Slave 做模拟测试。
### 4.1 连接 Modbus Slave
1）依次点击 connection-connect。
1670555359436-34c658da-1337-412c-8eba-188b361c1a98.png

2）输入正确的 ip 和 port，与 Roboshop 中 proxyOne 的配置一致（见1.3），点击 OK。
1670555379005-bbbd02d1-19d1-4ffe-9ea1-6c9d725d5d33.png

### 4.2 测试
## 1）前面 1.2 的设置多个库位样例中
## {
        "binareaname": "PT",
        "binaddress": 2,
        "binholderaddress": 0,
### "binname": "Loc-1-2"
## }
我们知道 binaddress 为 2 的库位是 Loc-1-2，我们将 Modbus Slave 中的 2 号地址位的值改为 1。

1670555393318-bf71c333-e277-4c73-8e30-2c7930d834b9.png

2）到 RDS 网页端的库位页面，查看 Loc-1-2 的库位是否改为了占用状态。

1703568651076-fa171f5f-d873-43c5-981b-a562e4017a40.png

3）可以看到变为占用状态，且库位页面，同步失败列全为否，则表示光电同步，且可以根据监测情况修改库位占用和未占用状态。

至此，光电配置成功。
