# Linux 热备

## Linux 热备
## RoseMirrorHA7.0安装：
安装配置以及后期维护具体细节可以查看文档： RoseMirrorHA7.0 安装配置维护(Windows&Linux)-2020-v1.4
下文均为 RDS热备配置方法。

## 一、 安装环境准备：
1． 活动主机、备用主机（两台服务器都需要是双网口）两条心跳线 ：
1670565046163-a35f5f13-a0eb-4e13-96ad-8349503f87e2.png

## 2． 操作系统配置要求：如下图

1670565078201-81db487a-0f05-4456-ae25-ce8f799ef241.png

### 二、 应用安装： RDS（参考我司RDS配置文档对其进行安装配置）
## 应用以 RDS为例：
## 1.  主备机安装的应用软件版本需要完全一致 ：
### 2.  主备机应用软件需要安装在完全相同的路径下，配置方式、参数、密码等要完全一致 ：
### 3.  将应用开机自启动设置为手工方式（由 Rose控制启停） ：

### 三、 RoseMirrorHA安装配置：以Ubuntu18.04版本系统和应用软件RDS为例；
1． 安装 RoseMirrorHA （ Ubuntu 18.04 ） ：
（1） 主备服务器均需要安装 RoseMirrorHA（无顺序要求） ；
（2） 先下载 Ubuntu安装包，进行解压；
1670565445721-a78156df-2a6e-4f1d-8f2b-5fe6c961f9f1.png

（3） 打开终端命令窗口输入命令；
a． cd RoseMirrorHa-7.2.0-2830.220722-DEB18-x86_64（进入到解压后的安装包内）
### b． ./install（执行install文件）
c．（安装过程中，选择3：all继续安装），注意选择3后回车，此时会进入一个配置文件，按下Esc键，输入 :wq , 退出配置文件；
d.此时会要求输入Your name 及 Company nane,此时按两次回车即可；
1670567733736-fb536c4a-1aa7-4e1e-92fa-cb641a611063.png

### 2． 打开 RoseMirrorHA控制中心：
（1）双击服务器桌面上的“访问RoseMirrorHA”；
（2） 通过浏览器访问： http://服务器IP:9999
（3）默认账号：webadmin 密码：webadmin；
（4） 支持的浏览器，如下图 ；
1662617415264-142dc532-67f2-4fff-a3b6-df4a2f6ef563.png

### 3． RoseMirrorHA中添加两台主机：
（1） 登录进入 RoseMirrorHA ：点击右上角 “菜单”-->“主机管理”-->“添加主机”；
（2） 添加主机 IP-->连接-->密码：admin -->确定；
（3） 主从两个主机都需要添加；
1670569436167-b2fad37a-c5a6-4f51-b652-51623870b61b.png

4． 开始创建方案：初次创建方案，界面上会显示 “开始创建方案”，点击进去配置向导。
1670569534017-f9972de4-3515-4c88-8349-4a01d74b6c1e.png

## 5． 方案向导：
（1） 点击 “下一步”，进入配置向导 ；
## 6． 选择活动服务器：
（1）选择 “步骤3” 中添加的主机，做为活动服务器；
1670569647978-1e794511-0930-4f2f-a58c-f2d1cf385dfc.png

## 7． 选择备用服务器：
（1） 同 “选择活动服务器”配置一样， 选择从机做备用服务器；
1670571365147-afd77011-0573-4a17-aff3-12ed4e13b70a.png

## 8． 设置注册码：
（1） 复制主备服务器的主机 ID 号 ，给供货商，申请临时或者永久授权
（2） 点击 “注册码”，导入授权文件 ；
1670571673742-f49d8635-39cf-4b9c-a824-721b257f88c3.png

## 9． 配置链路：
（1） 点击 “添加链路” ；
1670571892339-943a7b7b-d67e-41c0-a042-d73ddc103713.png

（2） 选择用于心跳和数据镜像的 IP链路地址，建议添加两组链路地址 ；
1670577575199-4a672b2b-b103-4d1c-8bcb-f9a3625c65ef.png

（3） 完成配置心跳和数据链路 ；
1670578334453-c5339dfd-ae1c-4fb9-a04c-4108d0599032.png

### 10． 应用类型：选择 UserDefine ：
1670578409158-fc20ec11-527f-43f3-b2ac-924509d62851.png

## 11． 绑定数据：
（1） 选择 “修改”进入绑定数据集选择 ；
1670578589149-66aeace9-f495-4028-9ee3-c98fb941b795.png

（2） 选择需要进行实时复制的文件或者文件夹：下图是 RDS需要选择的数据 ；
1670579147398-2fd5262b-d59f-4823-abd1-dfa1869163a9.png

（3） 选择完成点击 “确定”后自动勾选数据集，RDS绑定的数据集【如下图】 ；
1670579107037-ec271cd6-1f79-4c9f-b649-fa2d748aac18.png

## 12． IP资源：
（1） 点击 “添加”，进入配置界面 ；
1670579256632-114d4202-1b26-40af-b7ee-0bc73e537be1.png

（2）在“网卡”处，勾选挂载活动IP的网卡；
（3）在资源处，输入活动IP地址和掩码（例如主机IP为192.168.6.12，备机IP为192.168.6.13，则活动IP自定义为局域网内未被占用的IP如：192.168.6.xxx）；正常启动后，无论主机还是备机在工作，对外的IP均为此处配置的活动IP；
## 注：如果需要可以添加多个IP资源
1670579393719-3aed6fdb-6af1-4b8f-bc6e-2dc0640d1207.png

## 13． 脚本 资源：
### （1）添加监听端口、启动脚本、停止脚本：
TCP监听端口：8080;8088;
### 启动脚本：msql_start.sh；（路径如下图）
### 停止脚本：msql_stop.sh；（路径如下图）
1670579602169-e7b3215f-5da0-4a17-a84c-cfae78e678c3.png

14． 最后到 “配置详细信息”页面可以对照查看绑定的数据，然后点击“完成”完成方案配置 ；
1670579810738-7432fa6b-a216-42ff-9a65-32a6fecdca4f.png

### 四、 启停脚本、core、rds配置：
## 1、Core：主从切换、控制权抢占配置（主从两台服务器中都需配置）：
（1） Roboshop连接主从core --> 机器人模型 --> ServerHardwareld；
（2）ServerHardwareld中配置两个服务器的机器人ID（core高级配置中可以查看到服务器的机器人ID）；
1662618644022-9d5579a6-9cdd-48ed-baac-4c6688aed422.png

### 2、Rds中配置任务恢复功能（主从两台服务器都需要配置）：
（1） 在 application-biz.yml文件中进行配置；
## #  是否开启重启恢复任务功能
### restartRecoverConfig:
### #  true为开启，false为不开启
### restartRecover: true
1662618701047-8b2dc647-5182-43b6-8a38-9a31ac639784.png

### 3、启停脚本配置；（主从服务器都需要配置）：
（1） 启动脚本；
## a． 打开图片位置中的启动添加以下内容
### sleep 20 （数据库启动预留时间）
sh /home/sr/Desktop/start.sh &（执行指定路径下的RDSCore启动脚本）
### sleep 15（执行RDSCore启动脚本预留时间）
1662618838531-20922623-42cc-4a6b-8e5d-18e907bf317b.png

（2） 停止脚本；
### a．打开图片位置中的停止脚本添加以下内容
sh /home/sr/Desktop/kill.sh （执行指定路径下的RDSCore停止脚本）
### sleep 15（执行RDSCore停止脚本预留时间）
## sync
1662618875973-8f8de5a2-0f20-454e-8115-0f1b4d67af5f.png

## 五 功能按钮使用说明：
## 1、主菜单栏：
1671177749920-7d3c8806-2540-4aed-8d85-a43aba984a26.png

## 添加方案：进入本地配置向导
### 注销：退出Web登录，进入Web登录界面
## 语言：中英文切换按钮
## 恢复：创建恢复任务
## 在线日志：查看在线日志
菜单：授权管理（服务器授权入口）、主机管理（增加修改主机）、修改密码（修改登录密码）、帮助（Rose帮助文档）、关于入口（查看rose版本信息）
### 2、应用服务操作栏：
1671177787168-bc03a13b-1d10-47b3-815e-b361ee1b14fa.png

带入：主机会启动活动IP、启动业务系统、数据开始同步（备机应用会自动停止）
### 带出：主机会停止业务系统、停止数据同步，停止活动IP
## 切换：资源组从主机切换到备机运行
## 离线：Rose会停止该资源组的监控
修改/查看：常规（应用服务的名称、类型）、数据（能够修改绑定需要传输的数据）、策略（配置应用服务切换的策略）
更多操作：选择数据源（当两台服务器数据不一致时，选择数据源的同步方向）、交换主机位置（主从机调换显示位置）、删除资源组、强制启动
## 六 常见问题及操作说明：
## 1、问题1：因主从服务器IP改变，导致网卡异常，rose无法正常使用；
（1）：选择对应主机-->更多-->更新网卡信息（两台服务器均需要进行次操作）
1671177946028-2e723410-abcf-488c-b6d9-1fec0d4cfe0e.png

（2）：选择对应主机-->操作（链路配置）-->点击修改按钮
1671178326214-20371be0-a77a-4249-b613-ac95ba60c602.png

（3）：点击IP地址下拉选框，点击改变后的IP，最后点击确定
1671178479087-9815f7b6-cd89-4214-b51e-d4b3c116b1ac.png

### （4）：选择应用服务-->操作（链路配置）-->点击修改
1671178633492-dbdeb774-b856-49cf-93ce-5dd51e487b7c.png

（5）：点击IP地址下拉选框，点击改变后的IP，最后点击确定
1671178751657-4239c0b1-0dd8-4e9d-b68e-f88003b63c17.png

### 2、操作1：修改活动IP；
（1）：先带出-->选择应用服务-->选择IP资源-->点击操作按钮-->点击属性；
1671179189181-a23cee22-773e-4bde-b911-e3ecc52f7f1f.png

（2）：修改IP地址、IP掩码，最后点击确定；
1671179339524-5c9bdf4d-3080-4762-826f-42bbf955103d.png
