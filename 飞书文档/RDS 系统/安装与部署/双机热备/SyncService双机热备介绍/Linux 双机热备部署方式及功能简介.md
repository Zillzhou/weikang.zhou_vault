# Linux 双机热备部署方式及功能简介

## Linux 双机热备部署方式及功能简介
## 一、功能简介
1696831232316-bbe24e18-bc5c-42d3-a43e-2b23858f3c7f.png

双机热备能完成 RDS 两台服务器之间实时的数据同步，包括 RDS数据库 、场景文件、配置文件等。同时，它可以在主服务器发生故障时实现人工或自动切换到备份服务器上继续任务，确保数据的安全性和任务的连续性，而用户使用时无需关注哪一台服务器作为主服务器，以及当前主服务器的ip地址，只需要通过配置好的公共IP访问服务即可。
对于Ubuntu操作系统，主要通过可执行文件SyncService_linux来实现文件的实时同步和服务切换，同时需要通过Ubuntu系统中的相关设置选项来配置公共IP。
### 二、环境要求
## 环境要求

## 环境要求及预安装软件

## 说明

## Linux

## 目前支持 Ubuntu18.04

## RDS及双机热备的相关程序

### 已完成预安装 默认目录：/opt/data/
### 双机热备需要两个RDS程序，需要申请两个RDS旗舰版授权

## 两台服务器

分别作为主备机 建议使用规格相同的服务器 每台服务器需配备双网卡

## 四根网线及四个及以上空闲端口的交换机

## 用于服务器之间的连接和局域网的配置

### 需开放端口：8384、 22000、 21027

该组端口分别用于图形界面登录、文件传输、设备发现，若服务器防火墙需保持开启状态，则需在两台服务器上均开放上述端口

## ip配置：

## 1.主机IP：主服务器本身的IP
### 2.备机IP ：备用服务器本身的IP
### 3.公共IP： 与外部设备、AGV交互的公共IP，该IP会浮动于主机和备机之间
## 三者IP的网关和子网掩码需相同

### 2. 安装方式
Linux 下的双机热备目前支持两种方式的安装和部署：服务器预安装和 iso 镜像安装，其中服务器预安装指的是所有相关的系统和软件已在出厂的服务器中完成了部署，用户可直接使用该服务器进入系统操作，只需要在现场配置公共ip等参数以及 SyncService 数据同步即可完成部署。
镜像安装指的是客户在现场服务器中安装仙工提供的 Ubuntu 双机热备镜像文件并进行激活，通过该方式安装时，RDS 以及双机热备相关的软件已经在镜像中进行了预安装，部分的配置工作也已经完成，在按照下文第3小节的方式安装好镜像后，同样在现场配置公共 ip 以及 SyncService 数据同步即可完成部署。 注：目前仅支持Base包中默认安装的Mariadb数据库。
以下介绍镜像安装的安装步骤。
### 三、安装步骤
## 1. 镜像安装
rds 双机热备系统 ISO 镜像共有两份，主机和从机，镜像是基于 Ubuntu18.04 做的定制版本，自带 Systemback 工具进行安装，请注意及时备份您系统硬盘上的重要资料，系统安装将会清除硬盘上的所有文件，之后按照以下步骤进行操作。
第一步：以戴尔的T140 T150为例（目前主要部署这两种型号的服务器），将 ISO 镜像以任何支持的方式安装，刻录光盘，或者使用 SyncService ISO 镜像制作U盘启动盘进行安装。
ISO镜像启动盘启动系统安装后，首先进入系统安装界面，输入默认用户名称，及 root 密码，并以 node1 为例设置hostname ，hostname 字段后续还需使用，建议以相关联并容易区分的名称命名，如 node1，node2 或者用其他易分辨 的名称给 rds 这个两台主从服务器 hostname 命名。
1695275269217-61b04043-a696-4761-840b-269e80f87bf5.png

第二步：点击 "Next" 进入下一步分区界面，示例以 1T 硬盘为例进行分区，请根据使用的实际硬盘大小设置分区(如果是全新的硬盘没有进行过分区，请直接跳转到第4步)，下图中 dev/sda(1-5) 是需要重新分配的区域，总可用大小 931.51GB，不同电脑的名称以及序号、数量都可能不同，请根据硬盘大小或者实际名称来区分。图中 /dev/sdb 是 U盘，因为本示例是通过 U盘 安装的系统所以此处显示有 U盘，总可用大小 58.59GB，注意不要在 U盘 上进行任何操作。
1695275269974-3a7e582a-e2f7-4771-b14d-f4ab4aee82a2.png 

第三步：分别点击 图 中 /dev/sda1 ~ dev/sda5 选择右侧操作菜单中的删除按钮 !Delete!，操作完成后，5个 分区将合并成一个新的分区 /dev/sda?，如下图，总大小 931.51GB 未分配的硬盘。
1695275270709-ec4f62ba-aa3d-457c-aa14-a4c7fbea0ed8.png

第四步：点击 /dev/sda? 所在行，右侧会显示 Create new 字样，修改分区大小为 512MiB 后，点击绿色左方向箭头，表示分配一个 512MB 大小的分区，之后就会在左侧多出一个 /dev/sda1 大小 512MB 的分区。
1695275271329-95b3174f-b3c2-4434-964c-47d183285664.png 

1695275272137-3911eee4-4099-4db9-9480-f2355efa00e8.png

第五步：按照上一步方法再次点击左侧 /dev/sda? 继续创建分区，需要创建其余 4个 分区，加上上一步创建的分区，总共 5个分区，大小分别是 512MB，256MB，32GB，100GB，和剩余全部空间(此处示例剩余是 798.76GB，当剩下最后一个分区时，分配时不需要在右侧 Create New 输入分区大小，直接点击绿色左方向箭头即可将剩余全部空间分配到最后一个分区，即 /dev/sda5)，如下图所示，分配了 5个 区域就不再有 /dev/sda?。
1695275272828-c98e1c7d-f3bf-47ac-a855-59aa37577d2b.png 

第六步：点击 /dev/sda1 512MB 分区，在右侧 Mount point 下拉框选择 /boot，点击绿色左方向箭头便把 sda1 分区分配给 /boot 系统引导分区，如此分配剩余 4个 区域，256MB 给 /boot/efi EFI系统分区；32GB 给 SWAP 系统内存扩展分区，此分区一般是系统内存的两倍，示例服务器内存是 16GB，因此此处分配 32GB 给 SWAP 分区；100GB 给 /home 分区；剩余分配给 / 分区，由于 rds、core等系统服务均使用的是 / 分区，不占用其他分区，所以尽可能分配大一点，如果服务器需要在 /home 分区安装 rds 之外的其他应用，也可适当调整 /home 分区的大小，根据实际应用情况分配 home 和 / 的比例即可。 
1695275273438-2add6bf6-5134-4927-b23a-dd70588f7279.png

1695275273962-14c42332-7320-4ea2-8ec8-87ef25bb4048.png 

第七步：调整之后的效果如上图所示，接着在 上图 中左下方勾选 Transfer user confguration and data files ，注意是对勾样式(此处存在其他勾选方式，注意甄别)。点击 Next 后，进行最后一步安装操作，点击 Start 开始安装，如下图所示。
1695275274642-e50d53ff-a8d8-47ca-ac0c-1f1199f506bb.png

安装结束后，重新启动服务器即可。

## 若有收获，就点个赞吧

## 2 环境配置
## 静态 IP 设置
rds 主从服务器必须使用静态 IP 互相访问，且每个服务器最少需要两张网卡，一个用于心跳检测以便主机下线后主备能够快速切换；另一个用于对外业务，访问 rds 和 Core。
网卡1(ens33)，用于心跳监测，推荐使用一条网线将主从服务器直连，以降低网络带来的问题。
网卡2(ens37)，用于业务访问，作为公共ip，为主从服务器提供网络服务。
rds ISO 镜像是 Ubuntu18.04 桌面版，修改静态 IP 可以在"设置"界面进行操作，设置相关参数。
1695275275197-6c181e70-2c28-466e-b099-f3eecafa6a46.png

注意：两张网卡均需设置。完成后，在另一台服务器重复以上 IP 设置步骤。
## 测试网络连接
重启两台服务器，使用 ping 命令，每台服务器使用两次 ping 命令，分别 ping 网卡1 IP，网卡2 IP ，查看能否互相访问。任何一次访问失败，则检查以上步骤是否出现错误，重新设置重启服务器测试。
## 修改网络配置文档
找到安装rds的目录，默认为/opt/data/rds/app，打开当中名为IpAddress的文本，将当前主机配置公共ip 的地址，子网掩码，网卡名称填入其中，使用“/”分割，注意，填入的子网掩码为转换成二进制后1的个数。例如，当前配置好的静态公共ip为192.168.114.108，子网掩码为255.255.255.0，转为二进制后为 11111111.11111111.11111111.00000000，共有24个1，网卡名称为ens37，则在该文本中填入192.168.114.108/24/ens37。最后点击[Save]保存。
1695275275657-acb73b5e-90d5-4448-9167-a9c41aae02ad.png

## 文件夹权限更改
找到rds的安装目录，默认为opt目录，在opt目录中打开控制台，输入指令
sudo chmod -R 777 *，将opt下的所有文件夹及其子文件夹的权限开放，防止因为权限问题造成的文件同步失败。
1695275276007-64af710a-50cb-4291-9a19-29249ca37685.png

### 2.进入mariadb存放数据库的目录，默认为/var/lib/mysql，同样输入指令 sudo chmod -R 777 *，开放该目录下的文件夹操作权限。
1695275276313-bc28906d-1781-4222-a705-dcde4be82baa.png

## 3 SyncService 数据同步
## 准备
其他所有同步数据相关文件，全部由同步工具 SyncService 来完成，SyncService 已预安装到主从服务器镜像中。在正式使用前，请确保主从两台服务器均可以通过 http://node-ip:8384 访问 SyncService，之后按照以下同步配置过程进行设置确认。
## 添加同步设备
首次配置同步服务时，需要在主从 SyncService 页面上添加将对方添加为要同步的设备。以 node1 的 SyncService 为例具体操作如下。
点击 SyncService 界面右下方的添加远程设备，在弹出框中设备列表中点击选择 node2 服务器的设备 ID (设备 ID 在 node2 SyncService 右上角菜单栏中的"操作"中可以看到)，并输入设备名 node2，此时 node1 便将 node2 加入到自己的同步服务中，点击保存。
1695275276626-84054997-17bc-42aa-bead-9b6dffd36afa.png

切换到 node2 服务器的 SyncService 界面会看到一条来自 node1 的同步请求，点击"添加设备"将 node1 添加到 node2 同步服务中，输入设备名 node1，直接点击保存。
经过以上添加设备操作后，可以在 node1 和 node2 两个节点的"远程设备"中看到对方已经加入到本地同步服务中。
1695275276965-70b2af00-ee70-471b-ab00-cee7cd3e1a2e.png

## 添加公共ip
点击右上角“操作”→“设置”→“连接”，在“公共ip”处填入此前配置好的公共ip地址，最后点击“保存”。
1695275277323-22fe31c8-1769-4a3f-a08d-aa74f6a3050b.png

## 同步数据
浏览器进入同步工具 SyncService 应用界面，按照以下步骤手动添加同步目录。
## 添加 rds 配置文件
点击"添加文件夹"按钮，首先出现的是"常规"选项卡。其中的"文件夹标签"，即自定义文件夹的名称，如 biz，表示这是 rds 的 biz 配置文件；"文件夹 ID"，设置同步文件夹的唯一 ID，默认已经生成好了，不需修改；"文件夹路径"，指定要同步的文件夹路径，rds biz 配置文件是固定路径，为 /opt/data/rds/script。 
1695275277678-c3c4f27f-7e89-4c02-87ad-3058d147b8f3.png

点击"忽略模式"选项卡。
1695275277998-716ff02d-ad10-4ad6-93fe-2596f738ba41.png

点击"保存"后，会返回到主界面，在 UI 界面上点击 "biz" 文件夹，点击"选项"。
1695275278345-e06e29d9-da88-4c4d-a74c-6956e3c587a6.png

### 点击"共享"选项卡，勾选要同步的目标服务器
1695275278699-3ff6a5c1-8bc6-4579-b470-ef982782d78d.png

点击"高级"选项卡。在"文件夹类型"中选择"发送与接收"，勾选"同步所有权"，点击"保存"完成设置。
1695275279034-1ec4dc6e-a061-425a-b666-118046aec653.png

上一步保存后，切换到另一台服务器的 SyncService 界面，Web 界面将会弹出共享界面(图24)，点击"添加"后，按照以上4个步骤同样设置这台服务器的文件夹。
1695275279397-9a6defb2-2949-4f4b-8fe0-143d10cabe20.png

## 添加 core 同步文件
同 rds 配置文件的同步设置，增加 core 的同步目录 /opt/.data/rdscore/resources/， 对core文件夹进行共享时，需要在忽略模式中填入 lservrc。即不对该文件进行同步。该文件为激活 权限相关的文件，每一份主机中该文件需保持唯一。
1695275279739-5e83e7b6-1ceb-4d56-a2b6-714279b6a189.png

## 添加 mariadb 同步文件
同 rds 配置文件的同步设置，增加 mariadb的同步目录 /var/lib/mysql/，以此来同步rds的数据，该文件夹中的文件都需要同步，无需使用忽略模式。在"文件夹标签"中可将该目录定义为rds。
设置完成后， core 和 rds以及 的配置文件显示如下就表示配置正常，其中 biz 为 rds 配置文件 application-biz.yml 目录 /opt/data/rds/script，core 为目录 /opt/.data/rdscore/resources/。rds为目录/var/lib/mysql/。
1695275280027-fd57bed5-9808-4238-b0d3-2864d6a8806b.png

## 设置任务重启恢复
当两台主机都完成上述配置后，先完成配置的服务器会在约五分钟后自动开启rds服务（也可在此之前手动启动rds服务），此时将开启同步，该服务器会自动被标定为主机，另一台服务器在接收到主机同步的文件后会自动标定为备机。当主机断电或者关机时，备机约在几分钟后自动启动rds服务，继续完成此前主机中未完成的运单任务，并同步主机的相关数据。 由于rds中正在执行的天风任务在关机重启后默认将变为重启异常的状态，在备机切换服务后，无法继续执行此前主机中已经下发而未完成的任务，因此需要在主机开启rds服务后，更改相关配置。
具体步骤为，在启动rds相关服务并对备机开启同步之后，在主机浏览器中输入地址127.0.0.1:8080进入rds操作界面，随后进入当中的“设置”选项，找到重启恢复的相关字段“restartRecover”，将其更改为“true”。通过这样的方式，能够确保在主机中未完成的任务同步到备机之后能够继续执行。

1695275280403-440e07e7-dd3a-4cfc-bfa2-8c4b22a46140.png

## 4 验证
完成配置并启动同步服务后，可以通过已配置好的公共ip访问 rds 主页查看是否正常，至此 rds 双机热备服务配置已全部完成。

### 四、在SyncService中配置公共IP

1.主机和备机完成上述配置后，皆启动RDS，通过roboshop连接并获取各自的机器码，完成相关授权后，分别进入主机和备机的RDS设置菜单栏，在配置中勾选restartRecoverConfig选项并点击保存按钮，使得天风任务能够在重启后自动恢复。
1708666476314-11a89d51-4d2b-4c50-90a1-5a0c24cb127e.png

2.主机和备机皆重启系统，在主机重启后使用管理员身份打开控制台，并启动RDS（ 备机不需要启动RDS ）。同时在shell控制台输入“ifconfig”指令获取当前服务器两个网口的ip信息，记录网口2的子网掩码和默认网关。 
## 示例如下所示：
1708667023236-49641420-e40e-4c3b-a4cc-1c5356dfcacf.png

3.打开浏览器输入127.0.0.1:8384，进入双机热备的UI操作界面，找到“网络配置”按钮点击并进行编辑，将预先约定好的公共IP地址填入第一行，将上一步中网口2的子网掩码、网口名称、网关信息依次填入下面三行，最后点击保存。然后在备机中进行同样的操作：在UI界面的“网络配置”中填入相同的公共IP地址和备机网口2的子网掩码、网口名称和网关。 
1708667468933-ea98401b-6073-4af9-9b28-8f249c6de1e1.png

4.完成上述配置后，在主服务器的 UI操作界面点击“初始化公共IP”，则之前配置好的公共IP会自动分配到主服务器的网口2上（ 备机不需要执行此操作，该公共IP会在主机服务关闭，备机启动服务之后自动分配到其网口2上 ），此时可通过在浏览器中输入“公共ip:8080”，测试是否能够通过该公共IP进入RDS界面。若无法通过测试，则需要从IP冲突、网络配置是否正确、交换机与主机的接线等方向进行排查。 
1708667828453-87f7624e-54f2-4570-aa5d-b8762b2e92c1.png

5.完成上述配置后，右上角点击操作→设置→连接，在远程设备地址一栏，填入另一台主机的网口1的IP（ 注意填入的不是本机的IP，若此时在主机上操作，则填入备机网口1的IP，若此时在备机操作，则填入主机网口1的IP ），在公共IP处填入此前配置好的公共IP地址，最后点击保存， 主机和备机都需要进行该步骤的配置 。通过该配置双机热备应用便能够永久记录远程设备的IP地址及公共IP地址，无需在重启后重新配置。
1708668658841-f21421ff-5f79-4afa-8a24-5e9946402057.png

### 五、在SyncService中进行文件同步
1.点击右下角“添加设备”，若此时网络连接正常，则弹出的界面会显示出备机的设备ID，选中该设备ID，点击“保存”。此时在备机的UI界面中，会显示主机的请求信息，点击添加即可。 
1694582736311-71a55511-9166-46ea-b9c9-5bc776aef168.png

1694582736589-3a9a6441-b5bb-4a05-9b00-5b8457db92e6.png

2.进入备机的mariadb目录和core目录，默认为C:\RDS\data\mariadb-10.6-winx64\data、C:\RDS\.data\rdscore\resources，将当中除lservrc（在resources目录下，此为授权文件）的所有文件删除，为同步做准备( 当前运行RDS服务的主机无需进行该操作 )。 

3.进入主机的双机热备操作界面，点击“添加文件夹按钮”，将文件夹标题设置为“RDS”，将Mariadb目录下的data文件夹的路径（默认为C:\RDS\data\mariadb-10.6-winx64\data）填入其“文件夹路径”。 
1708669694087-3e73f006-e9bb-4d95-ac84-6ee033615a18.png

### 4.在上述界面中，点击“共享”，勾选备机的设备名，然后点击忽略模式，勾选增加忽略模式。
1708670270920-ad325b0f-c062-4cb6-9a7e-314e29c01ece.png

1708670251211-27b74e47-b3ea-40cd-9823-fe9d7e4c0aa0.png

### 5.在上述界面中，点击“高级”，勾选“同步所有权”，“发送所有权”以及“忽略文件权限”。将“文件拉取顺序”调整为“新文件优先”，点击“保存”。
1700793070503-b603efbe-2b8a-4d20-861c-8e7ec3e45c5e.png

在弹出的忽略模式中，输入mariadb_error.log，最后点击保存。 该文件为数据库日志文件，需保持唯一，因此无需同步该文件 。 
1708670373609-b02ead0c-eda6-4394-919d-f06021417edd.png

6.确认本机Core的路径，默认为C:\RDS\.data\rdscore\resources，以及RDS脚本及配置文件所在路径，默认为C:\RDS\data\rds\script。重复上述操作，将Core的文件夹以及RDS脚本文件夹共享给从机。 
当对core文件夹进行共享时，同样需要在忽略模式中填入lservrc 。即不对该文件进行同步。该文件为激活 权限相关的文件，每一份主机中该文件需保持唯一。 
1695274795780-562b575b-67d4-41d0-8b80-17c142965f05.png

### 7.打开从机SyncService的UI界面，若网络连接正常， 则会出现三个请求弹窗，该弹窗即为主机将文件夹共享给从机的请求。
1694582737887-f509d8a2-bad6-4e07-9e57-16945297490e.png

依次点击“添加”按钮，填入备机各个文件夹对应的路径，确保接收的文件夹路径与主机相同，并按照主机配置文件夹参数的方式，点击“高级”，勾选“同步所有权”，“发送所有权”以及“忽略文件权限”。将“文件拉取顺序”调整为“新文件优先”，同时针对RDS和Core的文件夹同步，同样在忽略模式中进行勾选中之后，对mariadb_error.log和lservrc进行忽略，最后点击“保存”，便完成了文件同步。 

### 六、其他功能说明
1.开机自启服务：在按照上述说明完成对两台服务器的配置后，则默认开启开机自启RDS服务的功能。触发条件：两台服务器都因断电、宕机等重启，则先重启的服务器会再开机后一分钟内自动开启RDS和双机热备等服务，后重启的服务器则自动作为备机。 

### 2.更改服务切换条件：
在备机syncService右上角点击操作→设置→更改服务切换条件，可将服务切换条件更能改为RDS\Robod,则切换服务的条件变更为：当主机rds或robod服务发生崩溃关闭时，备机便切换服务，无需等待主机宕机或断电才会自动切换服务（默认情况下无需点击）。 
1708672025842-65642d24-07ca-4745-934d-5e4757195f01.png

3.手动切换服务：点击该按钮可实现手动切换服务（在当前两台服务器RDS服务都停止运行的情况下才生效）。当正在运行RDS的主机发生断电、宕机关机时，通常情况下备机会在自动切换服务，无需点击该按钮，若此时由于诸如网络通信异常等情况，备机没有自动切换服务，或者因为某种原因需要主动的在备机上继续运行RDS服务，则在确保主机RDS服务关闭后，可通过点击该按钮一键启动RDS相关服务。 
1708672669845-07526876-d860-4754-82f4-1bc9fef4d30d.png
