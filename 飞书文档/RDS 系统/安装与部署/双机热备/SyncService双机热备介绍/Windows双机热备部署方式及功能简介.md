# Windows双机热备部署方式及功能简介

### Windows双机热备部署方式及功能简介
## 一、功能简介

1696831232316-bbe24e18-bc5c-42d3-a43e-2b23858f3c7f.png

双机热备能完成 RDS 两台服务器之间实时的数据同步，包括 RDS 数据库 、场景文件、配置文件等。同时，它可以在主服务器发生故障时实现人工或自动切换到备份服务器上继续任务，确保数据的安全性和任务的连续性，而用户使用时无需关注哪一台服务器作为主服务器，以及当前主服务器的ip地址，只需要通过配置好的公共IP访问服务即可。
对于Windows操作系统，主要通过可执行文件 SyncService.exe 来实现文件的实时同步和服务切换和公共IP的配置。

### 二、环境要求及安装方式
## 1.环境要求

## 环境要求及预安装软件

## 说明

## Windows Server

Windows Server 2016 2019 2022 等常见版本均支持

### Base_RDSInstaller_version.exe

该安装包已包含所有RDS及双机热备的相关服务，
## 安装目录：C:\RDS
### 双机热备需要两个RDS程序，需要申请两个RDS旗舰版授权

## SyncService.exe

双机热备程序，推荐安装目录：C:\RDS\data\rds\app

## 两台服务器

### 分别作为主备机 建议使用规格相同的服务器
## 每台服务器需配备双网卡

## 四根网线及四个及以上空闲端口的交换机

## 用于服务器之间的连接和局域网的配置

### 需开放端口:8384、22000、21027

该组端口分别用于图形界面登录、文件传输、设备发现，若服务器防火墙需保持开启状态，则需在两台服务器上均开放上述端口
### 2.安装方式
Windows下的双机热备目前支持自主安装的方式进行部署。
其中自主安装指的是现场人员自行在服务器中安装并激活windows server操作系统，然后在该系统中安装RDS以及双机热备的相关服务。 注：目前仅支持Base包中默认安装的Mariadb数据库。
### 3.安装步骤
自主安装方式如下。
## 现场人员自主安装
第一步：安装并激活操作系统。对于该种安装方式，首先需要用户自行准备版本正确的 Windows Server 操作系统并在两台服务器上完成安装和操作系统激活， Windows Server 2016，2019， 2022 等常见版本均支持 。
第二步：通过Base包安装RDS及双机热备相关服务。详见链接： windows下的RDS部署方式 ，最终安装后的目录结构如下所示，其中syncService包含了双机热备所需要的软件及相关脚本文件：
1708665722183-cc3b0a50-c97c-41a0-9bf5-db19523ca0f8.png

说明：通过双机热备专属的Base包完成上述安装后，会自动配置相关的环境变量和系统服务，使得双机热备服务能够开机自启，并且在按照下文配置好主备机IP地址和公共IP地址后，在之后的重启中能够让主机自动开启RDS服务。
第三步：完成后续配置工作。在完成上述步骤后，在两台服务器上均按照下文步骤完成相关的配置。
### 三、防火墙及文件夹权限设置
1.在文件同步过程中会由于防火墙和文件夹权限问题，使得同步文件受阻，因此需要关闭防火墙并开放同步文件夹的操作权限。点击“开始”→“控制面板”→“系统和安全”→“Windows Defender防火墙”→“启用或关闭Windows防火墙”→选择“关闭Windows防火墙”，点击“确定”即可。
1694582727396-ac72905a-6b29-4e1c-a67d-0e74aa07e260.jpeg 

1694582727682-6646bf50-4555-4852-960a-a0cb67eebfdd.jpeg

2.文件夹权限设置。在本地磁盘中找到安装RDS的文件夹，默认为 C:\RDS，选中该文件夹，右键单击“属性” →“安全”→“高级”→“更改”→在“输入要选择的对象名称”一栏中填入“Users”，点击 “确定” 保存。
1694582727982-df64553e-430f-4d35-8b09-6751d17a0f69.png

保存后，在下图中红框勾选出点击勾选，最后点击“确定” 保存 。
1694582728378-725ba641-8f33-4590-b21e-ac8f8eb11719.png

退回到文件夹属性界面，点击“编辑”按钮，将所有用户的“完全控制”一栏全部勾选，点击“应用”，最后点击“确定” 保存。
1694582728702-bcca8226-ea15-48b9-8769-85000adb34d1.png

### 四、在SyncService中配置公共IP
1.主机和备机完成上述配置后，皆启动RDS，通过roboshop连接并获取各自的机器码，完成相关授权后，分别进入主机和备机的RDS设置菜单栏，在配置中勾选restartRecoverConfig选项并点击保存按钮，使得天风任务能够在重启后自动恢复。 
1708666476314-11a89d51-4d2b-4c50-90a1-5a0c24cb127e.png

2.主机和备机皆重启系统，在主机重启后使用管理员身份打开控制台，通过指令“rds.bat”首次启动RDS（ 备机不需要执行此命令 ）。同时在cmd控制台输入“ipconfig”指令获取当前服务器两个网口的ip信息，记录网口2的子网掩码和默认网关。
## 示例如下所示：

1708667023236-49641420-e40e-4c3b-a4cc-1c5356dfcacf.png

3.打开浏览器输入127.0.0.1:8384，进入双机热备的UI操作界面，找到“网络配置”按钮点击并进行编辑，将预先约定好的公共IP地址填入第一行，将上一步中网口2的子网掩码、网口名称、网关信息依次填入下面三行，最后点击保存。然后在备机中进行同样的操作：在UI界面的“网络配置”中填入相同的公共IP地址和备机网口2的子网掩码、网口名称和网关。

1708667468933-ea98401b-6073-4af9-9b28-8f249c6de1e1.png

4.完成上述配置后，在主服务器的 UI操作界面点击“初始化公共IP”，则之前配置好的公共IP会自动分配到主服务器的网口2上（ 备机不需要执行此操作，该公共IP会在主机服务关闭，备机启动服务之后自动分配到其网口2上 ），此时可通过在浏览器中输入“公共ip:8080”，测试是否能够通过该公共IP进入RDS界面。若无法通过测试，则需要从IP冲突、网络配置是否正确、交换机与主机的接线等方向进行排查。

1708667828453-87f7624e-54f2-4570-aa5d-b8762b2e92c1.png

5.完成上述配置后，右上角点击操作→设置→连接，在远程设备地址一栏，填入另一台主机的网口1的IP（ 注意填入的不是本机的IP，若此时在主机上操作，则填入备机网口1的IP，若此时在备机操作，则填入主机网口1的IP ），在公共IP处填入此前配置好的公共IP地址，最后点击保存， 主机和备机都需要进行该步骤的配置 。通过该配置双机热备应用便能够永久记录远程设备的IP地址及公共IP地址，无需在重启后重新配置。 
1708668658841-f21421ff-5f79-4afa-8a24-5e9946402057.png

### 五、在SyncService中进行文件同步
1.点击右下角“添加设备”，若此时网络连接正常，则弹出的界面会显示出备机的设备ID，选中该设备ID，点击“保存”。此时在备机的UI界面中，会显示主机的请求信息，点击添加即可。

1694582736311-71a55511-9166-46ea-b9c9-5bc776aef168.png

1694582736589-3a9a6441-b5bb-4a05-9b00-5b8457db92e6.png

2.进入备机的mariadb目录和core目录，默认为C:\RDS\data\mariadb-10.6-winx64\data、C:\RDS\.data\rdscore\resources，将当中除lservrc（在resources目录下，此为授权文件）的所有文件删除，为同步做准备( 当前运行RDS服务的主机无需进行该操作 )。

3.进入主机的双机热备操作界面，点击“添加文件夹按钮”，将文件夹标题设置为“RDS”，将Mariadb目录下的data文件夹的路径（默认为C:\RDS\data\mariadb-10.6-winx64\data）填入其“文件夹路径”。
1708669694087-3e73f006-e9bb-4d95-ac84-6ee033615a18.png

### 4.在上述界面中，点击“共享”，勾选备机的设备名，然后点击忽略模式，勾选增加忽略模式。
1708670270920-ad325b0f-c062-4cb6-9a7e-314e29c01ece.png

1708670251211-27b74e47-b3ea-40cd-9823-fe9d7e4c0aa0.png

### 5.在上述界面中，点击“高级”，勾选“同步所有权”，“发送所有权”以及“忽略文件权限”。将“文件拉取顺序”调整为“新文件优先”，点击“保存”。
1700793070503-b603efbe-2b8a-4d20-861c-8e7ec3e45c5e.png

在弹出的忽略模式中，输入mariadb_error.log，最后点击保存。 该文件为数据库日志文件，需保持唯一，因此无需同步该文件 。
1708670373609-b02ead0c-eda6-4394-919d-f06021417edd.png

6.确认本机Core的路径，默认为C:\RDS\.data\rdscore\resources，以及RDS脚本及配置文件所在路径，默认为C:\RDS\data\rds\script。重复上述操作，将Core的文件夹以及RDS脚本文件夹共享给从机。
 当对core文件夹进行共享时，同样需要在忽略模式中填入lservrc 。即不对该文件进行同步。该文件为激活 权限相关的文件，每一份主机中该文件需保持唯一。

1695274795780-562b575b-67d4-41d0-8b80-17c142965f05.png

### 7.打开从机SyncService的UI界面，若网络连接正常， 则会出现三个请求弹窗，该弹窗即为主机将文件夹共享给从机的请求。

1694582737887-f509d8a2-bad6-4e07-9e57-16945297490e.png

依次点击“添加”按钮，填入备机各个文件夹对应的路径，确保接收的文件夹路径与主机相同，并按照主机配置文件夹参数的方式，点击“高级”，勾选“同步所有权”，“发送所有权”以及“忽略文件权限”。将“文件拉取顺序”调整为“新文件优先”，同时针对RDS和Core的文件夹同步，同样在忽略模式中进行勾选中之后，对mariadb_error.log和lservrc进行忽略，最后点击“保存”，便完成了文件同步。

### 六、其他功能说明
1.开机自启服务：在按照上述说明完成对两台服务器的配置后，则默认开启开机自启RDS服务的功能。触发条件：两台服务器都因断电、宕机等重启，则先重启的服务器会再开机后一分钟内自动开启RDS和双机热备等服务，后重启的服务器则自动作为备机。

### 2.更改服务切换条件：
在备机syncService右上角点击操作→设置→更改服务切换条件，可将服务切换条件更能改为RDS\Robod,则切换服务的条件变更为：当主机rds或robod服务发生崩溃关闭时，备机便切换服务，无需等待主机宕机或断电才会自动切换服务（默认情况下无需点击）。

1708672025842-65642d24-07ca-4745-934d-5e4757195f01.png

3.手动切换服务：点击该按钮可实现手动切换服务（在当前两台服务器RDS服务都停止运行的情况下才生效）。当正在运行RDS的主机发生断电、宕机关机时，通常情况下备机会在自动切换服务，无需点击该按钮，若此时由于诸如网络通信异常等情况，备机没有自动切换服务，或者因为某种原因需要主动的在备机上继续运行RDS服务，则在确保主机RDS服务关闭后，可通过点击该按钮一键启动RDS相关服务。

1708672669845-07526876-d860-4754-82f4-1bc9fef4d30d.png
