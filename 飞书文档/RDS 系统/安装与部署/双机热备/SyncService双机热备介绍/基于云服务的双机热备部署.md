# 基于云服务的双机热备部署

## 基于云服务的双机热备部署
## 一、功能简介

1702866457184-02e32aeb-b686-4a9b-a67d-d3050506d8e2.png

双机热备能完成 RDS 两台服务器之间实时的数据同步，包括 RDS 数据库 、场景文件、配置文件等。同时，它可以在主服务器发生故障时实现人工或自动切换到备份服务器上继续任务，确保数据的安全性和任务的连续性，而用户使用时无需关注哪一台服务器作为主服务器，以及当前主服务器的ip地址，只需要通过配置好的公共IP访问服务即可。
对于云服务器上的双机热备部署，需要在两个云服务实例中安装好RDS以及双机热备的相关服务之后，再通过云服务自带的负载均衡服务来配置公共ip。在本文档中，将结合阿里云的传统型负载均衡(CLB)，介绍基于阿里云服务器下的RDS双击热备部署过程。
### 二、云服务的开通和部署
## 1.创建阿里云服务器
https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fhome.console.aliyun.com%2Fhome%2Fdashboard%2FProductAndService&lang=zh
进入上述连接后通过支付宝等方式登录阿里云，在完善相关的账号信息（如实名认证等）之后，左上角点击进入到阿里云主界面。 
1702869098736-58c27db6-54fc-4eb0-ac71-e800b86f65fa.jpeg

进入主界面之后找到“云服务器ECS”，点击进入→立即购买。
1702869174892-f2fac298-02f5-453d-8342-4f778571f733.png

## 随后进入到购买选项界面
付费类型：付费一栏可根据自己需求选择包年包月，也可选择按量付费。
地域：不同地域的实例之间内网互不相通，距离实例所在地域越近，对实例访问速度越快。
网络及可用区：一般选用默认的网络，也可根据具体需求创建专有网络和交换机。
1702870180424-bf93dd15-4de8-49da-b248-13bc878c4256.png

实例：根据实际需求选择cpu核数以及内存大小。 在架构选项中，选择X86计算 。
镜像：选择Windows Server2022数据中心版 64位中文版 
1702877204395-8ec560da-65f6-48bb-8ac2-b632a4fa3c75.png

## 系统盘：根据需求选择磁盘大小
## 数据盘：根据需求选择数据盘的个数
## 公网IP：勾选“分配公网IP地址”
## 登陆密码：设置服务器登陆密码
## 其他配置选项可采用默认配置
1702877512638-7264cadc-b608-4c59-b0c4-b10e428e685e.png

最后点击确认下单，即可完成购买。重复上述操作，创建另一个云服务实例作为备机，注意，两台服务器的地区选择上要选择相同的地区。
1702877778251-5293c2d9-5f58-408a-a48d-77ae9cbfa05e.png

### 2.登录云服务器
完成云服务器的配置和购买后，进入“控制台”→“资源概览”→“我的资源”一栏，点击选中云服务器ECS，便可找到创建好的两个云服务器实例。
1702878027982-408b7350-6c6d-4a2e-a614-a6cb7f898892.png

点击远程连接，并选择使用“workbench”连接，便可在浏览器中直接登录配置好的云服务器。
### 三、在云服务器中配置RDS及双机热备服务
## 1.安装相关应用包
第一步：安装RDS相关服务。详见链接： windows下的RDS部署方式
第二步：安装双机热备相关服务。在按照第二步完成RDS的部署之后，进入到RDS的根目录(默认为 C:\RDS\data\rds\app )，将制品库中双机热备程序压缩包 SyncService.zip解压至该文件中。

1696835090977-4fa6ee68-bc44-4b9b-a2fd-03f63a7d96cf.png

如上图所示，SyncService.zip包含sync.bat、rds.bat、syncService.exe三个文件。其中syncService.exe为双机热备的主程序。sync.bat为启动syncService.exe的脚本，rds.bat为切换RDS服务的脚本。
进入RDS的.data目录(默认为 C:\RDS\.data\ )，新建文件夹，将该文件夹命名为syncService，该目录将存储syncService的日志和相关配置文件，最后将sync.bat文件移动至该目录下，如下图所示。
1696836243981-10aafa8c-eb2f-4284-bb1b-01ef65cfb979.png

### 2.配置环境变量
在主备机服务切换过程中，需要通过启动脚本来切换RDS服务，同时需要删除rds和core数据库中的冲突文件，通过配置系统变量的方式，能够动态获取所需文件所在路径。
在系统中点击：此电脑→属性→高级系统设置→环境变量，在环境变量中找到系统变量部分。
1694582725111-5b67db73-cea4-42b2-a1f9-425d24030598.png

在系统变量中找到“Path”这一栏点击，然后打开编辑界面，点击“新建”，将 maridb的bin目录路径 、 rds所在路径 、 core所在路径 、 robod 所在路径添加到当中，然后点击“确定”保存，如下图所示：
1694582725543-f4085917-bf96-4eeb-8d12-ef555a3044bb.png

注：上述四个路径皆为推荐安装目录，若实际安装时路径发生变化，则对应的环境变量也要发生变化，例如，当maraidb的安装路径变为D:\maridb时，环境变量中mariadb的bin目录路径也要从图中的C:\RDS\maraidb\bin变更为D:\maraidb\bin。
在环境变量中点击“新建”，在“变量名”一栏中输入“CoreDatabase” ，“变量值”一栏中输入core数据库的路径，若采用推荐安装目录，则填入“C:\RDS\.data\rdscore\resources\db”，点击“确定”保存。重复上面的操作，再次新建一个系统变量，在“变量名”一栏中输“RdsDatabase” “变量值”一栏中输入Rds数据库的路径，若采用推荐安装目录，则填入C:\RDS\mariadb\data”，同理，若未采用推荐安装路径，则这两个填入的路径也要做更改。
1694582725971-45c645da-c740-4648-b410-31d422f2cc55.png 

1694582726353-31557ba7-95aa-46f9-ae60-3b7268340fdb.png

### 3.配置系统服务
双机热备使用中需要禁用mariadb数据库开机自启，并且需要将SyncService注册为开机自启的系统服务。
以管理员身份打开控制台，输入命令“services.msc”，在当中找到Mariadb，右键点击“属性”，将启动类型更改为“手动”，点击“确定”保存。
1694582726772-129e6902-c497-45a5-a9df-2c9d6c9ff67a.png

 在控制台中输入命令”sc create startSyncService binpath= "C:\RDS\.data\syncService\sync.bat" start= auto ”，按回车键确认，将syncService注册为系统服务，使其能够开机自启，注意"C:\RDS\.data\syncService\sync.bat"为推荐的默认安装路径，若实际中路径有变动，上述命令中的binpath也需要随之更改。
1694582727117-77455150-6b02-4333-805c-d99921d0cb67.png

### 4.防火墙设置
1.在文件同步过程中会由于防火墙和文件夹权限问题，使得同步文件受阻，因此需要关闭防火墙并开放同步文件夹的操作权限。点击“开始”→“控制面板”→“系统和安全”→“Windows Defender防火墙”→“启用或关闭Windows防火墙”→选择“关闭Windows防火墙”，点击“确定”即可。
1694582727396-ac72905a-6b29-4e1c-a67d-0e74aa07e260.jpeg 

1694582727682-6646bf50-4555-4852-960a-a0cb67eebfdd.jpeg

2.文件夹权限设置。在本地磁盘中找到安装RDS和mariadb的文件夹，默认为 C:\RDS，选中该文件夹，右键单击“属性” →“安全”→“高级”→“更改”→在“输入要选择的对象名称”一栏中填入“Users”，点击 “确定” 保存。
1694582727982-df64553e-430f-4d35-8b09-6751d17a0f69.png

保存后，在下图中红框勾选出点击勾选，最后点击“确定” 保存 。
1694582728378-725ba641-8f33-4590-b21e-ac8f8eb11719.png

退回到文件夹属性界面，点击“编辑”按钮，将所有用户的“完全控制”一栏全部勾选，点击“应用”，最后点击“确定” 保存。
1694582728702-bcca8226-ea15-48b9-8769-85000adb34d1.png

在另一台云服务器中重复执行上述操作。将一台云服务器选作主机，另一台用作备机。
### 四、配置网络负载均衡（CLB）
CLB是一种提供分发应用流量到多台服务器的服务，用于确保应用高可用性、可扩展性和更好的性能。负载均衡器可以检测到服务器的健康状况，并按照配置的负载均衡算法将流量智能分配到不同的后端服务器上。 当主机服务发生异常时，可将访问的流量自动分配到备机当中。 而公共IP地址是一个对外的网络标识，用于实现设备或服务在互联网上的可访问性，即外界只需要通过一个公共IP即可在实现对服务的访问。
## 1.开通传统型网络负载均衡（CLB）
### 进入阿里云主界面，点击进入负载均衡SLB
1702869098736-58c27db6-54fc-4eb0-ac71-e800b86f65fa.jpeg

## 点击购买CLB
1702879919023-8f02a17c-d459-4a43-ab91-01261745681b.png

### 地域和可用区： 务必选择与云服务器实例相同的区域
1702880888304-0d56335e-e39c-465f-a8e8-af588aa7c432.png

## 实例名称：自定义
## 实例规格：简约型
## 实例类型：公网
## IP版本：IPv4
## 资源组：选择默认资源组
## 计费周期和带宽值给根据实际需求自定义
1702881177410-959832dd-1bf6-4042-a96b-4f9993924b68.png

配置完成后点击购买开通该实例。
### 2.启动网络负载均衡实例
完成云服务器的配置和购买后，进入“控制台”→“资源概览”→“我的资源”一栏，点击选中传统新网络负载均衡CLB，下滑找到传统型负载均衡CLB→实例管理。便可找到创建好的负载均衡实例，点击“点我开始配置”。
1702882633964-0a986266-d578-41a7-b268-959fe200ca5e.png

## 选择监听协议：TCP
## 监听端口：输入80
## 点击下一步
1702883644889-4e97946c-d957-4d96-8f98-38d0a0a32b77.png

## 选择主备服务器组
## 为主备服务器组命名
### 选择蓝色“添加”按钮，勾选创建好得两个云服务器实例
## 点击“下一步”，在端口处填写80
## 点击“添加”
1702883956402-a532d086-02d3-4694-95a0-897ebf5cca9a.png

勾选一台服务器作为主机，另一台服务器作为备机。最后点击“下一步”→“提交”
1702884168264-7897ef8a-dd08-468a-98e8-59b89a5806f3.png

至此，便完成了负载均衡及公共IP的配置，其中的服务地址便是公共ip
1702887847993-9b51fd7a-c324-44dd-89a9-805cb9d60c52.png

### 五.SyncService配置
1.完成上述配置后，主备机皆重启实例，在主机使用管理员身份打开控制台，通过指令“rds.bat”首次启动RDS（ 备机不需要执行此命令 ）。打开浏览器，输入地址“127.0.0.1:8384”，进入SyncService的UI操作界面。点击右上角“操作”→“设置”→“连接”，在“公共ip”处填入CLB公网ip。在远程设备地址处填入另一台云服务主机的ip，最后点击“保存”。 
1700792344234-b4cbbff1-ec43-4218-a54b-541e8d033fd4.png

2.点击右下角“添加设备”，若此时网络连接正常，则弹出的界面会显示出备机的设备ID，选中该设备ID，点击“保存”。此时在备机的UI界面中，会显示主机的请求信息，点击添加即可。

1694582736311-71a55511-9166-46ea-b9c9-5bc776aef168.png

1694582736589-3a9a6441-b5bb-4a05-9b00-5b8457db92e6.png

3.点击添加文件夹按钮，将文件夹标签设置为“RDS”，将Mariadb目录下的data文件夹的路径（默认为C:\RDS\mariadb\data）填入其“文件夹路径”。
. 
1694582736863-77fa50cb-31b9-48fd-9d5b-7c74ecc32af4.png

### 4.在上述界面中，点击“共享”，勾选备机的设备名。
1694582737160-e12edfd7-100f-420a-a219-49f788307ae1.png

### 5.在上述界面中，点击“高级”，勾选“同步所有权”，“发送所有权”以及“忽略文件权限”。将“文件拉取顺序”调整为“新文件优先”，最后点击“保存”。
1700793070503-b603efbe-2b8a-4d20-861c-8e7ec3e45c5e.png

6.确认本机Core的路径，默认为C:\RDS\.data\rdscore\resources，以及RDS脚本所在路径，默认为C:\RDS\data\rds\script。重复上述操作，将Core的文件夹以及RDS脚本文件夹共享给从机。
当对core文件夹进行共享时，需要在忽略模式中填入 lservrc。即不对该文件进行同步。该文件为激活 权限相关的文件，每一份主机中该文件需保持唯一。

1695274795780-562b575b-67d4-41d0-8b80-17c142965f05.png

7.打开从机，将Mariadb目录下的data文件夹的路径（默认为C:\RDS\mariadb\data），Core数据库的路径以及RDS脚本所在路径（默认为第7步中的路径）， 保留文件C:\RDS\.data\rdscore\resources\lservrc ,然后将除lservrc之外的这三个文件夹中的内容清空，为接收主机所同步的文件做准备。
### 8.打开从机SyncService的UI界面，若网络连接正常， 则会出现三个请求弹窗，该弹窗即为主机将文件夹共享给从机的请求。

1694582737887-f509d8a2-bad6-4e07-9e57-16945297490e.png

9.依次点击“添加”按钮，按照步骤1，在“公共ip”处填入通过CLB实例的公网ip。在远程设备地址处填入另一台主机的ip。按照步骤3、5，确保接收的文件夹路径与主机相同，并按照主机配置文件夹参数的方式，点击“高级”，勾选“同步所有权”，“发送所有权”以及“忽略文件权限”。将“文件拉取顺序”调整为“新文件优先”，最后点击“保存”，对三个接收的文件夹重复此操作。

### 六、 设置任务重启恢复
当两台主机都完成上述配置后，先完成配置的服务器会在约一分钟后自动开启rds服务，此时将开启同步，该服务器会自动被标定为主机，另一台服务器在接收到主机同步的文件后会自动标定为备机。当主机宕机或者关机时，备机约在几分钟后自动启动rds服务，继续完成此前主机中未完成的运单任务，并同步主机的相关数据。 由于rds中正在执行的天风任务在关机重启后默认将变为重启异常的状态，在备机切换服务后，无法继续执行此前主机中已经下发而未完成的任务，因此需要在主机开启rds服务后，更改相关配置。
具体步骤为，在启动rds相关服务并对备机开启同步之后，在主机浏览器中输入地址127.0.0.1:8080进入rds操作界面，随后进入当中的“设置”选项，找到重启恢复的相关字段“restartRecover”，将其更改为“true”。通过这样的方式，能够确保在主机中未完成的任务同步到备机之后能够继续执行。

1695267454544-d7838038-96fc-4624-9b37-4202305239bb.png

### 七、附加功能说明
1.开机自启服务：在按照上述说明完成对两台服务器的配置后，则默认开启开机自启RDS服务的功能。触发条件：两台服务器都因宕机等原因重启，则先重启的服务器会再开机后两分钟内自动开启RDS和双机热备等服务。后重启的服务器则自动作为备机。

### 2.更改服务切换条件：
在备机上点击该按钮，则切换服务的条件变更为：当 rds 服务发生崩溃时，备机便切换服务，无需等待主机宕机或断电才会自动切换服务（默认情况下无需点击）。

1700813977737-63e3debd-d42c-4776-836f-da6e2ef8909a.png

3.切换服务：点击该按钮可实现手动切换服务（在当前两台服务器RDS服务都停止运行的情况下才生效）。当正在运行RDS的主机发生断电、宕机关机时，通常情况下备机会在两分钟内自动切换服务，无需点击该按钮，若此时因为意外情况备机没有自动切换服务，或者因为某种原因需要主动的在备机上继续运行RDS服务，则在确保主机RDS服务关闭后，可通过点击该按钮启动服务。
