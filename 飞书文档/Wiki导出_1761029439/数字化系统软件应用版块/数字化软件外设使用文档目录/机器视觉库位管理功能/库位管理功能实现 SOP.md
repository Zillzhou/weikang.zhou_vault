# 库位管理功能实现 SOP

## 库位管理功能实现 SOP

## 版本

## 更新日期

## 更新说明

## 文档状态

## 维护责任人

## V1.0

### 2024.8.29

## 初版

## 使用中

## 同步块
## @王益亮
## 1. 机器视觉库位管理功能应用程序下载与启动
   如果您需要安装 机器视觉库位管理功能 的应用程序，请联系我司技术支持工程师，按照如下流程获得对应安装包
### 制品库路径：制品库->rds->rdscore
1698658187884-8334ad59-eae3-42ba-a908-4078bd86a8bd.png

版本可能会更新，但是制品库路径不变，找到带机器视觉库位管理功能后缀的文件下载。
注意：目前机器视觉库位管理功能已经与core融合，可以理解为机器视觉库位管理功能是core的一部分，所以机器视觉库位管理功能的整包与core的整包目录结构相似，启动core即启动了机器视觉库位管理功能。
下载后右键解压（Extract Here）（如下操作步骤按照 Ubuntu 操作系统为例）
1698659735876-cfe8ee1e-8fa5-4c74-9ef9-65a6aa005476.png

打开到release目录下，右键空白处，打开一个终端。
1698659821534-6e40bd79-b5f1-4bc1-b1ee-f8b09c8b75f6.png

core的安装目录在“/opt/data/rdscore”，所以要将上面release目录下的所有内容移动到core的安装目录下，否则robod无法升级core和取日志，RDS也无法同步库位状态。依次在release目录的终端执行以下命令，移动文件：
## // 新建文件夹
sudo mkdir -p /opt/data/rdscore

## //复制当前目录下所有文件到指定目录
sudo cp -rf ./* /opt/data/rdscore
## 最终目录结构如下图所示：
## image.png

在终端窗口输入以下命令和账户密码，启动机器视觉库位管理功能。
sudo /opt/data/rdscore/rbk.sh start
终端窗口，按下Ctrl+c 关闭机器视觉库位管理功能。
注意：由于不同型号的服务器硬件及系统环境差别，上述安装包可能存在缺少关键的运行库导致某些插件无法加载，若发现此类情况，不要慌，联系研发人员修复一下就好。
### 2. RoboShop下载与启动
下载并安装RoboShop软件。
### 下载地址： CODING | 一站式软件研发管理平台
制品库路径：制品库->roboshop，找到最新的roboshop-ubuntu的版本
1698660321586-1dd46a10-fec2-4474-abb1-fcb06511e486.png

### 下载完打开到下载文件目录，右键空白处打开一个终端：
1698660423627-93a213ea-e282-4240-b444-f45f4488de0a.png

### 输入以下命令和密码安装roboshop：
sudo dpkg -i Roboshop-ubuntu-2.4.1.143.deb
安装完成以后，可以右下角菜单栏中找到roboshop图标，打开roboshop。
1698660640331-997ea945-4e7f-498c-8982-bd3a72a768a3.png

### 3. 监控相机参数配置
监控相机接入机器视觉库位管理功能前，需要对相机进行一些设置，具体设置方法和参数如下：
选用的相机品牌型号为： 海康DS-2DE2D40IW-DE3/W/XM
## a. 网络配置
首先网线连接电脑和相机，配置电脑的ip和掩码到相机 同一网段 。
## Linux下：
1698718704285-24216c79-d1c1-4ddc-9caf-3b2857b440e3.png

1698718785004-25eca128-765c-4ec7-9cfb-749e0717e4ae.png

## window下：
1698718886761-8deb78bc-3517-48b4-8f1e-911498916cde.png

## b. 登录
打开浏览器，网址栏输入相机ip地址，回车后进入登录界面，输入相机账号和密码登录
1698719099925-8271cf18-a586-418f-a16e-4a8879a86877.png

## c. 参数配置
## 进入到相机配置界面，按照如下参数配置
1698719635536-0670e9b2-5ec0-49ce-9f92-4d76e8efdd06.png

## 特别以下参数要按要求设置：
码流类型：主码流；
## 相机分辨率：1280*720p
## 码率类型：定码率
## 视频帧率：25
## 码率上限：2048
## 视频编码：H.264
设置完之后，点保存，然后 重启相机 即可。
1698720576783-1706e7f0-6e6f-4a7f-9088-57752de099e9.png

## d. 调整相机视角
相机一般选用的是云台相机，可以调整相机的角度和焦距。可以通过浏览器调整，也可以在roboshop上进行相机角度调整。
1698721409146-232af185-cdf3-4868-b06a-2f3e9009f9dc.png

根据列库取放逻辑，要求相机安装在列库入口的斜上方， 然后调整相机视角，使其斜视库区。
## e. 数据采集（可选步骤）
按照上述步骤调整好相机视野和参数后，如果需要采集视频数据，需要通过浏览器操作，首先修改视频录制的保存路径：
1698722733866-79259349-ed8e-4c8d-b373-c281b1e7b57a.png

注：由于浏览器的版本和兼容性问题，很多相机配置选项无法显示出来，当出现这种情况是，需要点击右上角的【安装插件】，安装完重启浏览器，即可使用完整的配置选项。插件只有window版本的，所有设置的时候需要一台window电脑。
设置好录制视频的保存路径后，在预览界面打开录制按钮，录制一段时间后关闭按钮，即可在保存路径下得到视频数据，然后数据给到研发人员处理。
1698723381494-2711192b-81fb-4d70-85a3-6ea41255b6e7.png

### 4. 库位部署
完整的业务逻辑部署过程中，需要机器视觉库位管理功能、core、RDS配合使用，在这个过程中机器视觉库位管理功能的作用在于绑定库位、实时监控库位状态、将库位状态更新到数据库中。具体的小车到达站点的库位任务在core中配置，列库下发运单的列库逻辑在RDS中配置。本文档仅介绍机器视觉库位管理功能的部署内容，core的使用参考链接： RDSCore 功能文档 ， RDS的使用参考链接： RDS 多机器人调度系统

启动机器视觉库位管理功能后台程序，用roboshop连接机器视觉库位管理功能，两者如果都是在同一台电脑上启动，则机器视觉库位管理功能的ip默认是127.0.0.1
1698732648170-fc1eac04-086a-4a47-b614-8105578a99ed.png

通过roboshop在机器人模块的地图中根据实际场景建立建立库位，参考 库位 。然后进入机器视觉库位管理功能的调度场景，在场景中添加机器人，可以看到场景中库位、站点、轨迹等图标。
1698737297388-d6daacee-4614-4dd3-a59e-f778a88c0033.png

## a. 建立库区
一列库位定义为一个库区，每个库区包含多个库位取放任务。
1698737519232-c7ea83fa-2b36-4fb8-8f0e-3f2774ebe021.png

启用编辑之后，添加一个库区，在场景中选中一列的所有库，右键库区，将选中的库位添加到库区。然后保存，推送场景。
按照现场业务场景，规划好所有库区。
## b. 添加相机
1698737942885-e50f8373-2f1c-4b78-acea-4b4fc97c0aaf.png 

点击相机，添加一个相机，配置相机的IP地址，端口号、账号密码，点击【登录】，【播放】即可看到相机画面。
## c. 绘制库位
1698738798230-446c2730-6276-42c7-96df-99f2129c40a0.png

打开相机画面，点击上方四边形，先绘制一个矩形框，然后切换到指针，选中四边形，在右侧【+】添加一个指定的库区，roboshop会自动将矩形框分为库区内库位的个数。
然后拖动矩形框的顶点，使其与地面库位区域重合，绘制库区的矩形框需要完全将库位外边框包裹在内，绘制库区内部的间隔时，需要沿相邻的两个库位的正中间绘制。
1698738989164-7335267a-b951-4757-b943-70abc2ce4692.png

右侧可以拖动库位图标进行排序。
通过上述操作，可以将实际现场库位区域与地图的库位动作绑定，通过摄像机监控现场库位的状态，RDS即可按照列库的取放料逻辑自动下发运单执行搬运任务。
绘制完库位区域之后，点击左上方推送，该相机就部署好了，依次添加所有相机和库位即可。
1698739220352-d6fb40be-e34b-4197-a657-66a798e343ab.png

## d. 查看库位状态（可选步骤）
推送完相机后，在参数配置界面打开显示参数，即可看到实时监测画面。
1698739484022-82e22db0-022f-4e63-85f5-0039ac5ca89e.png

将【ShowOpenCVImage】参数改为true，点击【永久修改】，后台就会弹出实时监测框，该画面框为调试时候方便观测使用，必须在命令行窗口使用命令手动启用core才能显示，若是后台运行core，需要禁用该参数，然后robod重启一下core。调试完成，需关闭该参数，让core后台运行。
1698739578009-fc77d0b1-215a-42cd-a83e-cf0bce8fc82e.png

可以看到如果库位被占用，库位区域会被标记为红色，如果库位空闲，库位区域会标记为绿色。
同时，机器视觉库位管理功能会检测行人和AMR，如果行人或者AMR遮挡了某个库位，则该库位所在的整列库区都会变为失联状态。
## core的更新
目前，由于库位管理功能不在core的发布流程中，如果通过robod升级core之后，lua脚本文件会被覆盖，默认是不启用库位管理相关插件的，所以更新完core之后，需要手动修改FullFeature.lua文件，具体修改如下：
### 在rbk.initModel()之前添加
## --机器视觉库位管理功能插件
gCamera=rbk.getPlugin("CameraAdapter")
gResult=rbk.getPlugin("ResultPlotter")
gStorage=rbk.getPlugin("StorageBinDetection")
gYoloDetecion=rbk.getPlugin("YoloDetection")
## image.png

### 在rbk.sleep(2000)之前添加
## --启动机器视觉库位管理功能插件
## gCamera.start()
## gResult.start()
## gStorage.start()
### gYoloDetecion.start()
## image.png

然后保存，重启core之后，即可在参数配置界面查看是否有视觉相关参数，判断插件是否启用。
注意：若由于权限问题导致文件无法编辑，可用命令行打开文件：sudo gedit ./FullFeature.lua
## FAQ
## 窗户高亮度反光
1705304359326-04d3398e-e04a-4b87-b82a-f2a5180daac6.png

### 方案：应该避免相机正对窗户安装，或者遮挡窗户

## 斜视角下灯光放光
1705304408417-0279e723-1630-4b6c-a8b3-ebccb731b863.png

## 强光直射
1705304555771-0045ee60-0508-423f-b4bb-aa7508bf83aa.png

## image.png

解决方案：使用指定型号的监控相机，开启相机的【宽动态】和【强光抑制】功能，可解决阳光直射问题
## image.png

## 光线过暗
## image.png

## 方案：建议开灯作业
## 线框破损
## image.png

## image.png

## 环境干扰，库位状态抖动
问题：现场人或者叉车临时经过库位，导致沿途的一些库位状态变为占用， 脚本自动下单的时候检测到临时库位状态变化开始下单，实际库位并没有货物。 （ 机器视觉库位管理功能更新频率0.5s，RDS更新频率3s）
解决方案：RDS的下单逻辑里做一些滤波操作：连续获取三次库位状态，如果三次都是有货，则开始下单（下单频率变为10s左右）

## 人工放货，路线阻挡
问题：列库取货逻辑是从库头依次取货，假设库位顺序依次为s1, s2, s3, s4, 机器视觉库位管理功能检测到s1，s2为空，s3为有货，RDS下发订单去s3取货，在AMR运动过程中，人工在s1库位放货了，导致AMR无法越过s1去s3取货，订单等待。
解决方案：列库在RDS下单逻辑中称为密集库，需要在密集库附近的某个位置给AMR建一个前置点，AMR接到订单后，先去前置点，此时再次判断库位状态，决定取哪个库位的货物。 
