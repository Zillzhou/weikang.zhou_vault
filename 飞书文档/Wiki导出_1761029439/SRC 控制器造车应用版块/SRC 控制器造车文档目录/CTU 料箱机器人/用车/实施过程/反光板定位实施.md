# 反光板定位实施

## 反光板定位实施
## 1. 反光板说明
## 反光板分为反光柱和反光条：
反光贴纸包住标准圆柱体，称为反光柱；
反光贴纸以条形贴在平面，称为反光条。
现场布置时使用的 反光柱 和 反光板 ，相应的，仙工智能提供【反光柱】和【反光条】地图构建接口。
为防止混淆现场中的 反光柱 和 反光板 和机器人地图中的【反光柱】和【反光条】的概念，对于机器人地图中的反光板加上【】。即现场中实际安装的不管是反光柱还是反光条，在软件上，机器人都可以使用【反光柱】和【反光条】两种不同的识别方法，用于在建图中生成对应的反光识别标记。

反光柱原理以及布置要求可以参见RBK功能文档的反光柱定位原理 ，需要严格按照要求进行布置后，才能达到理想精度，反光柱相比反光条，在测量角度上有各向同性的优点。

反光柱定位实施对于激光雷达识别反光柱有特别要求，目前经过测试，支持的激光类型（仙工标准雷达）有：
倍加福 R2000 ；
富锐 H100 ；
Sick-nano3 ；

### 使用反光板定位时，需要确保该功能已开通：
1711700177919-2a33f023-3f49-4314-9774-a54db72ac834.png

### 2. 场景布置说明和建议
仙工智能提供【反光柱】和【反光条】建图接口。对应两种雷达高反定位方案，分别为使用标准反光柱进行场景布置，和使用反光条进行场景布置。
经过测试和验证可靠性的为反光柱定位方案，建议优先使用标准反光柱进行场景布置。

### 3. 使用入口
### 3.1. 更新说明
rbk 3.4.6.14 及以上版本，对【反光条】建图定位方案进行了优化和测试。对于使用仙工标准雷达的机器人，【反光条】建图方案能够兼容【反光柱】建图方案，建议使用标准反光柱布置现场，使用【反光条】建图用于建图和定位；
对于 rbk 3.4.6.14 及以上版本，提供一个额外可配置参数：

## 参数名称

## 参数位置

## 单位

## 默认值

## 最小值

## 最大值

## 支持版本

## CompensationLength

## 参数配置

## m

## 0

## -1

## 1

### 3.4.6.14~latest

此参数为反光柱拟合时候的补偿值，每款雷达对高反点云识别效果不一样，因此增加此参数用于补偿，建议填入当前 反光柱半径 。

此参数在现场布置为反光柱，但 roboshop 使用【反光条】建图定位时需要启用，并修改值为实际安装使用的反光柱半径。

其他非标准雷达或其他 rbk 版本，使用【反光条】建图用于建图和定位，或者自行测试后择优选择。
tip：【反光柱】识别方案对非标雷达可能效果较好，但对于标准雷达【反光条】方案更稳定。

### 3.2. RoboShop 配置入口和实施说明
Roboshop 版本要求：2.4.1.111 以上版本。
### 进入建图接口如下，需要先获取机器人控制权：
1710918943915-367f6432-7be0-4d84-a08a-0ec3845f05b5.png

### 3.2.1. 反光板建图
选择在线建图中需要确保获取当前机器人控制权。点击在线建图入口，建立 SLAM 地图，在 Roboshop 点击 2D 建图 -> 在线建图 ，在对话框中勾选反光板选项，如下图所示：
1710918978066-b77d562a-47ea-40bd-95f9-c5b156d92061.png

1710919276398-2c95c13f-27f2-4f4d-87a6-72fb21354285.png

## 在【配置建图参数】页面：
【反光柱】选项，即使用【反光柱】拟合方式进行建图；
【反光条】选项，即使用【反光条】拟合方式进行建图；
以上选项在建图中会生成不同属性的反光标志，Roboshop 上显示为 【反光柱】-> 圆形，【反光条】-> 方形。
反射强度阈值：提取反光柱的阈值，默认为 150.0，一般情况下使用默认值即可；
宽度：反光柱或者反光条，在激光扫描方向的直径（正常为水平方向观察到的反光板宽度）。默认 0.09 m，可根据实际的反光板宽度进行修改之后点击确定即可进行建图。
## 建图过程如下图所示：
1681875187489-eca530ec-8a0e-441d-a232-e8451fd8d7fa.png

1710919844584-89846913-3f8b-497f-a92a-d194862ea7ad.png

建图完成后，可以看到地图中生成了红色反光标记，需要注意检查地图中的红色反光标记与实际布置是否一致：
如果有生成多余的反光标记（可能是环境中其他高反物体，或者是激光近距离拖尾产生的误识别点。），需要在地图编辑页面，选中该反光标记进行删除。
如果地图中存在漏掉反光标记（环境中布置了，但是地图中并没有生成），可以进行重新扫图生成，也可以进入地图编辑页面，手动进行添加，但必须保证机器人此刻定位准确，如下图所示：
1683266757594-9da175ea-f3aa-494f-8ab5-b1742df4ef32.png

### 3.2.2. 定位区域配置
### 地图中，需要配置【反光板区域】，入口如下：
1710921631160-bee82035-66a6-4d44-91da-950c8ad3d1c5.png

1710921666048-0f0cfdc6-7b92-4a02-923a-b84cd5bc03d3.png

地图中，只有配置【反光板区域】的浅色方形区域，在该区域内机器人才会优先使用识别到反光板，进行反光板定位：
1710921858997-3f3e4782-6df3-44cc-b7eb-d6c0df28ad21.png

1710921903251-de2e362d-3a86-4782-a4b7-b385576b0beb.png

注意：由于在反光板定位区域内只会使用该【反光板区域】内反光板进行定位，在绘制反光板定位区域时，该区域需要包含地图中需要使用到的反光柱/条。
如下图，绘制【反光板区域】时，需要用 红色区域 1，而不是 绿色区域 2 。
## image.png

### 3.3. 反光板区域内的定位说明
### 3.3.1. 反光板区域内定位显示
目前在 Roboshop 中支持实时显示检测到的反光板，检测到的反光板是由黑色实心圆/方形表示，如下图检测到的反光板（此功能需要 Roboshop 2.0.6 及以上才可支持，如使用 Roboshop 2.0.4 可略过此步骤，不影响使用）：
1655102623884-389aa60e-700b-452d-8fb3-33be7198ccd0.png

如图所示，当前检测到的黑色反光板点和地图里的红色反光标记匹配度较高的时候，就是在【反光板区域】内定位比较准确的时候，此时可以查看左下角的当前定位置信度：
1655102624024-793318de-51f9-455a-acf7-bbdd852023a0.png

通常在【反光板区域】定位准确的时候置信度在 0.95 以上，如果出现置信度低于 0.9 的时候可以检查右下角是否出现 Warning 的警告，提示有可能当前检测到的反光板数量少于 3 个，定位结果不可靠，此时应该检查原因，是否视野中的反光板被其他物体遮挡，导致检测反光板数量不够。
1655102624235-1f0528d9-ceb3-4dca-a6c5-260eba5ddf5e.png

### 3.3.2. 反光板区域内的重定位
在【反光板区域】内的重定位和在非反光板区域定位方式相同，但是【反光板区域】内的重定位需要给定一个较为精确的初值，通常给的初值不能距离真实位置超过 1m，否则会重定位失败，再给定一个精确的初值后，在【反光板区域】内通常内快速的重定位成功：
1655102624466-aceb07b3-1d04-4d4c-854e-f55590b7753f.png

### 4. 使用注意事项
在【反光柱】建图过程中可能存在一些其他的高反物体，导致误识别，所以有其他高反物体请提前遮挡住后，再进行建图。
在 Roboshop 的建图和定位中，在同一张地图中优先只使用一种反光板定位方案，即只使用【反光柱】或者【反光条】，不要混用。
