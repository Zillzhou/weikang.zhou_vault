# 实施过程-正向操作 SOP

## 实施过程-正向操作 SOP

## 版本

## 更新日期

## 更新说明

## 文档状态

## 维护责任人

## V1.0

### 2024.4.29

## 更新发布

## 使用中

## 1. 场景描述
## 1.1. 场地
场地为仓库内，多层多列货架，巷道单侧货架，料箱车间隔缝隙10cm，机器人底盘距离货架15cm。
本文内容皆基于此场景进行作业。
1710486240543-97eaac6d-645f-4856-9bd9-27d32fd57199.jpeg

## 1.2. 料箱机器人
### 产品名称： 激光 SLAM 多层料箱机器人
## 型号： SPK-M50J-F-6
### 尺寸：1700 x 1000 x 3200 mm
## 整机质量： 450kg
## 最大单箱载重： 50kg
## 料箱车实体照片如下：
1710486348264-f0cb234c-f9d3-4d31-8767-9a2e5cf3ef3e.jpeg

### 2. 开机
### 2.1. 电闸
（1）在机器人底盘左侧下方找到一个可打开的盖子，打开盖子后可以看到里面的电闸。 
1710134870917-2a629aa0-576f-4ea2-82ad-f5197b3f5cd8.png

（2）打开盖子后，可以看到有两组推杆，左边两个连在一起的推杆是供电电闸，右边单独一个推杆是自动充电开关，将左边推杆推上去即可完成供电。 
1710134887553-3a4e514c-e3fd-4293-a6fe-040f6e5f6cd1.png

### 2.2. 开机键
在车体底盘右侧找到两个网络调试口和一键启停的开关按钮，长按一键启停按钮3秒左右，蓝色按钮指示灯亮起代表机器人已开机。 
1710134744128-f034547e-ad82-4217-b1c0-cba58bdf1591.png

### 3. 连接机器人
### 3.1. 有线连接机器人
（1）机器人开机后，第一次使用需要用网线连接机器人，后续配置好无线网络参数以后，可以使用WiFi连接机器人。
（2）如下图，将网线一端连接SRC调试口，另一头插在笔记本电脑以太网口上，如果使用的笔记本电脑没有网口，则需要使用USB-网口转换器进行连接。 
1710134756583-68397720-8332-4a00-b6fc-7c71420ab514.png

（3）连上网线后，打开电脑的网络设置，将电脑的以太网IP地址更改为192.168.192.xx 网段，操作参考下图， 机器人默认 IP 地址为 192.168.192.5。
1710491608804-84c6bcee-6348-4597-9c20-690702e40bb9.png 

（4）打开电脑上的 Roboshop 软件，点击右上角【添加设备】按钮，输入控制器默认 IP 地址 ： 192.168.192.5 ，点击确认。
1710491707160-45ee1f60-c1bf-403a-a0a8-1211f8afb603.png

（5）在【首页】的机器人列表中找到 IP 地址为【192.168.192.5】的机器人点击【开始连接】按钮进行连接。
1710050923927-6cd00344-e8b2-4b7f-b736-d3923d03c082.png

（6）连上机器人后，双击该机器人进入机器人地图主界面，会弹窗提醒需要确认机器人当前位置是否正确，初次使用时还未扫图，建图，点击取消即可。
1710042940310-b17e75de-0de3-49ca-a44b-473734a18d5b.png 

### 3.2. WiFi 连接机器人
（1）通过无线连接机器人的前提是已经给机器人配置好了无线网络，配置无线网络的操作参考 无线网络配置 。
（2）确保电脑和机器人连接的是同一个局域网，打开Roboshop软件，在右上角点击【添加设置】，在弹窗中输入机器人的无线 IP 地址，点击【确认】。
1710051120489-d0220e4b-6989-435d-bcc2-4b9e45a20d24.png

## 机构复位和标零
（1）在 Roboshop 机器人主界面，点击菜单栏 【机构脚本】，点击【下载】拉取全部脚本，
（2）找到 containerRobot.py 文件 ，选中该文件点击【开始】 ，
（3）在弹出的窗口界面勾选 operation 参数，选择 zero 选项，
（4）点击【确认】后执行机构归零操作，该操作将对货叉进行一次自动机构复位动作，确保货叉正常。
1710491388768-e086defc-dbcd-46eb-995d-0905b8bde7ee.png

（5）机器人开机后，第一次执行脚本指令时，在货叉运动前会自动进行电机标零，标零完成后机器人才会执行刚刚下发的脚本指令。只有新开机第一次执行指令前会有电机标零的动作，后续下发的任务会直接执行。
## SLAM 扫图
（1）确认机器人无异常后，可开始对所需要作业区域进行扫图；回到地图主界面点击 【2D 建图】, 选择 【SLAM】，不同Roboshop版本中【SLAM】可能显示为【在线建图】，参数保持默认即可，确认后开始扫图；通过键盘【WASD】键来操控车辆行走和转向，对所需要作业区域进行闭环式扫图，最后扫出来的地图和机器人行走的路线一定要行程一个闭环。参考以下截图及动图操作。
1710051731317-2338f4a4-febc-45f1-9da8-dc7f02d071ca.png

1710051785424-f47f638e-cdbf-4bef-b16c-9af80ccddc68.png

1710051607816-245fa298-cba5-4e17-817f-ffa184a4d80a.gif

（2）完成扫图后将地图保存至本地并将地图推送给机器人，机器人会根据当前激光检测到的点云数据在地图当中的匹配程度自动进行定位，完成后会弹出提示框需要人工进行确认确保机器人实际位置在当前地图当中是正确的，如不对需要人工使用重定位功能进行二次手动定位确认，重定位功能可以按住鼠标左键不放，然后拖动圆圈来选择定位所需要参照的范围大小，也可不选择。操作如下动图。
1710052194099-b4459f28-d2bc-4f59-86f8-449521cc2c06.gif

### 6. 创建站点和路径
（1）在【地图与控制】界面点击【启用编辑】后进入地图编辑界面，可在左侧菜单栏选择【站点】和【路径】来进行站点和路径的创建。各站点类型的区别请参考 Roboshop 使用手册。
1710052924147-5ae9889a-4ba1-4f1c-9188-574b05aa8327.png

（2）点击【站点】，在地图空白处创建站点，可连续创建多个站点；
（3）点击【路径】，将创建的站点连接起来；
（4）点击【退出编辑】，点击【保存】，点击【推送地图】，机器人将自动同步地图信息并打开编辑后的地图，地图上显示刚刚创建好的路线；
（5）确认定位后，点击【路径导航】后，将鼠标放在某个站点上点击【导航到xx站点】,机器人将按照创建好的路径进行导航。
详细操作可参考以下GIF动图。
1710052734163-d909b7da-1615-4e90-9b99-653d3cc4f7c0.gif

### 7. 创建库位及动作
### 7.1. 创建库位
（1）在【地图与控制】界面点击【启用编辑】后进入地图编辑界面，在地图上创建工作站点，地图上显示为AP站点；
（2）选择【库位】，在AP点附近创建库位，选中库位，在界面右侧库位属性中，将库位绑定到AP站点上；
（3）点击【编辑】动作轨迹，在弹出的界面中点击【添加】，在属性框中添加对应的动作参数。
1710055334515-ce1e337e-4633-4228-b057-dab0fdd3737b.png

1710054972880-4b3e3bda-78ef-4965-befb-4836f39f91de.gif

### 7.2. 添加库位动作
（1）选中库位，点击动作轨迹【编辑】，可进行动作的添加、编辑、删除操作；
（2）添加或者编辑动作时，【键】表示动作名称，可自命名，常用动作为Load、Unload、Zero等；【值】表示具体的动作指令参数，该参数一般参考具体的脚本使用说明，料箱车的动作指令参数需要参考 智千料箱车脚本动作指令 。
1710055884006-f82d1015-2594-4e9c-9b88-060e86d1e985.png

## （3）识别取货指令
## {
    "id": "SELF_POSITION",
    "operation": "script",
## "script_args": {
### "goodsId": "111",  # 可缺省
        "lift": 0.91,
        "operation": "load",
        "rotate": 1.57,
        "stretch": 0.68,
        "visionBinType": "code",
        "visionType": "box",
## "recAdjust": 1
    },
    "script_name": "userpy/containerRobot.py"
## }
## （4）识别放货指令
## {
    "id": "SELF_POSITION",
    "operation": "script",
## "script_args": {
### "goodsId": "111",  # 可缺省
        "lift": 0.8,
        "operation": "unload",
        "rotate": 1.57,
        "stretch": 0.68,
        "visionBinType": "code",
        "visionType": "shelf",
## "recAdjust": 1
    },
    "script_name": "userpy/containerRobot.py"
## }
### 8. 执行任务链
### 8.1. 执行机构脚本指令
（1）点击【任务链】，点击【新建】，点击【新建任务】，点击【添加组】；
（2）鼠标选中【自定义动作】，拖进刚刚新建的组中，此时新建了一个自定义动作；
（3）点击【自定义动作】，选择【触发脚本动作】，将输入框中的参数替换成料箱车的脚本指令；
料箱车的脚本指令参数需要参考 料箱车脚本任务链指令 。
1710492457480-a1eb036e-2b36-4509-9bb5-4350456391fd.png

（4）勾选要执行的任务，点击【发送勾选的任务】，任务将自动执行。
1710057220662-8e4a7761-9d90-4281-850f-06275349efd2.png

### （5）任务链执行机构脚本的参数格式如下：
## {
  "id": "AP1",
  "operation": "Script",
## "script_args": {
## "operation": "zero"
  },
  "script_name": "containerRobot.py"

## }
## 参数说明如下表：

## 参数

## 说明

## id

## 站点名称

## operation

## 操作类型

## script_args

## 脚本输入参数

## script_name

## 执行的脚本名称
## 参考动图如下：
1710057133587-3988b4df-121c-4c4c-b3ad-4c1b16eb6e4f.gif

### 8.2. 执行库位动作
添加库位动作与添加脚本指令的操作是一样的，不同的点是动作中的参数不同，如下图中，1是执行机构脚本指令，2是执行库位Loc1中Load动作。
1710491879853-e57d321c-aac9-4f9f-85bb-815202cf2408.png

## 任务链执行库位动作的参数格式如下：
## {
    "id": "Loc-1",
## "binTask": "Load"
## }

## 参数

## 说明

## id

## 库位名称

## binTask

## 库位动作
### 9. 手动设置背篓数据
料箱车在进行取放货时，会对车身上的背篓进行记录，如果中间出现异常人为进行干涉，需要检查实际背篓上的料箱和roboshop当中记录的是否一致，如果不一致，需要人为在roboshop中设置或者清空才可继续进行；一般选择清空操作。999 层数代表机器人本身手上的有无货物。具体操作如下：
（1）点击【地图与控制】界面左下角齿轮图标，弹出【设置手动控制参数】界面；
（2）点击【货物配置】，选择有异常的背篓号，点击右下角【无货】，即可清空该背篓数据。
1710053676345-6b770fba-0a1b-40a5-8f31-261ef178d9ce.png

### 10. 调度下发运单
需要在笔记本电脑或服务器上安装RDS， 安装教程参考RDS 快速入门
### 10.1. 调度同步机器人场景
（1）RDS安装成功后，启动RDS程序，在Roboshop首页右上角【添加设备】，输入目标电脑或服务器的IP地址，本机一般默认为 127.0.0.1 ，点击确定。
1710290100174-914289c1-2ffb-4921-ac58-70a5d7b23974.png

（2）双击添加的调度进入调度界面，进入调度界面后，点击【启动编辑】，并点击【新建】，可建立一个新的场景。在【机器人组】上点击鼠标右键，选择【添加组】；
1653529677624-24ba4a65-c586-461c-b643-9a10af968f35.png

（3）选中新建的组，在【机器人组】上点击 “+” ，在弹出的【添加设备】页面中勾选机器人，默认为全部勾选，点击【全部】取消勾选，然后选中要添加的机器人即可（需要是真实机器人），即可添加设备到组内；
1710290915076-793e0119-d301-4b62-bd7f-9849086b94bc.png

（4）点击【启动编辑】，在机器人组上，如图所示，鼠标移动到分组，点击右键选择【添加组内机器人地图到区域】，即可显示机器人中的地图列表。蓝色框内的小“√”为当前机器人使用的地图。如需要切换地图，可在【添加组内机器人地图到区域】后选择其他地图点击，退出编辑后上传场景即可完成地图的切换。
1710291190164-35992061-f2e1-4e12-9718-f7e624628e74.png

### 10.2. 通过API下发运单
（1）退出编辑后，在首页点击【发送运单】，选择【API】，【POST发送任务】，将Body输入框中的运单内容修改为料箱车脚本任务；
1710291352011-0770ff5d-5ec7-4633-8676-e1fde988eae1.png

## （2）修改后的运单参数内容参考如下:
## {
    "id": "task3",                                                                                                
    "vehicle": "AMB-01",                                                                        
    "group": "Test",                                                                
    "keyRoute": ["AP1"],                                                                        
    "priority": 10,                                                                                                
## "blocks": [{
        "blockId": "b1",                                                                        
        "location": "Loc-01",                                        
        "binTask": "load",                                
        "goodsId":"xxx",                                                                
## "postAction": {}
    }],
## "complete": true
## }
（3）如果下发任务无误，且机器人正常，则机器人会按照指令执行对应的任务。
### 10.3. RDS天风任务下发
## 编辑场景文件
### 在roboshop添加127.0.0.1的设备
1710162327323-ce3bcf2f-e5f0-417f-b2df-5b6e6f812cce.png

## 点击①启用编辑，点击"+"号 ②
1710162447809-51e56345-bcc8-4ba0-8d3d-d3fd068a7ce5.png

## 勾选需要添加的机器人
1710162517431-f5e32a01-1414-42f6-a834-c307cf07dba1.png

## 右击组，导入对应的地图
1710162647495-10b9e43c-904a-4c23-8472-c7f9f8ea1203.png

## 效果如图，保存并推送场景
1711091387184-03831daa-d447-46e8-b57e-34c88458f958.png

## 新建天风任务
1709533824000-8905b9cd-0fc6-4412-bff1-f7c6835cdce1.png

1709533823939-4ed63077-3082-4650-a84a-b49b30861743.png

## 选择执行任务的机器人
## 在机器人界面可以看到可用机器人列表
1711092019771-cf7d8c24-a0ff-49e6-a777-538bbbac46fb.png

## 将机器人块拖到编辑框
1711092002130-a52fe0d7-81d9-484f-8abe-0bbd7b2383e3.png

## 填写机器人名称
1711092098870-d4d3e678-8684-4bf1-ac04-91e1b8f6659d.png

## 填写关键路径 AP1
1711092220785-701c6412-05f7-4c78-8bc6-370fcfeea17f.png

## 添加机器人通用动作
设置目标库位，如 Loc1-1；
1711092643915-7494a0a7-b788-4449-bb52-5395f979898a.png

设置指令内容：选择 bintask；
1711092679377-84814835-7924-42b0-9dbb-ae759e65a265.png

设置指令参数：输入 load 或 unload(注：这里选择的 load 和 unload 的动作 来自于库位的 bintask 配置;
1711092722244-16883f1b-8f00-4572-aca0-09571bd51f8e.png

## 同样办法设置unload如下图
1711092792054-6edaaedc-145e-47af-bced-132524606ff9.png

## 保存并运行天风任务
机器人接收到调度下发的任务后会自动前往 Loc-2-1库位取货，到 Loc-1-1 库位放货。
1711092845937-ebca14c7-1662-4fbf-a85a-17e25b63a370.png
