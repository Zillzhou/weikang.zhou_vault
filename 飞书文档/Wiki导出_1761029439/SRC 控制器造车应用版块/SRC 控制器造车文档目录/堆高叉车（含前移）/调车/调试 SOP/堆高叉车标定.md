# 堆高叉车标定

## 堆高叉车标定

## 版本

## 更新日期

## 更新说明

## 文档状态

## 维护责任人

## V1.0

### 2024.4.29

## 更新发布

## 使用中

## 版本

## 更新日期

## 更新说明

## 文档整理人

## 维护责任人

## 研发审核人

## 应用审核人

## 市场审核人

## V1.0

### 2024.03

## 初版

## @徐克轶

## @徐克轶

## V1.1

### 2024.06

## 增加标定结果查看

## @徐克轶

## @徐克轶

## 标定舵轮转向电机
### 进入【地图与控制】-【其他】-【标定机器人】
1711016144248-c2352201-9c4d-4ece-b637-23cfdadf6c9e.png

## 图 1.1 进入标定页面
1711016056653-9820748a-a116-440a-b4bc-dae14d543f7d.png 

## 图 1.2 开始标定
1711016159830-9720e668-57bd-4b6d-9e13-3954cb74626b.png 

## 图 1.3 标定过程
1711016165349-a423a763-8986-40d8-a92a-67d3976325ac.png

## 图 1.4 标定结束
## 标定结果检查：
进入模型文件页面，查看对应转向电机的最大最小角度，是否与驱动器中配置的软限位一致，驱动器配置请参考步科直流伺服驱动器。
## image.png

## 图 1.5 标定结果
## 堆高叉车激光&里程计标定
同时标定激光雷达外参（相对于车体坐标系的位姿）和里程计参数。
## 标定介绍
## 下图所示为一个动作循环，具体依次为：
车辆从起始位置出发，正向行进一个 90° 的左转圆弧，到达“田字格”范围的左边中点后，再反向原路返回；
正向直行，到达“田字格”范围的上边中点后，再反向原路返回；
正向行进一个 90° 的右转圆弧，到达“田字格”范围的右边中点后，再反向原路返回。
根据参数，标定动作可能包含若干次循环。
1652611132752-527061d8-b85b-4c41-8d4f-779ed6b2f8d5.png

## 图 2.1 标定介绍
## 可调参数

## 参数名称

## 参数意义

## 备注

### SteerLaserOdomCalibSize

## “田字格”范围的边长

## -

## LaserOdomCalibSpeed

## 标定时的最大线速度

## -

## LaserOdomMaxRotVel

## 标定时的最大角速度

## -

## LaserOdomCalibCnt

## 动作循环重复次数

## -
## 操作介绍
## 进入标定页面
1709638276176-5bc5edcb-391f-40b5-b2e1-f5bd0ccacefe.png

## 图 2.2 进入标定页面
## 开始标定
选择自动标定，标定的设备选择 laser （模型文件中配置的定位激光）
1709638276312-17d73197-15a9-4634-9984-a3dbfae56df7.png

## 图 2.3 开始标定
## 标定过程
该标定项时间较久，约 10min，如过程中出现意外情况，可直接停止标定
1709638276340-41059f47-b478-450d-9cc5-8f9ca20bf593.png

## 图 2.4 标定过程
## 标定结束
标定结束后，窗口上方会弹出【设置标定参数成功】的提示，说明标定成功。确认机器人位置结束标定。
如出现【Fitting error during the calibration process】提示，可忽略，点击【确定】按钮继续。
1709638276250-a56d8746-9f1a-465a-9fac-6b6793c469f0.png 

## 图 2.4a 标定结束
1709638276565-0ef16015-ac38-4b61-9646-50cc6e35c2a2.png

## 图 2.4b 标定结束
## 标定结果查看
进入模型文件页面，刷新后打开设备【laser】，如标定成功，右侧参数栏x、y、yaw参数后会有标定后的蓝色修正值。
1709638803902-bf01b646-2d41-49fd-8056-7c0c968d2d9f.png

## 图 2.5 标定结果查看
## 实操视频

## 编辑地图任务链测试.mp4
### 视频 2.1 堆高叉车激光&里程计标定实操视频
## 激光与单舵轮模型半自动标定
如果上述自动标定不满足客户高精度要求，则进行半自动标定，熟练操作约30min,  rbk 版本 3.4.6.12 + 。
## 标定界面
点击其他（下图①），标定机器人（下图②），弹出标定界面，将依次标定以下项目，需要注意每个标定项需要预留的场地空间。
1710343585922-f3c44059-302d-4b1d-8968-ab7ed202747e.png

## 图 2.6a 进入标定页面
1710056102767-379b4727-829d-44ef-93ab-cf9d23837c6a.png

## 图 2.6b 开始标定
注意：确保机器人内没有自动标定的激光里程计标定结果，如果有需要删除。
1704779601657-12ec86db-a026-4907-9a3a-87e0248d75a9.png

## 图 2.7 删除激光里程计标定结果
### 覆盖舵角补偿文件，motor1，SinSteer_1
勾选motor1，SinSteer_1，点击开始标定，标定完后状态显示已标定
1710055964480-6a81b751-f4b5-4f44-846b-337e8bca635c.png

### 图 2.8 勾选motor1，SinSteer_1开始标定
### 舵角0度补偿和轮径标定 motor1，SinSteer_2
勾选motor1，SinSteer_2，舵角0度补偿和轮径标定；机器正前方预留5m，左右3m的空间，点击开始标定。
如果结果error不通过，进行上一步操作，直到出现结果通过/标定合格字样，则认为标定结束。一般至少需要标定2次。
1709651270335-294bc604-898a-402b-9a8a-1795ea98df3c.png

### 图 2.9 勾选motor1，SinSteer_2开始标定
舵轮安装位置 X 方向标定 motor1，SinSteer_3
勾选motor1，SinSteer_3，舵轮安装位置 X 方向标定：预留机器人旋转180°的空间，标定速度30°/s。
1709651537026-3c19dbf0-0cda-4a0d-9867-f53073aae6a9.png

图 2.10 勾选motor1，SinSteer_3开始标定
如果结果error不通过，进行上一步操作，直到出现结果通过/标定合格字样。一般至少需要标定2次。
### 激光安装角yaw标定 laser，SinSteer_4
勾选laser，SinSteer_4，激光安装角yaw标定：机器正前方预留5m，左右3m的空间，点击开始标定
1709651830853-ba50973b-7ae2-4a8e-8ca7-49ac3df41cca.png

### 图 2.11 勾选laser，SinSteer_4开始标定
如果结果error不通过，进行上一步操作，直到出现结果通过/标定合格字样。一般至少需要标定2次。
### 激光安装位置X标定 laser，SinSteer_5
勾选laser，SinSteer_5，激光安装位置X标定：预留机器人旋转180°的空间，标定速度30°/s。
1709652047394-5e7d09b1-47b8-4011-92cc-ee3e902fa18f.png

### 图 2.12 勾选laser，SinSteer_5开始标定
激光安装位置 Y 标定 laser, SinSteer_6 (手动标定)
laser,SinSteer_6，激光安装位置 Y 标定：此项需要手动测量，绘制地图。
## 编辑地图
点击编辑地图，在空白处右键点击导入图元，地图新增三个点位，此项标定需要测试出 从右点位正走至中间点 与从 左点位倒走至中间点 的里程中心y方向偏差。
1710343643161-3341b6a4-c250-46a9-b35f-12db254afb79.png

### 图 2.13a 进入编辑地图页面 导入图元
1710343680872-94d1be3f-22c1-4107-81a1-5f817ae57a6a.png

### 图 2.13b 进入编辑地图页面 导入图元
## 得到图型如下：
1710343698092-f2af3ee1-ddae-4650-8aaf-77e683ef5b92.png

## 图 2.14 导入图元结果
建议改LM编号如下图，方便后续操作讲解。
1710343758965-15e3dbfa-3692-42f9-9cc7-938cd466c0a4.png

## 图 2.15 修改站点编号
## 修改线路方向，不勾选点位朝向：
LM1与LM2：LM1->LM2正走，LM2->LM1倒走；
LM2与LM3：LM2->LM3倒走，LM3->LM2正走；
## 点击线路①后在右侧②处选择正走倒走
1710343827794-780283f0-365b-401b-9360-dec33e6d523e.png

## 图 2.16a 修改站点/线路
1710343810314-da0febcc-3bd3-476f-82bb-9be14c08d34d.png

## 图 2.16b 修改站点/线路
1709652780417-6292ac3a-9500-4844-809f-82c9c223ab37.png

## 图 2.16c 修改站点/线路
## 里程中心打点
导航前先将参数配置的wkp改为3，完成此项标定后再改回wkp为原有值。(叉车参数配置的lqr_mode=false，这个不要改)；如搜索不到对应参数，则勾选"显示更多"重新搜索。
1710059172662-d480fd4f-35cb-4f52-83fb-8463a0f9ddb2.png

## 图 2.17 修改参数wkp
LM1与LM2之间多次循环路径导航，直至连续两次到达LM2点处y方向偏差小于5mm。
由于地图坐标系和机器人坐标系存在转换关系，我们需要观察机器人y方向的变化。一般通过下图运行状态-地图坐标观察偏差值，小幅度变化的为y方向，大幅度变化的为x方向。 
1709653261726-01d01abf-af9d-4e92-847f-cf4a9e25a970.png

## 图 2.18 查看机器人坐标
### 在货叉里程中心，即两轮中心取中间点打点，如下图
1710909763032-b3a10741-1395-4ba0-b178-44d03463e8b1.png

## 图 2.19 打点
注：①用马克笔在所画里程中心处位置标记号，使两次用同样位置打点
## ②用直尺量取两轮内侧之间的间距
③取两轮之间的中间值，打点。
LM2与LM3之间多次循环路径导航，直至连续两次到达LM2点处y方向偏差小于5mm。
## 在货叉里程中心，即两轮中心取中间点打点
量出两点在y方向的偏差。
## 标定机器人
在机器人界面勾选标定项，开始标定，在弹框中填写测量出的偏差值，点确认，标定完成。
1709653726515-87729342-00cb-46f8-9713-feab957e6f0e.png

## 图 2.20 开始标定
1709653772486-e13f9f7e-f6a9-4c4c-9abb-a1eaeb6fa9a3.png

## 图 2.21 填写偏差值
舵角补偿标定(正负90度正走倒走) motor1，SinSteer_7
勾选motor1，SinSteer_7，舵角补偿标定(正负90度正走倒走)：预留机器人旋转360°的空间。
1709653922612-45bd9526-878a-455c-8db4-8d9f81f0ab0e.png

图 2.21 勾选motor1，SinSteer_7开始标定
如果结果error不通过，进行上一步操作，直到出现结果通过/标定合格字样。一般至少需要标定2次。
### 检查标定结果 laser，SinSteer_8
勾选laser，SinSteer_8，机器正前方预留5m，左右3m的空间，点击开始标定。每个标定项结果如图， 如果有未通过标定项，则继续针对次标定项进行标定。
1709653998386-7559785b-fcc5-461a-8c0e-50799cb02b17.png

### 图 2.22 勾选laser，SinSteer_8开始标定
1701942692765-8066f9c5-6dc8-4876-874b-c30f29b31714.png

## 图 2.23 标定结果查看
## 货叉标零（待补充）
## 避障激光外参标定
## 需要 RBK 3.4.6.12 及以上
### 在进行避障激光标定之前，需要完成定位激光的标定！！！
## 环境与地图要求
通常情况避障激光的安装高度与定位激光并 不一样 ，也就意味着他们感知到的环境不在一个平面上。而为了简化标定操作，我们只使用定位激光的地图作为参考。

1701477137831-77202c52-f5dc-48d8-a50f-64c4a71ea2d8.png

## 图 4.1 避障激光安装图
由于激光高度不同，所观测的环境通常也会不同，为了保证好的标定结果，需要保证环境中有 垂直的平面 以便不同高度的激光也可以看到相近的环境特征。如下图所示：
1701312226473-233def56-9b8a-4dd3-a20a-ea02a5c5cb87.png

## 图 4.2a 标定环境
1701312236156-31c37537-0157-4dc7-b571-8e32b81356bd.png

## 图 4.2b 标定环境
## 对应的地图区域如下图红框所示：
1701312552622-1893c77a-f13b-48ea-9256-d16ec7a6318c.png

## 图 4.2c 标定环境
注意必须有两个以上的垂直平面，彼此间角度明显差异。
如上图所示，红色区域是避障激光对环境的观测结果，蓝色是定位激光的观测结果。
## 标定流程
1701314224726-a9f236e8-14bf-49e0-adbf-4b334c12cff5.png

## 图 4.3 激光安装参数
首先需要按照机械图纸输入避障激光的安装位置。有时初始安装位置误差比较大，如上图，为了保证较好的标定结果， 位置误差需不大于 20cm，角度误差不大于 30° 。
将车辆开到上文中提到的垂直平面位置附近（2米内为宜），再调整位置确保避障激光在不同平面上可以打到充分的点。为了便于观察通常只启用一个待标定的激光。
### 确认当前的位置正常，勾选待标定的激光，点击开始标定
1701314274123-fc7cb7ff-4715-4862-b1ec-bd7325561f57.png

## 图 4.4 开始标定
标定结果如下图所示。
1701314420925-ee47f30e-7fec-4821-8229-a262f9ff3a1c.png 

1701314456084-6c24efb3-9f70-4f03-ae87-d957a1ca5d88.png

## 图 4.5 标定结果查看
此时避障激光应该与定位激光有很好的重叠，如若重叠不好可再次尝试标定（ 注意不需要清除上次的标定结果 ）。通常标定误差在 5mm 以内，角度误差不大于 0.05°。
1701314377159-ed6e2ead-2903-4a61-8e55-bfd015e76d44.png

## 图 4.6 多次标定
如果多次标定避障激光与定位激光都无法很好的重合，需要确认下地面不平或者不同激光观测到的环境有较大差异。
## 操作演示

## 避障激光标定.mp4
## 视频 4.1 操作演示
## 避障相机外参标定
相机外参标定适用于安装有 3D 相机（模型文件中勾选了 3Dcamera 属性；该属性根据相机型号自动赋值，请勿人工修改）和二维RGB相机的车辆，每个符合条件的相机都对应一个此类型的标定项。
相机外参标定主要分为两种方式， 一种是针对只用作避障的3D相机（比如：大彊mid70），另一种是针对识别的rgb相机以及部分3D相机(例如图漾)。
针对避障的3D相机，只标定相机距离地面的距离（z值），以及相机的倾斜角roll值。
## 避障3D相机标定
此种方式标定的相机一般用作避障功能 ，检测障碍物和坑洞。只标定相机距离地面的距离（z值），以及相机的倾斜角roll值。该标定的标定结果直接由深度相机插件给出。该插件是通过识别地面相对于相机的距离和角度来求取相机外参的。
## 相机包括：mid70
## 使用地面标定
在相机模型文件中勾选 3Dcamera 属性。
1680424836878-d4d691cb-4543-4d7f-b94c-322b466c6b22.png

## 图 5.1 勾选 3Dcamera
### 2. 标定相机。 该标定无需运动，仅需调整车辆位置 使待标定的 3D 相机的视野里尽可能多地为水平地面 。点击“开始标定”后将立即返回标定结果。

查看标定结果 。 z是指相机的离地高度，可以拿尺进行准确量取，通常标定后的高度与测量的高度误差应该小于0.05m（主要来源于相机中心难以确定），roll表示相机的倾角（一般水平的时候是-90度，往下越多则比-90更小，因此如果相机朝下看的话，一般小于-90）
1680426590295-484da725-15e2-4a4c-b850-658701238f53.png

## 图 5.2 查看标定结果
## 注意事项
如前所述，标定时需要使 待标定 的 3D 相机的视野里尽可能多地看到水平地面，并且保证地面空旷平整。因此，当装备了多个 3D 相机时，请注意分辨标定项所对应的标定相机，并据此调整车辆位置。
参数配置中：MaxLength可以配置相机检测的最远距离。改变此参数确保读取的点云数据都为地面。
1680425217219-8d87a942-73f4-47f3-974c-fcaeb07fd22f.png

### 图 5.3 配置参数 MaxLength
## 使用墙面标定
在相机模型文件中勾选 3Dcamera 属性。
1680424836878-d4d691cb-4543-4d7f-b94c-322b466c6b22.png

## 图 5.4 勾选 3Dcamera
在相机模型文件中勾选 useWallCalib 属性。
1693359322870-1c8c2aff-6528-4ea6-a957-6241fab15617.png

### 图 5.5 勾选 useWallCalib
标定相机。该动作无需运动， 仅需调整车辆位置 使待标定的 3D 相机的视野正前方为墙面，尽量避免视野内存在除墙面以外的其他物体 。点击“开始标定”后将立即返回标定结果。
测量相机高度。使用卷尺测量相机的中心点离地高度，记录下来后修改标定后的相机模型文件。
1693798502837-bb8dd798-b5a2-4f61-bc64-ab3a33ff8a07.png

## 图 5.6 测量相机安装高度
修改相机模型文件。
1693798639080-b4852799-27e9-4f70-8a85-6542ab35b759.png

## 图 5.7 修改模型文件
相机模型文件中 z是指相机的离地高度，由于使用墙面的标定方法是无法准确得到相机离地高度信息，我们根据步骤4中用卷尺测量得到的相机离地高度去修改相机模型文件。 如上图所示，要求修改后的红色框和黄色框中的数值相加与步骤4的测量高度相等。修改完成后重新推送模型文件。
## 注意事项
由于使用墙面标定时相机高度是人工测量得到，难免会由于个体差异导致z值标定精度不高。因此，当避障相机能够看到地面时优先推荐使用地面的方式做相机标定，对于上视避障相机视野内完全看不到地面的情况才适合使用墙面标定。
## 栈板识别相机标定
## 识别相机工装标定
此种方式标定的相机一般用于 二维码识别以及栈板识别功能 。标定相机的外参：x，y，z，roll，pitch，yaw。 相机包括：图漾、维感。
## 标定所需工具
工装标定支架、二维码、卷尺。
## 工装标定支架：
## 标定支架设计图纸可以从以下链接中下载：
https://dl.seer-group.com/SEER-Knowledge/software_tools/camera/XGXJ-21003%20%202021-07-06-%E5%8F%89%E8%BD%A6%E4%BA%8C%E7%BB%B4%E7%A0%81%E5%AE%89%E8%A3%85%E6%A3%80%E6%B5%8B.7z
## 二维码
标定二维码采用的是AprilTag 36h11，编号分别为 0 和 1 。该码的生成在 Roboshop -> 其它 -> 二维码工具 ,
1694139141670-c28cba0a-ffcc-4283-8630-3216fe5069bc.png 

## 图 6.1a 生成二维码
1694139319315-2d83a96c-48c0-4a35-b60e-0814c19fd22f.png

## 图 6.1b 生成二维码
## 注意： 二维码黑边圈数一定要选 1
## 卷尺
长度超过两米的卷尺即可。
## 标定板的制作及安装
1694140529538-0262a56b-7c17-4793-89ba-5a5b4cf6d149.jpeg

## 图 6.2 制作二维码
AprilTag 36h11 编号为 0 粘贴在工装标定板左侧，AprilTag 36h11 编号为 1 粘贴在工装标定板右侧；
二维码大小在 100mm 即可；
单个二维码关于一侧的工装板中轴线对称；
两个二维码的在同一水平高度。
二维码要紧贴工装板，不能二维码与工装板有空隙突起；
标定板左右两侧的卡槽贴紧叉齿左右两侧，以保证左右两侧的二维码关于里程中心的 x 轴对称；
## 修改参数入口
## 本文档的所有参数修改入口如下操作所示：
1686711754885-67ab792a-3f21-4a00-9822-d6182996fd03.png

1686711796898-6565f4e2-c62c-474b-bb87-62ec87527008.png

## 图 6.3 修改参数
## 标定数据的获取

1654573172307-6305997f-d8ad-4453-83a8-d99a3f2371af.jpeg

## 图 6.4 测量标定参数
完成以上工装设置之后，开始量取标定所需数据， 注意单位均为米。

## Tag_Height

## 二维码的中心距离地面的高度

## disBetweenTag

## 两个二维码中心之间的距离

## Tag_disFromCenter

## 二维码距离里程中心的X方向距离

## Tag_Size

## 二维码的大小

## Taginfork

## 标定板是否固定在叉齿上

将量取的数据 在参数配置中分别对应填入,同时 将参数配置中 TagInFork 改为 false 即可。
1654573201264-38e77243-7d80-477f-b21c-641a68f96202.png 

1654573373757-dd3dbf24-fe30-4954-b2c8-d7e6cfde00d6.png

## 图 6.5 修改标定参数
## 开始相机标定
开始进行相机标定：在 Roboshop 地图与控制 界面的 其他 选择 标定机器人 进入相机标定界面，勾选需要进行标定的相机，如下图的图漾 FM851，然后点击 开始标定 。标定完成后会弹出标定好的数据，点击 设置参数 即可。
1694576485008-b9f6faee-97e3-4ab2-ba69-ce27b987f2d3.png

## 图 6.6a 开始标定
## image.png

### 图 6.6b 选择标定方法，此处选择 PalletTool
查看标定结果：标定完相机数据将标定数据设置完成之后，需要点击模型文件刷新按钮，进而可以在模型文件中看到标定数据，如下图所示：
1706434442361-d4eae689-2303-461c-b1c0-3254dd3444f3.png

1654695619205-f7a8accf-2442-4edb-92f4-016479cb67c0.png

## 图 6.7 查看标定结果
相机的外参是模型文件的数据加上红框标定数值，因此标定完成后需要根据求和之后来判断结果的合理性。
x、y、z表示相机在机器人里程坐标系的位置，可以通过卷尺进行准确量取，通常标定后的高度与测量的高度误差应该小于 0.05m（主要来源于相机中心难以确定）;
roll表示相机的倾角（一般水平的时候是 -90 度，往下越多则比 -90 更小，因此如果相机朝下看的话，一般小于 -90 ），pitch 角度一遍都比较小（不会超过 1° ）。yaw 表示相机和机器人的水平角度偏差（如果相机安装在叉车或者地牛上，通常都是 180 或者 -180 左右，一般偏 差不会超过 5°，除非特别的安装方式）。
因此根据这些经验数据来判断标定的合理性，超过这些数据就需要检查一下。
## 非工装标定
二维码支架或二维码标定版，两种工具选一种并配置对应的参数即可。针对两种工具都没有的大部分现场来说，仙工还提供了非公装标定法。
## 借助其他规整物体进行标定
除了上述的方法之外，还可以直接使用一个比较规整的长方体来进行标定。
## 标定所需工具
叉车、规整长方体、二维码、卷尺。
## 标定板的制作与安装
在长方体上面贴好tag之后直接摆放在叉齿上，按照中心对称、与叉齿两个辅助轮对齐的操作将长方体摆放在叉齿上。然后测量两个tag之间的距离、离地间隙，分别填入参数配置。如下图：
1671070064368-39689ad0-26a5-49cf-ab65-363f25244e42.png 

## 图 6.8a 非标定工装
1671070073108-b2391a40-ac70-492c-bb59-6275c79f054d.png

## 图 6.8b 非标定工装
1706434006192-9848a5c1-8700-4b45-8e60-34b7709c4295.png

## 图 6.8c 非标定工装
## 要点：
1：二维码必须距离里程中心同一个距离。
2：保证二维码尽可能垂直居中在插齿上（而不是箱子居中在插齿上）。
3：二维码应设置平整整齐。
4：二维码左 0 右 1。
## 标定数据的获取
参考 4.1.5。
## 开始相机标定
参考 4.1.5。
## 标定结果验证
标定结果可参考栈板上下架应用正向操作 SOP中的操作，如取放货偏差在±20mm内则可认为标定结果正常。
