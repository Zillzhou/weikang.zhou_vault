# 小车充电桩

## 小车充电桩
## 更新记录：

## 版本

## 更新日期

## 更新说明

## 文档状态

## 维护责任人

## V1.0

### 2024.7.11

## 初版

## 使用中

## 充电桩选型说明
现有底盘车充电桩按照是否内置控制器分为不带通讯的和带通讯的两种类型，从来源分，可分为自研和客制。充电桩主要由充电模块、极片接触机构、外壳组成。
## 充电桩端架构和分类
AMR 由于车型高度较低，一般情况下充电极片安装在车头或车尾位置。其配合的常见的充电桩由充电器、极片接触机构、外壳、反光贴（激光识别用）组成，其工作原理实质与手动充电器一致，不同的是具有固定机构、导向板、反光贴以方便 AMR 通过激光识别到反光贴以确认充电桩位置。如下图为 AMR 充电桩的结构示意：
1651998808377-cdf66407-2e7e-4fd8-aba2-487ff25685e6.png 

## 自研不含通讯充电桩
## 充电桩有两种模式：
智能模式：当机器人就位时，充电桩检测到机器人极片电压后才会开始输出充电。
强制模式：充电桩持续输出。当电池严重亏电，无法开机时，将充电桩置为强制模式，强制输出充电电压来激活电池，当电池被激活后应立即将充电桩恢复为智能模式。
充电过程分为如下阶段：预充、大恒流、小恒流、恒压、关断等，其作用为保留最大的充电效率的同时降低对电池的损伤、延长电池寿命。如下图为常见的充电曲线（ 48V 系统）：
1651999235201-e0e98d52-2926-46a2-8209-12e4f81cce75.png

## 注意事项
导向板为磨损件，需要按期维护、检查可靠性。
根据负载场景不同，可选择不同充电电流等级充电器使用。
## 客制非标充电桩
针对客户自研的自动充电桩，rbk 也同时适配一套基于 modbus tcp 的通讯协议来与充电桩交互。具体协议内容可参考。自研充电桩 API
## 充电桩端配置
## 充电桩roboshop连接
操作充电桩需要使用2.4.1.63及以上版本的Roboshop。
使用网线将电脑与充电桩侧方网口进行连接。
将电脑的以太网 IP 设置为 192.168.192.xxx （ xxx 需大于 200 ） 网段，子网掩码 255.255.255.0 ，网关可省略。
打开 Roboshop 在【首页】点击【刷新】按钮或手动【输入 IP】地址为【192.168.192.5】进行机器人添加。
1654585690971-04acfcc8-896e-491e-bcab-6e00e7045ebf.png

在【首页】的机器人列表中找到 IP 地址为【 192.168.192.5 】的机器人点击【开始连接】按钮进行连接。
等待机器人标签页中显示机器人的“网络延时”、“名称”、“备注（若有）”等信息时，表明连接成功。
1654585517949-1eab149b-8703-4974-9f13-63397f1d015b.png

## 充电桩端模型文件
1654585517949-1eab149b-8703-4974-9f13-63397f1d015b.png

## 功能

## 详细说明

## basic

## ChargeDO

## 极片充电输出DO

## manualChargeDO

## 手动延长线充电DO

## manualTime

## 手动充电时间

### connectTimeoutThreshold

## 通讯超时时间

### reachTimeoutThreshold

## DI 未触发超时时间

### reachTimeoutTryTimes

## 极片未触发后的重复伸缩次数

## redLIghtDO

## 三色灯红色 DO ，充电桩异常时打开

## greenLightDO

## 三色灯绿色 DO ，充电桩运行时打开

## yellowLightDO

## 三色灯黄色 DO ，充电桩待机时打开

## fanDO

## 风扇 DO ，充电桩运行时打开

## overTempDI

## 过温传感器DI

## backWaitTime

## 极片收回前的等待时间

### ChargeOnAfterReachTime

## 极片到位多少秒后打开ChargeDO

enableCurrentJudgelnPushDetect

## 是否开启输出电流检测到位状态

### judgePushReachedCurrent

## 多大电流认为极片处于到位状态

## brand（充电模块型号）

## chargeBaisc（充电模块参数）

## moduleNum

## 充电桩安装的充电模块数量

## chargeVoltage

## 充电模块充电电压

## maxChargeVoltage

## 最大充电电压

## maxChargeCurrent

### 最大充电电流（此处填写的是单个模块最大充电电流）

## overVoltage

## 充电过压阈值

## overCurrent

## 充电过流阈值

## stopCurrent

## 充电停止电流

## backOkCurrent

### 停止充电时等待电流衰减到该值时极片再缩回

## waitJuCurrentTime

### 开始充电时，到达该时间后开始判断停止电流

## riseBigCurrentTime

### 升大恒流时间（按照该时间从 0 上升至大恒流）

## downBigCurrentTime

### 降大恒流时间（按照该时间从大恒流下降至小恒流）

### riseSmallCurrentTime

### 升小恒流时间（按照该时间从 0 上升至小恒流）

## constantVoltageTime

### 恒压降流时间（按照该时间从小恒流下降至关闭电流）

## autoBasic（自动模式）

## fullQuantity

### 充满电量（ AGV 电量达到该值停止输出电流）

## handoffQuantity

### 切换电量（达到该值之前使用大恒流充电，之后使用小恒流充电）

## bigCurrent

### 大恒流值（大恒流的电流输出值，该值为单个模块输出值）

## smallCurrent

### 小恒流值（小恒流的电流输出值，该值为单个模块输出值）

## manualBasic（手动模式）

## fullVoltage

### 充满电压（机器人电压达到该值停止输出电流）

## handoffVoltage

切换电压（ AGV 电压达到该值之前使用大恒流充电，之后使用小恒流充电）

## bigCurrent

### 大恒流值（大恒流的电流输出值，该值为单个模块输出值）

## smallCurrent

### 小恒流值（小恒流的电流输出值，该值为单个模块输出值）

## motorBasic（电机）

## canId

## 电机 canID

## rpm

## 电机 rpm 转速

## maxRPM

## 电机 RPM 最大转速

## encodeLine

## 编码器线束

## ratio

## 电机轴旋转一圈，行进多少 mm

## pushPositiveDI

## 极片伸出正极 DI

## pushNegativeDI

## 极片伸出负极 DI

## backDI

## 极片缩回 DI

## pushLength

## 极片伸出最大长度

## backLength

## 极片缩回距离

## dist

## 电机到位精度
## 控制器配置SOP
## 车体端模型文件配置
1703216256161-a37ec5fd-3008-4b6e-82bd-5dde8b76bda8.png

## 模型文件配置页面
a. 配置充电口在车体上的位置：根据实际车体结构设计及安装填写；
## b. 配置充电相关DO：
switchDO：充电开关 DO ，如有充电控制继电器；
switchDOTimes：尝试重启 switchDO 的次数；
switchDODuration：重启 switchDO 的周期；
openDODist：开始充电距离，机器人与充电桩距离小于该距离时开始充电；当这个值配置为 0 时，将会启用新逻辑：通过看是否有 DI 被配置成 "openCharge"，如果有，那就导航直到有一个符合要求的 DI 被触发后停下，之后再将充电 DO 打开。特别注意：如果不存在硬件 DO，而是使用虚拟 DO 进行控制，需要在模型文件中 DO 列中添加一个 DO。对于叉车适配我司充电器存在一个特殊逻辑，当该值配置小于 -0.1 时，到达目标点后，会先等待充电桩伸出到位后，再打开 switchDO，从而避免充电开始大火花的现象。
c. 配置充电相关逻辑：是否屏蔽激光（autoShieldLaser）、是否使用地图上充电点的方向覆盖识别结果的方向（recChargeUseTargetDir）、拍急停时是否关闭充电DO（disableByEMC）;
d. 启用设备并推送模型文件到控制器。
## 参数说明

## 参数名称

## 参数位置

## 单位

## 默认值

## 最小值

## 最大值

## 支持版本

## x

## 模型文件-charger-basic

## m

## 0

## -9

## 9

### 3.3.4.20~latest

## 充电口在车体坐标系下x轴方向的值

## y

## 模型文件-charger-basic

## m

## 0

## -9

## 9

### 3.3.4.20~latest

## 充电口在车体坐标系下y轴方向的值

## theta

## 模型文件-charger-basic

## °

## 0

## -360

## 360

### 3.3.4.20~latest

### 充电口在车体坐标系下 z 轴的角度偏移值

## switchDO

## 模型文件-charger-basic

## m

## -1

## -1

## 1000

## ~latest

预置条件 ：所要控制的充电 DO 必须装配有充电回路继电器。若无该继电器或不需要控制该充电 DO 时，将 switchDO 设置为 -1 即可。用于在充电时控制是否打开充电 DO 或打开对应 id 的充电 DO，不开启时该数值填写为 -1。例如：在充电时需要打开充电 DO3，则该数值应该填写为 3。
对于叉车，如果配置了switchDO，那么叉车离开充电桩前，需要同时保证switchDO 关闭，并且充电电流小于0。

## switchTimes

## 模型文件-charger-basic

## m

## 0

## 0

## 1000

## ~latest

在无法一次成功打开 switchDO 情况下，尝试开启 switchDO 的次数

## switchDODuration

## 模型文件-charger-basic

## s

## 3

## 1

## 1000

## ~latest

## 打开和关闭 switchDO 的周期

## openDODist

## 模型文件-charger-basic

## m

## 1

## -1

## 100

## ~latest

表示在自动模式下，当机器人和充电桩距离小于该参数时，会将充电 DO 打开。例如：设置该数值为 1 和 switchDO 为 7 时，在充电距离小于 1 m 的时候，会打开充电 DO7；当这个值配置为 0 时，将会启用新逻辑：通过看是否有 DI 被配置成 "openCharge"，如果有，那就导航直到有一个符合要求的 DI 被触发后停下，之后再将充电 DO 打开。特别注意：如果不存在硬件 DO，而是使用虚拟 DO 进行控制，需要在模型文件中 DO 列中添加一个 DO。对于叉车适配我司充电器存在一个特殊逻辑，当该值配置小于 -0.1 时，到达目标点后，会先等待充电桩伸出到位后，再打开 switchDO，从而避免充电开始大火花的现象

## disableByEMC

## 模型文件-charger-basic

## false

拍急停是否关闭充电 DO，勾选则为拍急停断开充电 DO，反之将充电 DO 置于打开状态

### chargeDisableMotorTime

## 模型文件-charger-basic

## s

## 1.

## 0

## 100

## ~latest

完成充电任务前，需要将walk电机或者抱闸电机去使能相应的时间后再恢复使能

## autoShieldLaser

## 模型文件-charger-basic

## true

## ~latest

### 控制在充电点自动屏蔽障碍物的区域是否生效

## powerOffDO

### 模型文件-charger-powerOffDO

## -1

## -1

## 1000

## ~latest

表示充电到点完成后进行关闭（用于关闭设备进行充电的场合）。当机器人从充电处离开前，会自动打开 poweroffDO。

## 设置充电点
① 建立地图，将充电桩扫描进地图内，如下图：AreaShield 区域为充电桩的大致位置
1703134900085-3f87bc67-be06-44d6-8cec-40dcf8de7cb7.png

## 建图
② 将鼠标悬停在代表机器人的蓝色矩形上，右键点击，选择“标记特殊工作站”，将会出现充电点
ChargePoint；
1700207496319-e92c8200-ef42-421a-93ec-b88427deb928.png

## 标记充电点
③ 选择充电点的识别模型文件为：chargerpot （如果不选择，则无法使车体与充电桩产生通讯）。
1703134760122-f6ba8587-36c3-4f17-94a7-d4389f4356c4.png

## 设置识别文件
## 识别文件配置
1703053040234-234ecd1f-7217-4999-8a6a-a9802b4e8087.png

## 识别文件配置
## 仙工充电桩配置（直接通信）
选择品牌：brand 选择 SRC-800（SRC-600研发中，后期会作为充电桩专用控制器，具体使用请咨询充电桩产品经理）
配置通信参数：根据充电桩实际通信参数配置 IP；
配置电气参数：根据机器人电池及充电桩型号，确定最大电流、最大电压；
选择充电方式：protocolCharging 选项，勾选则采用【协议充电】，不勾选则采用【状态充电】；
推送识别文件到控制器。
1703134146586-388271b1-9ad2-4812-a5ff-142d0d704ab4.png

## 识别文件配置-仙工-直接通信
## 说明：
Protocol Charging（电池协议充电曲线）：充电桩根据车体 识别文件 和 电池协议 中允许的最大充电电压及电流来进行输出，两者小的数值优先；
State Charging（充电桩内部充电曲线）：充电桩根据车体 识别文件 限制输出，在识别文件允许的最大充电电压及最大充电电流内，充电桩根据内部的充电曲线来进行输出，即充电桩模型文件中自动模式下的大小恒流。
## 仙工充电桩配置（通过core通信）
由于一些工厂对设备间的网络通信要求较严格，设备间存在网络隔离；机器人无法直接和 SRC800 充电桩通信，需要使用 RDSCore 来间接控制充电桩进行充电。在这类场景中， RDSCore 充当机器人与 SRC800 充电桩之间的数据中转站。因此，需要在机器人和 RDSCore 中分别配置充电桩才能使机器人与 SRC800 充电桩成功通信。
### 在RDSCore的模型配置界面配置 charger 设备
品牌选择 src-800，设备名填充电桩的名字，ip填充电桩ip，如下图
1653988206198-15e53439-062e-41f8-9964-db6875880cf5.png

## 机器人中配置识别文件
### 选择品牌：brand 选择 RDSCore_src
配置通信参数：根据充电桩实际通信参数配置 IP；注意：设备名需要与 RDSCore 中模型配置中的设备名一致
配置电气参数：根据机器人电池及充电桩型号，确定最大电流、最大电压；
推送识别文件到控制器。
1703134122848-92dcd2e3-1438-4608-9aab-5fad33de6561.png

## 识别文件配置-仙工-core通信
配置过 RDSCore_src 充电桩的机器人在 RDSCore 掉线后就无法进行单车自动充电，必须配合相应的 RDSCore 才能中转充电桩数据。
## 充电桩识别
将反光贴贴在充电桩上，这样就可以通过识别反光贴来实现充电桩的识别。
对于不同的粘贴位置以及反光贴的大小，仙工智能提供了一些参数可供配置。通过配置参数可以灵活使用充电桩。

## 参数名称

## 参数位置

## 单位

## 默认值

## 最小值

## 最大值

## 支持版本

## minwidth

### 参数配置-LaserSegmentation

## m

### 0.1

## 0

## 10

### 3.3.4.20~latest

### 充电桩上反光条的最小宽度，一般为反光贴宽度减去0.05m

## maxwidth

### 参数配置-LaserSegmentation

## m

### 0.2

## 0

## 180

### 3.3.4.20~latest

### 充电桩上反光条的最大宽度，一般为反光贴宽度加上0.05m

## dx

### 参数配置-LaserSegmentation

## m

### 0.025

## 0

## 180

### 3.3.4.20~latest

### 充电极片，相对于充电桩坐标系原点，在 x 轴上的偏移量

## dy

### 参数配置-LaserSegmentation

## m

## 0

## 0

### 0.1

### 3.3.4.20~latest

### 充电极片，相对于充电桩坐标系原点，在 y 轴上的偏移量

## rec_laser_id

### 参数配置-LaserSegmentation

## —

## true

## —

## —

### 3.4~latest

## 根据 id 选用特定的激光进行识别

## ythreshold

### 0.8

### 识别充电桩时小车y方向有效激光点，用于排除旁边充电桩的干扰

## detect_direction

### 参数配置-LaserSegmentation

## —

## x

## —

## —

### 3.3.5.20~latest

识别方向。

## method_type

### 参数配置-LaserSegmentation

## —

## by_reflector

## —

## —

### 3.3.5.20~latest

是否使用反光膜进行识别，目前只开放了反光膜识别，后续会开放形状识别

上述表中 dx 和 dy 的坐标系说明如下图， 充电桩坐标系原点即为反光条的中心，Z 轴不需要考虑。
1652665819512-1471a97b-e2ca-42d7-a8a0-133b93b9ac2b.png

## 报警码
为了更方便定位到错误，仙工智能在识别的机器人进行识别的时候提供了一些报警码，只需要根据报警码以及相应的提示即可快速定位到问题所在。
## Warning54901
### 提示： Recofile not exist!!!!
## 触发条件：
没有识别文件；
识别文件中的参数不对。
## 解决方式：
检查是否存在识别文件；
检查识别文件中的参数是否缺失。

## Warning54902
提示： Cannot find shelf, please check saved pics!!!!
## 触发条件：
识别距离内没有识别到反光贴；
反光贴的宽度和识别参数相差过大；
## 解决方式：
通过roboshop检查是否能识别到反光贴，注意检查距离是否过远；
检查识别文件中的参数设置是否正确；
