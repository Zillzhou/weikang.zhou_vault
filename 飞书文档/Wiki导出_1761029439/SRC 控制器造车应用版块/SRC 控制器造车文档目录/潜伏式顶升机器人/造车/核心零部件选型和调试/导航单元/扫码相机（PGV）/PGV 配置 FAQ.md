# PGV 配置 FAQ 

## PGV 配置 FAQ

## 版本

## 更新日期

## 更新说明

## 文档状态

## 维护责任人

## V1.0

### 2024.3.15

## 初版

## 使用中

## 问答：
## 识别相机标定值精纠偏方法
## 解答：
识别相机需要先进行标定。具体参见识别 相机标定 文档。
### 对于偏差问题，应当首先检查相机标定值 是否在典型标定值附近
本方法适用于系统性偏差，就是识别一直都向一边偏，角度也是一直固定在一个方向有倾角才能用
理想状态下，识别后进行叉取，托盘被叉车抬起后，托盘中心应当在左右叉齿形成的中心线上，如图所示两段距离应该相等：
1691474600538-e1d3ec90-5fa6-4f91-bf1a-41b333c399d9.png

如果 每次固定的朝一边偏 （至少需要观察 3 次以上），需要进行精纠偏。 先记录下当前的模型文件标定值（修改后需要还原）：
1691481224359-18632c02-0d60-4d69-9245-64a79fc8c172.png 

先准备一个平面特征较好的栈板，如本文档第一张图片所示。调整具体步骤分为：
## 1: yaw 角纠正
第一步需要进行纠偏 yaw 角度。
稍微解释下原理，因为外参变换矩阵是齐次矩阵，先应用旋转变换，再进行平移操作，调整 yaw 时候会影响 y，所以先调整固定 yaw 角度，再调整标定 y 值。
进行识别操作，在叉车挡板即将触碰到托盘平面时，停止导航。观察并预估角度：
1691476140615-b2c5f9b6-0cb6-4c58-9178-e9770356bab3.png

对相机模型文件 yaw 角值进行微调加减。
1691476302347-d094ddbd-b28e-4946-86ca-ea3d2eed9aac.png

### 循环往复，保证托盘平面与挡板平面大致平行。如下图所示：
1691476516442-bba6f50b-bde1-4071-8901-ca6ae7211de9.png

注意：yaw 角度在模型文件中的设定的范围限制是 -180° ～ 180° 之间。若超出范围，加减 360° 保证值在 -180°～180° 区间即可。
## 例：
如果想调整到 181°， 则使用 181-360=-179， yaw 角填入 -179；
如果想调整到 -181°，则使用 -181+360=179，yaw 角填入 179 即可。

对于调整方向加减方向无需死记 ，若加上正值，下次偏差更大了，则判断就是需要减的方向了；
以下确定 y 的调整方向时同理。
## 2: y 值精纠偏
### 请先完成 yaw 角纠偏，再进行本操作！
同样的方法，观察下图左右偏差是否相等。
1691476611182-733a252e-d407-4867-ae3b-47b4b6c7a756.png

如果还未居中，计算 bias = |左宽度-右宽度| / 2；
## 加减到 y 值上，如下图：
1691476750291-d78737db-8fa3-4a4b-b2a9-db9014325417.png

循环往复，保证托盘居中。

## 验收
叉取三次，观察是否还有偏差，若无偏差，结束纠偏。
## 以左右偏差不超过 1cm 为佳
## 备注：
为了保证同款产品多台车模型文件一致性。需要将最终修改值需要加到 cp 标定文件里，而不是直接修改模型文件的值。因此需要先还原之前记录的模型文件参数，记录 yaw 和 y 偏差，还原模型文件的值。打开并修改标定文件的值。
## 具体进入入口为：
## 使用 Roboshop 打开标定机器人
1691478295323-783bb8a2-417b-460a-bdc8-1dd353489f0d.png

找到需要修改的相机（percipio 指图漾相机），编辑标定文件（如果界面与下图不一致，请使用新版 RoboShop）
1691478371331-61379d92-8812-4576-bece-f302823ce8b6.png

找到 模型文件中用于识别相机编号 ，这里是 camera2， 需要根据实际情况进行选择 。将 yaw 和 y 修改的 偏差 加减 cp 文件中原来的值 的结果填入。
1691481013498-31667616-da03-42cd-a051-01fff58bbacb.png

一般利用二维码标定值较准确，精调整修改总幅度一般不会很大，（yaw 修改小于 5°，y 不超过 5cm ），若修改幅度过大， 请重新使用二维码进行标定。

## 使用PGV二次定位时左右旋转无法停止
## 解答：
先检查车体标定是否正常，在检查二维码标定是否正常。如果标定不准会导致二次调整无法完成。
对于 机器人直接行驶到终点，然后原地旋转调整到位的应用场景。 需要 检查车体原地旋转是否有侧向偏差。需要将 PGV_ReachDistTor 改成 和原地旋转侧向偏差同等量级。这是由于机器人原地旋转引入的侧向偏差，在二次调整时无法补充。

## 上视读码相机（pgv）标定时会顶升
## 解答：
标定上视 pgv 顶升的作用是起到指示二维码粘贴高度的作用，顶升的高度恰好是二维码识别 pgv 的高度，省去了使用尺子量识别高度的步骤
## 标定方式：
## 使用标定支架
### 把支架的二维码和顶升后的托盘保持在同一高度即可
## 使用货架底部粘贴二维码的方式进行标定
需要确保顶升后的托盘高度与货架底部的二维码处于同一平面内，保证读码高度一致
在保证 a 的前提下，把 jack 的模型文件 type 类型配成 BYCustom，这样标定时就不会顶升了，在标定完成后再把该模型文件改回默认即可
1684896108735-2faf6c4e-b21b-4675-b48f-d6978c621f88.png

## 读码相机反馈数据异常
解答：典型特征，小车处于旋转场景且仅识别到一个二维码的情况下，x,y反馈的数据在 短时间内出现大范围数据跳变 ，如图的跳变范围在-0.01~0.03m，差值达到了4cm，标准二维码的尺寸仅有8cm，显然是不合理的
此时可参照车体上/下视觉相机用二维码（导航/二次定位用）通识说明 对比所用二维码规格是否符合使用要求
1683253807937-5e9b3523-95d3-4baf-a71b-45c343a1bfae.png

coding链接： https://seer-group.coding.net/p/order_issue_pool/bug-tracking/issues/2789/detail

## 报警码
### 52003 标定文件steerOffsetFile不存在

## 52003

steerOffsetFile's path doesn't exist！

### 标定文件steerOffsetFile不存在

## 1.人为删除相关标定文件
### 2.导入了其他车体的资源文件
### 3.标定文件损坏或丢失

## 1.重新标定
## 52121 读码相机模型配置错误

## 52121

pgv model param config error.

## 读码相机模型配置错误

读码相机模型配置错误时，会触发这个报警码。

## 解决方式：
检查读码相机模型文件 xUnit xRange yUnit yRange angleUnit 配置是否合理。
重启机器人后，拉取模型文件，重新配置读码相机模型。
## 52127 PGV 连接错误

## 52127

### PGV connection error

## PGV 连接错误

## 电气连接，设备配置，模型配置问题

## 1. 检查 PGV 是否正常工作
### 2. 检查 PGV 接线是否正确
### 3. 检查 PGV 是否配置正确
### 4. 检查机器人模型配置中的 PGV 相关配置是否正确
### 5. 请查阅我司提供的 PGV 使用文档
### 6. 如果仍然无法恢复，请联系售后
## 52128 pgv信息与设备不符

## 52128

PGV info with mismatched device id

## pgv信息与设备不符

## 模型配置问题或设备本身问题

## 检查模型配置，对应id和pgv的id
## 52253 二维码相机通讯连接不上

## 52253

### cannot connect with locCamera

## 二维码相机通讯连接不上

## 1. 开机时出现这种情况通常是模型文件中相机类型，或者相机ip和端口配置不正确
### 2. 相机网口通讯线松动，存在通讯异常风险

## 1. 配置正确的相机类型，ip以及端口，保存后推送模型文件即可恢复
### 2. 重新插拔通讯线，如果可以恢复则说明通讯网口或通讯线存在异常，需要检查更换
### 52301 已经一段距离看不到二维码，需要报错停止

## 52301

Cannot detect tag after some distance

## 已经一段距离看不到二维码，需要报错停止

### 在参数配置中，默认配置了 WarningDistance
为2m，是指机器人使用二维码定位时已经运动超过 WarningDistance
## ，仍然没有看到二维码，因此会报错停止

## 1. 如果现场二维码间隔比较大，超过默认2m，可以适当将 WarningDistance
配置大一些，然后保存即可。
### 2. 拍急停将机器人推动到可以看到二维码的位置，可以清除报错
### 3. 3.3.4版本rbk支持报错情况下手动控制机器人，让机器人看到二维码即可清除报错。
### 52952 顶升机构、识别文件或者按PGV调整配置错误

## 52952

jack, rec, pgv adjsut config file error

### 顶升机构、识别文件或者按PGV调整配置错误

1. 提示 PGV Method Based On Code Doesn't Support pgv_adjust_dist paramter!!! 按PGV调整，任务指令错误
### 2. 提示 Cannot open blinkDO: 无法打开blinkDO
### 3. 提示 Plan PGV Adjust path failed!!!! pgv调整路径规划失败
### 4. 提示 Can't open Recfile 无法打开识别文件
### 5. 提示 Error jack cmd Modbus顶升指令错误
### 6. 提示 connection error Modbus顶升连接错误
### 7. 提示 unknow jack error Modbus顶升未知错误

1. PGV Method Based On Code Doesn't Support pgv_adjust_dist paramter!!! PGV调整指令错误，确认一下参数配置中 PGV_Method
，默认值应该为1。如果是被配置成了0，那么任务指令中不能包含 pgv_adjust_dist
。
### 2. Cannot open blinkDO: 需要确认一下模型文件中pgv机构中的blinkDO是否配置正确，或者DO功能是否正常。
### 3. Plan PGV Adjust path failed!!!! pgv调整路径规划失败，增加任务指令中的 pgv_adjust_dist
。
### 4. Can't open Recfile 无法打开货物识别文件，需要确认一下货物识别文件的路径
### 5. Error jack cmd Modbus顶升的operation只支持 JackLoad
## , JackUnload
## ， Wait
## ， JackHeight
## ， JackStop
，其他operation不支持。
### 6. connection error 检查一下Modubus和控制器的连接是否正常
### 7. unknow jack error Modbus顶升位置错误
### 8. 如果无法判断具体错误，需要联系售后
## 54051 相机通讯连接不上

## 54051

### cannot connect with camera

## 相机通讯连接不上

## 1. 开机时出现这种情况需要查看模型文件中相机类型，是否配置正确
### 2. 相机USB通讯线是否松动，存在通讯异常风险

## 1. 配置正确的相机类型，ip以及端口，保存后推送模型文件即可恢复
### 2. 重新插拔通讯线，如果可以恢复则说明通讯网口或通讯线存在异常，需要检查更换
### 54053 使用纯二维码定位时看不到二维码

## 54053

Tag cannot be Seen,please enable PGV with Localization or adjustLocalization

## 使用纯二维码定位时看不到二维码

## 1. 在使用纯二维码定位时，看不到二维码

## 1. 在使用过程中，由于看不到二维码会报此警告，看不到二维码后可以清除
## 54070 PGV 看不到二维码

## 54070

### PGV cannot find codes

## PGV 看不到二维码

- PGV cannot find code. 在依据PGV进行二次位置调整时，看不到二维码。
- PGV cannot find code. Maybe the shelf is moved. Please adjust the shelf's position 在AGV导航过程中PGV看不到二维码。

## 1. 在依据PGV进行二次位置调整时，看不到二维码。检查是不是PGV经常性误报这个错误，可以尝试将参数配置中的 PGV_Time
## 调大，增大报错阈值
### 2. 如果PGV对着二维码但还是报错，则检查模型文件PGV是否配置正确，检查PGV和二维码距离是否合适
### 3. 在AGV导航过程中PGV看不到二维码，检查货架和PGV相对位置是否发生了偏移，检查PGV和二维码距离是否合适
### 4. 如果无法自动恢复，请联系售后
## 55504 二维码定位功能没有激活

## 55504

### rbk_tag_nav is not activated

## 二维码定位功能没有激活

使用带有PGV的车进行纯二维码定位，却没有激活rbk_tag_nav

## 1. 检查是否添加了二维码定位区域使用二维码定位功能
### 2. 检查是否授权脚本功能rbk_tag_nav,没有的话联系售后开启
### 3. 如果无法自动恢复，请联系售后
## coding问题
## pgv最大调整角度参数不生效
问题描述：PGV最大调整角度设置为3度，其他车5度在该点位可以做有效调整，问题车调整幅度明显大于设定值并抵住货架腿导致电机过流
### 解决方案：把站点的启用下视pgv关闭就不会超过设定值调整了

## 启用二维码导航时车就原地旋转打滑报警
问题描述：使用导航和下视pgv二次定位都正常，但是在使用二维码导航时，车在原地旋转，然后就打滑报警，激光数据也没有跟着变化。
### 解决方案：把安装角度改成90°后正常使用
### 上视pgv识别货架码＋顶升+下视pgv二次定位问题
## 问题描述：
现场需要上视pgv先识别货架码做匹配然后下视pgv识别地码做二次调整后顶升
机构脚本写的是识别货架码+顶升动作，用任务链测试了这个+二次调整没办法同时进行
车辆到点识别完货架码后就直接顶升了，没有二次调整动作并且顶升完该动作不结束
## 解决方案：动作块顺序错误

## 读码相机（pgv）噪声过大判断
## 问题描述：
## 以单个pgv为例，判断方法：
在小车静止且 pgv0.tag_value 有读数（非0）且不变的情况下持续 1 秒，判断 pgv0.tag_angle 反馈的数据
若 tag_angle 出现较大范围跳动，可输出如下结果提示：
### “pgv噪声过大，请按照配置手册检查曝光参数和FAQ提示”
## 认为数据跳动过大的阈值为：0.2°
## 附件log为噪声过大的情况
## 解决方案：通过测试，解决问题

## 读码相机（pgv）反馈数据单位判断
## 问题描述：
## 以单个pgv为例，判断方法：
在 pgv0.tag_angle 反馈的数据在 0° 左右时，取 pgv0.tag_value 不变的一段数据，比较 pgv0.tag_x（pgv反馈的x方向数据）与 Odometer.x（小车实际运行的x方向数据）的数据变化是否相近
最常出现的情况是二者的变化情况呈十倍的关系，如果出现该现象，在pgv自动判断中给出以下结果提示：
“pgv模型文件‘xUint’和‘yUint’配置错误，请按照配置手册检查该处的参数配置”
## 该项自动测试正确的log参考附件
## 解决方案：后续逐步使用自制的PGV

## 使用jackload不调用上视pgv
问题描述：客户需求启动上视PGV的车，在执行jackload的时候让机器人不识别上视pgv，将上视pgv与jackload分开
## 解决方案：版本更新后已可以使用

## 动作块不执行问题
## 问题描述：
任务逻辑为先识别货架码做比对，比对成功则识别地码二次定位调整后顶升，库位键值如下，
时间19.36-20.07，站点AP4566-AP4577,实例ID6-18-t19——6-18-t24。问题：单独测试过QHTZ和FH的binTask都可以正常识别地码调整后顶升，但是前面加上上视相机识别比对动作后小车就不调整位置比对成功后直接顶升，FH顶降时由于没有上视相机识别比对动作，可以正常调整位置顶降
解决方案：本问题的原因在于调度系统原地任务的动作数量限制，经拆分，点位设置三个bintask 识别——二次调整——顶升

## 开机后，海康相机频繁报错
## 问题描述：
开机后，海康相机频繁报错，需要反复重启，才能消除错误。
错误码：[52250][第1次] [2024-06-13T15:22:58.007+0800] cannot init Hik
6月13日15:23分左右开机海康相机报错，反复重启后错误消失。
## 解决方案：长期对策为更换大华相机

## 集成（PGV）：PGV标定失败
解决方案：后续标定做在Roboshop上，针对于各类失败的处理也在Roboshop上直接提示

## pgv标定超过30min未提示结果
## 问题描述：
配置好大华pgv上位机，模型文件配置完毕情况下，未显示pgv模型
### 同时大华pgv标定时间超过30min并且没有提示任何结果
## 解决方案：配置问题

## 牧星pgv扫码读取时间测试
问题描述：牧兴pgv连上SRC800并配置完成后，放在二维码上进行扫码老化，半小时后取log
### 解决方案：无pgv时占用过高（已修复），有pgv时占用较低

## AMB-800K pgv 数据异常
问题描述：AGV 都离开了二维码位置了，但是roboshop->运行状态PGV 状态依然显示数据
### 解决方案：反复标定后，在二维码上路径导航没出现数据显示异常

## Roboshop中读取不到二维码信息
## 问题描述：
## 1.PGV通过上位机配置完成后，能够与SRC-2000控制器进行通讯
### 2.但是通过roboshop连接AGV，在运行状态-->PGV中显示没有读取到二维码
### 3.使用大华二维码相机上位机可以看到PGV能够正常读取二维码信息，但控制器没有接收到PGV反馈的二维码信息。
## 解决方案：
### 已找出打滑PGV不能正常识别二维码的原因：
1：roboshop中打印的二维码，每个单码是由1414小格组成，而大华PGV只能识别1212小格组成的单码。
目前中电科6寸车所用的大华PGV，已换成倍加福PGV并已测试完成。

## AMB-800K下视PGV标定结果异常
问题描述：AMB-800K下视PGV标定结果异常，标定出来的yaw值+74.9，与直接情况不一致。
## 解决方案：模型文件配置
## 禁用激光
## pgv_down.yaw = 0
pgv_down.func = adjustLocalization
