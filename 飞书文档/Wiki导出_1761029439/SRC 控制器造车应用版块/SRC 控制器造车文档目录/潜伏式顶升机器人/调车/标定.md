# 标定

## 标定

## 版本

## 更新日期

## 更新说明

## 文档状态

## 维护责任人

## V1.0

### 2024.3.15

## 初版

## 使用中

## V1.1

### 2024.4.09

## 修改编号

## 使用中

### 可作为通用文档，rbk3.4.5.+版本以上
标定前提条件：参照RoboshopPro 使用手册—标定步骤，点击链接查看：标定步骤
## 激光里程计标定
适用于双轮差动车和前驱单舵轮车。每个勾选用于定位的激光雷达都对应一个该类型的标定项。用户关心的重点是标定所需空间，且一台小车的运动参数标定只有一个运动类型，因此以运动类型描述对应车型。
## 标定动作流程和所需标定空间

1652611087111-83d6533b-b6c6-4c06-a123-bc0592511650.png

## 上图所示为一个动作循环，具体依次为：
车辆在起始位置原地左转 90° 后，正向行进一个 180° 的右转圆弧；
右转 90° 后，正向直行到起始位置；
左转 90° 后，正向行进一个 180° 的左转圆弧；
右转 90° 后，反向直行到起始位置；
根据参数，标定动作可能包含若干次循环。
激光标定涉及参数如下，可在roboshop-参数 路径中进行修改。roboshop参数设置参考文档参数配置。

## 适用车型

## 标定项

## 参数名称

## 默认值

## 参数意义

## 双轮差速车
## 双差速模组
## 多舵轮车
## 多差速模组
## 麦轮车

## 激光里程计标定
## 基于激光的里程计标定
## GNSS里程计标定
## IRCam里程计标定
## LocCamera外参标定
## Opt光学定位外参标定

### DiffLaserOdomCalibSize

## 3m

## 圆形轨迹范围的直径

## LaserOdomCalibSpeed

### 0.2m/s

## 标定时的最大线速度

## LaserOdomMaxRotVel

## 30°/s

## 标定时的最大角速度

## LaserOdomCalibCnt

## 2次

## 循环次数
## image.png

## 激光自动标定步骤
步骤1：在 Roboshop 中选择【其他】>【标定机器人】唤出【标定机器人】对话框，弹出自动标定界面，如下图所示。
1708500371998-b8acd0f8-1b6c-4697-8c99-9afb1af99405.png 

步骤2：【查询已标定数据】，可查看原先机器人内部的标定数据，第一次标定时，标定数据为空。
1708500434183-691d1d46-bcc0-4c90-bbe3-981085593e9d.png

步骤3：点击【清空所有已标定数据】，可以将之前标定过的且已经写入的数据进行重置。如果建图环境比较好，可以用迭代标定，此时不需要清空标定数据。
1708500569944-5865cc08-f391-492d-8507-03e76ba20a3a.png

如果仅针对单个设备进行重新标定，可选择【清除勾选的标定数据】，将选中的，之前标定过的且已经写入的数据进行重置。
1708500823783-8cbab2f6-5b2b-4d05-b38f-9a17b621701e.png

步骤4：勾选Laser 选项，点击【开始标定】按钮，机器人开始进行标定运动。
标定必须按照顺序自上而下进行标定。 注意：由于标定过程中机器人会进行运动，标定机器人需要在空旷的场地进行。
1708501446320-b7d1938e-4bca-4964-bbc8-2e54717313a6.png 

标定时间约需几分钟，请耐心等待。 
1708501533556-fe9894b5-6872-4908-ab5d-3135a156fab5.png

## IMU（陀螺仪） 标定
## 标定动作流程和所需标定空间
1702088002781-c5624c15-51a9-4cd0-8475-91d47f799c81.png

## 可原地旋转车型
## 上图所示为一个动作循环，具体依次为：
车辆在起始位置直行一段距离；
车辆在起始位置倒退一段距离；
根据参数，12执行若干次循环。
逆时针原地旋转 540° ；
顺时针原地旋转 540° ；
根据参数，34执行若干次循环。

## 适用车型

## 标定项

## 参数名称

## 默认值

## 参数意义

## 双轮差速车
## 双差速模组
## 多差速模组
## 前驱单舵轮
## 多舵轮车
## 麦轮车
## 等可原地旋转车辆

## IMU标定

## IMUCalibSize

## 2m

## 直行/倒退距离

## IMUCalibSpeed

## 1m/s

## 直行/倒退速度

### IMUCalibGoBackandForthCnt

## 3次

## 直行/倒退循环次数

## IMUCalibRotSpeed

## 30°/s

## 原地旋转角速度

### IMUCalibRotateCycleCnt

## 2次

## 循环次数
## 陀螺仪自动标定步骤
步骤1：在 Roboshop 中选择【其他】>【标定机器人】唤出【标定机器人】对话框，弹出自动标定界面，如下图所示。
1708500371998-b8acd0f8-1b6c-4697-8c99-9afb1af99405.png 

步骤2：【查询已标定数据】，可查看原先机器人内部的标定数据，第一次标定时，标定数据为空。
1708500434183-691d1d46-bcc0-4c90-bbe3-981085593e9d.png

步骤3：点击【清空所有已标定数据】，可以将之前标定过的且已经写入的数据进行重置。如果建图环境比较好，可以用迭代标定，此时不需要清空标定数据。
1708500569944-5865cc08-f391-492d-8507-03e76ba20a3a.png

如果仅针对单个设备进行重新标定，可选择【清除勾选的标定数据】，将选中的，之前标定过的且已经写入的数据进行重置。
1708500823783-8cbab2f6-5b2b-4d05-b38f-9a17b621701e.png

步骤4：勾选Controller选项，点击【开始标定】按钮，机器人开始进行标定运动【此时上方所有设备应均已标定完成才可以标定】。
标定必须按照顺序自上而下进行标定。 注意：由于标定过程中机器人会进行运动，标定机器人需要在空旷的场地进行。 
1708501854575-e1156833-eb56-4dfa-b87f-de6aab7ed8e1.png 

标定时间约需几分钟，请耐心等待。 
1708501864309-434c7af5-24ab-4d5e-9c53-2ba82a7e7d19.png

## 电机标定
1708569331559-1298131b-38d3-4594-965f-ffa27fea9df3.png

## 读码相机标定
读码相机（PGV） 标定适用于安装有 PGV（上视或下视）设备的车辆，每个 PGV 设备都对应一个此类型的标定项。
## 标定动作流程和所需标定空间
标定动作流—使机器人在初始状态下能用待标定的 PGV 检测到二维码，机器人将执行如下动作：
调整机器人位姿，使 PGV 对齐到二维码中心；
前进-后退若干次；
围绕（模型文件所描述的）PGV 中心旋转一周。
## 所需空间
1702098909304-f1b8e723-142a-4c35-b781-b2190104a43f.png

## 上图所示为一个动作循环，具体依次为：
车辆在起始位置直行一段距离；
车辆在起始位置倒退一段距离；
车辆去二维码中心；
顺时针原地旋转 360° ；
根据参数，若干次循环。(里面设计到一些逻辑，仅给出大概运动，图画不出来)

## 适用车型

## 标定项

## 参数名称

## 默认值

## 参数意义

## 双轮差速车
## 双差速模组
## 多差速模组
## 多舵轮车
## 麦轮车
### 等所有搭载PGV的可围绕PGV原地旋转的车辆

## PGV标定

## PGVCalibSize

### 0.1m

## 直行距离

## PGVCalibLinSpeed

### 0.05m/s

## 直行速度

## PGVCalibRotSpeed

## 30°/s

## 原地旋转速度

## PGVCalibMoveCnt

## 10次

## 循环次数
## 读码相机标定步骤
由于 PGV 能够检测到二维码的范围很小，而标定过程中又是围绕模型文件中所描述的 PGV 位置旋转，所以如果模型文件中 PGV 外参误差较大，则可能导致采集到的数据过少，使得辨识不准确。因此请正确配置模型文件中的 PGV 参数。
## 二维码相关通识请参考：
### 车体上/下视觉相机用二维码（导航/二次定位用）通识说明
## 自动标定
读码相机自动标定，分为两类， 带导航激光的 PGV 标定 和 不带导航激光的 PGV 里程计标定。
## PGV 标定
使机器人在初始状态下能用待标定的 PGV 检测到二维码，机器人将执行如下动作：
调整机器人位姿，使 PGV 对齐到二维码中心；
前进-后退若干次；
围绕（模型文件所描述的）PGV 中心旋转一周。

## 参数名称

## 参数意义

## 备注

## PGVCalibSize

## 前后往复直行的距离

## -

## PGVCalibLinSpeed

## 前后往复直行的速度

## -

## PGVCalibRotSpeed

## 绕PGV中心旋转的角速度

## -

## PGVCalibMoveCnt

## 前后往复的来回数

## -
## PGV  里程计标定
鉴于 PGV-里程计标定过程中，需要尽可能多地获取源自 PGV 检测到的二维码位姿信息的定位数据，因此需要一个二维码密集的区域进行标定。该区域最简单的形式为一个连续的条状二维码区域，例如： 
1652613003454-02b7f613-f92c-4f89-a43a-43b3461b5437.png

### 此条状二维码区域同时还具有如下属性（参见下图）：
二维码坐标系的x轴对应于条状区域的长边；
二维码区域中，二维码坐标系下x负方向那一端的二维码称为 起始二维码 ，开始执行 PGV-里程计标定时机器人应位于 PGV 可检测到此二维码的范围内。
1652613003556-512f90c0-2686-4344-8531-6e5fd93547d2.png

请联系技术支持人员索取该专用二维码条带或咨询设置该专用二维码区域的更多要求。
除需铺设该二维码区域外，还需要在地图中正确绘制这些二维码的位置和姿态，以便车辆能够正确地利用二维码
使机器人在初始状态下能用待标定的 PGV 检测到起始二维码，开始标定后机器人将执行如下动作：
调整机器人位姿，使 PGV 对齐到起始二维码中心；
前进-后退若干次；
原地逆时针-顺时针旋转若干次。
## 参数

## 参数名称

## 参数意义

## 备注

## PGVOdomCalibLength

## 前后往复直行的距离

## -

## PGVOdomCalibSpeed

## 前后往复直行的速度

## -

## PGVOdomCalibAngle

## 往复旋转的角度

## -

### PGVOdomCalibRotSpeed

## 往复旋转的角速度

## -

### PGVOdomCalibGoBackandForthCnt

## 前后往复直行的来回数

## -

PGVOdomCalibRotBackandForthCnt

## 往复旋转的来回数

## -
## 手动标定
## 手动标定标定步骤和标定推导：
 在 车体上，需要标定其相对于里程中的位置 x ，y， 和朝向 yaw。 我们可以通过下面步骤进行标定。
将模型文件中PGV的 x, y, yaw 都配置为0，或者记录当前值。
通过让pgv往前移动一段距离，标定 pgv 的 yaw。
注意一些差动车，在从原地旋转的运动状态变为直线时，或者从正走变成倒走时，万向轮的扭矩会阻碍车子直线，需要先将车子执行一段距离的正走后，再进行标定。
先记录初始pgv读到的数据 (x1,y1) 再正走移动一段距离，比如3 cm 或者 5cm后，记录 pgv读到的数据(x2,y2) 。在能够读到二维码的范围内，距离越长标定误差会减少。然后通过这个excel里面的yaw表格自动计算出 pgv yaw角的补偿值。
如果在标定途中，pgv 无法检测到二维码，需要将移动的距离减少。
1687251350701-f1fccc24-f185-4ac2-bf59-9fbcc86ed750.png

通过让pgv原地旋转180度和180度，标定pgv的x，y。
注意一些差动车，在从直线的运动状态变为原地旋转时，或者从顺时针变成逆时针旋转，万向轮的扭矩会阻碍车子旋转，需要先将车子执行原地逆时针旋转一定角度，再进行标定。
## 先记录初始pgv读到的数据
### 再逆时针时针旋转180度，记录 pgv读到的数据
### 接着，在逆时针旋转180度，记录记录 pgv读到的数据
然后通过附件的excel里面的xy补偿表格自动计算出 pgv x,y 的补偿值。
注意不安装在里程中心的车 ，原地旋转后，pgv可能看不到二维码，这时候，可以将上面的旋转角度减少，保证在小角度旋转的时候，pgv都能够看到二维码。

## pgv标定表格.xlsx

## PGV手动标定公式推导.docx
### 在3.4.6.15版本及之后，加入了此标定功能：
### 企业微信截图_1712457342743.png

## 注：标定时PGV需要看到二维码
### 此标定动作行为：前进->后退->原地左旋转->原地右旋转

## 参数

## 描述

## 默认值

## PGVCalibSize

前进距离和后退距离，
### 若PGV前进后看不到二维码，可调节此距离

### 0.1m

## PGVCalibRotAngle

旋转角度，
### 若PGV安装和里程中心偏差较大，可较小此角度

## 180°

## 注意事项
PGV标定失败 MoveFactory didn't respond properly 如下图所示。可能原因在标定上视pgv，但由于这个车子没有顶升电机，导致无法将托盘抬起来。对于没有顶升电机标定上视 PGV 的情况，可以将 jack 机构配置的 type成 byCustomer.
1687861529632-f5bb3948-37c7-4048-af71-007d01f87dcf.png

如果 PGV 不在机器人坐标系的y轴上（以模型文件为准），而车辆又无法全向移动，则标定动作的步骤 3 无法执行，会导致标定失败。
由于 PGV 能够检测到二维码的范围很小，而标定过程中又是围绕模型文件中所描述的 PGV 位置旋转，所以如果模型文件中 PGV 外参误差较大，则可能导致采集到的数据过少，使得辨识不准确。因此请正确配置模型文件中的 PGV 参数。

## 编辑标定文件
## 编辑标定文件
## 导出/导入标定文件 robot.cp
## 导出/导入 robot.cp
## 标定数据合理性评判标准
## 标准的标定数据格式——缺少，待补充
## 标定数据合理性的评判标准：
## 数据合理性的评判标准
## 差速潜伏顶升车标定注意事项
## 1、若标定双激光机器人（如 AMB-150D）, 需要使用 Roboshop 在【模型文件】中将两个激光均设置为定位激光才能正常进行双激光标定；
### 2、若标定后，机器人运行异常，请先【 清空所有已标定数据】，然后重新构建地图，再重新进行标定。
