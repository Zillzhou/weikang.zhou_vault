# 标定

## 标定

## 版本

## 更新日期

## 更新说明

## 文档状态

## 维护责任人

## V1.0

### 2024.4.29

## 更新发布

## 使用中

CBD15属于单舵轮模型，本篇介绍全自动和半自动标定两种方式对机器人进行标定，半自动标定对rbk要求版本3.4.6.12+，文档参考《 单舵轮叉车半自动标定3.4.6.12 》。
## 1. 标定环境确认
场地要求：大概够7m长，宽4m即可，地面平整，机器人需要做旋转、直线行走等动作；
工具：记号笔、直尺。

### 2. 建图
在标定区重新建图，需要建图质量良好，具体标准可参考《 单线激光建图 》
### 3. 自动标定
### 3.1. 进入标定页面
1709638276176-5bc5edcb-391f-40b5-b2e1-f5bd0ccacefe.png

### 3.2. 开始标定
选择自动标定，标定的设备选择 laser （模型文件中配置的定位激光）
1709638276312-17d73197-15a9-4634-9984-a3dbfae56df7.png

### 3.3. 标定过程
该标定项时间较久，约 10min，如过程中出现意外情况，可直接停止标定
1709638276340-41059f47-b478-450d-9cc5-8f9ca20bf593.png

### 3.4. 标定结束
标定结束后，窗口上方会弹出【设置标定参数成功】的提示，说明标定成功。确认机器人位置结束标定。
如出现【Fitting error during the calibration process】提示，可忽略，点击【确定】按钮继续。
1709638276250-a56d8746-9f1a-465a-9fac-6b6793c469f0.png 

1709638276565-0ef16015-ac38-4b61-9646-50cc6e35c2a2.png

### 3.5. 标定结果查看
进入模型文件页面，刷新后打开设备【laser】，如标定成功，右侧参数栏x、y、yaw参数后会有标定后的蓝色修正值。
1709638803902-bf01b646-2d41-49fd-8056-7c0c968d2d9f.png

### 4. 激光与单舵轮模型半自动标定
如果上述自动标定不满足客户高精度要求，则进行半自动标定，熟练操作约30min,  rbk 版本 3.4.6.12 + 。
### 4.1. 标定界面
点击其他（下图①），标定机器人（下图②），弹出标定界面，将依次标定以下项目，需要注意每个标定项需要预留的场地空间。
1710343585922-f3c44059-302d-4b1d-8968-ab7ed202747e.png

1710056102767-379b4727-829d-44ef-93ab-cf9d23837c6a.png

注意：确保机器人内没有自动标定的激光里程计标定结果，如果有需要删除。
1704779601657-12ec86db-a026-4907-9a3a-87e0248d75a9.png

### 4.2. 覆盖舵角补偿文件，motor1，SinSteer_1
勾选motor1，SinSteer_1，点击开始标定，标定完后状态显示已标定
1710055964480-6a81b751-f4b5-4f44-846b-337e8bca635c.png

### 4.3. 舵角0度补偿和轮径标定 motor1，SinSteer_2
勾选motor1，SinSteer_2，舵角0度补偿和轮径标定；机器正前方预留5m，左右3m的空间，点击开始标定。
如果结果error不通过，进行上一步操作，直到出现结果通过/标定合格字样。一般至少需要标定2次。
1709651270335-294bc604-898a-402b-9a8a-1795ea98df3c.png

### 4.4. 舵轮安装位置 X 方向标定 motor1，SinSteer_3
勾选motor1，SinSteer_3，舵轮安装位置 X 方向标定：预留机器人旋转180°的空间，标定速度30°/s。
1709651537026-3c19dbf0-0cda-4a0d-9867-f53073aae6a9.png

如果结果error不通过，进行上一步操作，直到出现结果通过/标定合格字样。一般至少需要标定2次。
### 4.5. 激光安装角yaw标定 laser，SinSteer_4
勾选laser，SinSteer_4，激光安装角yaw标定：机器正前方预留5m，左右3m的空间，点击开始标定
1709651830853-ba50973b-7ae2-4a8e-8ca7-49ac3df41cca.png

如果结果error不通过，进行上一步操作，直到出现结果通过/标定合格字样。一般至少需要标定2次。
### 4.6. 激光安装位置X标定 laser，SinSteer_5
勾选laser，SinSteer_5，激光安装位置X标定：预留机器人旋转180°的空间，标定速度30°/s。
1709652047394-5e7d09b1-47b8-4011-92cc-ee3e902fa18f.png

### 4.7. 激光安装位置 Y 标定 laser, SinSteer_6 (手动标定)
laser,SinSteer_6，激光安装位置 Y 标定：此项需要手动测量，绘制地图。
### 4.7.1. 编辑地图
点击编辑地图，在空白处右键点击导入图元，地图新增三个点位，此项标定需要测试出 从右点位正走至中间点 与从 左点位倒走至中间点 的里程中心y方向偏差。
1710343643161-3341b6a4-c250-46a9-b35f-12db254afb79.png

1710343680872-94d1be3f-22c1-4107-81a1-5f817ae57a6a.png

## 得到图型如下：
1710343698092-f2af3ee1-ddae-4650-8aaf-77e683ef5b92.png

建议改LM编号如下图，方便后续操作讲解。
1710343758965-15e3dbfa-3692-42f9-9cc7-938cd466c0a4.png

## 修改线路方向，不勾选点位朝向：
LM1与LM2：LM1->LM2正走，LM2->LM1倒走；
LM2与LM3：LM2->LM3倒走，LM3->LM2正走；
## 点击线路①后在右侧②处选择正走倒走
1710343827794-780283f0-365b-401b-9360-dec33e6d523e.png

1710343810314-da0febcc-3bd3-476f-82bb-9be14c08d34d.png

1709652780417-6292ac3a-9500-4844-809f-82c9c223ab37.png

### 4.7.2. 里程中心打点
导航前先将参数配置的wkp改为3，完成此项标定后再改回wkp为原有值。(叉车参数配置的lqr_mode=false，这个不要改)
1710059172662-d480fd4f-35cb-4f52-83fb-8463a0f9ddb2.png

LM1与LM2之间多次循环路径导航，直至连续两次到达LM2点处y方向偏差小于5mm。
由于地图坐标系和机器人坐标系存在转换关系，我们需要观察机器人y方向的变化。一般通过下图运行状态-地图坐标观察偏差值，小幅度变化的为y方向，大幅度变化的为x方向。 
1709653261726-01d01abf-af9d-4e92-847f-cf4a9e25a970.png

### 在货叉里程中心，即两轮中心取中间点打点，如下图
1710909763032-b3a10741-1395-4ba0-b178-44d03463e8b1.png

注：①用马克笔在画里程中心处位置标记号，使两次用同样位置打点
## ②用直尺量取两轮内侧之间的间距
③取两轮之间的中间值，打点。
LM2与LM3之间多次循环路径导航，直至连续两次到达LM2点处y方向偏差小于5mm。
## 在货叉里程中心，即两轮中心取中间点打点
量出两点在y方向的偏差。
### 4.7.3. 标定机器人
在机器人界面勾选标定项，开始标定，在弹框中填写测量出的偏差值，点确认，标定完成。
1709653726515-87729342-00cb-46f8-9713-feab957e6f0e.png

1709653772486-e13f9f7e-f6a9-4c4c-9abb-a1eaeb6fa9a3.png

### 4.8. 舵角补偿标定(正负90度正走倒走) motor1，SinSteer_7
勾选motor1，SinSteer_7，舵角补偿标定(正负90度正走倒走)：预留机器人旋转360°的空间。
1709653922612-45bd9526-878a-455c-8db4-8d9f81f0ab0e.png

如果结果error不通过，进行上一步操作，直到出现结果通过/标定合格字样。一般至少需要标定2次。
### 4.9. 检查标定结果 laser，SinSteer_8
勾选laser，SinSteer_8，机器正前方预留5m，左右3m的空间，点击开始标定。每个标定项结果如图， 如果有未通过标定项，则继续针对次标定项进行标定。
1709653998386-7559785b-fcc5-461a-8c0e-50799cb02b17.png

1701942692765-8066f9c5-6dc8-4876-874b-c30f29b31714.png

### 5. chassis 文件标轴距标定
### 5.1. 模型文件配置
在模型文件里勾选allowWheelBaseShiftLengthCalib，且配置好车头的里程中心偏差，即货叉在高位和低位时的里程中心变化值，此时在标定项目中出现chassis项
1709650900915-abd1503d-f9e7-43f1-b420-ae1802631173.png

### 5.2. 场地要求
### 预留机器人旋转的空间，cbd15大约需要4m宽的场地
### 5.3. 开始标定
勾选chassis，点击开始标定，机器人分别在货叉低位和货叉高位进行旋转，一段时间后显示chassis已标定。模型文件出现chassis值
1710056784727-0bf38fc6-a13f-43b6-af9f-6413519efb87.png

1710056807902-087719c7-3252-41cb-bb17-7761cd31120b.png

### 6. 避障激光标定
CBD15前方有两个避障激光，需要依次对两个激光进行标定，参考《 避障激光标定 》，需要RBK 3.4.6.12 及以上。
### 6.1. 场地要求
### 在场地找到两个垂直角，把机器人开至角落附件，距离在2米以内
1710064552542-bce67671-f08b-4ff2-becf-a65ae4a163c1.png

1701312552622-1893c77a-f13b-48ea-9256-d16ec7a6318c.png

### 6.2. 开始标定
点击laser1 obstacle开始标定，点击laser2开始标定。标定效果如下。
1709654440642-da07d668-9215-4cdf-b406-887b43753a89.png 

1701314420925-ee47f30e-7fec-4821-8229-a262f9ff3a1c.png

### 7. 3D识别相机外参标定--图漾FM851
### 7.1. 工具准备
## 二维码x2，2米以上卷尺x1，标定支架
### 7.1.1. 二维码
在roboshop点击①其他 ②二维码工具③AprilTag码。
## ④中参数固定不变
### ⑤分别打印编号0 与 编号 1 两张二维码
1709654810876-e0d09b65-e5d4-4a10-b9f6-32a58d185611.png

效果图如下，左边为编号0的二维码，右边为编号1的二维码。
1694140529538-0262a56b-7c17-4793-89ba-5a5b4cf6d149.jpeg

### 7.1.2. 标定支架
a. 可获取已有的《 标定支架图纸 》来制作，条件有限时可通过纸箱等有垂直面的物品粘贴标定支架
b. 将二维码对称贴在标定工装两侧。如下图。
## image.png

### 7.1.3. 工装设置
把工装放在里程中心处，即平面抵在①两轮中间处，两码之间的中心和里程中心②重合
1710064668937-65bd2f08-1642-4d74-8273-334c6ff0a266.png

## 量出下图尺寸，填写保存参数配置
1710065208885-2e9f765a-1e8d-4c6b-aa33-6c550316b1f0.png

## 编号

## 参数

## 解释

## ①

## Tag_Size

## 二维码的中心距离地面的高度

## ②

## disBetweenTag

## 两个二维码中心之间的距离

## ③

## Tag_Height

## 二维码的中心距离地面的高度

## Taginfork

## 标定板是否固定在叉齿上，改为false
1710064740818-c21c6ade-3fad-446d-aece-ee5dd319f9b9.png

### 7.2. 开始标定
在标定机器人界面选择camera-tuyang，点击开始标定
1694576485008-b9f6faee-97e3-4ab2-ba69-ce27b987f2d3.png

查看标定结果：标定完相机数据将标定数据设置完成之后，可以在模型文件中看到标定数据。
1710057111373-0e0d01b2-7446-454f-8fa1-bcc01259d3fb.png

### 8. 3D避障相机外参标定--大疆MID70
### 8.1. 地面标定
保证大疆前地面平整空旷，在标定机器人界面点击camera dajiang，开始标定
查看标定结果：标定完相机数据将标定数据设置完成之后，可以在模型文件中看到标定数据，如下图所示
1710057076395-94ed881a-51c8-4c0a-8a77-8b5951f2fab6.png

### 8.2. 墙面标定
在相机模型文件中勾选 3Dcamera 属性。
1680424836878-d4d691cb-4543-4d7f-b94c-322b466c6b22.png

在相机模型文件中勾选 useWallCalib 属性。
1693359322870-1c8c2aff-6528-4ea6-a957-6241fab15617.png

标定相机。该动作无需运动， 仅需调整车辆位置 使待标定的 3D 相机的视野正前方为墙面，尽量避免视野内存在除墙面以外的其他物体 。点击“开始标定”后将立即返回标定结果。
测量相机高度。使用卷尺测量相机的中心点离地高度，记录下来后修改标定后的相机模型文件。
1710065542011-647afaca-dda7-4bde-98e2-19bba31f3cfe.png 

1710065517701-0238761d-fd1b-4da1-84a3-32c6a946a739.jpeg

修改相机模型文件。
1693798639080-b4852799-27e9-4f70-8a85-6542ab35b759.png

相机模型文件中 z是指相机的离地高度，由于使用墙面的标定方法是无法准确得到相机离地高度信息，我们根据步骤4中用卷尺测量得到的相机离地高度去修改相机模型文件。 如上图所示，要求修改后的红色框和黄色框中的数值相加与步骤4的测量高度相等。修改完成后重新推送模型文件
