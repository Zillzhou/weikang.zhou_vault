# 正向SOP

## 正向SOP

## 版本

## 更新日期

## 更新说明

## 文档状态

## 维护责任人

## V1.0

### 2024.4.29

## 更新发布

## 使用中

### （ 表格功能说明：需要明确文档全生命周期迭代进程 ）
正向操作 SOP 的目的是为了迅速让客户通过该文档，掌握该类型车体现场的快速部署、实施的方法，包括单机功能调试和测试、和系统 RDS 的联动和测试。

## 应用场景说明

## 场景要素序号

## 场景要素

## 场景说明

## 场景说明

## 1

## 场景车辆说明

## 1.CBD15搬运车*1 ，平面式搬运，货叉起升离地高度 205mm；
### 2.车辆配置
导航激光 free + 避障激光 free；
3D避障：大疆mid70；
3D识别相机：图漾FM851；
## 叉尖避障：宜科光电

1710116040711-4946efb9-ed96-476a-abf7-54426716062f.png

## 2

## 场地布局说明

1.库区：场景中有两个库区，一个是库区是满物料区 * 3 个满物料库位 A 和 B和C；一个是满物料放货区* 3 个库位 D 和 E和F，需要通过 AMR 满物料从满物料区运送至 满物料放货区；
### 2.载具：初始时川子托盘满物料存放于满物料库区；

1710117488190-99d99879-4f6f-4082-9a7a-7477277d61fb.png

## 3

## 业务场景功能实现说明

## 1.通过3D相机栈板识别功能实现物料从满物料库区 A/B/C 搬运至满物料存放库区 D/E/F,识别方式采用深度学习方式的展板识别;
### 2.实现叉车手操器在移动过程中，在移动方向存在障碍物情况下，实现音频报警功能；

## 1.载具：CBD 15 采用开放式川子类型展板；
## 路径设计标准

根据使用条件和现场环境，设计移动机器人的行驶路径，并确定充电系统（充电桩）、外围设备、现场操作站等的位置。应充分考虑车体尺寸、驱动方式、执行机构动作方式及运行环境条件等，确保移动机器人在运行时，与周边的物体无干涉现象发生。在路径设计中应该考虑以下因素：a）停靠点（PP）、充点电（CP）、动作点（AP）、途经点（LM）；b）操作站台、充电桩、外围设备等；c）运行速度；d）公共区域、限制区域、危险区域划分。 
## 实施安全要求
## 一般要求
移动机器人在现场使用时应满足以下安全要求： a）操作员正常操作和日常检查的位置或进出的区域内，不得有任何可能造车伤害的风险源； b）危险区域和限制区域应由适用方和制造商在设计、安装和启动阶段指定，并对此类区域进行标记，由制造商在系统运行前对使用方人员进行可验证的培训； c）障碍物和移动机器人（包括负载）之间宜保持0.5m的最小间隙，小于此间隙的所有区域应被视为危险区域或限制区域，须清晰标记； d）应设计合理的停靠位置，足以保证移动机器人及其负载不会阻塞安全通道。
## 限制区域
在限制区域内移动机器人应满足以下安全要求： a）间隙小于0.5m高度小于2.1m的区域可能对人员造成危险。移动机器人进入这些区域之前，应降低速度，并启动声音警告； b）人行安全通道（0.8m或更宽）作为步行者的专用通道，一般不允许与移动机器人的运行区域有干涉； c）当通道狭窄不能有效保护步行者时，应在有安全保障的地方设置人行通道（0.5m宽或更大的区域）。 
## 危险区域
危险区域应满足以下安全要求： a）使用方和制造商将无法被防护装置保护的区域以及未涉及人员逃生通道的区域指定为危险区域，使用方和制造商应针对这种情况商定适当的保护措施。应由使用方采用醒目的标志（如：底板标志等）进行相应标志，避免与其他标志混淆； b）移动机器人行驶至此区域时，最大行驶速度应限制在0.2m/s，并启动声光告警装置。 
## 额外交通设施
由于人员视线受限原因可能造成风险时，应采取额外的交通管理措施（如：交通灯、道闸等），以降低风险
## 开关机
1709285434919-baecc397-9397-4fa5-bd87-359938efd05b.png

## 开机步骤如下：
步骤①：如上图，先将钥匙开关旋到ON；
步骤②：按下开机键2-3S，开机键变绿，松开开关机键，等待数秒，氛围灯变为绿色（请参阅“ 氛围灯 ”），此时机器人处于可使用状态。
## 关机步骤如下：
步骤①：按下开机键2-3S，等待数秒，观察开机按钮灯熄灭，整车掉电；
步骤②：将钥匙开关旋到OFF挡。
## 连接网络
由于cbd15上默认未配置单独客户端，需要使用控制器自带网卡连接网络，如下图，①连接至控制器下网口，②连接至控制器上网口。
### 3.1. 有线连接
### 将网线一端插上PC，一端插上LAN口（图中②）
## image.png

设置 PC 网卡 IP 段为192.168.192.x，如下图
## image.png

在roboshop添加机器人，ip 192.168.192.5 
## image.png

### 双击192.168.192.5 进入机器人
1710047792028-7c069fb3-8c47-40e3-b8e4-4d720999bf95.png

### 3.2. 无线连接
在roboshop首页进入高级配置界面，连接网络，具体见《 网卡配置 》
## image.png

### 通过读取IP获取机器人IP，可通过IP无线添加机器人
## image.png

## 扫图建图、站点配置、库位配置
### 4.1. slam扫图
确认机器人无异常后，可开始对所需要的作业区域进行扫图。
回到地图主界面点击【2D 建图】, 选择【Slam 建图】，参数保持默认即可，然后可开始扫图。通过笔记本电脑键盘上的 "W、A、S、D" 来操控车辆行走，运行速度保持在0.5m/s以下，并对所需要的作业区域进行闭环式扫图（扫出来的地图和机器人行走的路线一定要形成一个闭环）。
1710043122995-d6607728-b1da-4b64-beaf-f4be4cef0bc1.png

1710067393887-caac767a-3455-4c25-b2ee-096feaed61c4.png

扫图完成后点击保存地图。
1710067437071-a33e6693-69e6-48c9-bff5-140ad4fb6f98.png

1710067492966-1dcef0ee-207a-42e6-b409-c1bd56b6f352.png

## 启动编辑地图，进入地图编辑界面
1710067535666-1067105d-fdc0-4bfa-9bd7-6a24953c1d02.png

在编辑界面左侧，使用橡皮擦擦掉地图中人员等移动物体的杂点。
1710067622908-81f53a43-8293-4074-afce-37c9abb7eb08.png

## 点击保存地图后退出编辑
1710067745894-e9cf4106-ea16-4d9c-b1c1-eda9c610a350.png

### 点击推送地图，将扫好的地图推送到控制器，此时会自动重定位
1710067819242-eb8e6a3f-03ea-4484-a196-932578c13d0b.png

## 确认机器人位置正确后，点击确认
1710067867915-cfff675f-2449-4db7-a85d-db44996e352e.png 

1710067853708-0403e252-6793-45a9-a9a8-e339da0b610b.png

### 4.2. 站点配置
### 4.2.1. 建立满物料库区工作站
根据前置场景条件，将机器人开到取货区，右击机器人，标记为工作站AP点
1710068140350-76088f34-9942-4bb8-9308-854631994192.png

### 点击启用编辑进入编辑界面，右击AP点，选择批量创建机器人
1710068282989-1f4731e8-4f56-42b8-ad10-ebd05a33f1f7.png

### 根据实际需求，在下图中建立需要的站点数量
1710068379773-bbe943ac-965f-4bf2-b4fc-7dbb4165239f.png 

## 得到下图：
1710068412439-cc3d0883-ba7c-4fde-a175-a4da7141a685.png

首先按照上述方式构建出站点 AP1/AP2/AP3 ，再按照下述步骤构建场景中的过渡点位，具体操作如下所示：
步骤①：将鼠标光标移动到图标①站点位置；
步骤②：选择站点图标，并单击；
步骤③：合理示教 LM 12 的位置；
照上述步骤重复示教其他 LM 过渡点位的位置，
再将车辆移动到充电桩位置，使车体充电极片位置能够正对充电桩伸出位置，按照如下操作合理示教充电位置：
步骤①：点击图标①的位置；
### 步骤②：选择图标②中的“显示机器人”、“显示坐标系”勾选项
步骤③：右键当前机器人实时位置，选择标记特殊工作站；

1710213269137-6966f168-c167-4ef5-ac15-ac81c28c55c8.png

1710213418463-af040e6a-a6a5-49a9-b0b5-362db0f3ffc8.png

## 组图：场景添加 CP 充电点操作
在场景中建立的 LM 点选择合适的位置作为车辆无任务时的车辆停靠位置，按照如下操作合理建立 PP 点：
步骤①：如图标①位置所示，鼠标光标移动到LM 点，右键点击预设的 LM 点
步骤②：如图标②所示，选择 ParkPoint 点位属性将点位类型更改成停靠点位；
1710213781240-6398f94b-806f-47b8-988f-1a82ab66d770.png 

## 图：场景添加 PP 停靠点

### 4.2.2. 链接场景拓扑链路和设置相关标识
首先按照下图操作步骤选择拓扑链接线位贝塞尔曲线，具体操作步骤如下：
步骤①：如下图图标①所示，选择贝塞尔曲线链接图标；
### 步骤②：选择默认的“高级 3 阶贝塞尔曲线”
1710214236401-c791af80-7122-4c1a-873a-e5e509a5de89.png 

步骤③：在出现的十字链接图标，将十字图标移动到需要两两项链的起点 点位上，按住鼠标左键不动，移动十字光标到需要链接到的位置上；则可完成点位链接操作；重复如上动作将场景所有点位链接，具体操作如下视频所示；

### 2024-03-12_113125788.mp4
## 视频：链接场景拓扑
给场景构建添加合适的标识以方便操作人员理解 smap 地图和业务实现上具体物理位置的映射关系，具体操作如下图所示：
步骤①：选择高级区域图标；
步骤②：选择“区域描述”功能键；
步骤③：在出现的“十字”标中框选合适的物理区域；
步骤④：在描述栏中，输入相关的场景区域描述文本内容；
步骤⑤：选择合适的字体大小，颜色等等；
### 按照上述步骤操作则可得到和场景描述一致的场景 layout
1710214979189-a87dba96-c3d1-45c5-a963-760c32ade6e6.png 

1710215417433-3ec6b7c8-e242-4a82-9d70-f33ecd8c207a.png 

## 组图：创建场景区域标识
### 4.2.3. 设置前置点与路线属性
选中AP9 如①，在②处设置LM17是 AP9 的前置点。
1711087196402-4f902c94-4092-469b-9a12-966d9341775f.png

设置线路方向，选中LM17 与 AP9 之间的连线，在右侧②处设置为 LM17 -> AP9 倒走，AP9->LM17为正走。
1711087355024-6bfa4f82-c455-467f-a8c1-4228d81caca4.png

1711087487066-4f0732be-40f6-45a9-9dcf-a69883501b7c.png

### 4.3. 库位 bintask 配置
进入地图编辑界面，选中所有的库位。
1711090676070-aa1b4e20-5185-49b5-b927-8583d5a00205.png

点击①设置库位，点击②选择所有AP点，在③处填写命名，点击④命名，点击⑤创建库位。
1711090876034-b3c038a0-8b58-4c91-bb1a-21b98ed15450.png

此时得到下图，ap点附近有对应的库位标识和编号。
1711091058130-5c55db47-01a1-4835-93df-ee939628b6cf.png

选中需要编辑的库位①，在右侧点击新增②后，在弹框中点击编辑③，在方框内填写对应的键值，即步骤6得到的json语句。
## {
    "end_height": 0.85,
    "id": "AP9",
    "operation": "ForkLoad",
    "recfile": "pallet/p0001.pallet",
    "recognize": true,
### "start_height": 0.205
## }
## {
    "end_height": 0.085,
    "operation": "ForkUnload",
    "recognize": false,
### "start_height": 0.205
## }
1711091166136-c0903061-b0e5-44af-aaaa-d2a8852939d1.png

## 得到以下界面
1710162254904-f70fa548-8de7-49d8-b101-e1845147c039.png

## 退出保存并推送地图
## 单库位点位调试
使用图漾 FM851 相机进行栈板识别，获取图漾在车体机械安装位置，与图漾相机内部网络配置与模型文件一直，确认此时机器人无报错。
## image.png

### 5.1. 识别文件配置
## 根据托盘尺寸配置pallet文件：
## image.png

## image.png

## image.png

### 5.2. 查看识别结果
路径导航至前置点（前置点一般是识别相机距离展板 1.5 m左右间距处），选中AP点，依次勾选识别文件、识别，查看弹框识别结果。识别结果为true时相机处于可用状态
## image.png

### 5.3. 识别测试
在主界面，路径导航执行识别栈板取货，正常情况可以顺利取到货物
## 注意 ：
由于cbd15上升过程中轮有后轮会往前有5cm左右的移动，所以在货叉抬升时有轴距缩短，里程中心会有小距离的移动，定位与导航算法均已做处理。具体现象如下：

## FAQ ：
## 1.相机连接错误3D camera disconnected
a)首先排查相机网线直接插在SRC上网口、设备ID ip与端口是否正确等
b)如果是早期CBD15，可能存在DCDC供电与图漾相机问题，可通过增加稳压电源或更换图漾相机的方式解决。

### 2.识别结果为False，如下图
## 参考栈板识别错误排查
## image.png

## a)相机是否标定，标定异常重新标定相机
## image.png

### b)识别文件里调整recogheight值
## image.png

## 使用任务链
任务链界面分别点击新建①，新建任务②，添加组③。如下图所示。
1710117892176-bad5f938-d5cc-45a5-9acf-765e9520bcfb.png

取货任务：在右侧选中对应的动作，在弹框中设置起始、终点高度，识别文件等，点击确认
1710118027235-b1485190-f158-4bbc-9406-cd3fa5c88628.png

## {
    "end_height": 0.85,
    "id": "AP9",
    "operation": "ForkLoad",
    "recfile": "pallet/p0001.pallet",
    "recognize": true,
### "start_height": 0.205
## }
放货任务：在右侧选中对应的动作，在弹框中设置起始、终点高度，识别文件等，点击确认
1710160806962-575440bd-c560-444f-9fa4-a3c95b1c39fa.png

## {
    "end_height": 0.085,
    "operation": "ForkUnload",
    "recognize": false,
### "start_height": 0.205
## }
## 使用RDS
### 按教程安装好RDS服务器，教程链接:安装教程
### 7.1. 编辑场景文件

### 在roboshop添加127.0.0.1的设备
1710162327323-ce3bcf2f-e5f0-417f-b2df-5b6e6f812cce.png

## 点击①启用编辑，点击"+"号 ②
1710162447809-51e56345-bcc8-4ba0-8d3d-d3fd068a7ce5.png

## 勾选需要添加的机器人
1710162517431-f5e32a01-1414-42f6-a834-c307cf07dba1.png

## 右击组，导入对应的地图
1710162647495-10b9e43c-904a-4c23-8472-c7f9f8ea1203.png

## 效果如图，保存并推送场景
1711091387184-03831daa-d447-46e8-b57e-34c88458f958.png

### 7.2. 新建天风任务
1709533824000-8905b9cd-0fc6-4412-bff1-f7c6835cdce1.png

1709533823939-4ed63077-3082-4650-a84a-b49b30861743.png

### 7.3. 选择执行任务的机器人
## 在机器人界面可以看到可用机器人列表
1711092019771-cf7d8c24-a0ff-49e6-a777-538bbbac46fb.png

## 将机器人块拖到编辑框
1711092002130-a52fe0d7-81d9-484f-8abe-0bbd7b2383e3.png

## 填写机器人名称
1711092098870-d4d3e678-8684-4bf1-ac04-91e1b8f6659d.png

## 填写关键路径 AP1
1711092220785-701c6412-05f7-4c78-8bc6-370fcfeea17f.png

### 7.4. 添加机器人通用动作
设置目标库位，如 Loc1-1；
1711092643915-7494a0a7-b788-4449-bb52-5395f979898a.png

设置指令内容：选择 bintask；
1711092679377-84814835-7924-42b0-9dbb-ae759e65a265.png

设置指令参数：输入 load 或 unload(注：这里选择的 load 和 unload 的动作 来自于库位的 bintask 配置，配置参考 正向SOP)
1711092722244-16883f1b-8f00-4572-aca0-09571bd51f8e.png

## 同样办法设置unload如下图
1711092792054-6edaaedc-145e-47af-bced-132524606ff9.png

### 7.5. 保存并运行天风任务
机器人接收到调度下发的任务后会自动前往 Loc-2-1库位取货，到 Loc-1-1 库位放货。
1711092845937-ebca14c7-1662-4fbf-a85a-17e25b63a370.png
