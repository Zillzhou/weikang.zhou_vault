# 正向操作 SOP

## 正向操作 SOP

## 版本

## 更新日期

## 更新说明

## 文档状态

## 维护责任人

## V1.0

### 2024.4.29

## 更新发布

## 使用中

## 1 场景说明
由于是讲述车体的使用操作 SOP， 所以会涉及到什么样场景下的 SOP 实现，我们可以通过 如下表格的关键信息对此场景下的 SOP 实现做一定的说明，具体现场的实施可以参考该篇文档进行实施和部署。
## 1.1 应用场景说明

## 序号

## 场景要素

## 场景说明

## 备注说明（可以含图示）

## 1

## 使用车辆说明

## 1.车辆地盘运行模型为 双舵轮全向移动+顶升；

1710059748137-0f45edf7-5569-4a3c-9f06-ea94fd648001.png

## 2

## 场地布局说明

## 1.库区：场景中有两个库区A和B，每个库区包含一个库位和一个站点；
### 2.料架*1，由于料架形状特殊，货架宽度较小，机器人只能从料架侧向钻入货架;
### 3.场景中搬运的料架尺寸为：1.5 X 0.52 X 0.6m(长宽高)。

1710060443260-8e314a0e-86b3-4337-8981-52cc2217831b.png

## 采用RDScore的方式实现

## 3

## 业务场景功能实现说明

## 1.初始状态：料架摆放在A库区的库位1；机器人停在A库区的站点1；机器人前进方向与料架长度方向保持一致。
2.工作任务：全向机器人在接到RDS下发的任务后，需要将库区A内的空料架搬运到库区B中的库位2；并空车在站点2短暂停靠；然后再将库位2的货架搬运到库区A的库位1处；并空车在站点1停靠等待新的任务。
### 3.机器人在整个运动过程需要保持车体朝向与地图坐标系保持不变，需要使用车体方向保持功能（holdDir）。

1）料架识别采用反光板识别，需要在料架一侧的两个支腿处粘贴反光贴，
2）车体反光贴高度需要能保证车体激光能够识别。
1710062181347-d917ac42-aab0-492c-a23f-6c401bc8e8a2.png

## 1.2 场景站点和路径说明
根据现场环境和料架尺寸，设计移动机器人的行驶路径，并确定库位、站点、工作路径等。应充分考虑车体尺寸、驱动方式、执行机构动作方式及运行环境条件等，确保移动机器人在运行时，与周边的物体无干涉现象发生。在路径设计中应该考虑以下因素： 
a）动作点（AP）、站点（LM）； 
b）运行速度； 
c）激光屏蔽区域。
## 2 开机
（1） 按下开关机按钮 绿灯亮，保持 3 s 释放开机按钮；
（2） 直至绿色开机指示灯常亮，松开开机按钮，完成开机过程 ；
（3） 等待数秒 ，前后舵轮和顶升机构开始标零，舵轮角度标零时可能会伴随着车体轻微摆动，属于正常现象；
（4） 标零结束后，灯带变为绿色，此时机器人处于可使用状态。
1709538949754-f34f0045-827a-44a5-9116-ecde911c4124.png

## 3 有线及无线连接
完成开机后，需要对机器人进行检查，查看是否一切正常。
（1） 使用网线连接机器人，网线一头插在机器人控制器的连接网口上，另一头插在笔记本的以太网口上。连上后将响应以太网 IP 地址更改为 192.168.192.xx 网段。
注意：AMR 默认 IP 地址为 192.168.192.5。
1684983702415-aed69d0c-24b4-4793-908c-8e7f009f8143.png

1684983753834-52dc49bb-652e-4396-9bdf-847854ddaf13.png

（2） 连接上机器人后，打开 Roboshop 软件，点击右上角添加服务按钮，输入控制器默认 IP 地址：192.168.192.5 ，即可连接成功。
注意：如机器人内置了第三方网络客户端，所以若需配置无线 IP，需要参考相关文档进行配置。
## 4 建图
确认机器人无异常后，可开始对所需要的作业区域进行扫图。
回到地图主界面点击【2D 建图】, 选择【在线建图】，如现场使用了反光板/反光柱做辅助定位，需勾选反光板选项，并选择辅助定位方式，然后可开始扫图。通过笔记本电脑键盘上的 "W、A、S、D" 来操控车辆行走，并对所需要的作业区域进行闭环式扫图（扫出来的地图和机器人行走的路线一定要形成一个闭环）。
当场景较小时，建议扫图前将手动控制最大速度设置为0.5m/s，方便扫图时控制小车行驶轨迹。
1709622174695-b2332a21-8fb4-4b46-a175-abc09add6b0f.png

### 4.1 进入建图操作页面
根据图示步骤执行。
1709620548217-b66644fb-9487-4235-a54c-d0ae56ecff5f.png

### 4.2 设置激光建图参数
根据实际需求填写激光建图参数，一般采用默认参数即可。本次场景中采用无反激光slam导航，所以无需勾选反光板。
1709620887223-bf391435-8446-4ea8-9859-5529481e97b2.png

### 4.3 建图
完成建图参数配置后，通过笔记本电脑键盘上的 "W、A、S、D" 来操控车辆行走，并对所需要的作业区域进行闭环式扫图。对于较小的场景来说，建图的过程比较随意，只需保证扫出来的地图和机器人行走的路线一定要形成一个闭环即可，如下图所示。
1709622899824-4d1e3cf1-94fe-45a9-9c5d-262c70d2a311.png

当场景比较大的时候，建图的过程就需要一些策略。
控制车辆走“回”字；
1651916711444-c7c8557a-1545-44f6-8ceb-1c0942b7bfa9.png

先整体构建场景轮廓，再逐个房间完善；
1651916358346-a75e1ace-7fb5-4a44-b214-dd975885a665.png

### 4.4 保存与推送地图
完成闭环扫图后，对扫描完成的点云地图进行保存，操作步骤如下图所示，可以根据实际需求对地图进行重命名。
1709624146528-bb8cb428-dd01-4daa-a7bf-8d056f15b6b0.png

打开刚刚保存在本地的地图。
1709624481181-8ab6b63a-2603-4343-919b-e77aba32c160.png

将刚刚新建的地图推送至控制器端。
1709624619279-cc016604-a81e-462b-ac3b-ddda500b402c.png

### 4.5 重定位
完成新建地图的保存和推送后，需要对机器人在地图中的位置进行确认和重定位。首先对当前机器人位置进行确认，然后需要进行重定位。
1709625015217-0a0d880b-6a57-4f4e-a804-189a07865bbe.png

重定位功能可以按住鼠标左键不放，然后拖动圆圈来选择定位所需要参照的范围大小，也可不选择。重定位完成后需要再次查看当前车辆在地图中位置的置信区间。一般置信区间大于多少？说明位置可信度高。
1709627045839-94720a58-598b-4969-8e26-48e8035fe3a5.png

### 4.6 建图过程操作视频

## 建图过程操作视频.mp4
## 5 料架识别参数配置与测试
### 5.1 料架配置前准备工作
实际应用场景中可能存在多种满足机器人钻入要求的货架，机器人在不同的任务中，也可能被指定钻入不同的货架，因此我们需要对机器人要钻入的各种货架进行参数描述，在“识别编辑”中的“shelf”标签下编辑。首次在Roboshop中对货架识别进行参数配置时，需要将控制器端的货架描述文件拉取到本地电脑。操作步骤如下图。
1709791675744-3039e1cf-698f-4438-9fe5-6dc235c72e5f.png

### 5.2 配置参数
第一部分场景说明中的货架配置参数如下图所示。
1709794600002-bf769eb3-a7df-46df-885c-80af01d541ad.png

## 具体参数含义解释如下

## 参数名称

## 单位

## 默认值

## 最小值

## 最大值

## 支持版本

## rec_laser_id

### 配置识别激光，设置为 -1 表示默认用前激光去识别

## width

## m

当小车从货架侧面横移钻入时，此参数表示货架的实际宽度，上述货架宽度0.52m

## length

垂直于钻入方向的两个货架腿的最外侧宽度，上述货架长度1.58
1709793753233-a2bc9fad-3165-4a0c-a649-84b515f018a5.png

## leg_width

反光条宽度，若选用标准 3M 汽车反光贴，即为 0.05（米）

## align_depth

识别方向为x或者-x识别下，前置线路为“倒走”，也就是机器人钻入货架底部后，机器人坐标系 x 轴正方向与货架 x 轴正方向重合时，机器人停下的位置和货架前腿之间的距离，一般为(length/2)，该数值需要根据实际实施时的位置进行调整。

## anti_align_depth

识别方向为x或者-x识别下x或者-x识别下，前置线路为“正走”，也就是机器人钻入货架底部后，机器人坐标系 x 轴正方向与货架 x 轴正方向重合时，机器人停下的位置和货架前腿之间的距离，一般为(length/2)，该数值需要根据实际实施时的位置进行调整。

## y_align_depth

识别方向为y或者-y识别下，前置线路为“倒走”，也就是机器人钻入货架底部后，机器人坐标系 x 轴正方向与货架 x 轴正方向重合时，机器人停下的位置和货架前腿之间的距离，一般为(width/2)，该数值需要根据实际实施时的位置进行调整。

## y_anti_align_depth

识别方向为y或者-y识别下，前置线路为“正走”，也就是机器人钻入货架底部后，机器人坐标系 x 轴正方向与货架 x 轴正方向重合时，机器人停下的位置和货架前腿之间的距离，一般为(width/2)，该数值需要根据实际实施时的位置进行调整。

## rec_off_x

### 表示在识别坐标 x 方向的偏移量，一般设置为0

## rec_off_y

### 表示在识别坐标 y 方向的偏移量，一般设置为0

## rec_off_angle

表示在识别坐标角度偏移量(度) 识别坐标系为右手坐标系，x 轴指向识别物体外侧，即为识别表面的外法向向量。，一般设置为0

## outer_width

因为存在货架顶部比货架腿形成的矩形要大的情况，因此有这个参数；这个宽度的方向和参数width是同向的。上述场景中与width保持一致为0.52m

## outer_length

因为存在货架顶部比货架腿形成的矩形要大的情况，因此有这个参数；这个长度的方向和参数 length是同向的。注意为了防止反光条的噪声，outer_length 至少需要比 length 大 5cm，上述场景中为1.68m。

## extra_dist

### 激光抠除区域的宽度，比货架腿略宽；上述场景中设置为0.1m

## side_block

是否货架侧方有挡板，根据实际情况勾选；上述场景中货架侧边无挡板不勾选。

## recDist

## 默认设置为0

## detect_direction

用来指明识别朝向，detect_direction有x,y,-x,-y四个选项，x指的是车体的前进方向，采用右手坐标系；
### 由于场景要求从货架侧边横移进入货架底部，所以选择y方向识别

## leg_type

货架腿类型，方形（cube）和圆柱形（cylinder）可选，暂时不起作用；默认选择“cube”

## method_type

by_reflector 反光板识别   /  by_legshape 形状识别；上述场景中选择“by_reflector”

配置完识别文件后，将配置完成的识别文件推送至控制器。
### 企业微信截图_17114246006845.png

### 5.3 配置结果验证
完成识别文件配置后，对配置参数进行验证。验证前需要将机器人移动至料架附近，机器人与料架保持平行，并保持一定距离（推荐 0.8~1.5m)，保证识别激光的视野能完整识别到料架贴着反光板的两个料架腿，详细验证过程如下图。
### 企业微信截图_1711424305803.png

在第 2 步中，选择上一步推送的配置文件。
Roboshop 会自动跳出识别结果，如果显示识别成功，证明配置的识别文件是正确的。
## 6 地图编辑与库位建立
在完成扫图后，在新建的地图中进行地图编辑操作，步骤如下图。
1710063305284-71bb1b5d-81cc-490f-a16b-6f5e4100b173.png

### 6.1 新建工作站点
首先在地图的合适位置新建两个工作站点，分别作为库区A和库区B料架的两个库位，可以用鼠标将站点拖拽任意到所需的位置，具体操作步骤如下图。
1709796962380-11b950fd-b98e-4f50-9343-0d9612f5dee6.png

由于机器人需要在工作站点实现对料架的顶升和放下的动作，所以需要在工作站点设置激光屏蔽区，否则机器人完成动作后会需要钻出货架时有可能出现“激光阻挡”报错，屏蔽区域的尽量比料架的投影区域稍大一些，具体操作步骤如下图。
1709797727202-f54b17b7-0b17-40f5-9a2f-41b4a3086cf7.png

完成屏蔽区域设置后，需要对工作站点的角度进行设置，本场景中设置为0°，具体操作步骤如下图。
1709798310483-4a9ac3a5-6656-429b-9d7c-62c3282b104b.png

新建两个站点分别作为工作站点的前置点，由于在前置站，机器人需要识别货架腿，所以需要保证激光能扫描到货架腿的反光贴，所以尽量让前置站点与工作站点保持0.5~0.8m的距离，并根据场景需求将两个前置站点角度设置为0°，具体操作步骤如下图。
1709798754257-021114d0-71ae-47a2-a13b-9dfdf8e77fdc.png

1709799126551-e00d9338-5dab-49a6-b88f-6d2f92c9395a.png

### 6.2 建立导航路径
完成站点建立后，需要将各个站点进行路径连接，并根据场景中“在搬运过程中，保持全向机器人在世界坐标系下的朝向不变”的需求在对路径上的“holdDir”角度参数进行设置，具体操作步骤如视频所示。

## 路径设计操作视频.mp4

## 参数名称

## 单位

## 默认值

## 最小值

## 最大值

## 支持版本

## holdDir

## °

车体在路径导航时车体坐标系相对于地图坐标系偏转的角度，此参数是全向机器人特有参数，通过设定此参数可以让机器人坐标系始终保持与地图坐标系不变。

### 6.3 库位建立和 binTask 创建
建立两个库位“Loc-1”，“Loc-2”，具体操作如下图所示。
### 企业微信截图_17113545686046.png

将“Loc-1”库位与“AP1”工作站点绑定，将“Loc-2”库位与“AP2”工作站点绑定，具体操作如下图所示。
### 企业微信截图_17113547546226.png

然后分别对机器人在该库位需要进行的动作进行编辑，具体操作如下图所示。
### 企业微信截图_17114200376876.png

在第 3 步中，输入的键值为自定义，如果车体在此库位是顶升料架动作，通常设置为“load”；如果车体在此库位还需要卸载料架动作通常设置为“unload”；如果车体在此库位既有顶升动作也有卸载料架动作，则需要设置不同的键值。
在第 4 步中，顶升料架动作输入代码如下。
## {
    "operation": "JackLoad",
    "recfile": "shelf/W600DS.shelf",
    "recognize": true,
    "use_down_pgv": false,
## "use_pgv": false
## }
## 卸载料架动作输入代码如下
## {
    "operation": "JackUnload",
    "recognize": false,
    "use_down_pgv": false,
## "use_pgv": false
## }
具体操作视频如下。

## 库位绑定操作视频.mp4
## 7 使用单机任务链测试
### 7.1 任务链建立步骤
完成上述配置后，即可通过建立单机任务链进行测试。具体测试任务步骤为：
1）任务开始前，机器人停在“LM4”站点；
2）任务开始后，机器人在“LM4”站点沿车体坐标系y方向识别料架；
3）完成识别后，机器人横向移动钻入料架后将料架顶起；
4）机器人沿着规划路径将料架搬运到“AP1”工作站点；
5）到达“AP1”工作站点后，机器人将料架放下；
6）放完料架后，机器人横向钻出料架，横向移动到“LM3”站点；
7）在“LM3”站点沿车体坐标系y方向识别料架；
8）识别完成后机器人钻入料架底部将料架顶起；
9）机器人沿着规划路径将料架搬运到“AP2”工作站点；
10）到达“AP2”工作站点后，机器人将料架放下；
11）放完料架后，机器人横向钻出料架，横向移动到“LM4”站点等待。
在搬运过程中，保持全向机器人在世界坐标系下的朝向不变。
### 7.2 单机任务链建立操作视频
具体操作步骤如视频。

## 建立任务链视频.mp4
### 7.3 机器人实际动作视频

## 货架实际测试视频.mp4
## 8 RDS 绑定 bintask 测试
完成单机测试后，可在 RDS 系统内使用天风任务调用机器人执行库位取放货。
### 8.1 新建天风任务
a）进入“天风任务”；
b）点击“定义新任务”；
c）在“请输入任务名称”中填入任务，可根据需求自定义；选择“普通任务”；
d）点击“确定”；
e）点击“编辑”。
具体操作如下图。
## image.png

## image.png

### 8.2 添加机器人并添加机器人通用动作
需要将机器人在此任务中的所有动作按顺序定义清楚，具体操作步骤如下图。
1710033441644-abac48f3-45fa-414b-8245-605e4c8ddf27.png

### 企业微信截图_17114359697538.png

第 1 步，点击“机器人调度”；
第 2 步，在下拉列表中将“选择执行机器人”拖拽至右侧空白区域；
第 3 步，指定机器人“AMB-01”；自定义“关键路径”名称；
第 4 步，将“机器人通用动作”拖拽至右侧执行机器人的方框内部；
第 5 步，设置目标站点，如 “Loc-1”；
第 6 步，设置指令内容：选择 bintask；
第 7 步，设置指令参数：输入 load 或 unload，这里输入的即为第 6 章部分库位定义的键值。
此部分省略了“导航至前置站点”等简单动作的操作，具体每一步操作参考实操视频。
### 8.3 运行天风任务并监测
将机器人在此次任务所需要执行的动作编辑好后，保存任务并运行，监控运行，具体操作步骤如下图。
1710034455762-65559f3a-0c90-43cc-9eb9-e2de154da23b.png

### 8.4 实操视频
实操视频中的库位和站点名称与上述章节没有完全对应，根据实际输入。

## RDS视频.mp4
### 8.5 机器人执行天风任务动作视频

### 机器人执行RDS任务视频（剪辑版）.mp4
