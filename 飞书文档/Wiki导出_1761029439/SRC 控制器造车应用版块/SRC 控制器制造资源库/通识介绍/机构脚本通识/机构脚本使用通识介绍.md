# 机构脚本使用通识介绍

## 机构脚本使用通识介绍

## 版本

## 更新日期

## 更新说明

## 文档状态

## 维护责任人

## V1.0

### 2024.11.4

## 发布

## 使用中

## 适用范围
此使用 SOP 适用的 RBK 版本为3.4.6.x，Roboshop版本为2.4.1.188~。
## “机构脚本”界面说明及基础操作
## 界面说明
### 1730803333313.png

打开RoboShop后，选择“机构脚本”页面，应当首要了解的内容有以下五个部分：
## 【工具栏】文件的基础操作按钮
## 【文件列表】
区别于底层文件，是实现特殊需求的关键。脚本列表中，所有文件的文件名左侧都有一个图标：
### 2.1 文件仅在本地，未上传
### 2.2 文件已上传，但和车载控制器的文件存在不一致
### 2.3 文件已上传，且和车载控制器的文件完全一致
### 2.4 文件仅在车载控制器，本地没有
## image.png

## image.png

### 【脚本编辑页面】使用Python语言编写
### 【程序执行结果】会显示程序的状态以及报错、警告信息
## 【参数键值】可用于跟踪中间变量
【参数可视化】展示脚本任务参数以及JSON配置参数的可视化配置入口
## 脚本拉取
对于仅存在于车载控制器且本地没有的文件，需要通过拉取的方式同步到本地，点击如下图所示的按钮即可实现。
## image.png

## 脚本导入
将本地的文件导入到Roboshop是使用脚本文件的第一步，导入方法有以下几步：
STEP 1. 右键客户脚本列表的空白处，点击“导入文件”；或点击操作按钮
## image.png

## image.png

### STEP 2. 在弹出的页面中选择需要导入的文件即可
## image.png

## 脚本推送
## 推送指定脚本有两个方法可以推送
### 方案1. 在客户脚本列表中，右键需要被推送的文件，点击推送
## image.png

方案2. 点击“开始”运行脚本，若车载控制器中没有本地文件或与本地文件不一致，会弹出“推送并运行”的按钮，点击即可完成推送。

### “项目管理”（脚本云服务器）界面说明及基础操作
项目管理页面是为了方便脚本开发的版本管理与现场部署时的多车间脚本复用，开发了一套在线的脚本管理服务器，类似git的代码管理，可以根据项目的唯一码，下载、上传所需的脚本文件。
注意：此处的上传、下载区别于PC与控制器之间的拉取、推送，此操作是在调试的PC与云端服务器之间的文件传输。
## 界面说明
## 登录：账号和密码均是 user
## image.png

## image.png

## 完成登录后点击拉取
## image.png

## 输入UUID，并点击【获取记录】
## image.png

## 选中指定版本的项目文件并点击【下载】
## image.png

## 选择下载方式：
## 说明：
是否下载参数文件夹，选择是，则下载此版本项目目录中的params目录下的文件；
是否清空所有文件，选择是，则先清空本地（调试电脑）的所有脚本文件，包含参数文件，再下载服务器文件。
## image.png

## “参数”界面说明及基础操作
## 脚本“参数”说明
## 脚本JSON配置文件
### 首先，认识什么是脚本文件，什么是脚本配置文件，定义如下：
脚本文件：如 containerRobot.py，后缀名为 .py 的 Python程序文件，文件可以在 Roboshop 上运行，可以控制机器人执行任务；
脚本配置文件：如 containerRobot.json，后缀名为 .json 的 JSON参数文件，该文件是由同名称的 Python 程序文件运行后自动生成的，保存在 param 文件里，用于修改配置参数。
此文件的主要用途是：对于某一车型在某一特定场景应用时，需要一次性修改某些参数，如线性电机的最大行程，识别后调整的路线类型（两段线还是贝塞尔曲线）等，为了便于配置这些参数，我们将这些参数存储在JSON格式的文件中，可以方便的直接修改参数，或者通过可视化的方式进行修改。
## 脚本任务参数
对于每一次脚本的执行，需要输入实际任务参数，比如动作类型、电机目标位置、是否识别等，这些参数类似脚本对外开放的API及其参数，需要在每次执行时给定。对于如何查看，可在Roboshop双击打开对应脚本，在页面的右边栏查看此脚本可输入的任务参数。
## image.png

## 也可在脚本中查看此段代码：
## image.png

### 亦或者点击开始按钮可视化查看支持的任务参数：
## image.png

## JSON配置文件可视化修改
为方便JSON配置文件中参数的修改，我们支持了脚本JSON参数的可视化配置，即可以像全局参数配置一样，修改、导入、导出参数，具体如何打开脚本JSON参数可视化界面操作参考：机构脚本。
## 界面说明
## image.png

### 【搜索】在所有分类中搜索包含指定内容名称的参数
【重新生成】情况json参数文件，重新运行py文件生成新的json参数文件
### 【导入参数】导入json参数文件替换当前文件
### 【导出参数】将当前json参数文件导出到指定路径
【导出脚本】将当前json参数文件对应的py脚本文件导出到指定路径
【翻译】点击后显示【14】弹框，目前支持16种语言，将会翻译【15】部分的参数说明
## 【刷新】刷新当前显示
【图标】仅显示当前json参数文件与控制器中对应的json参数文件是否有差异
### 【重置选中参数】将勾选了的参数值设置为对应默认值
### 【重置所有参数】将全部参数值均设置为对应默认值
### 【拉取】从控制器拉取json参数文件到本地
### 【推送】将当前json参数文件推送到控制器
### 【类别】参数对应类别，无类别默认为other
## 【翻译弹框】支持16种语言翻译
## 【参数说明】对应参数的说明，支持翻译

## 注意：
在可视化某些脚本的Json参数时，会报错找不到包。可以检查是否指到相对路径，参考如下代码：
### import sys  % 导入官方自带的包不需要指定路径
## import os

sys.path.append(os.path.dirname(os.path.abspath(__file__)))
sys.path.append(os.path.dirname(os.path.abspath(__file__)) + "/syspy")

from rbk import BasicModule, ParamServer  % 在导入自定义的包前需要指定路径
### from rbkSim import SimModule
## 参数修改
在“Json参数”界面中，对需要修改的参数后，修改其值即可并推送至控制器即可完成参数修改。
## 脚本调试
### 4.1 运行代码
## 单击“开始”按钮即可运行当前脚本
## image.png

### 没有控制权，就无法下发指令，需要回到“首页”获取控制权

如果脚本和车载控制器中的脚本不一致，则会提示是否推送，确认推送会覆盖车载控制器中的文件并直接运行当前脚本。
### 4.2 变量监控
在红框所指的位置内，会实时地显示当前脚本执行的状态。左侧是“键”，也就是变量的名称；右侧是“值”，即为变量的值。根据对变量的实时监控可以直观地分析当前运行的情况，对故障的分析大有帮助。
## image.png

如果需要添加更多的变量进行观察，可以使用以下语句，具体的可以和负责某个具体项目的工程师沟通。
self.report_info['key'] = name    % key填RoboShop中显示的名字；name填脚本中的变量名
### r.setInfo(str_state)
### 4.3 运行状态与报错
程序执行结果会在红框中显示，脚本状态无论是完成、暂停还是报错都会显示在这个位置。
## image.png

## 任务链和bintask
## 任务链调试
在任务链中添加自定义动作，输入如下代码。将红框内的脚本文件名称换成实际使用的文件名即可。
## image.png

## {
    "operation": "Script",
## "script_args": {
        "checkDi": true,
        "forwardDist": 0.6,
        "liftUpHeight": 0.5,
        "loadMoveHeight": 0.55,
        "loadMoveHeightOn": false,
        "operation": "load",
        "recFile": "plt/p2.plt",
        "recognize": true,
### "startHeight": 0.067
    },
    "script_name": "forkGeneral.py",
## "script_stage": 3
## }

## 字段说明：
operation：任务类型，此处必须填入 "Script"
script_args：脚本任务参数（参考 4.1.2），根据实际脚本和任务需要加入对应字段；
script_name：脚本名称，任务所需执行的脚本名称，此处需注意路径，如脚本放在子目录，需加入上级目录的路径(实际为脚本相对路径)，如下图脚本，需输入的名称为“test/forkGeneral.py”；
script_stage: 脚本任务与路径导航任务的执行顺序；
## 0：路径导航启动前执行脚本
1：路径导航中执行脚本，启动导航后开始执行脚本；
2：路径导航到点后执行脚本；
3：由脚本控制路径导航，即不自动执行路径导航任务，脚本内部实现路径导航。
## image.png

## bintask
### 在完成任务链调试后可以将任务链内容更新到库位中：
## 进入地图编辑状态
## image.png

## 选中库位，并进入库位编辑
## image.png

## 输入动作的键值
## image.png

后续即可在调度系统之执行此binTask任务。
