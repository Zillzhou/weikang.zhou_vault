# 局部地图自动更新

## 局部地图自动更新
## 局部地图自动更新

### ⚠️注意只支持 SRC2000 与 SRC3000
## 1. 【局部地图更新】背景及说明
仙工智能支持 【2D 地图】自动更新功能。
## 1.1 背景
机器人的激光定位依赖于预先建好的地图，建图请参考 单线激光建图 章节。
仙工智能将地图场景中的障碍物分为三类：静态障碍物、动态障碍物以及半静态障碍物。
静态障碍物指在地图中的静态障碍物，比如墙壁、柱子等一系列不会变化的障碍物。
动态障碍物指地图中经常变化的障碍物，如人、叉车等移动的物体。
半静态障碍物指在变化频率不大的障碍物，如箱子、料架等物体。
在激光雷达定位中，静态障碍物越多，定位就越准确，反之动态障碍物越多，定位就越不准确甚至出现丢定位的情况。在AGV的运行场景中，出现最多的是半静态障碍物，仙工智能着重解决该类场景。这就需要不断的对地图进行更新以应对现场复杂多变的场景。
## 1.2 功能说明
【局部地图更新】功能会在当前地图上新开辟一个子区域，该子区域被划分为需要更新的局部地图，称为 MapUpdate 区域。如下图浅紫色区域：
## image1.png

## 地图更新使用原则：
当车辆行驶到 MapUpdate 区域内，此时会开启局部建图。要求进入 MapUpdate 区域时，定位置信度高（ >0.7 ）（如果定位精度达不到要求，可以先建图，拼图，具体操作见 拼接地图 ），进入 MapUpdate 区域中，置信度高的路程越多，局部建图越好，后续定位效果越好。
只有在完成走出 MapUpdate 区域后，建图才会完成，并更新 MapUpdate 区域内局部地图。因此定位效果变化只有在下次路过 MapUpdate 区域（且这段时间 MapUpdate 区域场景未变化）时，才能体现出来。

由于 条例 2. 因素，要求使用该功能时，车辆禁止长时间（ > 2h ，具体时间受控制器性能影响）在同一个 MapUpdate 区域运动。
## 局部地图更新功能限制：
地图区域内只有小范围场景会经常变化，环境标志主体（如墙壁，柱子等）稳定且不易被遮挡。此时可对这些小范围场景画 MapUpdate 区域用于更新。
小范围：可参考当前激光最大视野范围的二分之一左右范围。
建议局部地图布置时，自动更新区域内，机器人行走路径 < 10m 。
【局部地图更新】功能不适用可见环境标志主体过少/没有（如周围堆满货物且货物经常搬运/环境变化大的长走廊等）场景；不建议用于大场景；

tip：目前局部地图更新优先保证贴合原地图，因此对于定位精度低于0.7场景，不会对该部分数据进行建图。
## 此外，使用时需要注意以下几点：
如果是刚建完的地图， MapUpdate 区域内，定位精度大部分高于 0.7 ，可直接在地图上划出 MapUpdate 区域开启地图更新功能；
如果 MapUpdate 区域定位精度低于 0.7 ，需要在待使用 MapUpdate 区域先重新建图进行拼接，然后再设置 MapUpdate 区域开启地图更新功能。
若 MapUpdate 区域定位效果一般（在该区域内有部分场景定位精度低于 0.7 ），此时需要多完成几次（至少 2 次） 进入 MapUpdate 区域，驶离 MapUpdate 区域的步骤，才能实现较好的地图拟合效果。
建议划分 MapUpdate 时，保证单个该区域视野好， MapUpdate 不要存在类似墙壁两侧、墙角处，这类转向后就是视野盲区场得场景。

### 2. 【局部地图更新】使用说明
tip: roboshop v2.4.1.34 及以后的版本支持【局部地图更新】操作，在使用之前先确认 roboshop 版本。
### 2.1  roboshop 界面配置
如下图所示，如果在地图中标出来的红框区域内，存在半静态的物体，比如在摆放着很多箱子，这些箱子并不是一直摆放在这个位置，这种场景下我们可以对该处区域进行地图更新操作。
## image2.png

## 需要在地图上构建定位配置区域：
## 进入车辆控制界面，选中【启用编辑】
## image3.png

选择 1 【区域】按钮，选中【定位配置区域】按钮 2 ，将需要实现局部地图更新的区域圈出，如 3 ；
## image4.png

按照下图，1 选中指针键，2 点击刚画的区域，在右侧区域属性内，勾选 useMapUpdate ，将其设置为true，退出编辑，并【推送地图】。
## image5.png

## image6.png

## image7.png

### 2.2 局部地图更新
## 局部地图区域内地图更新：
当车辆按照正常的导航路线行驶进 MapUpdate 区域内，此时启动局部建图，当agv驶离MapUpdate区域后，结束建图。
## image8.png

在 经过并且驶离 MapUpdate 区域之后，系统会自动判断此次建图的效果并更新至 MapUpdate 区域， 此时 roboshop 界面上并不会显示更新后的地图 ，如果想看到动态更新后的地图，可以通过以下操作。
如下图，车辆已经路过一次局部地图区域，点击车辆，在左侧点击【下载子地图】。
## image9.png

即可在roboshop 界面上显示之前局部地图更新部分，如下图，紫色部分为本次建图中检测到障碍物。
## image10.png

### 2.3 局部地图文件
### 对于当前地图，地图文件的使用详见：2D 建图
局部地图文件最终会保存在和地图同名目录下，子地图的名称与地图配置区域的 ID 相同。树状结构如下图：

## Plaintext
.
├── MAP-xx // 子地图文件夹,和当前使用的地图文件 MAP-xx 同名
│   ├── 12.smap // 子地图文件，对应 ID 为 12 的区域
│   ├── 13.smap //// 子地图文件，对应 ID 为 13 的区域
## │   └── 4.smap
└── MAP-xx.smap //当前使用的地图文件 MAP-xx ，后缀 smap 为地图格式名
### 2.4 删除子地图操作说明
### 当重新配置局部地图区域时，需要删除现有子地图：
对于 roboshop > 2.4.1.166 版本，可参照下图步骤删除子地图：
## image11.png

### 对于更早的版本，需要手动删除子地图，参照如下：
## image12.png

进入 高级配置->设备文件->Robokit Maps；
进入和当前地图同名的文件夹（例如地图名为1107PGV-Big-change.smap，文件夹名为1107PGV-Big-change）；
## image13.png

删除该文件夹下需要删除的smap文件；（如果不清楚是哪一个，也可以全部删除）
至此完成子地图删除操作。

### 3. 局部地图区域效果对比
局部地图区域在更新当前场景的障碍物后，能够提升当前区域的定位精度。
如下图，在LM4站点处，原始地图定位精准度 0.83 ，在经过【局部地图更新】后，定位精准度提升至 0.88 ；
## image14.png

## image15.png

同理，LM3定位精准度由 0.84->0.86 。
## image16.png

## image17.png

### 4. 附录
### 4.1. rbk 的参数配置说明
rbk 3.3.5.66 及以后版本支持局部地图更新功能，使用前请先确认版本是否支持。

## 参数名称

## 参数位置

## 单位

## 默认值

## 最小值

## 最大值

## 支持版本

## lrm StartSlam

## 参数配置-LocalReMap

## —

## true

## \

## \

### 3.3.5.66~latest

## 是否开启局部建图功能

## lrm time gap

## 参数配置-LocalReMap

## s

## 10

## 0

## 99

### 3.3.5.66~latest

## 相同区域连续建图间隔

### lrm save_submap_threshold

## 参数配置-LocalReMap

## m

### 0.15

### 0.0

### 0.5

### 局部地图建图之后的评价标准，一般不需要修改

### lrm use_nav_pose_threshold

## 参数配置-LocalReMap

## s

### 0.7

### 0.0

## 1.0

## 选取定位位姿的距离间隔，一般不需要修改

### lrm use_optimization

## 参数配置-LocalReMap

## —

## true

## \

## \

### 是否启用将定位pose作为图优化单边，一般不需要修改

## lrm max_rang

## 参数配置-LocalReMap

## m

### 20.0

### 0.0

## 150

## 建图时激光最大扫描距离，一般不需要修改

## lrm angle_threshold

## 参数配置-LocalReMap

## °

### 0.5

### 0.0

## 90

### 轨迹对齐时选取建图轨迹的角度阈值，一般不需要修改

### lrm distance_threshold

## 参数配置-LocalReMap

## m

### 0.2

### 0.0

## 90

### 轨迹对齐时选取建图轨迹的距离阈值，一般不需要修改

## lrm use_icp

## 参数配置-LocalReMap

## —

## false

## \

## \

## 轨迹对齐是否使用icp，一般不需要修改

## image18.png

## 其他：
在参数选择上，当 lrm use_optimization 为 false 的时候， lrm distance_threshold 不宜超过0.5，一般使用默认值0.2。

当 lrm use_optimization 为 true 的时候，该值不宜低于 1 ，根据现场更新区域的路径长度设置，该值最大不超过 10 ，最小不小于 1 。
