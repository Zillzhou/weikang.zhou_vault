# 天太驱动器

## 天太驱动器

## 版本

## 更新日期

## 更新说明

## 文档状态

## 维护责任人

## V1.0

### 2024.4.29

## 语雀迁移至飞书

## 使用中

## 一、适用范围
本技术规范适用于公司使用天太驱动器进行自动化改造的研发、生产、调试的技术人员。（ 目前本驱动器不支持SRC2000控制器，其他型号控制器可以使用 ）
### 二、调试资源
## 驱动器相关手册：
## 驱动器说明书

## 驱动器说明书1.3.2v.pdf
## CANopen对象字典

## CANOPEN对象字典1.2v.pdf
## 驱动器配置软件  ：
## TTMotor

## TTMotor0330.zip
## 409版本固件

## GD32DS220409.zip
### 三、改造和安装
### 3.1 类 Kiva 顶升部分 DI 使用规范
### 3.1.1 接线说明
## 顶升部分 DI 使用规范

## 序号

## DI

## 功能

## SRC 线号

## 1

## DI2

## 顶升下限位开关信号

## T23 6 号线

## 2

## DI5

## 顶升上限位开关信号

## T23 7 号线

## 3

## DI6

## 旋转零位信号

## T23 5 号线
注1:在顶升车上这三个 DI 不能作为其他其他用途；
注2：确保这三个传感器的均为 NPN 型，发出的信号能被 SRC核心控制器检测到。
### 3.2 进行改造（底盘驱动器部分）
### 3.2.1 行走电机驱动器安装方式
驱动器需要与车体进行可靠固定，检查驱动器与对应电机的三相线、编码器线路连接正确；
当机器人安装有多个驱动器(数量 ≥2)时，所有从站的 CAN_L,CAN_H引脚直接相连即可，尽量采用串联方式接线，如图3.2.1所示；若驱动器仅提供一个通讯接口，无法完成驱动器的 can线串联时，则将所有驱动器 can 线引出后把所有 can_H压入同一德驰插筒连接器，将所有 can_L 压入同一德驰插筒连接器，接入德驰DT06-2S 公头，最后与 TE35 中的 32、33 号线（can1)相连.
由于部分驱动器没有提供级联接口，只能通过从总线上接引线的的方式来串联，这里引线的长度需小10CM.
注：在改造过程中若由于驱动器连接所需要的线束数量不足，无法实现在驱动器端进行快速串联，可采用图3.2.2 所示连接方式，但不推荐。
1677550955295-d9ea3873-b57e-456a-b921-a64288f21198.png
     图3.2.1                                                                     图3.2.2

为保证 can通讯质量，需要在距离核心控制器最远的驱动器上或总线末端安装终端电阻（阻值一般是 120ohm).（注：客户可在购买驱动器时向驱动器厂商提出购买配套终端电阻）
CAN 终端电阻是否正确打开的检测方法：关机断电，断开驱动器和控制器的 CAN 连接线（如图3.2.1 中 Driver4和控制器之间的位置），使用万用表电阻档测量驱动器侧的 CAN 总线上CAN_L、CAN_H 之间电阻，电阻值为 120Ω则正确，如图3.2.3所示。电阻值明显小于120Ω（如60Ω),则说明至少有两个驱动器打开的终端电阻。
断开图3.2.1 中 Driver1 和 Driver2 之间的连接线，使用万用表电阻档测量Driver1 侧的 CAN 总线上 CAN_L、CAN_H 之间电阻，电阻值为 120Ω则正确，如图3.2.3 所示。如果电阻值明显大于 120Ω（如几KΩ),则说明终端电阻打开的位置不在 CAN 总线末端，需要调整。
1677565670949-cb51f24a-3c74-4b63-b867-12fcba9f0f5b.png
## 图3.2.3

### 四、驱动器参数配置
驱动器类型：电机和驱动器一体。
### 4.1 通过can卡修改电机参数
将usb can盒和天太电机连接（电机接头1是CAN_H,2是CAN_L），如果没有修改过天太电机的配置，则天太电机的驱动器的默认波特率为500kbps，如果500kbps无法连接，可以在usb can toos软件上将波特率改为250kbps尝试再次连接（注意：usb can盒的can通路需要有120欧的电阻）。 
1677565815538-f9c9464a-f842-4bbf-a9e6-e049e252d5b4.png
## 图 4.1.1

当usb can卡和天太电机正常通信后，发送跳转报文，使电机从bootloader状态跳转为App状态，发送报文如下
1677565863415-ee013ef4-459b-4a79-aa7b-3f3749aee209.png 
## 图 4.1.2

该报文Id为电机Id号。
## 返回AA BB认为跳转成功
核验电机ID（行走电机左1，右2，旋转电机的id为3，顶升电机id为4）如果不符合要求需发送以下报文，设置ID，2B 26 20 00 0x 00 00 00（将x换为Id值），如图
1677565939759-13fca07e-3049-4e06-a339-2e7230db5876.png 
## 图 4.1.3

### 注意上图的发送ID为0x600+电机Id号
返回60开头的数据帧，即代表写入成功。
天太电机的ID出厂默认已经按要求分配好，如果没有必要可以不做修改 。
天太驱动器的波特率(天太的驱动器的默认波特率为500kbps，部分已发货的800k的波特率为250kbps，将250kbps波特率改为500kbps的方法见附录)
### 下面为将500kbps 波特率修改为250kbps的方法：
1677565983250-e3008317-2560-4aaf-a8b7-06564132a894.png 
## 图 4.1.4

核验天太驱动器的急停方式，利用can usb tools 发送40 5A 60 00 00 00 00 00 报文：

1677566018095-571cf505-d9f6-4bdc-a23e-9b9a64f083b8.png
## 图 4.1.5

## 02：是急停后掉使能
如果发现上述回包的急停模式不为02,则需要发送以下的报文设置急停方式为02模式：2B 5A 60 00 02 00 00 00
1677566044678-791ba497-8030-4af2-bd78-7fe8d97b7e53.png
## 图 4.1.6

设置看门狗（下图中的数据中的23 16 10 01 E8 03 03 07字段改为23 16 10 01 F4 01 55 00，即设置看门狗触发时间为500ms,看门狗ID为755）
1677566102204-94d980dc-2804-4b2c-8fce-93600725de25.png 
## 图 4.1.7

保存参数：利用can usb tools 发送23 10 10 01 73 61 76 65 报文，将参数改变保存到Flash。
1677566274377-96091484-b4dc-4548-9271-8cb1d3b06e3d.png 
## 图 4.1.8

## 所有设置参数在电机重启后方能生效
### 4.2 通过上位机软件核验电机参数
确定天太上位机的波特率，如果此时波特率为250kbps，请连接can卡，正常通信后（确定CAN通信通道正确（CAN卡只能使用通道一））。

## 确定电机ID正确即可打开通信
1677566347068-696e411a-b239-42bb-b690-214db67b91c3.png
## 图 4.2.2

### 打开上位机软件如下：确定版本为220107
1677566363693-024d4c64-be63-46c5-b932-db2567e559c8.png
## 图 4.2.3

## 确定bootLoader版本号
如上个步骤，连接can盒和电机，在bootLoder状态（即can盒收到的数据为00 00 00 00 00 00 00 00），发送id为电机号（左1，右2，旋转3，顶升4），数据为20 20 的查询帧，确认版本号为CC DD 10 40(从当前版本，天太支持250kbps的波特率).
1677566404362-a81a4433-5288-479c-91ff-a75c58640456.png 
## 图 4.2.4

### 五、模型配置
Roboshop 版本是 2.0.X（固件版本为 1.8.X 及以下），请参考机器人模型图 5.1 所示。Roboshop  版本是 2.1.X（固件版本为 1.9.X 及以上），请参考机器人模型图 5.2 所示。

## Key

## Description

## Value

## Unit

## x

## 驱动器安装的X坐标

## 根据实际安装位置填写

## m

## y

## 驱动器安装的Y坐标

## 根据实际安装位置填写

## m

## yaw

## 驱动器安装的朝向

## 根据实际安装位置填写

## 度

## canID

## 驱动器的的CANID

## 根据驱动器上位机配置决定

## maxRPM

## 驱动器最大转速

## 3000

## RPM

## encoderLine

## 编码器线数

## 根据实际情况填写（4096）

## canPort

## 驱动器使用的端口

## 根据实际情况填写

## brand

## 驱动器品牌

TIANTAI-LVSI-CANOpenPDO/TIANTAI-LVSI-CANOpen

## wheelRadius

## 轮半径

## 根据实际情况填写

## m

## reductionRatio

## 减速比

## 根据实际填写

## image.png
              图 5.1                                               图 5.2

注：减速比、编码器线数、电机最大转速、驱动器品牌需要根据选用的实际填写； 编码器线数可以通过驱动器调试软件查看电机编码器参数配置
### 六、 附录

### 6.1 USB CAN 卡使用方法

## 1.  软件安装---安装软件 USB_CAN Tool（软件及使用手册请联系 CAN卡厂商售后）。

2.  硬件连接---准备 USB CAN 卡和连接线，将连接线 CAN_H 接到 SRC2000外接线束 TE35 33 号线上，将连接线 CAN_L 接到 SRC2000 外接线束 TE35 32号线上。如图 6.1.1 所示。

1677566432168-4ae8b2ad-800a-43a5-a16a-5b947c2cd22c.png
## 图 6.1.1

3. 打开 USB CAN tool ,选择【设备操作（O）】【启动设备（S）】,确认 CAN参数，【波特率】为 250Kbps,选择【CAN 通道号】为通道 1（根据图6.1.1的工具使用那一路can通道，进行此时的选择）,点击【确认】。如图6.1.2 所示：

1677566661317-c98a41b2-3239-4058-a514-02ba8e50b659.png
## 图 6.1.2

### 4. 选择【显示（V）】，取消选择【合并相同 ID 数据(M)】，CAN 报文如图6.1.3 所示。

1677566789159-573b30eb-8af9-4785-b8fa-42c2deaebf91.png
## 图6.1.3

### 6.2 AMB-800k的天太驱动器通讯方式SDO切换为PDO的步骤
### 6.2.1 确认电机固件版本
按照4.2章节的步骤，查询电机的固件版本，如果为220409以下的固件版本，按照6.3章节的操作方法修改电机的固件版本为220409.
修改成功后电机的波特率为500kbps，即此时不需要6.2.2章节的操作步骤将250kbps的波特率改为500kbps。
### 6.2.2 250kbps波特率修改为500kbps
确认电机此时的波特率，模型文件波特率如果为250kbps需要按下文进行修改电机参数，将波特率250kbps修改为500kbps。
1677566812969-42f688e0-3328-4ecf-b78d-022b51c3aecd.png

一：通过can总线，一次修改4个电机参数的方法。
将控制器的can总线（控制器的线束中can接口）和车体的can总线断开连接。
将上面使用的can盒工具连接到车体的can总线上，打开上文提及的usb can Tool软件，如6.1.2,设置波特率为250bps，连接成功后，可以收到四个电机的报文（报文ID分别为0x701,0x702,0x703,0x704）,数据为7F。
1677566829061-fb30a898-67d4-4793-a72d-6c5792146b0d.png

## 图 6.2.1.1
如果收到的数据为00 00 00 00 00 00 00 00则需要按照4.1章节的步骤2所示，发送10 10 进行bootloader和app之间的跳转。
1677566844550-d50cd3b2-d4c9-4e62-b491-646aef454082.png

发送如下报文设置波特率为500kbps，2B 27 20 00 05 02 00 00 ,(发送报文ID需要分别改为0601,0x602,0x603,0x604),和4.1章节的修改电机参数的相关步骤一致。
1677566861817-8cf15858-9618-4668-a4bf-b76d987ce18f.png

## 图 6.2.1.2
保存波特率的参数修改，具体步骤参考4.1章节的第六个步骤（需要修改ID对四个电机分别进行设置）。
1677566911453-cd1a0df6-bc02-49e6-9d28-d31a4b4d9ab4.png

## 图 6.2.1.3
对整车断电重启（尽量断电池的电，避免相关DO有故障，导致电机的供电的通断不受控制器控制），按步骤一设置can usb tool工具的波特率为500k，打开通讯，判断是否可以收到4个电机的报文（下文的ID为0x701,0x702,0x703,0x704）,如果收到即为修改成功，即可将控制器和驱动器的通信线恢复正常。
1677566996820-df08b517-4454-4279-a524-f6e26b4c37b1.png

## 图 6.2.1.4
二： 单独分别对四个电机的波特率进行修改。
将4个电机的can通讯线都与车体的can总线断开，利用can卡分别和4个电机进行连接通讯.
修改波特率，方法和一类似，但是此时只能和一个电机进行通讯，设置波特率的ID根据电机进行选择（左电机ID为0x601,右电机ID为0x602,旋转电机ID为0x603,顶升电机为0x604，即一次连接只需根据电机ID发送一次报文即可）如图6.2.1.2
## 保存参数，如6.2.1.4
确认参数无误即可将控制器和天太电机的通信线恢复正常。
### 6.2.3 修改模型文件如下
## 修改模型文件波特率为500Kbps
1677567013893-645e0a28-d0a2-4314-a4d8-dd68db2c0e4c.png

修改电机品牌（4个电机的名牌均修改为TianTai-LVSI-CANOpenPDO）
1677567037815-d7eb1e20-eb4f-4b87-8808-9b6a4c897c97.png

关机重启即可。
注：如有问题，课参考第七章的FAQ的相关问题。
### 6.3 更改电机固件版本(CAN卡+上位机)
如果已经和控制器进行连接通信，需要断开控制器和天太驱动器的通信，然后关闭电源重启（关闭电池电源），将can盒工具和车体的can总线相连（波特率可有6.2.2的模型文件确认），如果连接不上，请确保电机供电正常，can盒接线无误的情况下修改波特率为500kbps，125kbps，1000kbps进行测试，如果依然连不上，请联系天太驱动器技术人员远程支持。
1677567058367-7a3938a9-74f3-4caa-a622-9876c7c06bcf.png

## 升级固件
1677567077058-45f17d10-be3a-4ec6-b170-8e429a6a8d77.png

1：选择相关固件，2：选择电机ID，3：点击升级（在文件一列出现CRC校验正确字样即升级成功）。若看不到某个电机的通讯，将can盒单独和电机相连，断电重启，再次按如上步骤操作。如果依然连接不上，确定电机的供电正常，CAN卡通讯（默认为250kbps或500kbps，如果通讯失败可通过修改波特率为125k1000k波特率进行测试）正常（通过can usb tool工具可以读到电机的报文）则重启TTMotor软件，依然不行，请联系驱动器厂商，提供远程支持。
### 2 . 如果升级的固件版本为409，需要单独为4个电机导入一份参数。
1677567094942-2ad2d33c-f63b-48c1-832d-2ac0c3d1883a.png

注：电机参数在409固件版本的压缩包里，根据不同的电机ID选择不同的参数文档。
保存参数的按钮需要一定的保存时间，不要多次点击，保存参数点击后为不可电机的灰色状态，待再次可点击即写入成功。
若出现升级的进度卡住，需要整车断电重启，单独将can盒和相关电机连接，重新升级即可。如果发生多次卡住情况，请联系天太驱动器获取远程支持。
### 【同步帧超时系数】需要改成1，否则会出现掉线不受控的情况
1709296567060-0dc229a1-4ad9-4e49-a1e8-e1f68325b5e9.png

### 6.4 更改电机固件版本(脚本)
## 脚本： 📎send.zip
### 用网线连接控制器，双击打开MobaXterm创建好的SSH
1680155592706-501bce0e-0a0f-45fb-a304-7e4837a596a6.png

## 把程序和固件拖入左侧文件框
1680155621108-3c26fe03-b4bd-40e6-a185-043f2d80e60a.png

## 执行如下指令后， 断电 重启
sudo systemctl disable startup_robod.service
sudo systemctl disable startup_rbk.service
### sudo mount -n -o remount,rw /
### sudo umount /dev/mmcblk0p3
sudo systemctl disable startup_robod.service
sudo systemctl disable startup_rbk.service
### 重启后确保，电机正常带电，ssh登陆，执行如下指令
## sudo chmod +x send
### sudo ./send 文件名 驱动器编号
1680155810560-dc8f453a-6a20-4314-8688-2c60574880a2.png

## 读取文件时命令行窗口会有指令闪烁
1680155847722-49bfd972-4bca-4783-aa9c-b884d945fe6e.png

## 结束后，升级下一个电机
### sudo ./send 文件名 驱动器编号2
## 恢复rbk和robod
sudo systemctl enable startup_robod.service
sudo systemctl enable startup_rbk.service
### sudo mount -n -o remount,rw /
### sudo umount /dev/mmcblk0p3
sudo systemctl enable startup_robod.service
sudo systemctl enable startup_rbk.service
### 断电重启，在roboshop界面可以看到升级后的版本
1680155926674-87d3dfa7-ad28-4c99-9ef9-9d02c66cb87e.png

### 七、FAQ

## 1、这款驱动器只支持协议急停， 所以模型文件需要配成协议急停
1677567117823-30fd2303-f221-40c0-a78c-7e627c3a4060.png

以上电机参数确认写入无误，但是电机的状态不正常，此时需要进行8325电机学习，如果电机学习失败，需要利用驱动器在线升级工具，先升级为老版本固件（可以联系天太获取响应的固件或者从本文档给出的链接下载），进行8325电机学习，学习成功之后，在刷回当前使用版本的固件（如果过程失败，请联系天太电机技术人员获取技术支持）。
修改波特率后只有部分电机可以按照修改后的波特率（500kbps）进行通信（有回包）
将没有回包的电机与总线断开，利用can卡单独接该电机，设置can usb tool工具的波特率为250kbps，500kbps，125kbps，1000kbps分别连接，查看是否可以通信成功。如若通信成功，则按照6.2.1章节修改波特率为500kbps。
恢复驱动器默认参数,需要和电机正常通信成功。
1677567141610-440511d8-5fe6-402a-9a4c-d0308f718d50.png

即根据电机的ID发送如下报文，23 01 20 00 0x 00 00 00和23 11 10 01 6C 6F 61 64 (0x为电机的id)
天太上位机软件TTMotor只能使用can盒上的通道一。
如果使用天太驱动器上位机软件TTMotor出现连续发送失败，插拔can盒和电脑的USB连接线，关闭重开TTMotor软件，和修改连接的波特率多次尝试。如果仍然不行，请联系天太驱动器相关人员提供远程支持。
加速、减速时间含义， 默认是1500ms，另外100ms和10ms测试都达不到效果，受电机电流限制（ 测试记录 ） 
1695086267482-7d53d87c-7e6b-482c-a7b5-f19a3f4686de.png

### 八、驱动器常见错误码

1677567164478-4e9010df-f57d-4d8d-bb2d-da3c0100911a.png

1677567186535-af309820-8429-4864-9943-11782a822987.png
