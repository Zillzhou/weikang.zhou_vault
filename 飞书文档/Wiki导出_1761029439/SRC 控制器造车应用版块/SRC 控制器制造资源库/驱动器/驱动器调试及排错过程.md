# 驱动器调试及排错过程

## 驱动器调试及排错过程

## 版本

## 更新日期

## 更新说明

## 文档状态

## 维护责任人

## V1.0

### 2024.4.15

## 语雀迁移至飞书

## 使用中

## 1. CAN通讯负荷计算
## can 负载推荐表 //补充计算方式
### 单路can---波特率250kpbs---4个
### 单路can---波特率500kpbs---8个
### 2. 控制器和驱动器接线方法（杨振）
在做机器人机械和电气设计时，请保留足够的空间方便接线改造；
功率线缆和控制线缆不要走线距离保持5cm以上，所以不要走在同一个走线槽内；
## CAN总线现场布线说明与指导
### 2.1 CAN总线接线方法
当机器人安装有多个驱动器(数量 ≥2)时，所有从站的 CAN_L , CAN_H 引脚直接相连即可，采用串联方式接线
1709529849418-c060e3c7-0a30-4577-a2a1-e42e5133b013.png

### 接线与模型文件配置的【canPort】保持一致
1709529977552-61c0fe22-36fa-46cf-a999-56510ae6f403.png

### 2.1.1 SRC-2000
1709529737130-47a1c916-7512-4c30-a5c0-a1ac88b0bbd3.png

### 2.1.2 SRC-880
1709530095193-6a3a020f-0076-4171-8680-00b7180b725d.png

### 2.1.3 SRC-3000
1709531460373-02917939-96c8-4c5b-9ef6-ebef9aaa061f.png

### 2.1.4 如何配置终端电阻和确认终端电阻配置是否正确
为保证 can 通讯质量，需要将距离核心控制器最远的驱动器上的 120Ω 终端电阻打开，如上图 4 中将 Driver1 驱动器上终端电阻通过拨盘打开；其他 Driver2,3,4 的终端电阻关闭，打开时终端电阻开关如图 6 所示；
## 终端电阻是否正确打开的检测方法：
关机断电，断开驱动器和控制器的 CAN 连接线（如图 4 中 Driver4 和控制器之间的位置），使用万用表电阻档测量驱动器侧的 CAN 总线上 CAN_L,CAN_H 之间电阻，电阻值为 120Ω 则正确，如图7 所示。电阻值明显小于 120Ω （如 60Ω），则说明至少有两个驱动器打开的终端电阻。
断开图 4 中 Driver1 和 Driver2 之间的连接线，使用万用表电阻档测量 Driver1 侧的 CAN 总线上 CAN_L , CAN_H 之间电阻，电阻值为 120Ω 则正确，如图7所示。如果电阻值明显大于 120Ω （如几 KΩ)，则说明终端电阻打开的位置不在 CAN 总线末端，需要调整。
控制器侧的CAN终端电阻由软件控制，因此不可测。没开机时，终端电阻未接入，开机后配置了终端电阻了，因为CAN总线带电，万用表也会测不准电阻。
### 2.1.5 CAN对应的GND如何接
如果总线上两方都有CAN地，请将CAN地接在一起，如果有一方没有CAN地，将CAN地和电源地接在一起。如果两方都没有CAN地，可以不接。

### 2.2 急停接线方法及配置
### 驱动器的急停线需接到控制器端提供的干节点
### 例如：SRC2000上步科驱动器的急停接线
1709531651454-1dd60380-600e-4a3e-a897-f42c91e10bb1.png

### 2.2.1 SRC2000
## //补充另一路急停
1709531045801-1c379735-11dd-4987-aa92-c17595d7b832.png

### 2.2.2 SRC880
1709531204625-685bc9f5-b591-4069-a63b-44c862f07078.png

### 2.2.3 SRC3000
3000的安全车急停接线方式比较负责，需根据车型和安全固件配合
### 2.3 抱闸接线方法及注意事项
抱闸由驱动器控制，所以抱闸线需接到驱动器上，具体抱闸接线方式需查看对应的驱动器手册
### 3. 驱动器软件配置和驱动器模型文件配置
### 3.1 上位机软件连接驱动器
### 3.2 配置电机参数，驱动器参数初始化
### 3.3 配置CAN通讯参数
CAN ID配置：一般通过拨码开关来配置；
## CAN波特率配置：
## CAN通讯看门狗参数：
### 3.4 配置急停方式
### 3.5 配置驱动器工作模式
## 速度模式
## 位置模式
## 和位置模式相关的配置
### 3.6 驱动器其他配置
### 3.7 模型文件配置
因为不同品牌的驱动器配置方法不同，本章内容请参考具体的驱动器配置文档

### 4. 控制器常见和驱动器相关的报错
## //rbk报错码
## 52111：
## 驱动器通讯超时，一般和以下因素有关：
## 接线与终端电阻
## 有没有供电
## 驱动器配置（波特率，CAN ID）
## 模型配置（端口，波特率，CAN ID）
## 模型配置（驱动器品牌）

### 问：没有报错，但驱动器不响应一般和什么有关
答：和模型文件里驱动器品牌配置相关，有些驱动器的报文非常接近，导致能通讯上，但驱动器不执行

### 5. 驱动器常见报错
## //驱动器报错处理方法
## Xxx
## Xxx

## 报错

## 可能原因

## 过流

## 检查驱动器供电
电机UVW相与PE线连接错误，影响驱动器硬件电路导致总线电压升高，检查接线，正确连接动力端。
## 驱动器硬件故障，更换驱动器

## 过压/低压

## 过温

## 检查电机以及驱动器功率是否满足要求
核查驱动器散热风扇是否能正常开启，散热口是否堵塞，电气柜内做好散热措施。
上电就出现该报警且无法复位一般是驱动器内部功率电路损坏，可更换驱动器。

## 重载/过载

## 驱动器行程被卡
## 驱动器功率不足
正确连接抱闸线，检查抱闸电源是否满足要求，确保电机抱闸正常打开。
如果是空载的抱闸电机可尝试抱闸外接DC24V电源保持打开状态，用手转动电机轴是否有卡滞，不带抱闸的电机同理，断开与驱动器的连接，用手转动电机轴检查是否有卡滞。出现卡滞的现象请更换电机。

## 编码器报错

根据选型手册检查连接的编码器线型号是否正确，根据信号引脚定义检查接线顺序是否正确，用万用表测量编码器线缆两端引脚是否导通；
检查编码器线连接是否松动，重新安装编码器连接端。
编码器线坏或电机编码器损坏，交叉比对核查。
若编码器线非原厂配线，还需要注意是否做好屏蔽处理。
### 6. 通讯超时如何排查
## //增加典型案例

## 常见原因

## 可能原因

## CAN 通讯线接错

## 通讯线与模型文件的端口选择不同
## 通讯线接反

## 驱动器掉电

## 检查驱动器供电

## 模型文件配错

## canID 配错
## 波特率配错
## 驱动器 brand 配错

## //驱动器执行异常情况：
## 抓报文

### 7. CAN通讯误码率高如何排查
需要使用CAN Scope查看误码率，具体使用方法参照 《致远 CAN Scope 使用方法》 
## 检查走线是否存在干扰（电磁干扰）
## 检查CAN通讯线是否为双绞线
### 检查是否接了终端电阻，参照 2.1.4 章节
## 增加can隔离器
## （can地）
## （叉车：步科放在1253中间）
### 8. 驱动器的安全问题（张文珽）
驱动器的安全是机器人的核心安全，不管是安全型机器人还是非安全型机器人，都要特别关注驱动器的安全，我们针对这个问题有四种方案，安全等级由高到低如下：
### 8.1 STO安全功能
STO（safety Torque Off）是安全扭力关断，这是功能安全型控制器的一个基本功能，是安全机制触发后，由安全控制器发出STO信号，安全型驱动器接收到STO信号，将驱动器的功率输出关断。STO由两个相同逻辑的信号构成，在安全控制器内是两个DO，高电平代表不触发，低电平代表触发，如何一个信号变低都会触发STO。安全控制器接安全驱动器示意图如下。
### 企业微信截图_17113495126131.png

支持STO的驱动器内部接口如下。SF+是STO输入，SF-是公共接地端。EDM是监控STO执行的反馈。
### 企业微信截图_17113716517715.png

### 8.2 IO急停
当控制器不支持功能安全时，驱动器的安全还不可轻视，一个比较好的做法是通过外部IO来控制驱动器急停。
我们的控制器一直支持急停输出功能，这个是由一个到两个无源开关构成，接到驱动器的DI接口，DI的功能被配成了急停，无源开关逻辑上常闭，当断开时触发驱动器急停。
驱动器的急停一般有NPN和PNP两种接法，如下图，图中的开关就是我们的急停输出无源开关。这个开关的过流能力为120mA。
### 企业微信截图_17113727313486.png

### 8.3 断电急停
不是很常用，但也是一种方式，

### 8.4 协议急停
有些驱动器没有IO急停功能，这样只能通过CAN协议急停。但如果CAN通讯出现异常，急停的指令很可能无法正常传达。这个也是为什么IO急停的安全性远高于协议急停的原因。
为了提高协议急停的安全性，一定要有看门狗或者心跳机制，两者同时支持更好。心跳一般是驱动器定时发给控制器的特定报文。如果心跳停了，可能是驱动器异常了，控制器可以控制给驱动器断电。看门狗一般是控制器定时发给驱动器的特定报文，如果喂狗停了，有可能是控制器异常了，驱动器主动停止运转。
不管看门狗还是心跳机制，都是基于一定的超时逻辑的，所以触发急停都有一定的时延，安全性还是偏低。

## 顺口溜：
CAN ID，波特率，驱动器品牌对对齐。
菊花链双绞线，一进一出好整理。
CAN高对CAN高， CAN低对CAN低。
终端电阻配两头，信号质量有可依。
CAN隔离，需接地，不隔离，也接地。

先选电机型号初始化，再配心跳保安全。
IO急停是必选，安全上档次。
行走配速度，转向配位置。
IO回零太复杂，优选绝对值。
恢复出厂设置、多保存，配完不忘再确认。

配完驱动，配模型。
编码器，减速比，轮径等于几。
要有一手数据，别估计。
逐个单电机，一步一步再落地。

机械、零位很微妙。
手动直线先确认。
走正走歪细观察。
标定非万能，不做标定更不准。
