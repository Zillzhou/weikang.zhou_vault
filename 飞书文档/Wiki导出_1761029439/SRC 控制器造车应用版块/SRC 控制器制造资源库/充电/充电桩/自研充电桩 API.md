# 自研充电桩 API

## 自研充电桩 API

## 版本

## 更新日期

## 更新说明

## 文档状态

## 维护责任人

## V1.0

### 2024.4.30

## 语雀迁移至飞书

## 使用中

## V1.1

### 2025.4.2

### 修改协议端口后和适用场景以及范围@吕义甫更新

## 使用中

## V1.2

### 2025.5.21

## 增加notice和各告警码生效清除定义

## 使用中

## Modbus API
## 1. 概述

充电桩的 Modbus TCP 服务通过内网 IP (192.168.192.5) 和外网 IP 均可使用。网络端口采用标准 Modbus 端口 503。运行时，外部设备作为主设备（master），充电桩为从属设备（slave）进行通讯。外部设备负责从充电桩上拉取数据。

### 2. 地址位
### 2.1 只读状态量[1x] Discrete inputs

## 地址位

## 功能

## 说明

## 00001

## 是否有急停

### 0 = 无， 1= 有（报Eroor，调用0x11，置1，拔起后置0）

## 00002

## 温度保护是否触发

## 0 = 无，1 = 有

## 00008

## 是否有 Fatal

## 0 = 无，1 = 有

## 00009

## 是否有 Error

## 0 = 无，1 = 有

## 00010

## 是否有 Warning

## 0 = 无，1 = 有

## 00030

## DI0

## 0 = 低电平，1 = 高电平

## 00031

## DI1

## 0 = 低电平，1 = 高电平

## 00032

## DI2

## 0 = 低电平，1 = 高电平

## 00033

## DI3

## 0 = 低电平，1 = 高电平

## 00034

## DI4

## 0 = 低电平，1 = 高电平

## 00035

## DI5

## 0 = 低电平，1 = 高电平

## 00036

## DI6

## 0 = 低电平，1 = 高电平

## 00037

## DI7

## 0 = 低电平，1 = 高电平

## 00038

## DI8

## 0 = 低电平，1 = 高电平

## 00039

## DI9

## 0 = 低电平，1 = 高电平

## 00040

## DI10

## 0 = 低电平，1 = 高电平

## 00041

## DI11

## 0 = 低电平，1 = 高电平

## 00042

## DI12

## 0 = 低电平，1 = 高电平

## 00043

## DI13

## 0 = 低电平，1 = 高电平

## 00044

## DI14

## 0 = 低电平，1 = 高电平

## 00045

## DI15

## 0 = 低电平，1 = 高电平

## 00050

## DO0

## 0 = 低电平，1 = 高电平

## 00051

## DO1

## 0 = 低电平，1 = 高电平

## 00052

## DO2

## 0 = 低电平，1 = 高电平

## 00053

## DO3

## 0 = 低电平，1 = 高电平

## 00054

## DO4

## 0 = 低电平，1 = 高电平

## 00055

## DO5

## 0 = 低电平，1 = 高电平

## 00056

## DO6

## 0 = 低电平，1 = 高电平

## 00057

## DO7

## 0 = 低电平，1 = 高电平

## 00058

## DO8

## 0 = 低电平，1 = 高电平

## 00059

## DO9

## 0 = 低电平，1 = 高电平

## 00060

## DO10

## 0 = 低电平，1 = 高电平

## 00061

## DO11

## 0 = 低电平，1 = 高电平

## 00062

## DO12

## 0 = 低电平，1 = 高电平

## 00063

## DO13

## 0 = 低电平，1 = 高电平

## 00064

## DO14

## 0 = 低电平，1 = 高电平

## 00065

## DO15

## 0 = 低电平，1 = 高电平

### 2.2 可读写状态量[0x] Coils

## 地址位

## 功能

## 说明

## 00001

## 自动模式

## 0 = 取消自动 1 = 置为自动

## 00002

## 手动模式

### 0 = 取消手动 1 = 置为手动（置为1时自动将0x1置为0）

## 00010

## 启动

### 1 = 刷板伸出，启动充电，调用取消或取消手动模式置0

## 00011

## 取消

## 1 = 刷板缩回，取消充电，回弹置0

## 00012

## 手充

### 1 = 充电线接口输出充电，调用取消或取消手动模式置0

## 00021

## 清除所有错误

## 1 = 清除，回弹置0

## 00030

## DO0置为低电平

写入 1 后即可置 DO 0 为 低电平，机器人收到后会将该地址改为 0，具体的 DO 状态请查询只读状态量

## 00031

## DO1置为低电平

## 同上

## 00032

## DO2置为低电平

## 同上

## 00033

## DO3置为低电平

## 同上

## 00034

## DO4置为低电平

## 同上

## 00035

## DO5置为低电平

## 同上

## 00036

## DO6置为低电平

## 同上

## 00037

## DO7置为低电平

## 同上

## 00038

## DO8置为低电平

## 同上

## 00039

## DO9置为低电平

## 同上

## 00040

## DO10置为低电平

## 同上

## 00041

## DO11置为低电平

## 同上

## 00042

## DO12置为低电平

## 同上

## 00043

## DO13置为低电平

## 同上

## 00044

## DO14置为低电平

## 同上

## 00045

## DO15置为低电平

## 同上

## 00050

## DO0置为高电平

写入 1 后即可置 DO 0 为 高电平，机器人收到后会将该地址改为 0，具体的 DO 状态请查询只读状态量

## 00051

## DO1置为高电平

## 同上

## 00052

## DO2置为高电平

## 同上

## 00053

## DO3置为高电平

## 同上

## 00054

## DO4置为高电平

## 同上

## 00055

## DO5置为高电平

## 同上

## 00056

## DO6置为高电平

## 同上

## 00057

## DO7置为高电平

## 同上

## 00058

## DO8置为高电平

## 同上

## 00059

## DO9置为高电平

## 同上

## 00060

## DO10置为高电平

## 同上

## 00061

## DO11置为高电平

## 同上

## 00062

## DO12置为高电平

## 同上

## 00063

## DO13置为高电平

## 同上

## 00064

## DO14置为高电平

## 同上

## 00065

## DO15置为高电平

## 同上

### 2.3 只读寄存器[3x] Input registers

## 地址位

## 功能

## 说明

## 00005

## 当前控制模式

## 0 = 自动，1= 手动，2 = 无

## 00010

## 充电桩运行状态

## 0=待机，１=正常运行，2=异常

## 00011

## 刷板伸缩状态

## 0=缩回到位，1=运动中，2=伸出到位

## 00012

## 状态机序号

0=未连接，1=升大恒流，2=升小恒流，3=大恒流，4=降大恒流，5=小恒流，6=恒压，7=满电压，8=极片伸出，9=极片缩回，10=协议充电

## 00015，16

## 充电桩温度

## 单位:℃（数据类型：float32）

## 00017

## 刷板实时长度

## 单位:mm

## 00018，19

## 控制器检测电压

## 单位：V（数据类型：float32）

## 00021，22

## 充电桩输出的实时电压

## 单位: V（数据类型：float32）

## 00023，24

## 充电桩输出的实时电流

## 单位: A（数据类型：float32）

## 00025

## DI数量

## DI配置数量

## 00026

## DO数量

## DO配置数量

## 00031

## 机器人电池电量

### 范围 (0, 100]（自动模式下显示）

## 00032，33

## 机器人电池温度

### 单位: ℃（自动模式下显示）（数据类型：float32）

## 00034，35

## 机器人电池电压

### 单位: V（自动模式下显示）（数据类型：float32）

## 00036，37

## 机器人电池电流

### 单位: A（自动模式下显示）（数据类型：float32）

## 00038

## 已充电量

## 机器人电池本次已充容量, 单位: AH

## 00039

## 充电耗时

## 机器人本次充电耗时, 单位: min

## 00040

## 机器人IP 1

IP 地址第一部分（如 192.168.1.2 中的 192）

## 00041

## 机器人IP 2

IP 地址第一部分（如 192.168.1.2 中的 168）

## 00042

## 机器人IP 3

### IP 地址第一部分（如 192.168.1.2 中的 1）

## 00043

## 机器人IP 4

### IP 地址第一部分（如 192.168.1.2 中的 2）

## 00050

## 控制器系统时间

### 年：如2023（数据类型：uint16）

## 00051

## 控制器系统时间

## 月：如08（数据类型：uint16）

## 00052

## 控制器系统时间

## 日：如29（数据类型：uint16）

## 00053

## 控制器系统时间

## 时：如14（数据类型：uint16）

## 00054

## 控制器系统时间

## 分：如56（数据类型：uint16）

## 00055

## 控制器系统时间

## 秒：如60（数据类型：uint16）

## 00060，61

## 充电模块检测电压

## 单位：V（数据类型：float32）

## 00062，63

## 充电模块温度

## 单位：℃（数据类型：float32）

## 00070

## IP 1

IP 地址第一部分（如 192.168.1.2 中的 192）

## 00071

## IP 2

IP 地址第二部分（如 192.168.1.2 中的 168）

## 00072

## IP 3

### IP 地址第三部分（如 192.168.1.2 中的 1）

## 00073

## IP 4

### IP 地址第四部分（如 192.168.1.2 中的 2）

## 00080

## V 1

## 版本号第 1 部分

## 00081

## V 2

## 版本号第 2 部分

## 00082

## V 3

## 版本号第 3 部分

## 00083

## V 4

## 版本号第 4 部分

## 00090,00091.00092

## warning警告集合

仅 warning 码集合, 0 表示无 warning，如果有多个 warning，则显示前 3个

### 00095,00096,00097,00098,00099

## Error 错误码集合

仅 Error 码集合, 0 表示无 Error，如果有多个 Error，则显示前 5 个

### 2.4 可读写寄存器[4x] Holding registers

## 地址位

## 功能

## 说明

## 00011

## 刷板伸缩长度

## 单位: mm

## 00012

## 刷板执行超时

## 单位: s

## 00021，22

## 设置最大充电电压

### 设置最大充电电压（数据类型：float32）

## 00023，24

## 设置最大充电电流

### 设置最大充电电压（数据类型：float32）

## 00025

## 设置手动充电充电时间

## 单位: min

## 00030，31

## 设置充电过压

### 设置充电过压参数（数据类型：float32）

## 00032，33

## 设置充电过流

### 设置充电过流参数（数据类型：float32）

## 00036，37

## 设置停止电流

### 设置停止充电电流（数据类型：float32）

## Tcp API
## 概述
## 工作方式
## 1.小车链接上充电机后，小车 SRC 控制器会向充电桩 SRC 控制器发送报文（端口：20204，序号为：1001），从而获取充电桩的运行状态；
2.小车固定间隔时间 1S 发送报文（端口：20207 序号：1000）到充电机，充电机接收到信息以后根据报文数据设置来工作参数。如果5s 收不到报文，则进入通信错误状态，关闭输出。
### 3.该接口内容发送和响应规则，复合仙工 SRC 控制器提供的标准 TCP/IP 协议格式。
### 4.该方式需要充电桩上安装有 SRC 880充电桩版本的控制器才可以正常提供如下协议。

## AMR 车体 SRC 控制器用 API
 Status API （端口：20204 报文类型：1001 ，请求内容为空，下述json 为响应内容）

## {
    "state":0,        // 运行状态，0待机，1运行，2错误
## "output": {
### "current": 0, // 输出电流 A
### "voltage": 0, // 输出电压 V
### "max_current": 0, //最大充电电流A
### "max_voltage": 0, //最大充电电压V
        "auto_full":0.0 //充满电量阈值（单车充电时使用该值判断）
    },
## "status": {
### "is_manual":false, //是否是手动状态
### "is_auto":false, //是否自动状态
### "time_t":0, // 本次充电时长，单位min
### "temp":0,  // 充电桩温度，单位°
        "charging":0, // 0收缩到位， 1运动中，2伸出到位
        "sheet_position":0, //极片伸出长度，单位mm
        "is_push_di_tirggered":false, //极片伸出di是否触发
        "is_back_di_tirggered":false, //极片缩回di是否触发
### "is_emc":false, //是否急停
        "state_machine":1, //状态机序号 ：0未连接，1升大恒流，2升小恒流，3大恒流，4降大恒流，5小恒流，6恒压，7满电压，8极片伸出，9极片缩回
        "adc_battery_voltage":24.0 //极片检测电压，单位V
    },
## "alarms":{
## "errors":[
## {
### "code": 55001, // 报警代码
### "desc": " ",    // 信息
## "times": 1,   // 次数
### "timestamp": 1635391533
## }
## ]
## }
## }

Control API（端口：20207 报文类型：1000，请求内容为 下述的 json 内容）
## {
## "input":{
### "is_auto":false,//自动充电任务
    "charging_types":stateCharging,//自动状态指定充电模式(protocolCharging,stateCharging)，模型默认参数stateCharging
    "max_charge_voltage":0, 　// 机器人电池需求电压，模型默认参数60v，单位 V
    "max_charge_current":0, 　// 机器人电池需求电流，模型默认参数150A，单位 A
    },
## "status": {
    "battery_percent":0, // 小车电池电量
### "battery_temp":0,  // 小车电池温度
    "battery_current":0,       // 小车电池电流
    "battery_voltage":0,        // 小车电池电压
    "battery_full_percent":0,    //小车电池的充满电量（从模型文件的battery的basic.fullPercentage）
### "switchDO":false;//车体继电器状态
## }
## }

Roboshop 用  API （用于 robohop 获取充电状状态以及对充电桩进行动作）
status API (端口：19204  报文类型：1100 请求内容为空，下述为返回响应示例）

## {
## "alarms": {
## "errors": []
        },
## "cmd": {
                "battery_current": 0.0,
                "battery_percent": 0.0,
                "battery_temp": 0.0,
                "battery_voltage": 0.0,
                "clear_err": false,
                "is_auto": false,
                "charging_types":stateCharging
                "is_manual": false,
                "manual_cancel": false,
                "manual_current": 0.0,
                "manual_force_ouput": false,
                "manual_sheet_output": false,
                "manual_time": 60.0,
                "manual_voltage": 0.0,
                "max_charge_current": 0.0,
                "max_charge_voltage": 0.0,
                "sheet_push_position": 100.0,
                "sheet_push_timeout_threshold": 15.0
        },
        "create_on": "2021-12-16T16:57:50.463Z",
        "current_map": "",
        "current_map_md5": "",
        "model_md5": "9983f727bd0cc4354661452bfd806a77",
## "motor": {
                "encoder_cnt": 1,
                "err_code": 0,
                "is_disable": false,
                "is_error": false,
                "is_timeout": false,
## "position": 0.0
        },
## "output": {
                "current": 0.0,
                "max_current": 0.0,
                "max_voltage": 0.0,
## "voltage": 0.0
        },
        "ret_code": 0,
        "state": 0,
## "status": {
                "adc_battery_voltage": 6.0,
                "charging": 0,
                "is_auto": false,
                "is_back_di_triggered": true,
                "is_emc": false,
                "is_manual": false,
                "is_push_di_triggered": false,
                "sheet_position": 0.0,
                "state_machine": 0,
                "temp": 43.915,
## "time_t": 0.0
## }
## }
 Control API (端口：19204 报文类型：1000，请求内容如下）实际举例如下
## {
        "architecture": "arm64",
        "create_on": "2021-12-20T10:50:14.071Z",
        "current_map": "",
        "current_map_md5": "",
        "dsp_version": "Charger",
        "echoid": "e4d6f725-646aafcf-89b1809f-a6677de6",
        "echoid_type": "0x2",
## "features": [{
                "active": true,
                "expiry_date": "never-expire",
## "name": "rbk_diff"
## }, {
                "active": false,
## "name": "rbk_omni"
## }, {
                "active": false,
## "name": "rbk_steer"
## }, {
                "active": false,
### "name": "rbk_multisteer"
## }, {
                "active": false,
### "name": "rbk_dualdiff"
## }, {
                "active": false,
## "name": "rbk_rgv"
## }, {
                "active": false,
## "name": "rbk_fork"
## }, {
                "active": false,
### "name": "rbk_pallet"
## }, {
                "active": true,
                "expiry_date": "never-expire",
### "name": "rbk_pgv_loc"
## }, {
                "active": true,
                "expiry_date": "never-expire",
### "name": "rbk_pgv_nav"
## }, {
                "active": false,
## "name": "rbk_spin"
## }, {
                "active": false,
### "name": "rbk_reflector"
## }, {
                "active": false,
### "name": "rbk_3dcamera"
## }, {
                "active": false,
### "name": "rbk_dynamic_nav"
## }, {
                "active": true,
                "expiry_date": "never-expire",
### "name": "rbk_roaming"
## }, {
                "active": true,
                "expiry_date": "never-expire",
### "name": "rbk_script"
## }, {
                "active": true,
                "expiry_date": "never-expire",
### "name": "rbk_laser_loc"
## }, {
                "active": false,
### "name": "rbk_charger"
        }],
        "gyro_version": "Charger",
        "id": "6789174",
        "model": "AMB-150",
        "model_md5": "9983f727bd0cc4354661452bfd806a77",
        "product": "Charger",
        "ret_code": 0,
        "roboshop_min_version_required": "v2.3.2.6",
        "robot_note": "Charger",
        "vehicle_id": "Charger",
### "version": "0.0.1.0"
## }

## notice（通知）
## 5701 - 停止电流生效，充电完成
生效条件：手动充电且进入充电状态60S以后，输出电流逐步低于停止电流
### 清除条件：手动清除、60S后自动清除或被其他信息覆盖清除

## warning（警告）
## 5401 - PFC过温降额
### 生效条件：读取充电模块上报PFC过温信号
### 清除条件：手动清除、60S后自动清除或被其他信息覆盖

## 5402 - 风扇故障降额
## 生效条件：读取充电模块上报风扇故障降额
### 清除条件：手动清除、60S后自动清除或被其他信息覆盖

## 5403 - 高温降额
## 生效条件：读取充电模块上报高温降额
### 清除条件：手动清除、60S后自动清除或被其他信息覆盖

## 5404 - 手动充电任务超时
生效条件：接收到手动充电任务，但超过该参数还未进入充电状态时上报
### 清除条件：手动清除、60S后自动清除或被其他信息覆盖

## 5405 - 手自动不能同时存在
### 生效条件：手动充电任务时，接收到自动充电指令时上报
### 清除条件：手动清除、60S后自动清除或被其他信息覆盖

## 5406 - 电池异常断开
生效条件：在进行充电任务且输出电流大于8A以上时，在1S内突然降低至2A以下时上报
### 清除条件：手动清除、60S后自动清除或被其他信息覆盖

## 5407 - charger功能未激活
### 功能影响：HMI无法控制手动充电，无法接收自动充电指令
### 生效条件：激活文件中的charger功能未被激活时上报
### 清除条件：charger功能激活时自动清除

## 5408 - 过温降额
生效条件：运行状态中接收到过温信号时间超过1S（3分钟以内只触发一次）
## 功能影响：当前输出电流降低一半
### 清除条件：手动清除、60S后自动清除或被其他信息覆盖

## ERROR（错误）
### 5201 - TCP通信超时   （取消任务）
生效条件：自动充电中车体下发充电任务间断时间超过TCP通讯超时时间
### 清除条件：手动清除error或接受到新的充电任务

### 5202 - 刷版未配置DI   （取消任务）
### 生效条件：模型文件中配置了驱动器，但未配置任意极片DI
### 清除条件：模型文件未配置驱动器，或配置任意极片DI

### 5203 - 未触碰极片超时   （取消任务）
生效条件：模型文件配置了驱动器，且在极片伸出至最大距离3次后都未触发极片DI信号
### 清除条件：手动清除error或接收到新的充电任务

### 5205 - 急停   （按下取消任务,电机停止不动，拔起电机缩回）
## 生效条件：按下急停按钮或接收到急停信号
## 清除条件：拔起急停按钮或未收到急停信号

### 5206 - 电机通信超时   （取消任务，电机停止工作）
生效条件：模型文件中配置了驱动器，且超过3S未收到驱动器的数据通讯
## 清除条件：驱动器恢复数据通讯

### 5207 - 充电模块通信超时   （取消任务）
生效条件：模型文件中配置了充电模块，且超过3S未收到充电模块的数据通讯；
清除条件：充电模块恢复数据通讯；
排查方法：通过控制器进入SSH读取CAN1的CAN数据，有则是配置问题，无则是硬件问题；

## 5208 - 过压   （取消任务）
### 生效条件：运行状态中输出电压超过充电过压阈值时间超过1S
### 清除条件：手动清除error或接收到新的充电任务

## 5209 - 过流   （取消任务）
### 生效条件：运行状态中输出电流超过充电过流阈值时间超过1S
### 清除条件：手动清除error或接收到新的充电任务

## 5210 - 过温   （取消任务）
### 生效条件：运行状态中接收到过温信号时间超过3MIN
### 清除条件：手动清除error或接收到新的充电任务

### 5211 - 电机缩回距离超值   （取消任务，电机停止工作）
### 生效条件：模型文件中配置了驱动器，且电机距离≤-30mm
清除条件：手动清除error（清除后尝试重新回零，固定往前行进50mm然后重新回零）

### 5212 - 电机伸出距离超限   （取消任务，电机停止工作）
生效条件：模型文件中配置了驱动器，且电机距离≥最大伸缩距离+30mm
## 清除条件：手动清除error

### 5213 - DI3原点传感器异常常开   （取消任务，电机停止工作）
生效条件：模型文件中配置了驱动器，且DI3连续触发高电平时间超过3S
### 清除条件：手动清除error或DI3变为低电平

### 5214 - 充电模块输入交流欠压（取消充电）
### 生效条件：读取到充电模块上报输入交流欠压时间超过1S
### 清除条件：手动清除error或该接收到新的充电任务

### 5215 - 充电模块输入交流过压（取消充电）
### 生效条件：读取到充电模块上报输入交流欠压时间超过1S
### 清除条件：手动清除error或接收到新的充电任务

### 5216 - 充电模块输出欠压（取消充电）
### 生效条件：读取到充电模块上报输出欠压时间超过1S
### 清除条件：手动清除error或接收到新的充电任务

### 5217 - 充电模块输出过压，需停止充电并检查设备（取消充电）
### 生效条件：读取到充电模块上报输出过压时间超过1S
### 清除条件：手动清除error或接收到新的充电任务

### 5218 - 充电模块输出过流（取消充电）
### 生效条件：读取到充电模块上报输出过流时间超过1S
### 清除条件：手动清除error或接收到新的充电任务

### 5219 - 充电模块输出短路，需停止充电并检查设备（取消充电）
## 生效条件：读取到充电模块上报输出短路
## 清除条件：手动清除error

### 5220 - 充电模块过温保护（取消充电）
## 生效条件：读取到充电模块上报过温保护
### 清除条件：手动清除error或接收到新的充电任务

### 5221 - 充电模块硬件故障（取消充电）
## 生效条件：读取充电模块上报硬件故障
## 清除条件：手动清除error

### 5222 - 充电模块电池反接，电池正负极接反，需停止充电并检查设备（取消充电）
## 生效条件：读取充电模块上报电池反接
## 清除条件：手动清除error

### 5223 - RBK插件通讯超时（取消充电）
### 生效条件：超过15S检测不到RBK插件数据
## 清除条件：恢复通讯

### 5224 - charger插件通讯超时（取消充电）
### 生效条件：超过15S检测不到charger插件数据
## 清除条件：恢复通讯
