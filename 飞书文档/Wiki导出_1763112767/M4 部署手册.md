# M4 部署手册

## M4 部署手册
## 前言
M4 支持的操作系统：Linux（强烈建议）、Windows、macOS。
M4 支持的 CPU 架构：x86_64、arm64、aarch64。
启动需依赖 JDK 环境，请预先检查 JDK 配置。
支持多种数据库：M4 自用可以使用默认的数据库，若正式使用 M4 ，一定要使用第三方数据库（MySQL）。
启动后的访问地址： http://<ip>:5800，初始用户名和密码：admin。
安装之前准备好必要的 JDK 环境。
## Windows 安装
检查 JDK 环境 ，打开 cmd 输入：java --version

打开 CMD 快捷键方式：按下键盘 Win键（Windows徽标键） + R键，弹出 “运行” 对话框，输入 cmd 并按回车键。
## image.png

若 JDK 已正确安装并配置环境变量，会输出 Java 版本信息（如  openjdk version "17.0.15"），表示环境正常，跳过安装 JDK部分。
若提示 'java' 不是内部或外部命令，也不是可运行的程序或批处理文件，说明未安装 JDK 或环境变量配置错误，需安装 JDK 17（参考文档中 “安装 JDK 17” 部分）。
## 安装 JDK 17
前往仙工软件库下载 Windows 版 JDK 17 安装程序（当前仅提供 x86_64 架构）。
## image.png

## 启动 M4
准备后端包（仙工软件库下载）和项目包（联系仙工应用研发部获取），建议将文件存放于全英文路径目录（如 C:\m4）。
如果没有项目包，也可以直接新建文件夹，任意名字 比如：project，来启动一个新的项目
## image.png

### 快速启动：在 cmd 中进入后端包目录，执行启动命令：

也可以参照自动启动步骤里的写的 startm4 .bat ，双击快速启动

cd C:\m4\trick-m4-4.21.2 && java -jar trick-m4-4.21.2.jar C:\m4\LearnM4
## 绝对路径启动参考命令：

path\jdk-17.0.16\bin\java -jar trick-m4-4.21.2.jar C:\m4\LearnM4
## image.png

初次启动无许可证，前往自助授权（简道云M4 系统授权）系统，填写机器码，审核通过后，会得到许可证文件m4.license 文件。放到项目包文件夹里，与config 文件夹平级，再重新启动，许可证文件名必须为 m4.license
## image.png

## 启动新项目时才会进入引导界面，按需选择
## image.png

## 自动启动
制作bat 文件，以下指令按需修改，另存为startm4 .bat 的文件

## @echo off
### cd /d "C:\m4\trick-m4-4.21.2"
java -jar "trick-m4-4.21.2.jar" "C:\m4\LearnM4"
## pause
## 下载和解压缩 NSSM
## image.png

## nssm.zip
## 管理员启动cmd
## 图片.png

### 在管理员启动的 cmd 里启动 nssm.exe
## 图片.png

点击 Path 右侧的“…​”，选择上面创建的startm4.bat ，输入Service Name 后，再点击 “Install service”：
## 图片.png

注册成功，点击“确定”,在 管理员：命令提示符 窗口 输入 net start m4 启动服务，提示“m4 服务已经安装成功。”成功后可关闭 cmd，在 windows 系统服务里找到 名为 m4 的服务，启动它：
## 图片.png

## 以下是 nssm 的常用命令：
### 安装服务： nssm.exe install <服务名>
### 删除服务： nssm.exe remove <服务名>
### 启动服务： nssm.exe start <服务名>
### 停止服务： nssm.exe stop <服务名>
### 重启服务： nssm.exe restart <服务名>
### 服务状态查看： nssm.exe status <服务名>
## Linux 安装
## （以 Ubuntu 24为例）

## 不想手动安装？
直接下载镜装软件的 X86 架构的镜像(SBS 软件库也存在）：https://seer-group.feishu.cn/drive/folder/EHEjf7EB7lqTGZd69UTchNxanpd，务必看下帮助文档，此文档也存在于服务器上 /opt/file/帮助文档.wps ，可能要移动到桌面才能打开
若 JDK 已正确安装并配置环境变量，会输出 Java 版本信息（如  openjdk version "17.0.15"，其他版本不行），表示环境正常，跳过安装 JDK部分。
若不是以下输出，说明未安装 JDK 或环境变量配置错误，需安装 JDK 17（参考文档中 “安装 JDK 17” 部分）
## image.png

## 安装 JDK 17
### 前往仙工软件库下载对应架构的 JDK17
## image.png

### 切换到 root权限执行,注意启动的路径

## sudo -i
下载 ，JDK 安装包，参照以下方法执行。
## install_jdk.sh

source install_jdk.sh OpenJDK17U-jdk_x64_linux_hotspot_17.0.15_6.tar.gz  
## # 使用方法:
#  指定压缩包路径: source  ./install_jdk.sh    /path/to/jdk.tar.gz
#  或直接运行 source  ./install_jdk.sh 将默认使用OpenJDK17U-jdk_x64_linux_hotspot_17.0.15_6.tar.gz 

## image.png

## 启动 M4
准备后端包、项目包两个文件，解压缩放到 /opt/data/m4 （后端包可在仙工软件库下载，项目包联系仙工应用研发部的同学获得）
如果没有项目包，也可以直接新建文件夹，任意名字 比如：project，来启动一个新的项目

## tips：
## ###权限不足加 sudo 执行
### 解压缩指令： unzip xxxx.zip
移动指令： mv /xxx/xxx/   /xxx/xxx/
复制文件指令：cp /xxx/xxx/   /xxx/xxx/
复制文件夹： cp -r /xxx/xxx/   /xxx/xxx/
### 创建文件夹：mkdir  /path/data/xxx

## image.png

## 启动示例：

sudo java -jar trick-m4-5.3.3.jar /opt/data/m4/project/
## "/opt/data/m4/project/" 项目包路径根据实际情况修改
### ###如启动项目包 LearM4 项目包，启动指令为：
sudo java -jar trick-m4-5.3.3.jar /opt/data/m4/LearM4
## 绝对路径启动：

"path"/jdk-17.0.16/bin/java -jar trick-m4-4.21.2.jar /opt/data/m4/LearnM4

手动启动时，需要在 XXXX.jar 路径下启动，因为 jar 包会自动加载同级目录下的 UI 文件夹

## image.png

初次启动无许可证，前往自助授权（简道云M4 系统授权）系统，填写机器码，审核通过后，会得到许可证文件m4.license 文件。放到项目包文件夹里，与config 文件夹平级，再重新启动，许可证文件名必须为 m4.license
## image.png

## 启动新项目时才会进入引导界面，按需选择
## image.png

## 自动启动

## 手动启动成功之前先不要设置成自动启动
输入 vim /etc/systemd/system/m4.service 打开文件（进入命令模式）；
按 i 进入插入模式，粘贴以下代码块内容；（按需修改，比如“一直启动”）
按 Esc 回到命令模式；
### 输入 :wq 并按 Enter，保存修改并退出 Vim

注意：若文件因权限问题无法保存，可在命令前加 sudo（如 :wq! 无权限时，输入 :w !sudo tee % >/dev/null 强制保存）。

## [Unit]
## Description=m4
### After=network.target
### #Before=index.service

## [Service]
## Type=simple

## # 避免日志输入到 syslog
## standardOutput=null
## standardError=null

## ###工作目录根据实际情况修改
WorkingDirectory=/opt/m4/trick-m4-xxx

# 启动命令，根据实际修改 java 所在完成目录、主程序 jar 所在目录和文件名、项目包目录(这里用 /opt/m4/LearnM4 作为演示)
ExecStart=/opt/jdk-17.0.10/bin/java -jar /opt/m4/trick-m4-xxx.jar /opt/data/m4/LearnM4

### ###关闭一直启动，开启设为 always
## Restart=on-failure
## RestartSec=5

## [Install]
### WantedBy=multi-user.target
## 重载 service：
### sudo systemctl daemon-reload
## 启动 service：
### sudo systemctl start m4
## 开机自启：
### sudo systemctl enable m4
## 查看服务：
### sudo systemctl status m4
## 自选数据库配置（首选MySQL）
若 M4 商用，需要安装第三方数据库，修改项目包配置文件  项目包/config/config.json，下文给出常用的几种数据库。如项目上要求的数据库不在其中，请在项目工单里反馈到产研中心负责人。

## MySQL
使用 MySQL 作为数据库，安装之后必须手动创建数据库，再根据创建的数据库名修改配置文件

CREATE DATABASE m4 CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
## #### m4 是数据库名

## {
## "db":{
        "type":"MySQL",
        "host":"127.0.0.1",
        "port":"3306",
        "username":"root",
        "password":"mysql",
## "dbName":"m4"
    },
## "port":5800
## }
## MongoDB

## {
## "db": {
    "type": "MongoDB",
    "url": "mongodb://localhost/m4",
## "dbName": "m4"
  },
## "port":5800
## }
## 第三方数据库安装
## Windows
## MongoDB 安装
 前往仙工软件库下载 MongoDB，双击运行 mongodb-windows-x86_64-6.0.24-signed.msi 
## image.png

## image.png

E4OdbwYaLoteyFxsgfmcA1BwnNf.png

W4cYbfdikoOqhzxZQN8crcZ4nEc.png

TiK2b8EpWoMjMSxKs0KcFuiRnIh.png

Co5BbOYUfo3j5pxuuFqc5YVUnR9.png

 取消勾选“Install MongoDB Compass”，然后点击“Next”；

注：下图的 Compass 是 MongoDB 数据库的可视化工具，但是第一次安装会使安装过程比较慢，所以先不安这个，后续需要再单独安装。
VUiHb2z3tore3cxqutacWZkxnNf.png

Yaj3bxEvnoQoO8xny5lcdpbRnnd.png

MACobG3r4oNQuSxxqUkcL6E1nIb.png

LraCbS7heoMyQ6xn4rWcrlVMnTe.png

## MySQL 安装（首选）
## 前往仙工软件库下载 MySQL 安装
## image.png

## 点击 next
## image.png

## 接受，next
## image.png

## 这里选择自定义安装，next
## image.png

## 选择文件安装路径
## image.png

## 点击安装
## image.png

### 运行 MySql Configurator ，Finish
## image.png

开始 mysql configurator 进行数据库配置，next
## image.png

默认选择 Development Computer，端口号 3306 ，next
## image.png

## 设置密码  mysql ，next
## image.png

## 默认开机自启，next
## image.png

## 默认，next
## image.png

## 默认，next
## image.png

### 点击“Execute”后，等待加载完，next
## image.png

## 点击 finish ，安装完成
## image.png

## 连接数据库，输入密码

## mysql -uroot -p
## 创建 m4 专用的数据库

CREATE DATABASE m4 CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
## #### m4 是数据库名
## Linux
## 这里以 Ubuntu 为例
## MongoDB 安装
### 在仙工数据库下载 mongoDB 的 安装包，然后直接安装
## image.png

## 离线安装

    sudo dpkg -i mongodb-org-server_7.0.21_amd64.deb
### 在线安装91310115MA1K4HX99N

### #添加 MongoDB 官方 GPG 密钥
### sudo apt-get install gnupg -y
wget -qO - https://pgp.mongodb.com/server-6.0.asc | sudo gpg --dearmor -o /usr/share/keyrings/mongodb-server-6.0.gpg
## # 添加 MongoDB 6.0 源
echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | sudo tee 

/etc/apt/sources.list.d/mongodb-org-6.0.list
## # 更新并安装
## sudo apt-get update
sudo apt-get install -y mongodb-org
## 服务管理
## 启动服务

sudo systemctl start mongod.service
## 停止服务

sudo systemctl stop mongod.service
## 查看服务状态：

systemctl status mongod.service
## 设置开机自启：

sudo systemctl enable mongod.service
## MySQL 安装（首选）
安装之前先查看 mariadb是否已启动，如已启动则跳过安装步骤，直接创建数据库。

### systemctl status mariadb
如看见running字样，则表示已启动，直连创建数据库即可。
### Mariadb 与 MySQL 同宗同源，可以替换使用
## 前往仙工软件库下载 mysql 资源包
（如果已经装过，maraiDB就无需再安装，使用命令：systemctl status mariadb  查看是否安装）
## image.png

## 步骤：
## 1、切换用户

## sudo -i  ###切换用户
### 2、解压缩文件

unzip mysql-8.4.6-x86_64_linux.zip   ####解压缩文件
### 3、进入刚解压缩的文件夹后，启动安装脚本

如果执行报错，先核对一下文件是否都存在，下图是所有必须存在的文件
## image.png

cd mysql-8.4.6-x86_64_linux && bash install_mysql.sh  #### 进入解压缩文件夹后启动脚本
## 执行成功的过程：
## image.png

脚本会自动创建 M4 需要的数据库；
如若出现 “MySQL初始化失败！”，则是权限不对，请移步 安装问题文档
### 4、使环境变量生效

source /etc/profile.d/mysql.sh 

## 检查数据库启动状态

### systemctl status mysql8
## image.png

## 访问数据库，密码： mysql

## mysql -uroot -p

如出现：ERROR 2002 (HY000): Can't connect to local MySQL server through socket '/tmp/mysql.sock' (2)
## 可能引起的原因：
MySQL 会和 MariaDB 配置文件冲突，需要在 /etc/mysql 目录下删除所有关于 mysql 的文件和目录。删除后重新解压缩安装
服务未启动，请手动执行 systemctl strart mysql8 启动
## image.png

## 云服务器安装 M4
在云服务器上安装 M4 的步骤跟前文所述没有差别，但是需要注意的是要设置安全组才能正常访问。
安全组是云服务商提供的一层虚拟防火墙，作用于单个云主机或一组云主机，用于控制出入方向的网络流量（包括端口、协议、IP 范围等）比传统服务器的系统防火墙（如 iptables 或 windows 防火墙）更灵活、易管理。
默认情况下，所有端口都是关闭的（拒绝所有未明确允许的流量），需手动放行特定端口和协议。
## 以天翼云服务器为例，配置方法如下：
## image.png

## image.png

## image.png

## image.png

## image.png

## 5 分钟极速启动M4-windows
## （仅限个人用户安装）
前往仙工软件库获得后端包，联系数字化部门同学获得项目包，没有项目包可直接新建一个文件夹 project

## M4asst.exe
下载上述exe文件，双击打开后按下图顺序依次点击。
## image.png

## image.png

## image.png

## image.png

安装好后弹出上文弹窗。选择对应版本的M4包拖入下图标识处自动解压，（此操作可用于后续版本更新）
## image.png

## image.png

解压后的M4包可在下图第一个下拉框选取、点击选择项目，选择需要启动的项目包（注意要启动的后端包，也可手动下拉选择）
## image.png

## 选择解压好的项目包
## image.png

## image.png

## image.png

两个下拉框都选择为期望路径后、点击“手动保存”（有自动保存功能，手动保存一下更靠谱）。选择好需要启动的项目包后，点击上图“桌面启动”按钮

## image.png

若没有授权，启动后会提示无许可证文件：前往自助授权系统，填写机器码，审核通过后，会得到许可证文件 m4.license
将该文件移到项目包所在路径下（与config文件夹同级目录）
## 卸载
### 支持标准的卸载流程。在控制面板里直接卸载就可以
## 光通讯部署
## 下载资源
控制下载 GW，根据控制器架构下载相应的版本，必须下载专用的 4.24.1 版本
## image.png

### 服务器上主程序包资源，指定下载 4.24.1
## image.png

## 控制器安装
### 将 deb 包传入到控制器内，使用 dpkg 进行安装
## sudo dpkg -i xx.deb
### 运维界面：9001端口，m4 界面：5800 端口
如不能访问，点击日志列表，打开 f2.log 可看到启动日志
## image.png

## 控制器上配置光通讯
将第一处 AMB 改为实际机器人的真实名称；
将第二处的 IP 地址换成 M4 服务器的 IP 地址；
保存；
查看菜单《单车应用》，观察机器人在线且能看到机器人地图上的位置。
## image.png

## 服务器上安装

## M4Light.zip
安装方式参照前面的 M4 部署，以上是项目包，使用教程看《光通讯用手册》
## 单车应用安装
## 下载安装包
## image.png

### 将 deb 包传入到控制器内，使用 dpkg 进行安装

## sudo dpkg -i xx.deb
运维界面：9001 端口，quickgo 界面：5800 端口
如不能访问，点击 9001 端口上的日志列表，打开 f2.log 可看到启动日志

注：首次启动必不能访问 5800 端口，需要授权证书，打开 f2.log 即可看见机器码。前往自助授权（简道云- M4 系统授权）系统，填写机器码，审核通过后，会得到许可证文件（m4.license） ，放入： /opt/data/quickgo/prjSingleApp
## image.png

## 附录：项目包结构详解
