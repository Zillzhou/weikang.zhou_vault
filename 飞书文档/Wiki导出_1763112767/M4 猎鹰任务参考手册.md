# M4 猎鹰任务参考手册

## M4 猎鹰任务参考手册
## 修订时间：2025年10月31日
## 猎鹰任务记录列表界面
在菜单栏点击“猎鹰任务记录”，即可进入猎鹰任务记录列表界面，看到所有已创建的猎鹰任务的任务信息。
此界面大部分功能与业务对象标准列表界面相同，该界面额外增加了一些猎鹰任务的特色功能，如暂停执行、继续执行、故障重试、取消执行，这些功能的详细介绍见该文档的《猎鹰任务生命周期管理》。
## image.png

另外，此界面还提供进入任务模板和全局控制界面的入口，见下图。
## image.png

针对移动端，部分上述功能收缩在右上角三个点图标中。
## image.png

## 如何查看猎鹰任务运行情况？
在桌面端点击猎鹰任务记录菜单，进入猎鹰任务记录页面，可以看到已经开始运行的猎鹰任务列表。
列表显示猎鹰任务 ID、任务模板、任务状态、错误原因等信息。
点击操作列的 “查看”，进入猎鹰任务运行详情，可以查看猎鹰任务每个组件的运行情况。
## image.png

## image.png

## 能否看到执行机器人？
猎鹰任务记录默认含“执行机器人”字段，涉及机器人的任务，会在选到机器人后显示在该字段内。如果有多个，一并记录，逗号分隔。
如下图，建了一个多机器人执行的猎鹰任务。运行后可以看到任务记录的多个执行机器人。
## image.png

## image.png

如果需要根据机器人搜索猎鹰任务，则可以在业务对象配置页中增加机器人为模糊筛选的对象。配置完成，点击保存。刷新页面。
## image.png

在模糊搜索输入框中输入机器人名（不区分大小写），回车，就可以按机器人模糊筛选任务记录。
## image.png

## 猎鹰任务详情界面
猎鹰任务详情界面展示任务运行的详情，可以从“猎鹰任务记录”界面点击“查看”进入，也会在任务模板运行后自动弹出。
以“循环任务”为例：输入希望循环的次数，每次循环后，打印输出当前为循环的第几次。
## 输入任务名：RepeatPrint
## 创建输入参数：次数
插入组件“重复执行”，添加子组件，输入参数。
## image.png

## 任务详情
“任务详情”界面可以查看任务、组件运行的详细情况，并进行相关操作。
顶部是工具栏，有暂停执行、故障重试等功能，这些功能详见本文档《猎鹰任务生命周期管理》章节。“返回顶部”、“前往底部”功能，是在任务比较大，组件比较多，页面比较长时，方便用户快速切换界面视图。
下一行是任务概述，展示任务状态、ID、任务模板名、创建完成时间。点击任务模板名（蓝字部分）可以打开编辑该任务模板。
输入参数。同创建任务时输入参数名称一致，为输入的次数。
详情中输入参数、输出参数、内部变量等，均有两种视图展示方式：Text 和 JSON，可以自由切换，当参数过长，JSON 视图更清晰直观。
## image.png

## 组件列表
随着任务的运行，正在执行和完成的组件会不断列出，结构类似任务模板。
每个组件及其状态、名称（组件说明）、引用名（如下图中的 “b2”）以及开始和完成的时间
输入变量、内部变量、输出变量。当需要看这些变量值时，可以留意这些位置。
## image.png

## 查看循环记录
针对循环任务，目前任务运行详情默认只显示最新的循环执行情况，但会显示共循环了多少次。可以在输入框输入整数，跳到指定循环。清空输入后，会加载最新的循环。
## image.png

## 任务故障
在任务出现故障时，任务详情界面中任务状态会变成“故障”，并在旁边显示故障次数。下方会提示故障的原因（如红框中 Error 字段），各组件运行情况也会显示是否故障及故障次数，便于进一步排查故障组件位置，判断故障原因。界面右侧告警中心中也会有对应的故障提示。故障的恢复详见本文档《猎鹰任务生命周期管理》章节。
## image.png

## 查看相关对象
对于一些猎鹰任务，如果涉及到业务对象，会在详情页右侧相关对象区域显示。例如两点搬运，涉及到新调度运单和新调度运单步骤两个业务对象，则会显示在右侧，点击可查看详情页。其他相关业务对象如库位、容器、库存、容器搬运单等，也会显示在右侧。
## image.png

## 显示日志
如果打开显示日志，可以查看每个组件的输出日志，日志显示在对应组件下方。但不是每个组件都有输出日志。
## image.png

## 能否自由开启或关闭组件的输入参数？
在系统配置页，找到猎鹰任务分类，有一个配置项“记录显示组件输入参数”，打开时，猎鹰任务记录的每个组件会显示输入参数，关闭后则不显示。
## image.png

下面的左右两张图分别是开启记录组件输入参数和未开启的对比。

## image.png

## image.png

## 猎鹰任务生命周期管理
## 猎鹰任务及组件状态
## 猎鹰任务状态分为以下几种：
已创建。
已开始。非终态，常见为任务暂停执行/宕机，点击继续执行后，任务继续。
故障。非终态，代表任务执行中出现故障，可排查问题修改后，故障重试，任务恢复执行。
已完成。终态，代表该任务已经做完。
已取消。终态，代表该任务被取消，不可继续执行。
已终止。终态，代表该任务已终止，不可继续执行。
猎鹰任务组件状态分为以下几种：创建、执行、故障、完成、取消、终止。
猎鹰任务支持暂停执行、继续执行、故障重试、取消执行等操作。可以在猎鹰任务列表界面、任务详情页面操作。
## image.png

## 如何暂停执行猎鹰任务？
在 M4 服务关闭时，系统会自动暂停非终态的猎鹰任务。除了自动暂停之外，还支持手动暂停任务。比如设备对接时遇到设备的故障，此时可以手动暂停猎鹰任务，调试好设备以后，继续执行任务。
具体操作是勾选猎鹰任务记录，点击“暂停执行”。
## image.png

## 如何继续执行猎鹰任务？
同手动暂停执行的猎鹰任务， M4 关闭后自动暂停的猎鹰任务，在系统重启后，不会自动恢复，需要手动点击“继续执行”。手动恢复的目的在于，避免因故障宕机而自动暂停的任务，在重启后再次因故障暂停；手动恢复可在一定程度上避免故障重复发生。可以全选/勾选想继续执行的任务。
## image.png

## image.png

## 猎鹰任务故障与故障重试
当任务有故障时，其状态会变为“故障”，猎鹰任务记录列表、任务详情页、告警中心都有相关提示，包含任务 ID、任务名、故障次数、故障原因等。而且可以故障重试和取消猎鹰任务。
## image.png

## image.png

找到故障原因后，支持修改任务流程/组件，点击“故障重试”按钮，恢复执行，且已执行过的步骤不会重复执行，不需要取消任务再发起。但如果修改量太多，结构变化太大，故障重试可能会报错。
## image.png

## image.png

## 如何快速调试猎鹰任务模板？
修改任务模板后，点击“运行”按钮，M4 跳转到猎鹰任务记录详情页。
在猎鹰任务记录详情页发现报错后，点击蓝色的任务模板名，M4 跳转到此猎鹰任务模板的编辑页面，修改模板后，点击保存。然后切换到猎鹰任务详情页，点击《猎鹰任务故障与故障重试》介绍页面的刷新/故障重试，M4 会使用修改后的模板运行猎鹰任务。
## image.png

## 如何取消执行猎鹰任务？
猎鹰任务可以在任务详情界面及任务记录列表界面取消。取消后猎鹰任务状态显示“已取消”。并在取消的组件前进行标记。取消后为终态，不可继续执行。

## image.png

## image.png

## 猎鹰任务管理页
在猎鹰任务记录列表界面找到“模板”，点击即可打开猎鹰任务模板管理页。该页面分为三大部分，分别是：任务模板列表、定制组件列表、内建任务。可以在此界面添加/删除/导入/导出/搜索任务模板和定制组件，并查看模板历史版本、复制或运行该模板。
## 什么是猎鹰任务模板？
猎鹰任务模板是业务流程的具象化配置框架，可通过预设参数、流程组件及规则，配置业务流程。同时，支持组件定制、参数调整等个性化配置，实现业务流程的快速复用与灵活适配。
每个仓储业务模块（比如入库单）对应一个或多个猎鹰任务模板，比如入库单提交后生成库存：
### 建一个名为 “入库后生成库存” 的猎鹰任务模板
在业务对象-入库单-按钮-提交按钮中关联 “入库后生成库存” 猎鹰任务模板
用户在入库单新建页面，点击 “提交” 按钮后，M4 会运行“入库后生成库存”这个猎鹰任务模板，运行完成后会创建库存明细。
在项目交付前，技术支持或开发同事会根据业务情况配置相应的猎鹰任务模板，终端用户不需要关心猎鹰任务模板。
因为配置和调试猎鹰任务的过程中，需要经常看运行结果，猎鹰任务记录列表页和猎鹰任务详情页，均放了猎鹰任务模板的入口。
### 有 2 种方式进入猎鹰任务模板列表页面：
在猎鹰任务记录页面，点击 “管理” 按钮。
点击任务模板页面。此页面一般不开放给业务操作员，因为一般无需改动。
## 如何添加任务模板?
在猎鹰任务模板列表页点击“添加任务模板”，即可进入猎鹰任务模板编辑页面。
## image.png

## 如何运行任务模板?
在任务模板列表页找到对应的任务模板，点击运行图标，即可运行猎鹰任务。
## image.png

## 如何复制任务模板/定制组件?
点击任务模板列表页的任务模板或者定制组件的复制图标，弹出复制弹窗，输入新的任务模板名/定制组件名，点击确定即可。复制后，系统默认打开复制任务模板/定制组件的编辑页。
## image.png

## image.png

## image.png

## 如何查看任务模板/定制组件历史版本?
每次对任务模板/定制组件进行编辑-保存后，版本号都会更新（版本号为任务模板或定制组件名称后括号内的数字）。猎鹰任务支持版本管理，可查看、恢复、比较历史版本。
点击任务模板列表页的任务模板或者定制组件的时钟图标，弹出“历史”弹窗。在对应历史版本后点击“恢复”，即可恢复至该版本的任务模板或者定制组件；还可以点击“比较”，查看历史版本与当前版本的异同。在比较弹窗中，支持比较版本的切换。
如果某一任务模板为初版（版本号显示为 1），点击时钟图标后，页面将提示“当前版本为初版，无历史版本”。
## image.png

## image.png

## image.png

## image.png

## 如何导入导出任务模板/定制组件
任务模板和定制组件均支持导入导出。在任务模板列表页，勾选目标任务模板或定制组件，点击顶部的“导出”按钮，可以将模板或定制组件导出为 json 文件。
## image.png

## image.png

如果不勾选定制组件，但勾选的任务模板中使用到了某些定制组件，那么系统会自动将使用的定制组件导出，且在导入的时候可以看到使用的定制组件。
点击“导入”按钮，选择导出的 json 文件，系统解析出模板列表和组件列表，在导入页面分为两部分展示，可以勾选需要的模板和组件进行导入。注意有的模板用到了某些定制组件，那么相应的定制组件也要勾选，否则模板将无法正常运行。
## image.png

如果导入的模板或组件与系统中已有的模板和组件同名，则版本号会被 +1，因此如果不想本地内容被覆盖，请仔细筛选导入的内容。
导入后，任务模板列表页将更新。
## 如何删除任务模板/定制组件？
勾选目标定制组件/任务模板，点击“删除”按钮，在弹窗二次确认后，即可删除。
## image.png

## image.png

## 如何搜索任务模板/定制组件？
在任务模板列表页顶部的搜索输入框中，输入任务模板名或定制组件名，回车，即可模糊搜索出任务模板或者定制组件。
## image.png

## 内建猎鹰任务
所谓内建猎鹰任务，就是系统自带的猎鹰任务。这些猎鹰任务用于执行系统标准逻辑，如处理库存。也可以作为预置的模板，供项目定制参考。内建猎鹰任务不能删除，可以修改任务，重启 M4 后，内建猎鹰任务会强制更新，恢复至默认状态。
内建猎鹰任务入口在系统的【猎鹰任务模板】菜单，目前 M4 有一个内建任务：将货物从起点搬运至终点。
## image.png

## image.png

## 移动端
移动端的任务模板和定制组件列表页采用一栏，从上往下滑动即可，最上方是模糊搜索输入框，可以搜索任务模板和定制组件名，然后是任务模板列表，最后是定制组件列表。
点击任务模板列表或者定制组件列表，可以查看任务模板/定制组件的详情。
更多功能可以点击右上角三个点查看，点击会出现更多菜单。桌面端顶部的操作栏的按钮，全都在移动端三个点里，包括保存、运行、撤销重做任务、插入组件等。

## image.png

## image.png

## 猎鹰任务模板编辑界面
点击“添加任务模板”，进入编辑页面。猎鹰任务模板编辑页面的顶部是操作栏，左侧是任务设置和任务参数栏，插入组件在桌面端是默认固定在业务流程的左侧，中间是业务流程，右侧是组件配置。
## image.png

## 如何设置任务名？
在任务模板编辑页的任务名输入框中输入任务名称。任务名称必填，否则无法保存。
## image.png

## image.png

## 如何设置任务分组？
点击“更多”，弹出“更多任务设置”对话框，在分组输入框中输入分组名，点击确定即可。
## image.png

分组过的任务模板会在列表页中显示在对应组内。如果未分组，默认显示在“其他”组中。
## image.png

## 如何插入组件？
在插入组件区域的对应分类中找到需求组件，悬浮到组件上方，点击插入按钮，组件就被插入在业务流程中，插入的组件默认在业务流程最后。
## image.png

## 如何搜索组件？
在插入组件区域的搜索框中，输入组件名称，回车，即可模糊搜索组件。
## image.png

## 如何移除组件？
## 允许删除单个组件，也允许删除多个组件：
在猎鹰任务模板编辑页面，找到需要删除的组件，点击，组件上的删除图标，组件就会被删除。
选中多个组件后，点击操作栏的 “移除组件”按钮，所有被选中的组件都会被删除。
## image.png

## 选中组件时，是否可以显示更为突出？
在猎鹰任务模板编辑页面，找到需要勾线的组件，组件边框会变成虚线，显示更为突出。
## image.png

## 如何调整组件顺序？
勾选组件后，点击其中任意一个组件前面的移动图标，然后上下拖动，插入至合适位置松开鼠标，可以调整组件的顺序。如果同时勾选多个（也可以不连续），则多个组件将作为一组一起调整顺序。
## image.png

在拖动时，拖动的所有组件会变为一个小矩形，显示被拖动的组件数量。
## image.png

## 如何配置组件内容？
左键单击一个组件，在右侧的组件配置中配置组件的详细内容，包括说明、组件引用名、输入参数。
## image.png

说明：可以将组件名字改为例如业务说明，方便理解。
组件引用名：（一般不需要修改）默认为 b 开头的 block 编号，可以修改引用名，在其他组件引用到此组件时，引用名会变为自定义的引用名。
## image.png

## image.png

输q入框中。

## image.png

## image.png

## 组件能折叠吗?
## 猎鹰任务模板支持折叠子组件，具体操作：
添加 “串行执行” 组件。
如果连续多个组件是做一件事，可以把它们放入一个串行组件里，每个组件被称为 “串行组件” 的子组件。
点击折叠按钮，即可将当前串行组件的子组件收起。
## image.png

其他必须配置子组件的组件，也可以折叠其子组件，如“如果 IF”、"并行执行“等。
## image.png

## 如何全选/全不选组件？
在工具栏找到“全选”、“全不选”按钮，能快速选择或取消选择任务中使用到的所有组件，便于进行进一步操作，如复制、粘贴、移动组件位置等。
## image.png

## 如何复制/粘贴组件？
猎鹰任务支持复制单个组件/多个组件，还可以在任务内和任务间复制粘贴组件。
如果是复制单个组件，直接点击组件右侧的复制图标即可，复制的组件会默认粘贴到被复制的组件下方。
如果是复制多个组件，选中目标组件，点击工具栏的“复制”按钮，复制以后，粘贴按钮才可以点击，点击“粘贴”按钮，复制的多个组件默认粘贴到所有组件的末尾，且是选中状态。
还支持跨页面复制粘贴组件，在编辑猎鹰任务模板时，如果多个猎鹰任务的某处逻辑一致，则可以将一个任务的多个组件，通过复制的方式跨页面粘贴到另一个任务模板中，提升模板编辑的效率。
先在一个任务中，勾选需要的组件，点击顶部操作栏的“复制”按钮。
切换到另一个需要粘贴的猎鹰任务编辑页中，点击“粘贴”。
被复制的组件默认粘贴在任务的最后，且默认为勾选状态，可以将被选中的组件拖动到任务的正确位置。
注意被复制粘贴的组件的参数配置也会被复制到新的任务中，如果需要，可以单独修改组件的参数配置。
## image.png

## 如何停用/启用组件？
编辑猎鹰任务时，顶部工具栏有“停用”、“启用”按钮，停用组件，猎鹰任务运行时会跳过停用的组件，且不会对停用组件做必填校验。通常有以下使用场景：
调试猎鹰任务时，想跳过一些组件。比如只想测试逻辑，不想让真车搬运，因此停用调度相关的组件。或者想快速测试，因此把所有“延迟”组件停用。
一个组件写法可能有问题，先复制这个组件，将原来的组件停用，在复制的组件上修改配置，临时看修改的效果是否符合预期。
某些组件后续可能用得到，因此不删除，先停用。
停用的组件会有删除线，且字体显示为灰色。
## image.png

## 能否撤销/重做任务？
### 点击操作栏的“撤销”、“重做”按钮，即可撤销/重做任务
## image.png

## 如何保存运行猎鹰任务？
编辑好猎鹰任务后，首要任务是保存：点击操作栏的“保存”按钮。保存时，会对任务设置、组件必填等内容进行校验，比如未配置任务名，则会弹窗提示。
## image.png

## image.png

## image.png

然后点击“运行”按钮。会弹出运行任务的对话框。
## image.png

如果配置了输入参数，在运行时，要填写参数值，如果配置了默认值则直接点击运行即可。
## image.png

## 如何查看猎鹰任务源码？
点击操作栏的“源码”按钮，可以查看该任务的源码，可以直接在源码上修改配置，修改完点击“修改”即可。相较于单独点击组件，再配置组件的参数，可能有人更喜欢改源码的方式。
此外，还可以全选源码，然后新建猎鹰任务，将此源码复制到新任务的源码对话框中，即可快速实现复制猎鹰任务。
## image.png

## image.png

## 移动端如何创建猎鹰任务模板？
移动端和 PC 端配置猎鹰任务的功能一致，但入口和交互略有不同。
在移动端-猎鹰任务右上角，点击更多功能图标，弹出功能列表。在功能列表中，点击“模板”，进入猎鹰任务模板列表页。

## image.png

## image.png

在猎鹰任务模板列表页，点击其中一个猎鹰任务模板，或者点击右上角三个点的图标，选择添加任务模板，即可进入猎鹰任务模板详情配置页。

## image.png

## image.png

和  PC  端配置一致，完成后保存并运行，如有输入参数，可以在弹窗中填写，任务运行后，自动跳转到任务详情页面。

## image.png

## image.png

任务运行详情页，及列表界面。

## image.png

## image.png

## 两点搬运猎鹰任务示例
为方便测试，创建两个输入参数，起点、终点。

## image.png

## image.png

三代调度需要先创建运单，然后向指定运单添加一个、两个或更多步骤，最后结束运单。
第一个组件，创建三代调度运单。输入场景名称，关键位置是必填的，一般是任务起点。其他信息按需填写，比如是否要指定机器人。这个组件输出运单号。后续要向此运单追加步骤，只需要引用此运单号。

## image.png

## image.png

第二个组件，选择“添加三代运单步骤”，即让选定的机器人执行某个动作。我们可以在说明处填写该组件的说明提示，比如“去地点取货”。在运单号处选择引用，引用第一个组件的输出参数，运单号。点位或库位我们也选择引用，引用我们创建的任务参数，起点。operation 就是动作，按需填写，比如 load。其他可以不填。
## image.png

## image.png

## image.png

第三个组件，与第二个类似，只是站点变成终点，operation 变为 unload。
## image.png

最后一个组件，结束三代运单，引用组件 1 输出的运单号即可。
## image.png

保存，运行，在对话框中填写地图上实际有的点位。可以在地图上查看机器人轨迹。
## image.png

## 单据调用猎鹰任务示例
单据调用猎鹰任务通过拓展按钮关联猎鹰任务，如果需要用到单据中的字段作为猎鹰任务的入参，那么还需要在猎鹰任务模板中关联业务实体，并设置输入参数。
在业务对象-界面按钮-新增界面/编辑界面，新增拓展按钮。到按钮编辑页面，关联已经创建好的猎鹰任务。
## image.png

猎鹰任务模板中，创建两个输入参数，单号、实体。

## image.png

## image.png

找到组件“根据 id 查找业务对象”插入到流程中，将任务输入参数“实体”和单号配置到此组件的输入参数中。这个步骤即确认关联的业务对象。
## image.png

使用业务对象的字段，作为输入参数。比如使用 “bin” 作为库位编号，那么所有需要录入库位编号的组件，配置输入参数时需要用到表达式。表达式中，“blocks.b1” 表示 “根据 id 查找业务对象” 的块编号，“ev” 表示引用的是当前实体，“bin” 表示引用的具体哪个字段。建议用户复制这个表达式，使用时替换块编号和字段 id 就行。
### 完整表达式：blocks.b1.ev.startbin
## image.png

## 猎鹰任务参数和变量体系
猎鹰任务与编程语言都是用来实现某个业务流程的。编程语言有变量、函数输入参数、返回值等概念。这些概念可以提高语言表达能力，让复杂业务流程更容易实现。猎鹰任务也有类似的机制。

猎鹰任务的“组件”相当于编程语言中的函数。“任务模板”（以下简称任务）相当于编程语言中的接口。

猎鹰任务的参数和变量有以下类型。
## 任务的输入参数
任务可以有零个或多个自定义的输入参数。输入参数可以让任务更灵活。例如两点搬运任务，有起点、终点、容器三个输入参数。
在猎鹰任务编辑页的任务输入参数配置区域，点击“添加”，添加一个任务输入参数，配置以下内容，配置完成，点击“完成”按钮：
参数名：必填，参数的名称。
显示名：必填，参数的显示名称。
类型：必填，支持字符串、布尔、整型、浮点型、JSON 对象、JSON 数组、不限制。
对象类型：对象类型标识这个参数的业务含义。例如是一个库位、一个机器人名、一个调度运单号等。一个参数可以配置零个、一个、多个对象类型。对象类型的目的是帮助加速配置。在后文《对象类型与匹配》章节会详细介绍。
必填：勾选以后，这个输入参数在运行时必填。
默认值：如果有默认值，输入默认值后每次运行任务则不需要再填写。
说明：填写辅助信息。
## image.png

点击底部的“复制”按钮，可以复制输入参数。复制的参数默认加一个 -copy 后缀，如有需求，手动修改即可。
## image.png

## 任务的输出参数
主要用于子任务。例如我们可以编写一个分配库位的猎鹰任务，里面可以很复杂。经过一些决策最终输出一个目标库位参数。在其他猎鹰任务里可以将该子任务作为组件。
在猎鹰任务编辑页的任务输出参数配置区域，点击“添加”，添加一个任务输出参数，配置以下内容，配置完成，点击“完成”按钮：
参数名：必填，参数的名称。
显示名：必填，参数的显示名称。
类型：必填，支持字符串、布尔、整型、浮点型、JSON 对象、JSON 数组、不限制。
引用组件：必填，这个任务中所应用的所有带有输出参数的组件，可以作为该输出参数的引用组件，意味着这个输出参数引用了哪个组件。
## image.png

引用组件输出参数：必填，与“引用组件”联动，会列出所选的“引用组件”的所有输出参数，选一个作为任务输出参数的引用对象。比如组件 A 有三个输出参数 BCD，组件 A 作为了输出参数的引用组件，那么这里会列出 BCD 三个选项。
说明：填写辅助信息。
## image.png

点击底部的“复制”按钮，可以复制输出参数。复制的参数默认加一个 -copy 后缀，如有需求，手动修改即可。
## image.png

### 比如这个任务“三代调度”配置了一个输出参数“输出一”
## image.png

在另一个任务中，使用该任务，即将“三代调度”作为子任务进行调用，在父任务“二代调度”中，打印子任务的输出参数。此时配置打印组件，可以引用到子任务的输出参数。注意只有父任务才可以引用到子任务的输出参数，如果任务未相互调用，在配置组件参数的引用类型时，不会出现其他任务的输出参数选项。
## image.png

## image.png
## 有子任务时才有其输出参数

## image.png
## 没有子任务，就找不到输出参数

## 任务变量
在任务内创建这个变量（赋值）后，任务后续都能访问这个变量。其作用与编程语言类似：给一个概念明确的名字。例如，终点库位要经过复杂的 if-else 流程才能获得。获得后，可以将其赋给“终点库位”这个变量。后续需要“终点库位”时，可以引用这个变量。而不是引用某个嵌套很深的组件的输出参数。
在猎鹰任务编辑页面的任务变量区域点击“添加”按钮，添加一个任务变量，配置以下内容，配置完成，点击“完成”按钮：
参数名：必填，参数的名称。
类型：必填，支持字符串、布尔、整型、浮点型、JSON 对象、JSON 数组、不限制。
对象类型：对象类型标识这个参数的业务含义。例如是一个库位、一个机器人名、一个调度运单号等。一个参数可以配置零个、一个、多个对象类型。对象类型的目的是帮助加速配置。在后文【参数的推荐机制，最佳匹配】章节会提及。
## 默认值
说明：填写辅助信息。
## image.png

点击底部的“复制”按钮，可以复制输入参数。复制的参数默认加一个 -copy 后缀，如有需求，手动修改即可。
## image.png

任务变量一般配合“设置任务变量”组件使用，可以在这个组件中配置变量名称和变量值。下图的猎鹰任务用到了任务变量，来传递读取到的放行变量的值，具体例子参见本文档的《读取任务记录字段》。
## image.png

## 任务记录字段
猎鹰任务也是一个业务对象。一个常见的需求是在任务列表（表格）界面增加一列，展示某种业务数据。例如，客户想在任务列表查看任务属于哪条“产线”。标准猎鹰任务的业务对象无此字段。可以添加这个字段，让它出现在表格里。并在猎鹰任务里给这个变量赋值。
基于此需求，猎鹰任务的两个组件，“设置任务记录字段”和“读取任务记录字段”，可以在任务中读取和设置任务的这些扩展字段。下面介绍使用示例。
## 设置任务记录字段
“设置任务记录字段”表示用猎鹰任务设置【猎鹰任务记录】业务对象中的对应字段。以在猎鹰任务记录中展示起点和终点为例。
首先需要在【猎鹰任务记录】的业务对象配置中，配置我们需要增加的字段：起点、终点。配置好字段名和显示名。字段名输入英文。
## image.png

## image.png

## image.png

配置完，记得保存。并在【运维中心】-【业务对象】进行修复，修复后进行“更新数据库结构”。
## image.png

然后在猎鹰任务中，在“猎鹰任务”分类的组件下，找到“设置任务记录字段”组件，插入到任务流程中。
## image.png

“设置字段”输入参数配置为固定值，填写 fromSite（此处需要与【猎鹰任务记录】业务对象中设置的字段名保持一致）。“fieldValue”输入参数配置为引用，勾选任务输入参数-起点，意味着我们把任务输入参数的起点变量值赋予给猎鹰任务记录的起点字段。终点字段的值设置同理。
## image.png

## image.png

我们运行此任务，在运行时填写输入参数。
## image.png

任务运行结束后，我们可以看到【猎鹰任务记录】的自定义字段“起点”和“终点”已经显示出来了。
## image.png

## 读取任务记录字段
“读取任务记录字段”表示猎鹰任务读取【猎鹰任务记录】中的任意字段。比如一个放行字段，机器人取完货，读取该字段，发现为“True”时执行放货。
先配置【猎鹰任务记录】业务对象。记得在运维中心-业务对象，进行修复且更新数据库结构。
## image.png

编辑猎鹰任务，使用“读取任务记录字段”组件读取放行字段值。
## image.png

整个猎鹰任务如下，机器人去起点取完货，读取放行字段值。加循环进行条件判断，当放行值不为 True 时跳出循环，执行放货。
由于需要在 while 循环外和循环内读取字段值，判断条件得找一个中间变量，因此设置一个中间变量“release”接收读取的字段值，while 循环条件一直读取设置的任务变量 release 即可。为了降低循环对性能的影响，在每次循环前加一个延时组件，延时 1 秒。 
## image.png

## image.png

猎鹰任务运行后，一直读取放行字段值，读不到放行信号，一直在循环中。
## image.png

在项目中，通常由上位系统触发接口或者脚本触发来改变字段值，本次示例中简单用另一个猎鹰任务修改放行值为 True。由于上文提及的“三代调度”猎鹰任务运行以后，在【猎鹰任务记录】中会生成一个 ID，因此可以在这个放行的猎鹰任务中输入此 ID，来修改特定猎鹰任务记录的放行字段值为 True，具体配置如下。
## image.png

复制运行的“三代调度”猎鹰任务记录的 ID，运行即可修改放行字段。
## image.png

## image.png

“三代调度”猎鹰任务读取到放行指令后，完成了猎鹰任务。
## image.png

循环结束。
## image.png

## 全局变量
在所有任务里可以访问的全局变量。举个例子，一个项目有七八种业务流程，但都要根据当前是早班还是晚班走不同的运输路线。那就可以设置一个全局变量“班次”。再比如，现场有正式和测试两台打包机，有多个猎鹰任务都要用到这个打包机的 IP 地址。调试和正式生产时用的 IP 地址不同，且正式生产之后也会临时有调试任务。为了避免反复多次改多个猎鹰任务配置，可以定义一个全局变量。更多详细内容见本文档《全局控制》。
## 其他参数和变量
组件的输入参数：组件可以有零个或多个输入参数。组件的输入参数就相当于编程语言的函数输入参数。假设有一个组件叫“乘法”，这个组件有两个输入参数，两个数字；一个输出参数，即两个输入参数的乘积。
组件的输出参数：组件可以有零个或多个输出参数。输出参数相当于编程语言的函数的返回值（输出参数）。例如“创建运单”组件，返回运单单号和执行机器人两个参数。
组件的上下文变量：主要用于循环组件，例如，
“循环执行 N 次”组件，即 `for(int i=0;i<N;i++) {}’，i 就是上下文变量。
“遍历数组”组件，数组元素就是上下文变量。
## 变量类型
与编程语言类似，参数和变量有类型。
## 文本
## 布尔
## 整数
## 浮点数
### 对象，准确说是 JSON 对象，例如一个业务对象
### 数组，准确说是 JSON 数组，例如一组单行、一组机器人名
## 任意

## 组件输入参数配置方式
当一个组件需要一个输入参数时，可以选择三种配置方式：固定值、引用、表达式。
## 固定值，就是固定不变的值，如：
### 期望的机器人组，填机器人组的名字 `Fork`
是否可撤回，填 true 或 false 。
优先级，填数字 10。

## 引用，就是引用之前的某个变量，包括：
## 之前已执行完成组件的输出参数
## 父组件的上下文变量
## 任务的输入参数、任务变量
## 全局变量

表达式，可以填写 MVEL 表达式（一种 Java 表达式）。详见本文档《表达式指南》章节。
## image.png

## image.png

## 对象类型与匹配
猎鹰任务输入参数，任务变量，定制组件的输入参数、输出参数支持配置“对象类型”。对象类型标识这个参数的业务含义。例如是一个库位、一个机器人名、一个调度运单号等。一个参数可以配置零个、一个、多个对象类型。
## image.png

对象类型主要是便于选取输入、输出参数。例如，一个组件有一个输入参数“目标库位”，则需要传入一个库位。猎鹰任务支持组件间输入、输出参数的相互引用，即让组件 B 的某个输入参数，取组件 A 的某个输出参数。如果任务复杂，在选择引用时会有大量的输出参数可用。

因此，对于文本类型的参数和变量，还可以进一步说明（限制）这个变量表示的概念，帮助加速配置。如：
## 机器人名
## 容器编号
## 库位名
## ……

## 在配置参数引用时，候选参数将分为三组：
最佳匹配：候选参数的类型和对象类型与输入参数的类型和对象类型匹配。例如调度运单块组件的“站点”参数，是文本类型，期望引用一个“站点”或“库位”。在可选的引用变量中，任务输入参数起点和终点匹配，它们是最佳匹配参数。或者当输入参数期望输入一个“调度单号”时，对象类型为“调度单号”的变量，会列在“最佳匹配”一节，如创建运单组件的输出参数。
可能匹配：候选参数的类型与输入参数的类型匹配。如输入参数是“文本”类型，则所有文本类型的变量列在“可能匹配”一节。
其他参数：类型不匹配的其他参数。有时候允许类型不匹配的引用，比如需要一个布尔参数，但传入一个数字，非 0 都标识 true。
开始配置一个组件的输入参数，如果有最佳匹配，配置类型将自动设为“引用”（默认是“固定值”）。
## image.png

最佳匹配并非是绝对的，配置任务时，仍需根据实际情况，从“可能匹配”或者“其他”参数中选择。比如设置了运单号生成后传入“设置任务变量”组件中，然后在执行运单块时将任务变量作为引用变量。
## image.png

## 其他示例：
绑定库位容器组件的库位编号，最佳匹配是“寻空库位”组件输出的库位 ID。
## image.png

解绑库位容器的容器编号，最佳匹配是“获取库位上的容器”输出的容器编号。
## image.png

按容器移动库存组件的终点库位，最佳匹配是“寻空库位”组件输出的库位 ID。
## image.png

从单据创建库存的单据，最佳匹配是“根据 id 查找业务对象”输出的业务对象。
## image.png

## 子任务使用示例
猎鹰任务支持任务的嵌套，即每个猎鹰任务都可以作为子任务，供其他任务调用。特别是某个固定的任务/某些固定顺序的组件在其他任务中大量重复执行，推荐使用。比如，项目中如果有设备交互（如电梯），每个机器人每次和设备交互的信号、逻辑相同，则可以把与设备交互的部分单独编辑一个猎鹰任务，在其他猎鹰任务中调用设备交互的猎鹰任务，作为子任务。
如果一个猎鹰任务需要触发另一个猎鹰任务，在子任务分类中找到需要的任务，插入到流程中。子任务模块颜色同其他组件不同，以绿色突出显示。
## image.png

这里以接力搬运为例，从起点搬到中转点，再从中转点搬到终点，这里会用到两个简单搬运。先配置简单搬运的猎鹰任务，再作为子任务插入接力搬运中。简单搬运前文已经介绍，详见本文档《猎鹰任务详情界面》。
在猎鹰任务的编辑界面，设置任务名：接力搬运，添加任务输入参数：起点、终点、中转点，插入子任务组件：简单搬运。此处第一个简单搬运任务中，终点设置为新增输入参数“中转点”。第二个简单搬运任务中起点设置同理。
点击配置组件中“查看子任务”，可快速跳转到子任务编辑界面。
## image.png

保存并运行，输入点位信息，可在地图上查看机器人运行轨迹。
## image.png

任务详情中，查看任务各组件完成情况，也可以点击子任务的单号，跳转到子任务详情页面。
## image.png

## 子任务详情界面：
## image.png

## 自定义组件编辑界面
猎鹰任务提供丰富的内建组件，但并非满足所有场景需求。猎鹰任务支持自定义组件，实现个性化的需求。
在猎鹰任务模板列表页点击“添加定制组件”，打开自定义组件弹窗。
## image.png

### 5.11.2 以上版本新增第四个参数, 如果不加此参数, 则脚本会直接报错, 5.11.2 及以下依旧使用三个参数
 参数4: extExtraCtx 组件的数据集合 , 正常情况下不会用到 , 可以忽略 , 但是输入参数不能少
## image.png

可以配置组件名、组件显示名、组件说明、调用函数。支持两种内联代码语言（Python/JavaScript）。
自定义组件支持配置输入、输出参数和子组件。在右侧代码编辑区录入代码。点击保存即可添加自定义组件。
自定义组件会显示在猎鹰任务组件列表的“定制组件”分类下，供编辑任务模板时使用。
## image.png

## 表达式指南（待编写）
## 可以作为表达式变量的有以下类别：
任务相关的变量：任务 ID、任务模板名、任务当前状态。
任务输入变量：即自己在编辑页左侧“任务输入参数”处定义的任务输入参数。
任务中其他组件的输出参数：可以结合其他组件的输出参数编写表达式。
全局变量：系统的【猎鹰任务记录】菜单页面的【全局控制】处定义的变量。
输入参数采用表达式输入时，会涉及到多个变量拼接形成表达式的场景，比如一个判断条件，需要综合多个任务变量的值进行判断，那么就可以通过 && 或者 or 符号连接多个判断条件。或者一个参数的输入需要进行字符串拼接。M4 在输入表达式时，鼠标停留在需要的位置，点击变量，则会将变量插入到光标所在处，实现拼接。

## image.png

## image.png

## 自定义组件编写指南
猎鹰任务提供丰富的内建组件，但并非满足所有场景需求，我们支持自定义组件，实现个性化的需求。
这里以 GetEmptyBinIdByDistrictId 根据库区找空库位 为例，介绍如何编写一个猎鹰任务自定义组件。
## image.png

组件名是一个自定义组件的唯一标识，不可与其它自定义组件重复。组件名建议只使用英文字母，同时采用驼峰命名法命名。如示例中的 GetEmptyBinIdByDistrictId。
组件显示名只用于显示。编写猎鹰任务选择组件和添加组件，均会显示此名字。
组件说明用于补充说明组件功能。在任务中添加组件后，可以在组件配置内查看对应组件的说明。
调用函数建议使用唯一标识，同时将首字母改成小写，符合大多数良好代码习惯。如示例中的 getEmptyBinIdByDistrictId。
内联代码语言根据所使用的编程语言来选择，支持 Python 和 JavaScript 两种语言。如果项目内有使用脚本，建议编写自定义组件时，也使用相同的语言。
每个自定义组件支持添加多个输入参数，也可以不添加输入参数。每个输入参数的定义方式及含义详见本文档《猎鹰任务参数和变量体系》章节。
每个自定义组件支持添加多个输出参数，也可以不添加输出参数。输出参数和输入参数的定义方式基本一致，区别在于输出参数没有“必填性”和默认值。
右侧代码区域，用于编写自定义组件的代码，M4 的代码编辑器支持关键字提示，换行自动缩进等功能。下面介绍编写自定义组件代码的规则：
请使用所选的内联代码语言来编写代码。
代码中必须包含左侧填写的调用函数。如示例中的 def getEmptyBinIdByDistrictId(tc, inputParams, taskInputParams)
代码中可以定义其它函数、对象等，便于在调用函数中使用。
代码里可以使用后端脚本能使用的所有方法。比如示例中的 cq.cqAnd 用于构造查询条件、entity.findOne 根据构造的查询条件进行查询。具体可以使用哪些方法详见M4 脚本开发文档。
### 调用函数必须包含以下输入参数，并且一定是以下顺序：
tc: TraceContext，追踪上下文。用于传给需要 TraceContext 参数的脚本方法。
inputParams: 是一个字典（Map），包含所有此组件定义的输入参数。
taskInputParams：是一个字典（Map），包含使用此组件的任务的输入参数。
如果需要输出参数，调用函数必须返回一个 JSON 字符串（建议使用 base.jsonToString)。JSON 对象有四个字段：
fatal: 布尔类型，true 表示产生了致命错误，将导致猎鹰任务直接终止。
error: 布尔类型，true 表示遇到了错误。
errorMsg: 字符串类型，表示错误原因，可以为 None。
outputParams: 组件的输出参数。
## 简单脚本（待编写）

## 全局控制
所谓全局控制，就是允许定义一些全局变量，在所有猎鹰任务中访问，控制猎鹰任务行为。
例如，某项目要定义多个猎鹰任务。每个里面都要访问一个第三方系统。需要第三方系统的 URL 地址。但开发阶段的测试系统和现场系统不同。通过全局遍历，只需要改一次，即可切换测试/现场 URL；不要逐个改猎鹰任务。类似的，有些项目要求能够，通过界面
切换两个班次，每个班次业务流程不同，使用不同库区、猎鹰任务流程……
### 切换 A、B 两条产品线，不同产品线使用不同流程……
猎鹰任务的全局控制即可低代码实现上述功能。
可以在【猎鹰任务记录】页面点击“全局控制”按钮，进入全局变量页面。也可以直接在 M4 配置“全局控制”菜单，通过菜单进入页面。
## image.png

## image.png

### 示例，这里定义了四个变量，分别是不同的类型：
## image.png

## image.png

首先，可以低代码定义需要的变量。在全局控制页面点击【定义变量】按钮，弹出定义变量对话框，可以定义新的全局变量。支持多种变量类型：文本、整数、长整数、浮点数、布尔、引用。
变量类型为文本/整数/长整数/浮点数时，支持自定义选项清单；当配置了选项清单，如果想设置默认值，需要填写选项清单设置中的标识而不是标签。
## image.png

## image.png

## image.png

类型为引用时，需要在后方选择引用的业务对象，支持添加筛选条件。
## image.png

## image.png

变量定义后，可以通过界面设置。在全局控制页面，修改已定义变量的值，点击更新，会应用到所有引用该变量的猎鹰任务。
在猎鹰任务编辑界面，配置组件的输入参数时，引用和表达式均会提供全局变量的选择。

## image.png

## image.png
