# M4 管理员手册

## M4 管理员手册
## 修订时间：2025年10月31日

## 菜单编辑
有菜单配置权限的用户，菜单栏下方会显示“配置菜单”，点击后进入《菜单配置》页面。
## 如何添加菜单？
在《菜单配置》页面，点击“添加菜单组”，并在增加的组中填写组名。（如果已经有菜单组，跳过本步骤）
## image.png

在组下方点击“添加菜单项”，在添加的行中选择“菜单名”，点击“保存”，并在在弹窗中点击“立即刷新”。

## image.png

## image.png

注意：如果要添加的页面是定制的，选择菜单名之前，页面类型要选择“定制页面”。
## 如何调整菜单顺序？
在《菜单配置》页面，按住组名前的“拖动”按钮拖动，可实现整组菜单前移后移。按住菜单项前“拖动”按钮拖动，可实现菜单在组内前移后移。
## image.png

## 如何定制菜单图标和颜色？
每个内建菜单都有默认的图标和颜色，如果不满足需求，可以在《菜单配置》页面定制。操作如下：
找到要定制的菜单，点击定制图标后面的“+”，在弹窗中选择图标。
## image.png

点击定制颜色后面的“颜色选择器”，在弹窗中选择颜色，或者直接在输入框输入色号。
## image.png

在页面左上角点击“保存”，并在在弹窗中点击“立即刷新”。
## image.png

## 如何定制菜单名称？
在《菜单配置》页面找到要更名的菜单，填写“定制菜单项名称”。
## image.png

在页面左上角点击“保存”，并在在弹窗中点击“立即刷新”。
## image.png

## 同步块

注意：切换其他语言时，定制的菜单名无法自动翻译。
## 如何删除菜单和菜单组？
在《菜单配置》页面，找到要删除的菜单组/菜单项，点击“删除图标”，在页面左上角点击“保存”，并在在弹窗中点击“立即刷新”。

## image.png

## image.png

## 用户角色管理
一个用户（账号）一次只能登录一个浏览器，后一次登录会把前一次登录踢掉。如果有多台设备或多个浏览器需要同时登录，那么需要创建多个用户。
目前的权限体系包括用户 - 角色 - 权限三层。每个用户可以赋予一个或者多个角色，每个角色可以赋予一个或多个功能项权、数据权。比如角色 1 被赋予了入库权限，角色 2 被赋予了出库、分拣的权限，给小张赋予角色 1 和角色 2，那么小张就会有入库、出库、分拣的权限。
## 如何新增角色？
打开【用户角色】菜单，点击“新增”，进入【用户角色新增】弹窗。
## image.png

填写角色名，并在下方的“权限清单-功能项权”中勾选需要的权限。可以逐项勾选，也可以通过“全部菜单权限”、“全部查看权限”、“全部权限”批量将对应权限赋予角色。
如果需要限制数据行权，切换到“权限清单-数据行权”，选择要限制的菜单，并设置筛选条件。
## image.png

如果默认角色选择时，创建用户时，会将此角色作为用户的默认角色。
点击“保存”，角色即可创建成功。
## 如何修改角色？
当需要给角色增加或者减少功能项权、数据权时，可以修改角色。具体操作如下：
打开【用户角色】菜单，找到角色所在行，点击“查看”，进入【用户角色 查看】页面。
## image.png

点击“编辑”，切换为编辑模式，即可调整功能项权、数据行权。
## image.png

调整后，点击“保存”，角色即可修改完成。
## image.png

## 如何新增用户？
打开【用户】菜单，点击“新增”，进入【用户新增】弹窗。
## image.png

如果创建的是一般用户，填写用户、密码，选择角色，然后点击“保存”。
如果创建的是企业管理员， 填写用户、密码，勾选企业管理员，然后点击“保存”。选择管理员后，会将此用户视为管理员，其它所选角色无效，该用户拥有所有权限。

注意：密码需要满足【系统配置-用户安全】页面设置的密码最小长度、密码最大长度、密码强制限制。
## 如何修改用户？
如果要停用用户，或者修改已有用户的密码、角色等，可以修改用户。具体操作如下：
打开【用户】菜单，找到目标用户所在行，点击“查看”，进入【用户 查看】页面。
## image.png

点击“编辑”，切换到编辑模式，根据需要修改信息，然后点击“保存”。
## image.png

## 如何批量创建用户？
如果用户较多，可以通过导入的方式进行批量创建。具体操作如下：
打开【用户】菜单，点击“导出”，在弹窗中，点击“导出成功，请下载”，即可导出一个模板。
## image.png

在 excel 中填写用户信息，一般用户填写用户、密码。企业管理员填写用户、密码、企业管理员。
在用户列表页，点击“导入”，在弹窗中上传 excel 文件。
## image.png

## 如何批量编辑用户？
打开【用户】菜单，勾选要修改的用户，点击“批量编辑”，在弹窗中先勾选要修改的字段，然后修改字段值，最后点击“保存”。
## image.png

## 简单系统配置
有系统配置权限的用户，可以点击系统右上角角色名，在弹出的菜单中点击 系统配置，即可进入系统配置页面。
## 如何修改系统名？
在《系统配置》页面，点击“基础配置”，即可在标签页中看到“企业名称”，修改后，点击“保存”，如果需要立即生效，在弹窗中点击“立即刷新”即可。

## image.png

## image.png

## 如何修改系统 LOGO？
在《菜单配置》页面，点击“基础配置”，即可在标签页中看到“企业 LOGO”，修改后，点击“保存”，如果需要立即生效，在弹窗中点击“立即刷新”即可。

## image.png

## image.png

## 如何切换系统语言？
目前 M4 支持中文、繁体中文、English、日本语这 4 种语言。
在《菜单配置》页面，点击“基础配置”，即可在标签页中看到“语言”，修改后，点击“保存”，在弹窗中点击“立即刷新”即可。

## image.png

## image.png

## 密码连续输错多次是否锁定账户？
M4 默认不限制密码输入错误的次数，不管密码连续输错多少次账号都不会被锁定。如果要实现连续输错 3 次密码，账户锁定 20 秒，20 秒后才能重试登录，需要做如下配置：
在《菜单配置》页面，点击“用户安全”，在【用户安全】标签页按下图填写“允许密码错误次数”、“密码错误次数重置时间”，点击“保存”并“立即刷新”。

## image.png

## image.png

## 如何设置免登录时长？
M4 系统默认密码永不过期，即一个浏览器只需登录一次，后续不需再登录。如果要实现，每隔 180 天，用户必须登录一次，需要进行以下配置：
在《菜单配置》页面，点击“用户安全”，在【用户安全】页面填写“密码过期时间”，点击“保存”并“立即刷新”。

## image.png

## image.png

当用户登录时间＞ 180天时，需要在登录页面重新登录。
## 如何设置密码安全程度？
系统默认密码最小长度是 1 位，最大长度是 20 位，没有密码强制限制。即用户可以设置 1 - 20 位的任意数字、字母、特殊符号。如果要增强密码安全程度，实现“密码”必须是 8 - 14 位且包含字母和数字”的需求，管理员可以做以下配置： 
在《菜单配置》页面，点击“用户安全”，按下图配置“密码最小长度”、“密码最大长度”、“密码强制限制”。然后点击“保存”并“立即刷新”。

## image.png

## image.png

### 创建新用户时，密码输入“123”，保存时系统报错如下：
## image.png

创建新用户时，当密码输入“12345678”时，保存时系统报错如下：
## image.png

## 如何设置移动端列表页按钮平铺/收起？
系统默认移动端列表收起在右上角的“…”，如果要将按钮平铺展示，需要在《菜单配置》页面，点击“界面配置”，将“移动端业务对象主界面按钮平铺”开关打开。

## image.png

## image.png

## image.png

## 引用类下拉列表如何支持扫描？
引用类下拉列表可以转换成输入框，便于扫描录入。配置方法是：在《菜单配置》页面，点击“界面配置”，将“引用录入采用直接录入的方式”开关打开。
## image.png

## image.png

## image.png

### 模糊搜索结果只有一个选项时，是否自动打开详情页？
在“系统设置”-“界面配置”，启用“列表页模糊搜索只有一个选项时，自动打开详情页”功能。当搜索结果只有一个时，系统自动跳转打开详情页面。
## image.png

## 数据库运维
## 如何导入、导出数据？
在《运维中心》页面，点击“导入数据”-“点击上传文件”，选择要上传的数据文件，等待导入完成。

## image.png

## image.png

点击“导出数据”-“开始导出”，等待导出成功后，点击下载即可。
## image.png

## image.png

## image.png

## 如何清理历史数据？
在《运维中心》页面，点击“立即清理历史数据”，弹出危险操作警告，点击“确定”。

## image.png

## image.png

## 如何自动备份、还原数据库？
系统支持自动备份数据，在“系统设置”-“数据管理”，启用数据库本地备份功能。可配置备份存放位置（备份文件夹）、最多保留多少天等。可以通过 Cron 表达式配置备份时机。默认每天凌晨 2 点备份。通过 Cron 表达式还可以实现一天多次备份、三天备份一次、一周备份一次等高级操作。
## image.png

备份文件默认放在项目目录 backup 目录下。在《运维中心》页面，点击“数据库自动备份记录”-“立即备份”，可以在 M4 上讲所需的文件或数据从服务器自动备份到本地。

## image.png

## image.png

点击“还原数据”，可将备份好的数据还原至系统中。
## image.png

## 如何删除备份数据库？
若想要删除备份数据库，勾选中备份数据，点击“删除”按钮，成功删除。
## image.png

## 日志
## 如何下载日志？
在《运维中心》页面，可以根据数据类型及时间段筛选日志下载，选择好后点击“下载日志”按钮，点击“导出成功，请下载”。

## image.png

## image.png

## 如何配置日志打印类型？（待编写）
## 如何设置日志位置、设置存储时间？
M4 采用 Log4j2 日志框架。如果想修改日志配置，可以在启动参数中添加：

-Dlog4j.configurationFile=path/to/log4j2.xml
= 后即日志配置文件的路径。
示例配置（根据需要修改 fileName 和 filePattern 的绝对路径生成日志）： 
## log4j2-test.xml
假设 m4 主程序位置 C:\m4，主程序 trick-m4-4.21.8.jar，日志配置文件 C:\m4\log4j2.xml，项目包为 C:\m4\demoProject
## image.png

### 按需要修改下方 log4j2.xml ：
### 注意修改日志文件名和所在位置（绝对路径）

<?xml version="1.0" encoding="UTF-8"?>
### <Configuration status="INFO">
## <Properties>
### <Property name="LOG_PATTERN">
            %d{HH:mm:ss.SSS} %highlight{${LOG_LEVEL_PATTERN:-%5p}}{FATAL=red, ERROR=red, WARN=yellow,
            INFO=green, DEBUG=green, TRACE=green} --- [%15.15t] %logger{1} - %m%n%ex
## </Property>
## </Properties>

## <Appenders>
        <Console name="Console" target="SYSTEM_OUT">
            <PatternLayout pattern="${LOG_PATTERN}"/>
## </Console>
## <!-- 这里是日志文件路径 -->
        <RollingFile name="RollingFile" fileName="C:/m4/logs/f2.log" filePattern="C:/m4/logs/f2-%d{yyyy-MM-dd}-%i.log">
## <PatternLayout>
                <Pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n</Pattern>
### <charset>UTF-8</charset>
## </PatternLayout>
## <Policies>
### <!-- 每天滚动一次，产生一个新的日志文件 -->
### <TimeBasedTriggeringPolicy/>
                <!-- 每 100MB 滚动一次，产生一个新的日志文件 -->
                <SizeBasedTriggeringPolicy size="100MB"/>
## </Policies>
### <!-- 最多保留 100 个日志文件 -->
            <DefaultRolloverStrategy max="100">
                <Delete basePath="" maxDepth="2">
### <IfFileName glob="*.log"/>
## <!-- 最多 30 天 -->
### <IfLastModified age="30d"/>
## </Delete>
### </DefaultRolloverStrategy>
## </RollingFile>
## </Appenders>

## <Loggers>
## <Root level="warn">
### <AppenderRef ref="Console"/>
            <AppenderRef ref="RollingFile"/>
## </Root>
        <Logger name="com.seer" level="debug" additivity="false">
### <AppenderRef ref="Console"/>
            <AppenderRef ref="RollingFile"/>
## </Logger>
      <Logger name="Fleet" level="debug" additivity="false">
### <AppenderRef ref="Console"/>
        <AppenderRef ref="RollingFile"/>
## </Logger>
        <Logger name="com.seer.trick.robot.vendor.seer.rbk.RbkPortClient" level="info" additivity="false">
### <AppenderRef ref="Console"/>
            <AppenderRef ref="RollingFile"/>
## </Logger>
## </Loggers>
## </Configuration>
## 启动命令：

## cd C:\m4
java -jar -Dlog4j.configurationFile=C:\m4\log4j2.xml trick-m4-4.21.8.jar "C:\m4\demoProject"
## 如何设置不打印的报文编号？
在“系统设置”-“车队管理”页面，不打印报文的编号默认显示“1100”。即没有配置的情况下，M4 默认不打印 1100 开头的报文，如果用户想打印，可以在页面里，将 1100 删掉。
## image.png

### 将 TCP 解码器收到的原始报文打在日志里？（Todo）
在“系统设置”-“开发配置”中，启用“将 TCP 解码器收到的原始报文打在日志里”后，点击“保存”。
## image.png

## 打印 TCP 写完成？（Todo）
在“系统设置”-“开发配置”中，启用“打印 TCP 写完成”后，点击“保存”。
## image.png

### 打印 HTTP 客户端请求日志？（Todo）
在“系统设置”-“开发配置”中，启用“打印 HTTP 客户端请求日志”后，点击“保存”。

### 打印 WebSocket 客户端日志？（Todo）
在“系统设置”-“开发配置”中，启用“打印 WebSocket 客户端日志”后，点击“保存”。
## 打印设备客户端日志？（Todo）
在“系统设置”-“开发配置”中，启用“打印设备客户端日志”后，点击“保存”。每次 Modbus  读写失败抛出异常后均打印到日志中。
## image.png

## 系统运维
如何查看系统监控信息？（Jobs、Monitor、Log、Old）
在《运维中心》页面，点击“系统监控”，进入系统监控页面。
共有四项监控数据：Jobs、Monitor、Log、Old，可以监控系统内各组件的实时运行情况，通过系统监控让系统运行透明化，遇到问题，不用查日志，看监控界面能直接排查问题。（主要用于运维任务和开发人员排错）
## image.png

## image.png

## 如何快捷重启脚本？
更新系统的脚本文件后，比如远程更新服务器上的脚本，无需重启系统，在《运维中心》页面，在脚本一栏中点击 “重启脚本” 即可重启脚本。
## image.png

### 如何通过数据字典查看业务对象的字段信息？
打开《数据字典》菜单页面，通过下拉框选择要查看的业务对象名称，界面会以表格的形式自动显示该业务对象的所有字段信息。
## image.png

## 如何查看故障记录？
M4 将运行过程中发生的故障记录“故障记录”数据表中，在《运维中心》页面，点击“故障记录”，可以看调度机器人告警、光通讯模式下运单的失败记录等。
## image.png

## image.png

## 如何清除系统缓存？
M4 支持清除系统缓存，以便解决部分情况下内存占用过高出现的问题。
在《运维中心》页面，点击“清除缓存”按钮，点击“确定”。

## image.png

## image.png

## 启动配置文件
## 如何选择并配置不同数据库？
自 4.12.1 版本开始，M4 数据库首推使用 MySQL，其次内置数据库，其次 MongoDB。
### 内建数据库配置（什么都不配，默认就是内建数据库）

## {
## "db": {
## }
## }
## MySQL 常见配置

## {
## "db": {
    "type": "MySQL",
    "host": "127.0.0.1",
    "username": "root",
    "password": "root_123",
## "dbName": "m4"
## }
## }
## MongoDB 常见配置

## {
## "db": {
    "type": "MongoDB",
    "url": "mongodb://localhost/m4",
## "dbName": "m4"
## }
## }
## 如何修改 HTTP 服务的端口？
默认情况下，M4 使用 Http 服务，使用 5800 端口，如果在端口被其它软件占用等情况下，想要更改端口，可以在项目包中的 config.json 中增加 port 配置，并设置为想要使用的端口。示例：

## {
## "port": 5801
## }
## 如何禁用文件浏览？（Todo）
## 如何禁用脚本
如果想要全局禁用脚本，可以在项目包中的 config.json 内增加 noScript 配置并设置为 true，即可禁用脚本。示例：

## {
## "noScript": true
## }
注意，脚本禁用后，项目脚本文件、猎鹰任务脚本块、实体上配置的脚本、删除编辑的脚本控制都将被禁用，请谨慎使用。
## 如何启用 https
### 通过 Nginx 实现 https 服务
如果需要 https，建议使用 Nginx。若无法使用 Nginx，可让 M4 本身提供 https 服务。
使用 nginx 开启 https 见：通过 Nginx 实现 https 服务
## 使用 M4 提供的 https 服务
### M4 本身提供 https 服务。可以通过以下方式配置：
修改 config.json 文件，增加 https 的配置
## 示例如下：

## {
## "httpsConfig" : {
    "enableHttps" : true,
    "httpsPort" : 5901,
### "password" : "123456"
## }
## }
其中 httpsConfig 为 https 的配置，enableHttps 表示是否开启 https，httpsPort 是开启 https 后通过 https 访问的端口号，password 为秘钥的密码。
## 放置证书文件
将 https 证书文件放置到项目的 config 目录下，目前仅支持 pem 格式。
## image.png

使用的证书文件名需要与上图中的一致，分别是 cert.pem 和 key.pem 。

注意：开启 https 之后，仍可通过 http 访问，https 和 http 分别通过不同的端口进行访问。
以下为可测试用的自签名证书，password 为 123456

## cert.pem

## key.pem
## 代理登陆
### 如何配置代理账户？（通过接口访问 M4）
为了确保系统的安全性和数据的完整性，M4 标准接口采用了多种安全机制。
管理员可在《代理用户》页面添加应用 ID 和密钥。程序客户端可在请求头携带身份信息，即可使用 M4 的接口，否则无法通过身份验证。
## image.png

## 第三方登陆配置
M4 目前支持使用企业微信、钉钉、飞书等平台进行第三方登录。开启并配置好后，在登陆界面会出现“更多登录方式”的链接。点击即可跳转登陆。
## image.png

这里以飞书为例，如需在 M4 中开启飞书登录，请先学习飞书的官方文档，并将获得的应用 ID 和应用密钥填入 M4 的系统配置 - 第三方登录中。如需使用其它平台，请联系我们。
## 匿名登陆配置
 5.2.1 版本后，可以开启匿名登录功能。可在配置文件 config.json 里添加 "anonymouseUser" : true。标识启用匿名登录。配置完成后需要重启系统。
## config.json 示例：

## {
### "anonymouseUser" : true
## }
系统启动后，将自动创建一个匿名账户，拥有管理员权限。打开页面后将不会再出现登录界面。并且这个账户允许多人同时使用。登陆后，用户会显示为“Anonymouse”

## 附注：M4 中身份验证的顺序：
如果 Cookie 中带有用户 id/token，按普通用户身份验证。
## 否则尝试按 agent 登录处理
## 否则如果启用了匿名登录，直接验证成功
## 身份验证失败
## 管理服务器文件
仅管理员或实施人员，可以在《服务器文件管理》页面对 M4 服务器上的文件进行指定操作。
打开《服务器文件管理》页面，会自动访问 M4 所在磁盘分区的根目录，并将当前路径下的所有文件、文件夹，都显示在列表中。可以根据需求对所有文件进行操作。例如：点击文件夹名称，能切换到此文件夹所在目录；点击“向上”按钮能放回到上一级目录。
## image.png

M4 支持在界面上对服务器的文件进行上传、下载、删除、压缩目录、解压等操作。请注意，进行删除等危险操作之前，请确认操作无误。
## 系统急停
管理员用户可以在告警面板下方看到“系统急停”按钮（STOP）。此按钮可以让系统进入急停状态。当系统进入急停状态，各种任务、设备都会尽快暂停。具体请见各个模块的功能说明。
当系统进入急停状态后，所有用户的界面将在右侧显示急停标识。管理员用户还有“取消”按钮，用于退出急停。

## image.png

## image.png

## 系统关键事件
在《系统关键事件》页面，会在列表中记录系统运行过程中发生的关键事件。通过这些记录，可以快速排查由于不当操作引起的问题，系统关键事件中会记录：
## 系统启动 / 关闭
## 对业务对象元数据的修改、删除、重置
## 导入、导出数据库，从备份中恢复数据
## 修改系统配置
## 重启脚本
## 修改场景
img_v3_02po_a882006c-43bf-4dbb-a9f5-1ef4b297e33g.jpg
## 系统关键事件界面
